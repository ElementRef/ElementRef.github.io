<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="AntDesign 因为存在 Admin 端，并且对话组件需要同时在 Admin|Web|JS-SDK 三个环境中使用；索性使用 AntDesign 作为组件库，恰好 AntDesign 也为 AI 应用推出了 AntDesign X 。
Popover 与 Tooltip 在写业务的时候，发现 Popover 与 Tooltip 的使用界限很模糊； 《文字提示与气泡弹窗有什么区别？怎么用？》 解答了我的疑惑：
"><title>AI JS-SDK 项目总结（二） · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/"><link rel="stylesheet" href="/scss/style.min.a4da387b20ce5a8b806cf676eb75d9139ad7b5f550cccaa0d6f935c8c4982f6c.css"><meta property="og:title" content="AI JS-SDK 项目总结（二）"><meta property="og:description" content="AntDesign 因为存在 Admin 端，并且对话组件需要同时在 Admin|Web|JS-SDK 三个环境中使用；索性使用 AntDesign 作为组件库，恰好 AntDesign 也为 AI 应用推出了 AntDesign X 。
Popover 与 Tooltip 在写业务的时候，发现 Popover 与 Tooltip 的使用界限很模糊； 《文字提示与气泡弹窗有什么区别？怎么用？》 解答了我的疑惑：
"><meta property="og:url" content="https://ElementRef.github.io/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2025-08-02T00:00:00+00:00"><meta property="article:modified_time" content="2025-08-02T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/react.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="AI JS-SDK 项目总结（二）"><meta name="twitter:description" content="AntDesign 因为存在 Admin 端，并且对话组件需要同时在 Admin|Web|JS-SDK 三个环境中使用；索性使用 AntDesign 作为组件库，恰好 AntDesign 也为 AI 应用推出了 AntDesign X 。
Popover 与 Tooltip 在写业务的时候，发现 Popover 与 Tooltip 的使用界限很模糊； 《文字提示与气泡弹窗有什么区别？怎么用？》 解答了我的疑惑：
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/react.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta http-equiv="Content-Security-Policy" content="frame-src *.bilibili.com *.qq.com *.youtube.com https://youtu.be"><script src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2" crossorigin="anonymous" defer=""></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="flex container extended main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu15751654176150258532.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://douban.com/people/nicknoonan" target="_blank" title="DouBan"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-douban"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h16"></path><path d="M5 4h14"></path><path d="M8 8h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-2a2 2 0 012-2z"></path><path d="M16 14l-2 6"></path><path d="M8 17l1 3"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/"><img src="/img/cover/react.webp" alt="AI JS-SDK 项目总结（二）" fetchpriority="high" decoding="async" width="1200" height="720" jampack-sized="true"></a></div><div class="article-details"><header class="article-category"><a href="/categories/react/">React</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/">AI JS-SDK 项目总结（二）</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Aug 02, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：23 分钟</time></div></footer></div></header><section class="article-content"><h2 id="antdesign">AntDesign</h2><p>因为存在 Admin 端，并且<strong>对话组件</strong>需要同时在 Admin|Web|JS-SDK 三个环境中使用；索性使用 AntDesign 作为组件库，恰好 AntDesign 也为 AI 应用推出了 <a class="link" href="https://x.ant.design" target="_blank" rel="noopener">AntDesign X
</a>。</p><h3 id="popover-与-tooltip">Popover 与 Tooltip</h3><p>在写业务的时候，发现 Popover 与 Tooltip 的使用界限很模糊；<a class="link" href="https://www.leadwhite.net/tooltip" target="_blank" rel="noopener">
《文字提示与气泡弹窗有什么区别？怎么用？》
</a>解答了我的疑惑：</p><ul><li>Tooltip 是从标签的 title 属性衍生过来的，用来展示<strong>完整信息</strong>，内部不包含用户交互；</li><li>Popover 起源于<strong>漫画对话框</strong>，在 macOS Lion 成为系统控件：<ul><li>可以承载更多的图文信息，提供详情预览的功能；</li><li>内部包含简单的用户交互，功能向<strong>弹窗</strong>靠拢。</li></ul></li></ul><h3 id="usemessage">useMessage</h3><p>AntDesign 的 <a class="link" href="https://ant.design/components/message-cn" target="_blank" rel="noopener">message
</a>不支持在当前提示框内部进行关闭操作，需要自己手动封装；useChatMessage 在 useMessage 的基础上做了两件事：</p><ul><li>调用 AntDesign 的 useMessage 的，获取到 messageApi 和 contextHolder；</li><li>调用 cloneElement，修改传入 ReactNode 的 props，添加一个 onClick 事件：<ul><li>这个 onClick 是 messageApi.error|info|loading|success|warning 的返回值；</li><li>这个返回值是一个函数，调用之后，会关闭当前 message 实例；</li><li>onClick 借助了 JS 的引用传递，在调用的时候才能拿到。</li></ul></li><li>这也算是 React <a class="link" href="https://elementref.github.io/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%8A/#%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F" target="_blank" rel="noopener">组合模式
</a>的应用。</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ArgsProps</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ConfigOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MessageInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MessageType</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">TypeOpen</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd/es/message/interface'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">ReactElement</span><span class="p">,</span> <span class="nx">ReactNode</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">message</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">cloneElement</span><span class="p">,</span> <span class="nx">isValidElement</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">useMessage</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">generateMessageInstance</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fn</span>: <span class="kt">TypeOpen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">messageType</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">current</span>: <span class="kt">null</span> <span class="kr">as</span> <span class="kt">unknown</span> <span class="kr">as</span> <span class="nx">MessageType</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">current</span>: <span class="kt">null</span> <span class="kr">as</span> <span class="kt">unknown</span> <span class="kr">as</span> <span class="nx">JointContent</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="o">===</span> <span class="s1">'[object Object]'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此时 content 为 ReactElement | ArgsProps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">isValidElement</span><span class="p">(</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 此时 content 为 ReactElement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">element</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">cloneElement</span><span class="p">(</span><span class="nx">content</span> <span class="kr">as</span> <span class="nx">ReactElement</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onClick</span>: <span class="kt">messageType</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 此时 content 为 ArgsProps
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isValidElement</span><span class="p">((</span><span class="nx">content</span> <span class="kr">as</span> <span class="nx">ArgsProps</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">content</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此时 content.content 为 ReactElement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">element</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">...(</span><span class="nx">content</span> <span class="kr">as</span> <span class="nx">ArgsProps</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">content</span>: <span class="kt">cloneElement</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nx">content</span> <span class="kr">as</span> <span class="nx">ArgsProps</span><span class="p">).</span><span class="nx">content</span> <span class="kr">as</span> <span class="nx">ReactElement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="nx">onClick</span>: <span class="kt">messageType</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 此时 content.content 为除了 ReactElement 之外的 ReactNode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">element</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">content</span> <span class="kr">as</span> <span class="nx">ArgsProps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 此时 content 为除了 ReactElement 之外的 ReactNode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">element</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">content</span> <span class="kr">as</span> <span class="nx">ReactNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 获取关闭 message 的方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">messageType</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">element</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">onClose</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">messageType</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 对 useMessage 进行包装，方便手动关闭操作
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">useChatMessage</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">messageConfig?</span>: <span class="kt">ConfigOptions</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="kr">readonly</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MessageInstance</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">React</span><span class="p">.</span><span class="nx">ReactElement</span><span class="p">&lt;</span><span class="nt">unknown</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">React.JSXElementConstructor</span><span class="err">&lt;</span><span class="na">any</span><span class="p">&gt;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">innerMessageApi</span><span class="p">,</span> <span class="nx">contextHolder</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useMessage</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">messageConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">duration</span>: <span class="kt">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxCount</span>: <span class="kt">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rtl</span>: <span class="kt">false</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">messageApi</span>: <span class="kt">MessageInstance</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">error</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">generateMessageInstance</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">innerMessageApi</span><span class="p">.</span><span class="nx">error</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onClose</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">info</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">generateMessageInstance</span><span class="p">(</span><span class="nx">innerMessageApi</span><span class="p">.</span><span class="nx">info</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="nx">duration</span><span class="p">,</span> <span class="nx">onClose</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loading</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">generateMessageInstance</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">innerMessageApi</span><span class="p">.</span><span class="nx">loading</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onClose</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">generateMessageInstance</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">innerMessageApi</span><span class="p">.</span><span class="nx">success</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onClose</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">warning</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>: <span class="kt">JointContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">duration?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="nx">VoidFunction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onClose?</span>: <span class="kt">VoidFunction</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">generateMessageInstance</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">innerMessageApi</span><span class="p">.</span><span class="nx">warning</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">duration</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onClose</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">open</span>: <span class="kt">innerMessageApi.open</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">destroy</span>: <span class="kt">innerMessageApi.destroy</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">[</span><span class="nx">messageApi</span><span class="p">,</span> <span class="nx">contextHolder</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>在使用时，只需要在应用入口初始化调用一次，通过 Context 传下来即可：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">ShowMessage</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">content</span>: <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="kr">type</span><span class="o">:</span> <span class="s1">'info'</span> <span class="o">|</span> <span class="s1">'success'</span> <span class="o">|</span> <span class="s1">'warning'</span> <span class="o">|</span> <span class="s1">'error'</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">[</span><span class="nx">messageApi</span><span class="p">,</span> <span class="nx">messageContext</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useChatMessage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">showMessage</span>: <span class="kt">ShowMessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">content</span><span class="p">,</span> <span class="kr">type</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="o">?</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">messageApi</span><span class="p">[</span><span class="kr">type</span><span class="p">]({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">content</span><span class="o">:</span> <span class="p">&lt;</span><span class="nt">MessageContainer</span><span class="p">&gt;{</span><span class="nx">content</span><span class="p">.</span><span class="nx">trim</span><span class="p">()}&lt;/</span><span class="nt">MessageContainer</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">className</span><span class="o">:</span> <span class="s1">'chat-message-container'</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">MessageContext.Provider</span> <span class="na">value</span><span class="o">=</span><span class="p">{{</span> <span class="nx">showMessage</span> <span class="p">}}&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">messageContext</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">MessageContext.Provider</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>具体关闭逻辑，写在 MessageContainer 内：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">MessageType</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd/es/message/interface'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">PropsWithChildren</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">MessageContainerProps</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onClick</span><span class="o">?:</span> <span class="p">{</span> <span class="nx">current</span>: <span class="kt">MessageType</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">MessageContainer</span>: <span class="kt">React.FC</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">PropsWithChildren</span> <span class="o">&amp;</span> <span class="nx">MessageContainerProps</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">onClick</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">"text-[14px] leading-[22px] pl-[2px] flex items-center"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">"pr-[16px] select-none max-w-[30vw] truncate"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="k">typeof</span> <span class="nx">onClick</span><span class="o">?</span><span class="p">.</span><span class="nx">current</span> <span class="o">===</span> <span class="s1">'function'</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">i</span>
</span></span><span class="line"><span class="cl">          <span class="na">data-testid</span><span class="o">=</span><span class="s">"message-close-icon"</span>
</span></span><span class="line"><span class="cl">          <span class="na">className</span><span class="o">=</span><span class="s">"i-web-message-close text-[12px] cursor-pointer"</span>
</span></span><span class="line"><span class="cl">          <span class="na">data-info</span><span class="o">=</span><span class="s">"i-web-close 有 hover 时的背景，所以不能直接用"</span>
</span></span><span class="line"><span class="cl">          <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="nx">onClick</span><span class="p">.</span><span class="nx">current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">onClick</span><span class="o">?</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">then</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}}</span>
</span></span><span class="line"><span class="cl">        <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="shadowdom">ShadowDOM</h3><p>为了能在 ShadownDOM 中正确渲染 AntDesign 样式，需要根据<a class="link" href="https://ant.design/docs/react/compatible-style-cn#shadow-dom-%E5%9C%BA%E6%99%AF" target="_blank" rel="noopener">
文档
</a>设置 StyleProvider；同时为了保证弹出框（Select, Tooltip, Menu 等等）的正确渲染，需要指定全局的 getPopupContainer，否则会得到<strong>trigger element and popup element should in same shadow root</strong>的错误信息：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ConfigProvider</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">zhCN</span> <span class="kr">from</span> <span class="s1">'antd/locale/zh_CN'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">StyleProvider</span> <span class="na">container</span><span class="o">=</span><span class="p">{</span><span class="nx">shadowRoot</span> <span class="kr">as</span> <span class="nx">ShadowRoot</span><span class="p">}&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">ConfigProvider</span>
</span></span><span class="line"><span class="cl">    <span class="na">getPopupContainer</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">appRoot</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="na">theme</span><span class="o">=</span><span class="p">{{</span> <span class="nx">inherit</span>: <span class="kt">false</span> <span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="na">locale</span><span class="o">=</span><span class="p">{</span><span class="nx">zhCN</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="err">业务组件</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">ConfigProvider</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">StyleProvider</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这里的 shadowRoot 为 ShadowDOM，appRoot 为 React 挂载的节点。</p><h3 id="tailwind-css">Tailwind CSS</h3><p>项目使用了 Tailwind CSS 4，所以 AntDesign 需要做一些<a class="link" href="https://ant.design/docs/react/compatible-style-cn#%E5%85%BC%E5%AE%B9%E4%B8%89%E6%96%B9%E6%A0%B7%E5%BC%8F%E5%BA%93" target="_blank" rel="noopener">
调整
</a>；使用 StyleProvider.layer 降低 AntDesign 样式优先级：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ConfigProvider</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">StyleProvider</span> <span class="na">layer</span> <span class="na">container</span><span class="o">=</span><span class="p">{</span><span class="nx">shadowRoot</span> <span class="kr">as</span> <span class="nx">ShadowRoot</span><span class="p">}&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">StyleProvider</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>同时 Tailwind CSS 4 正式支持了 CSS Layer；所以需要修改 @layer 配置，并手动引入 AntDesign 的样式重置文件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="c">/* 优先级从左到右依次升高，theme 权重最低，utilities 权重最高 */</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">layer</span> <span class="nt">theme</span><span class="o">,</span> <span class="nt">base</span><span class="o">,</span> <span class="nt">reset</span><span class="o">,</span> <span class="nt">antd</span><span class="o">,</span> <span class="nt">antdx</span><span class="o">,</span> <span class="nt">components</span><span class="o">,</span> <span class="nt">utilities</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c">/* https://github.com/ant-design/ant-design/issues/48762 */</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">import</span> <span class="s1">'antd/dist/reset.css'</span> <span class="nt">layer</span><span class="o">(</span><span class="nt">reset</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">import</span> <span class="s1">'tailwindcss/theme.css'</span> <span class="nt">layer</span><span class="o">(</span><span class="nt">theme</span><span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">import</span> <span class="s1">'tailwindcss/utilities.css'</span> <span class="nt">layer</span><span class="o">(</span><span class="nt">utilities</span><span class="o">)</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>引入了 AntDesign/X 之后，会遇到 AntDesign 样式丢失<a class="link" href="https://github.com/ant-design/x/issues/559" target="_blank" rel="noopener">
问题
</a>，需要使用<a class="link" href="https://pnpm.io/zh/cli/patch" target="_blank" rel="noopener">
pnpm patch
</a>给 AntDesign/X 打补丁：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-patch" data-lang="patch"><span class="line"><span class="cl"><span class="gh">diff --git a/es/theme/genStyleUtils.js b/es/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gh">index 759e2977b1d512490f9ff7889d83e703e00a33ea..8a06b61ac97e7dd24f5273b41550219cda87f059 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/es/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/es/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -34,6 +34,6 @@ export const {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   },
</span></span><span class="line"><span class="cl">   layer: {
</span></span><span class="line"><span class="cl">     name: 'antdx',
</span></span><span class="line"><span class="cl"><span class="gd">-    dependencies: ['antd']
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    // dependencies: ['antd']
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   }
</span></span><span class="line"><span class="cl"> });
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/lib/theme/genStyleUtils.js b/lib/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gh">index 1bfa4ff2ff1a74f140d3c1294ea44cb01de052b6..2b0c5ffcb0a3401804ff3bd9af13f0529218774f 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/lib/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/lib/theme/genStyleUtils.js
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -40,7 +40,7 @@ const {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   },
</span></span><span class="line"><span class="cl">   layer: {
</span></span><span class="line"><span class="cl">     name: 'antdx',
</span></span><span class="line"><span class="cl"><span class="gd">-    dependencies: ['antd']
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    // dependencies: ['antd']
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   }
</span></span><span class="line"><span class="cl"> });
</span></span><span class="line"><span class="cl"> exports.genSubStyleComponent = genSubStyleComponent;
</span></span></code></pre></td></tr></tbody></table></div></div><p>修改完 patch-commit 即可，pnpm 会在 pnpm-workspace.yaml 中记录当前修改：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">patchedDependencies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">'@ant-design/x'</span><span class="p">:</span><span class="w"> </span><span class="l">patches/@ant-design__x.patch</span><span class="w">
</span></span></span></code></pre></td></tr></tbody></table></div></div><h3 id="rolldown">Rolldown</h3><p>在后续项目中，尝试了 <a class="link" href="https://github.com/vitejs/rolldown-vite" target="_blank" rel="noopener">rolldown-vite
</a>，发现 AntDesign 的语言配置<a class="link" href="https://github.com/rolldown/rolldown/issues/6655" target="_blank" rel="noopener">
失效
</a>了，需要修改 Vite 配置：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">(({</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">command</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">legacy</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inconsistentCjsInterop</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>原因是 CJS 没有<strong>默认导出</strong>的概念，当在 ESM 导入 CJS 模块时：</p><ul><li>import * as cjsModule from ‘cjs-module’ 时，cjsModule.default === module.exports；</li><li>import cjsModule from ‘cjs-module’ 时，cjsModule === module.exports；</li><li>没有<strong>命名导出</strong>，import { foo } from ‘cjs-module’ 需要工具链处理。</li></ul><p>rolldown-vite 为了统一开发与编译阶段的<a class="link" href="https://github.com/vitejs/rolldown-vite/issues/490" target="_blank" rel="noopener">
模块解析行为
</a>，对 CJS 的默认导出处理做出了<a class="link" href="https://rolldown.rs/in-depth/bundling-cjs#ambiguous-default-import-from-cjs-modules" target="_blank" rel="noopener">
调整
</a>。在 antd/locale/zh_CN 中，zhCN 是通过 module.exports 导出的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="c1">// 在项目中使用时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">zhCN</span> <span class="nx">from</span> <span class="s1">'antd/locale/zh_CN'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// node_modules/antd/locale/zh_CN.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../lib/locale/zh_CN'</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>在默认配置下，只有当 exports.__esModule 为 true 时，module.exports 才会被视为默认导出。此时 rolldown-vite 将去 module.exports.default 上查找 zhCN，但未找到；导致了语言配置<a class="link" href="https://www.doubao.com/thread/w5999ff7c72b65da5" target="_blank" rel="noopener">
不起作用
</a>。</p><p>而当 legacy.inconsistentCjsInterop 被置为 true 时，module.exports 将被视为默认导出。</p><h2 id="shadowdom-1">ShadowDOM</h2><p>JS-SDK 插件端主要分为四个控件：</p><ol><li>右下角对话框入口按钮；</li><li>划词快捷指令菜单；</li><li>对话历史面板；</li><li>对话框面板。</li></ol><p>当时，和同事讨论了两种方案：iframe 和 ShadowDOM；我们的关注点主要有两个：样式隔离、宿主通信。</p><h3 id="样式隔离">样式隔离</h3><p>在真正接触 ShadowDOM 之前，以为和 iframe 一样，可以对样式实现完全的隔离；实则不然，ShadowDOM 的样式隔离是<strong>单向</strong>的，内部样式影响不到外部；但是，外部可以通过 ShadowRoot 对内部样式实现间接控制。这种控制是通过<strong>样式继承</strong>实现的；比如 HTML 中的表单元素大部分都是 ShadowDOM，但是我们还是可以通过 CSS 改变表单元素内部的<strong>字重、字体、颜色</strong>。</p><p>iframe 的样式隔离更彻底，但是如果要在 iframe 中使用 vw/vh 单位；此时 vw/vh 是基于当前 iframe 自身宽高计算的，而非宿主环境的 viewport。所以，基于 iframe 的布局难度是高于 ShadowDOM 的。</p><p>为了解决 ShadowDOM 的样式隔离问题，需要在 ShadowDOM 中重置样式：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="p">:</span><span class="nd">host</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">all</span><span class="p">:</span> <span class="kc">initial</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">contain</span><span class="p">:</span> <span class="kc">strict</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">direction</span><span class="p">:</span> <span class="kc">ltr</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">unicode-bidi</span><span class="p">:</span> <span class="kc">normal</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">font-size</span><span class="p">:</span> <span class="mi">16</span><span class="kt">px</span> <span class="cp">!important</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ul><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Selectors/:host" target="_blank" rel="noopener">:host
</a>，用来在 ShadowDOM 内部选择 ShadowHost，相当于宿主环境的 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Selectors/:root" target="_blank" rel="noopener">:root
</a>；</li><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/all" target="_blank" rel="noopener">all:initial
</a>，用来将元素的所有属性都更改为它们的初始值（不是浏览器默认值 UserAgentStyleSheet），忽略继承值（unset 会保留继承）；</li><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/contain" target="_blank" rel="noopener">contain:strict
</a>，表示 ShadowDOM 尽可能独立于文档树的其余部分，内部的重绘不影响宿主性能：<ul><li>等同于 contain:size layout paint style，尺寸隔离、布局隔离、绘制隔离、样式隔离：<ul><li>size，元素内部内容的尺寸变化，不会影响其外部父级或兄弟元素的布局；</li><li>layout，元素内部的任何 DOM 变动，不会触发元素外部的重新布局；</li><li>paint，保证元素内部的内容不会在元素的边界框之外绘制或溢出；</li><li>style，保证某些 CSS 属性及其副作用不会传播到该元素之外。</li></ul></li></ul></li><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/direction" target="_blank" rel="noopener">direction:ltr
</a>，重置文档流方向，因为 all 属性不会重置 direction 的值，所以需要重新设置 direction；</li><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/unicode-bidi" target="_blank" rel="noopener">unicode-bidi:normal
</a>，用于控制双向文本排版规则，因为 all 属性不会重置 unicode-bidi 的值，所以需要重新设置 unicode-bidi；</li><li>font-size:16px，别忘了重置 font-size，因为 Tailwind CSS 中默认 font-size 为 16px：<ul><li>Tailwind CSS 中有不少值使用的是 rem 单位，ShadowDOM 中的 rem 还是根据 LightDOM 根元素的 font-size 进行计算：<ul><li>比如 w-12 是基于 --spacing 计算的，--spacing 在 Tailwind CSS 中的值为 0.25rem。</li></ul></li><li>为了避免 SDK 样式受宿主影响，在写 SDK 时，要使用具体单位 px，不要使用 rem。</li></ul></li></ul><p>这样设置之后，宿主就不能通过 ShadowRoot 间接改变 ShadowDOM 内部的样式了。</p><h3 id="宿主通信">宿主通信</h3><p>产品需要支持划词菜单；当用户在划词菜单中选中某条命令时，需要使用<strong>命令 + 选中内容</strong>直接发起对话；这就涉及到了 JS-SDK 和宿主环境通信，如果两者不属于用一个执行上下文，就需要跨上下文通信，那么<strong>桥</strong>这种东西就不可避免；而 ShadowDOM 恰好可以避免跨上下文通信，而 iframe 需要借助 postMessage 等 API 和宿主环境通信：</p><ul><li>同源场景：iframe.contentWindow，top.window；</li><li>跨域场景：<ul><li>iframe.postMessage，window.onmessage；</li><li>parent.postMessage，window.onmessage。</li></ul></li></ul><p>跨域通信的复杂性，是放弃 iframe 的原因之一；如果采用 iframe，还需要再单独部署一个前端项目，还是算了。</p><p>还有就是：</p><ul><li>宿主的 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Guides/CSP" target="_blank" rel="noopener">CSP
</a>是可以<a class="link" href="https://www.doubao.com/thread/w75183156658ba4ba" target="_blank" rel="noopener">
控制
</a>iframe 的资源加载的；SDK 应避免改变宿主的安全策略；</li><li>iframe 中发起的请求的 Origin 不是<strong>宿主</strong>的，这就给接口权限验证增加了难度。</li></ul><h3 id="样式加载">样式加载</h3><p>由于组件渲染在 ShadowDOM，为了使样式不被 ShadowDOM 隔离；需要将 CSS 注入到 ShadowDOM 内部，这需要用到 Vite 对<a class="link" href="https://cn.vite.dev/guide/assets#importing-asset-as-url" target="_blank" rel="noopener">
静态资源处理
</a>：</p><ul><li>./index.css?inline，经过编译，作为<strong>内联样式</strong>处理，不会生成单独的 CSS 文件；</li><li>./index.css?raw，未经编译，获取到的是 index.css 的原始文本；</li><li>./index.css?url，未经编译，获取到的是 index.css 的路径信息；</li><li>./index.css?worker，作为<strong>WebWorker</strong>处理。</li></ul><p>显然，只有第一种 ?inline 最合适，未经 Tailwind CSS 编译的原始文件没什么价值。</p><p>有了样式代码，怎么将 CSS 注入到 ShadowDOM 中呢？需要借助 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/CSSStyleSheet" target="_blank" rel="noopener">CSSStyleSheet
</a>建立一个规则列表，并调用 <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/API/CSSStyleSheet/replaceSync" target="_blank" rel="noopener">replaceSync
</a>完成对规则列表的替换更新（清空旧样式，注入新样式）。</p><p>ShadowRoot 有一个 <a class="link" href="https://developer.mozilla.org/en-US/docs/Web/API/ShadowRoot/adoptedStyleSheets" target="_blank" rel="noopener">adoptedStyleSheets
</a>属性，用来将 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/CSSStyleSheet" target="_blank" rel="noopener">CSSStyleSheet
</a>应用到 ShadowDOM 内部，比在 ShadowDOM 中追加 &lt;style/&gt; 更方便高效：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">innerStyle</span> <span class="kr">from</span> <span class="s1">'./index.css?inline'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">shadowSheet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSSStyleSheet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">replaceSync</span><span class="p">(</span><span class="nx">innerStyle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">shadowRoot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">shadowRoot</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">shadowSheet</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>目前，样式是能够正常渲染了，但发现文本颜色没有生效；原因是 Tailwind CSS 中的颜色都写在 theme.css 中：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="p">@</span><span class="k">theme</span> <span class="nt">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-50</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">97</span><span class="p">.</span><span class="nc">1</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">013</span> <span class="nt">17</span><span class="p">.</span><span class="nc">38</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-100</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">93</span><span class="p">.</span><span class="nc">6</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">032</span> <span class="nt">17</span><span class="p">.</span><span class="nc">717</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-200</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">88</span><span class="p">.</span><span class="nc">5</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">062</span> <span class="nt">18</span><span class="p">.</span><span class="nc">334</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-300</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">80</span><span class="p">.</span><span class="nc">8</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">114</span> <span class="nt">19</span><span class="p">.</span><span class="nc">571</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-400</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">70</span><span class="p">.</span><span class="nc">4</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">191</span> <span class="nt">22</span><span class="p">.</span><span class="nc">216</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-500</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">63</span><span class="p">.</span><span class="nc">7</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">237</span> <span class="nt">25</span><span class="p">.</span><span class="nc">331</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-600</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">57</span><span class="p">.</span><span class="nc">7</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">245</span> <span class="nt">27</span><span class="p">.</span><span class="nc">325</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-700</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">50</span><span class="p">.</span><span class="nc">5</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">213</span> <span class="nt">27</span><span class="p">.</span><span class="nc">518</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-800</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">44</span><span class="p">.</span><span class="nc">4</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">177</span> <span class="nt">26</span><span class="p">.</span><span class="nc">899</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-900</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">39</span><span class="p">.</span><span class="nc">6</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">141</span> <span class="nt">25</span><span class="p">.</span><span class="nc">723</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="nt">--color-red-950</span><span class="o">:</span> <span class="nt">oklch</span><span class="o">(</span><span class="nt">25</span><span class="p">.</span><span class="nc">8</span><span class="o">%</span> <span class="nt">0</span><span class="p">.</span><span class="nc">092</span> <span class="nt">26</span><span class="p">.</span><span class="nc">042</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>可以看到，颜色写在 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Guides/Cascading_variables/Using_custom_properties" target="_blank" rel="noopener">CSS 变量
</a>上；其实，这些变量已经被写入到了 ShadowDOM 中，但未生效：</p><ol><li>Tailwind CSS 默认会将变量写到 :root 选择器中，但在 ShadowDOM 中没有这个选择器，只有 :host；</li><li>Tailwind CSS 4 中，所有 CSS 变量都依赖于 <a class="link" href="https://tailwindcss.com/docs/upgrade-guide#browser-requirements" target="_blank" rel="noopener">@property
</a>，实现 CSS 过渡、类型约束；</li><li>需要<a class="link" href="https://github.com/tailwindlabs/tailwindcss/issues/15005#issuecomment-2737489813" target="_blank" rel="noopener">
将这些 CSS 变量挂载到全局
</a>：</li></ol><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">globalSheet</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CSSStyleSheet</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">rule</span> <span class="k">of</span> <span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">cssRules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span> <span class="k">instanceof</span> <span class="nx">CSSPropertyRule</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">globalSheet</span><span class="p">.</span><span class="nx">insertRule</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">cssText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nb">document</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">globalSheet</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>或者<a class="link" href="https://github.com/tailwindlabs/tailwindcss/issues/15005#issuecomment-2737489813" target="_blank" rel="noopener">
将这些 CSS 变量挂载到 :host
</a>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">properties</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">rule</span> <span class="k">of</span> <span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">cssRules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span> <span class="k">instanceof</span> <span class="nx">CSSPropertyRule</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">rule</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">rule</span><span class="p">.</span><span class="nx">initialValue</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">insertRule</span><span class="p">(</span><span class="sb">`:host { </span><span class="si">${</span><span class="nx">properties</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'; '</span><span class="p">)</span><span class="si">}</span><span class="sb"> }`</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这样，颜色就能正常渲染了；这也说明了，CSS 变量是可以穿透到 ShadowDOM 内部的。同时，最新版的 Tailwind CSS 似乎已经在解决这个问题了，<a class="link" href="https://play.tailwindcss.com" target="_blank" rel="noopener">
Tailwind Play
</a>编译后的 CSS 变量会同时存在于 :root 和 :host 中。</p><p>尝试修改 JSX 代码中的类名，发现新的样式并没有生效；起初以为是 Tailwind CSS 配置的问题，但是手动刷新页面后，样式生效了；说明新的 CSS 没能热更新到页面：</p><ul><li>import ‘./index.css’ 将被视为<strong>模块依赖</strong>；CSS 将被编译并注入到 HTML；</li><li>import innerStyle from ‘./index.css?inline’ 将被视为<strong>静态资源</strong>。</li></ul><p>此时，Vite 是知道 ./index.css?inline 有更新的，但是不知道如何<strong>应用更新</strong>，毕竟 CSS 不再是一个模块依赖了；需要借助 <a class="link" href="https://cn.vite.dev/guide/api-hmr#hot-accept-cb" target="_blank" rel="noopener">import.meta.hot.accept
</a>告知 Vite 如何应用更新：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">.</span><span class="nx">accept</span><span class="p">(</span><span class="s1">'./index.css?inline'</span><span class="p">,</span> <span class="kr">async</span> <span class="nx">newStyle</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">newStyle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">await</span> <span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">replaceSync</span><span class="p">(</span><span class="nx">newStyle</span><span class="p">.</span><span class="k">default</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shadowRoot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">shadowRoot</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span> <span class="o">=</span> <span class="p">[</span><span class="nx">shadowSheet</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">rule</span> <span class="k">of</span> <span class="nx">shadowSheet</span><span class="p">.</span><span class="nx">cssRules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">rule</span> <span class="k">instanceof</span> <span class="nx">CSSPropertyRule</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">globalSheet</span><span class="p">.</span><span class="nx">insertRule</span><span class="p">(</span><span class="nx">rule</span><span class="p">.</span><span class="nx">cssText</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">adoptedStyleSheets</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">globalSheet</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这样处理之后，样式会被正确注入到 ShadowDOM 内部，而且也能被 HMR 捕获更新：</p><p><img src="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/shadowdom.style.webp" width="992" height="625" srcset="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/shadowdom.style_hu7254084410986647191.png 480w, /p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/shadowdom.style_hu278331455580562998.png 1024w" alt="ShadowDOM" class="gallery-image" data-flex-grow="158" data-flex-basis="380px" loading="lazy" decoding="async"></p><p>最后，每个应用需要在自己的 index.css 中使用 <a class="link" href="https://tailwindcss.com/docs/detecting-classes-in-source-files#explicitly-registering-sources" target="_blank" rel="noopener">@source
</a>指定一下 shared 目录：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-css" data-lang="css"><span class="line"><span class="cl"><span class="p">@</span><span class="k">source</span> <span class="s2">"../shared/**/*.{ts,tsx}"</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">@</span><span class="k">config</span> <span class="s2">"../../tailwind.config.js"</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="创建模式">创建模式</h3><p>ShadowDOM 有两种<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ShadowRoot/mode" target="_blank" rel="noopener">
创建模式
</a>：open 和 closed；起初没怎么在意，因为两种模式下，React 组件都能被正常渲染；而且 MDN 也提到<strong>当 mode:closed 时，JS 将无法访问及修改 ShadowDOM 内部</strong>，所以理论上，mode:closed 的安全性更高，隔离的也更彻底。</p><p>后来，写到<strong>划词需求</strong>时，才发现两种模式的差别；由于我有意想在<strong>表单元素</strong>和 <strong>ShadowDOM</strong> 上禁用划词：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">isForbiddenElement</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ele</span>: <span class="kt">HTMLElement</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">innerEle</span> <span class="o">=</span> <span class="nx">ele</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="nx">innerEle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// https://developer.mozilla.org/zh-CN/docs/Learn_web_development/Extensions/Forms/Other_form_controls
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLButtonElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLInputElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLTextAreaElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLMeterElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLProgressElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLSelectElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLOptionElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLOptGroupElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">HTMLDataListElement</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="k">instanceof</span> <span class="nx">ShadowRoot</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span><span class="o">?</span><span class="p">.</span><span class="nx">shadowRoot</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">innerEle</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">innerEle</span> <span class="o">=</span> <span class="nx">innerEle</span><span class="p">.</span><span class="nx">parentElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">handlePointerUp</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span>: <span class="kt">PointerEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">HTMLElement</span> <span class="o">&amp;&amp;</span> <span class="nx">isForbiddenElement</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'pointerup'</span><span class="p">,</span> <span class="nx">handlePointerUp</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但在浏览器中调试时，发现：</p><ul><li>mode:open，可以正常判断 e.target 以及祖先元素是否是 ShadowDOM/ShadowRoot；</li><li>mode:closed，ShadowDOM 变成了一个<strong>结界</strong>，e.target 最多只能拿到 ShadowDOM 的父级。</li></ul><p>也就是说，mode:closed 的 ShadowDOM 对于 JS 来说，成为了一个<strong>黑盒</strong>；JS 没办法判断一个 DOM 节点和 ShadowDOM 的层级关系。</p><p>至于 mode:closed 真的安全性更高吗？这只不过是我的<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_components/Using_shadow_DOM#element.shadowroot_%E5%92%8C%E2%80%9Cmode%E2%80%9D%E9%80%89%E9%A1%B9" target="_blank" rel="noopener">
一厢情愿
</a>罢了；对于处于上帝视角的浏览器扩展来说，mode:closed 的 ShadowDOM 是可以被修改的。</p><h2 id="typescript">TypeScript</h2><p>开发过程中，出现了项目本地正常运行，VSCode 没有报红，tsc –noEmit 正常执行，tsc –build 编译出错的问题；经过排查，发现<a class="link" href="https://github.com/microsoft/TypeScript/issues/30128" target="_blank" rel="noopener">
编辑器对 setTimeout 的类型定义和 tsc 对 setTimeout 的类型定义不一致
</a>，最简单的解决方法是：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">timer</span>: <span class="kt">ReturnType</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">setTimeout</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="nx">timer</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{},</span> <span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>如果非要用 number 类型，需要指明 setTimeout 使用的是 global 的还是 window 的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">timer</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{},</span> <span class="mi">0</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>当然，产生这个问题的根本原因的，tsconfig.json 配置问题；Vite 初始化的项目，存在两个 tsconfig：tsconfig.app.json 和 tsconfig.node.json，两者通过 <a class="link" href="https://juejin.cn/post/7126043888573218823" target="_blank" rel="noopener">references
</a>合并至 tsconfig.json：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"files"</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"references"</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"./tsconfig.app.json"</span> <span class="c1">// 针对浏览器环境的配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"path"</span><span class="p">:</span> <span class="s2">"./tsconfig.node.json"</span> <span class="c1">// 针对 Node 环境的配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>至于 tsc –noEmit 与 tsc –build 差别：</p><ul><li>tsc –noEmit 仅执行类型检查，不编译，不支持 tsconfig.json 中的 references；</li><li>tsc –build 输出编译文件，支持 tsconfig.json 中的 references。</li></ul><h2 id="eventsource">EventSource</h2><p>起初，使用 axios 向后台发起 SSE 请求，并通过 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream/getReader" target="_blank" rel="noopener">getReader
</a>读取数据流：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">onMessageInner</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">content</span>: <span class="kt">string</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="s1">'NFC'</span><span class="p">).</span><span class="nx">trim</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'\n\n'</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n\n'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="p">[,</span> <span class="p">,</span> <span class="nx">dataStr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dataStr</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">firstIndex</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'\ndata:{'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">'}'</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">firstIndex</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">lastIndex</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 需要做一层过滤，因为 onMessageInner 是在 while 循环中调用的
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在循环过程中，可能捕获到空信息，影响 JSON 解析
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">str</span> <span class="o">=&gt;</span> <span class="o">!!</span><span class="nx">str</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setResponseList</span><span class="p">(</span><span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">str</span> <span class="o">=&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">error</span> <span class="kr">as</span> <span class="nb">Error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">reader</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">getReader</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">decoder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TextDecoder</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">fatal</span>: <span class="kt">true</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">done</span><span class="p">,</span> <span class="nx">value</span> <span class="p">}</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">read</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setIsThinking</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">await</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">done</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">decoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">value</span> <span class="kr">as</span> <span class="kt">unknown</span> <span class="kr">as</span> <span class="nx">ArrayBuffer</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stream</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onMessageInner</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这种方式，onMessageInner 接收到的数据有小概率是<strong>不完整的 JSON</strong>，导致<strong>SyntaxError: Unexpected non-whitespace character after JSON at position</strong>报错；后来不得已切换到了 <a class="link" href="https://github.com/Azure/fetch-event-source" target="_blank" rel="noopener">@microsoft/fetch-event-source
</a>；为什么说不得已呢？因为它已经脱离了项目中已经写好的拦截器了：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AgentCallResponseFormat</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">conversationId</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// 对话 ID（来自 Ack 事件）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">agentMessage</span>: <span class="kt">AgentMessage</span><span class="p">;</span> <span class="c1">// 智能体消息内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">userMessage</span>: <span class="kt">UserMessage</span><span class="p">;</span> <span class="c1">// 用户消息内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">AgentMessage</span> <span class="o">=</span> <span class="nx">ConversationHistoryItem</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">role</span><span class="o">:</span> <span class="s1">'assistant'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">from</span><span class="o">:</span> <span class="s1">'eventsource'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">isError</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">UserMessage</span> <span class="o">=</span> <span class="nx">ConversationHistoryItem</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">role</span><span class="o">:</span> <span class="s1">'user'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">from</span><span class="o">:</span> <span class="s1">'send'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">isError</span>: <span class="kt">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">ChatEventSourceSuccessCallback</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">data</span>: <span class="kt">Partial</span><span class="p">&lt;</span><span class="nt">AgentCallResponseFormat</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">ChatEventSourceErrorCallback</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span> <span class="nx">error</span>: <span class="kt">Error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">ChatEventSourceOpenCallback</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="k">this</span><span class="o">:</span> <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">data</span>: <span class="kt">AgentCallStreamRequest</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RetriableError</span> <span class="kr">extends</span> <span class="nb">Error</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">FatalError</span> <span class="kr">extends</span> <span class="nb">Error</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">useChatEventSource</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 处理流式消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">onMessage</span>: <span class="kt">ChatEventSourceSuccessCallback</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'useChatEventSource.onMessage'</span><span class="p">,</span> <span class="nx">data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 处理结束消息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">onFinish</span>: <span class="kt">ChatEventSourceSuccessCallback</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'useChatEventSource.onFinish'</span><span class="p">,</span> <span class="nx">data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onError</span>: <span class="kt">ChatEventSourceErrorCallback</span> <span class="o">=</span> <span class="nx">error</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'useChatEventSource.onError'</span><span class="p">,</span> <span class="nx">error</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onOpen</span>: <span class="kt">ChatEventSourceOpenCallback</span> <span class="o">=</span> <span class="nx">data</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'useChatEventSource.onOpen'</span><span class="p">,</span> <span class="nx">data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">withCredentials</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">onMessageRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">ChatEventSourceSuccessCallback</span><span class="p">&gt;(</span><span class="nx">onMessage</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">onFinishRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">ChatEventSourceSuccessCallback</span><span class="p">&gt;(</span><span class="nx">onFinish</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">onErrorRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">ChatEventSourceErrorCallback</span><span class="p">&gt;(</span><span class="nx">onError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">onOpenRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">ChatEventSourceOpenCallback</span><span class="p">&gt;(</span><span class="nx">onOpen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onMessageRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">onMessage</span> <span class="kr">as</span> <span class="nx">ChatEventSourceSuccessCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">onMessage</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onFinishRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">onFinish</span> <span class="kr">as</span> <span class="nx">ChatEventSourceSuccessCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">onFinish</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">onError</span> <span class="kr">as</span> <span class="nx">ChatEventSourceErrorCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">onError</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onOpenRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">onOpen</span> <span class="kr">as</span> <span class="nx">ChatEventSourceOpenCallback</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">onOpen</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">cosecRequestId</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">responseData</span><span class="p">,</span> <span class="nx">setResponseData</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Partial</span><span class="p">&lt;</span><span class="nt">AgentCallResponseFormat</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">responseList</span><span class="p">,</span> <span class="nx">setResponseList</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">AgentCallResponseItemData</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="o">&gt;</span><span class="p">([]);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span> <span class="nx">setIsProcessing</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">accessToken</span>: <span class="kt">token</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useAuthTokenStore</span><span class="p">.</span><span class="nx">getState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">getId</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useCoSecDeviceId</span><span class="p">.</span><span class="nx">getState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">abortController</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">AbortController</span><span class="p">&gt;(</span><span class="kc">undefined</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">messageStack</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">[]</span><span class="p">&gt;([]);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">onMessageInner</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">normalize</span><span class="p">(</span><span class="s1">'NFC'</span><span class="p">).</span><span class="nx">trim</span><span class="p">()))</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setResponseList</span><span class="p">(</span><span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">str</span> <span class="o">=&gt;</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'响应主体解析错误'</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 终止请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">abortController</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 发起请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">fire</span> <span class="o">=</span> <span class="nx">useCallback</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="p">(</span><span class="nx">data</span>: <span class="kt">AgentCallStreamRequest</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'请求地址不能为空'</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'请求地址不能为空'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">abortController</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbortController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">fetchEventSource</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">body</span>: <span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nx">cache</span><span class="o">:</span> <span class="s1">'no-store'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">credentials</span>: <span class="kt">withCredentials</span> <span class="o">?</span> <span class="s1">'include'</span> <span class="o">:</span> <span class="s1">'omit'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">keepalive</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">method</span><span class="o">:</span> <span class="s1">'POST'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">openWhenHidden</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">signal</span>: <span class="kt">abortController.current.signal</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Authorization</span>: <span class="kt">token</span> <span class="o">?</span> <span class="sb">`Bearer </span><span class="si">${</span><span class="nx">token</span><span class="si">}</span><span class="sb">`</span> <span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'Content-Type'</span><span class="o">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">'CoSec-Device-Id'</span><span class="o">:</span> <span class="nx">getId</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onopen</span>: <span class="kt">async</span> <span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 获取 RequestId，将展示在「错误信息」中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">cosecRequestId</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">'cosec-request-id'</span><span class="p">)</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span>
</span></span><span class="line"><span class="cl">                <span class="o">?</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="s1">'content-type'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">?</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">?</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">EventStreamContentType</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// 重置状态，否则会将之前响应的数据一并抛出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="nx">messageStack</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">              <span class="nx">setResponseData</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">              <span class="nx">setResponseList</span><span class="p">([]);</span>
</span></span><span class="line"><span class="cl">              <span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="nx">onOpenRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">&gt;=</span> <span class="mi">400</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">500</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">              <span class="nx">response</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="mi">429</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">              <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="k">new</span> <span class="nx">FatalError</span><span class="p">(</span><span class="sb">`调用出错：</span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="k">throw</span> <span class="k">new</span> <span class="nx">FatalError</span><span class="p">(</span><span class="sb">`调用出错：</span><span class="si">${</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">              <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="k">new</span> <span class="nx">RetriableError</span><span class="p">(</span><span class="s1">'未知错误'</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">              <span class="k">throw</span> <span class="k">new</span> <span class="nx">RetriableError</span><span class="p">(</span><span class="s1">'未知错误'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onmessage</span><span class="o">:</span> <span class="p">(</span><span class="nx">response</span>: <span class="kt">EventSourceMessage</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">onMessageInner</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onclose</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onerror</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">Error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// onopen｜onmessage｜onclose 中的错误都会到这里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setIsProcessing</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onErrorRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">error</span> <span class="kr">as</span> <span class="nb">Error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="nx">url</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 响应内容拼接，更新 responseData...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">},</span> <span class="p">[</span><span class="nx">responseList</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">...</span><span class="nx">responseData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">agentMessage</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span><span class="nx">responseData</span><span class="p">.</span><span class="nx">agentMessage</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">from</span><span class="o">:</span> <span class="o">!</span><span class="nx">isProcessing</span> <span class="o">?</span> <span class="s1">'history'</span> <span class="o">:</span> <span class="s1">'eventsource'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">isFinish</span><span class="o">:</span> <span class="o">!</span><span class="nx">isProcessing</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用相应的回调函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">onMessageRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">temp</span> <span class="kr">as</span> <span class="nx">AgentCallResponseFormat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isProcessing</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onFinishRef</span><span class="p">.</span><span class="nx">current</span><span class="p">(</span><span class="nx">temp</span> <span class="kr">as</span> <span class="nx">AgentCallResponseFormat</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">isProcessing</span><span class="p">,</span> <span class="nx">responseData</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">stop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fire</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">isProcessing</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这里有一个细节，我们需要获取响应头中的一个自定义 cosec-request-id 头部信息，当报错时，需要作为 requestId 展示给用户；但是在<strong>跨域</strong>的情况下，仅会暴露<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Glossary/CORS-safelisted_response_header" target="_blank" rel="noopener">
白名单
</a>内的头部信息；需要服务端添加 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Reference/Headers/Access-Control-Expose-Headers" target="_blank" rel="noopener">Access-Control-Expose-Headers
</a>响应头。</p><h2 id="markdown-渲染">Markdown 渲染</h2><p>AI 返回的消息是 md 格式，需要借助第三方渲染插件；这里使用的是 <a class="link" href="https://github.com/remarkjs/react-markdown" target="_blank" rel="noopener">react-markdown
</a>，react-markdown 使用起来很简单，但要做好渲染降级处理：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ErrorBoundary</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react-error-boundary'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">Markdown</span> <span class="kr">from</span> <span class="s1">'react-markdown'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">logError</span> <span class="o">=</span> <span class="p">(</span><span class="nx">error</span>: <span class="kt">Error</span><span class="p">,</span> <span class="nx">info</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'MdRender.ErrorBoundary.error'</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'MdRender.ErrorBoundary.info'</span><span class="p">,</span> <span class="nx">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">ErrorBoundary</span> <span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">div</span><span class="p">&gt;</span><span class="nx">Markdown</span> <span class="err">语法错误</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;}</span> <span class="na">onError</span><span class="o">=</span><span class="p">{</span><span class="nx">logError</span><span class="p">}&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">Markdown</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">ErrorBoundary</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>因为 AI 返回的数据是不可信的，用户发送的数据也是不可信的。</p><h3 id="渲染插件">渲染插件</h3><p>列举一下用到的渲染插件：</p><ul><li><a class="link" href="https://github.com/riderjensen/rehype-class-names" target="_blank" rel="noopener">rehype-class-names
</a>，用来给标签添加 className，定制样式；</li><li><a class="link" href="https://github.com/rehypejs/rehype-external-links" target="_blank" rel="noopener">rehype-external-links
</a>，用来处理 AI 返回的<strong>外链</strong>，防止不良链接导致宿主被降权；</li><li><a class="link" href="https://github.com/rehypejs/rehype-format" target="_blank" rel="noopener">rehype-format
</a>，用来处理多余的空格和缩进；</li><li><a class="link" href="https://github.com/rehypejs/rehype-highlight" target="_blank" rel="noopener">rehype-highlight
</a>，对代码块进行语法高亮处理；</li><li><a class="link" href="https://github.com/remarkjs/remark-math/tree/main/packages/rehype-katex" target="_blank" rel="noopener">rehype-katex
</a>，用于渲染 KaTeX 代码；</li><li><a class="link" href="https://github.com/rehypejs/rehype-raw" target="_blank" rel="noopener">rehype-raw
</a>，不转义 md 中的 HTML，<a class="link" href="https://github.com/remarkjs/react-markdown/issues/392#issuecomment-2641318184" target="_blank" rel="noopener">
直接渲染
</a>；</li><li><a class="link" href="https://github.com/remarkjs/remark-breaks" target="_blank" rel="noopener">remark-breaks
</a>，处理 md 中的换行；</li><li><a class="link" href="https://github.com/remarkjs/remark-gfm" target="_blank" rel="noopener">remark-gfm
</a>，用来支持表格、划线、链接、页脚、任务列表等扩展语法；</li><li><a class="link" href="https://github.com/remcohaszing/remark-mermaidjs" target="_blank" rel="noopener">remark-mermaidjs
</a>，用来渲染 Mermaid 图表；</li><li><a class="link" href="https://github.com/alvinometric/remark-remove-comments" target="_blank" rel="noopener">remark-remove-comments
</a>，移除 HTML 注释。</li></ul><h3 id="渲染样式">渲染样式</h3><p>借助 <a class="link" href="https://github.com/riderjensen/rehype-class-names" target="_blank" rel="noopener">rehype-class-names
</a>，可以对 md 样式进行自定义：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">rehypeClassNames</span> <span class="kr">from</span> <span class="s1">'rehype-class-names'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">rehypeClassNamesOptions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">h1</span><span class="o">:</span> <span class="s1">'mx-0 mb-[16px] p-0 text-[32px] text-[#262626] font-[600] leading-[42px]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">h2</span><span class="o">:</span> <span class="s1">'mx-0 mb-[16px] p-0 text-[24px] text-[#262626] font-[600] leading-[32px]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">h3</span><span class="o">:</span> <span class="s1">'mx-0 mb-[16px] p-0 text-[18px] text-[#262626] font-[600] leading-[26px]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">h4</span><span class="o">:</span> <span class="s1">'mx-0 mb-[12px] p-0 text-[16px] text-[#262626] font-[600] leading-[24px]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">h5</span><span class="o">:</span> <span class="s1">'mx-0 mb-[8px] p-0 text-[14px] text-[#262626] font-[600] leading-[22px]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">a</span>: <span class="kt">cn</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'text-[#6950FB] underline decoration-solid decoration-current decoration-auto'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'active:text-[#6950FB] hover:text-[#6950FB] visited:text-[#6950FB]'</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">Markdown</span> <span class="na">rehypePlugins</span><span class="o">=</span><span class="p">{[[</span><span class="nx">rehypeClassNames</span><span class="p">,</span> <span class="nx">rehypeClassNamesOptions</span><span class="p">]]}&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="元素替换">元素替换</h3><p>如果想要给 md 中的图片添加<strong>点击放大</strong>功能，就需要对 &lt;img/&gt; 进行替换；好在 react-markdown 内置了这个功能：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Image</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'antd'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">Markdown</span>
</span></span><span class="line"><span class="cl">  <span class="na">components</span><span class="o">=</span><span class="p">{{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">img</span>: <span class="kt">imgProps</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">alt</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">src</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">className</span> <span class="o">=</span> <span class="s1">''</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">imgProps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Image</span> <span class="na">alt</span><span class="o">=</span><span class="p">{</span><span class="nx">alt</span><span class="p">}</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">className</span><span class="p">}</span> <span class="na">src</span><span class="o">=</span><span class="p">{</span><span class="nx">src</span><span class="p">}</span> <span class="p">/&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}}</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这样，图片都被替换为了 <a class="link" href="https://ant.design/components/image" target="_blank" rel="noopener">AntDesign.Image
</a>。</p><h3 id="自定义元素">自定义元素</h3><p>有一个场景，我们和 AI 约定，某种情况下，请返回 &lt;custom-event event-type=‘order’ event-payload=“8186340”&gt;自定义元素&lt;/custom-event&gt;；用户点击之后，可以将 eventType 和 eventPayload 发送给<strong>宿主</strong>，让宿主执行后续逻辑：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChatSdkConfigEventParams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">eventType</span>: <span class="kt">string</span><span class="p">;</span> <span class="c1">// 事件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">eventPayload</span>: <span class="kt">any</span><span class="p">;</span> <span class="c1">// 事件载荷
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">Markdown</span>
</span></span><span class="line"><span class="cl">  <span class="na">components</span><span class="o">=</span><span class="p">{{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'custom-event'</span><span class="o">:</span> <span class="p">(</span><span class="nx">customEventProps</span>: <span class="kt">ChatSdkConfigEventParams</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">span</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="na">...customEventProps</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="na">className</span><span class="o">=</span><span class="s">"cursor-pointer text-[#6950FB] text-[16px] leading-[24px] underline"</span>
</span></span><span class="line"><span class="cl">        <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="kr">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onCustomEvent</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">await</span> <span class="nx">onCustomEvent</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="c1">// HTML 不区分大小写
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="nx">eventPayload</span>: <span class="kt">customEventProps</span><span class="p">[</span><span class="s1">'event-payload'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="nx">eventType</span>: <span class="kt">customEventProps</span><span class="p">[</span><span class="s1">'event-type'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}}</span>
</span></span><span class="line"><span class="cl">      <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}}</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>onCustomEvent 是从 ChatSdkConfig 中拿的；当用户点击时，宿主将通过 onCustomEvent 拿到这个<strong>自定义元素</strong>所携带的数据，从而响应用户的点击行为。</p><h3 id="mermaid-图表">Mermaid 图表</h3><p><a class="link" href="https://mermaid.js.org" target="_blank" rel="noopener">Mermaid
</a>算是 md 的扩展语法，它用文本来绘制流程图：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">graph TD
</span></span><span class="line"><span class="cl">    A[Enter Chart Definition] --&gt; B(Preview)
</span></span><span class="line"><span class="cl">    B --&gt; C{decide}
</span></span><span class="line"><span class="cl">    C --&gt; D[Keep]
</span></span><span class="line"><span class="cl">    C --&gt; E[Edit Definition]
</span></span><span class="line"><span class="cl">    E --&gt; B
</span></span><span class="line"><span class="cl">    D --&gt; F[Save Image and Code]
</span></span><span class="line"><span class="cl">    F --&gt; B
</span></span></code></pre></td></tr></tbody></table></div></div><p>要渲染 Mermaid，需要借助 <a class="link" href="https://github.com/remcohaszing/remark-mermaidjs" target="_blank" rel="noopener">remark-mermaidjs
</a>，但是不能使用 5.0 及之后的版本；因为 react-markdown 不支持<a class="link" href="https://github.com/remcohaszing/remark-mermaidjs/issues/20#issuecomment-1446610314" target="_blank" rel="noopener">
异步插件
</a>。</p><p>同时，Mermaid 的渲染需要做好降级处理；在测试过程中，发现 AI 可能会对 Mermaid 语法做出一些<strong>伟大的创新</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">remarkMermaid</span> <span class="kr">from</span> <span class="s1">'remark-mermaidjs'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">Markdown</span>
</span></span><span class="line"><span class="cl">  <span class="na">remarkPlugins</span><span class="o">=</span><span class="p">{[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="nx">remarkMermaid</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">errorFallback</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">"mermaid-error"</span><span class="p">&gt;</span><span class="err">图表渲染失败</span><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">mermaidOptions</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">lazyLoadedDiagrams</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">startOnLoad</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">wrap</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">strategy</span><span class="o">:</span> <span class="s1">'pre-mermaid'</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">]}</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h4 id="抖动问题">抖动问题</h4><p>在测试过程中，还发现 Mermaid 的渲染会有比较严重的<strong>抖动问题</strong>；因为它不是文本，当 Mermaid 语法不完整时，会直接<strong>从屏幕上消失</strong>；所以需要做额外的缓冲处理；简单来说，就是判断 ```mermaid 代码块是否闭合，闭合了再渲染：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">hasUnclosedMermaid</span><span class="p">(</span><span class="nx">content</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">closedMermaidBlocks</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/```mermaid[\s\S]*?```/gi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">allMermaidBlocks</span> <span class="o">=</span> <span class="nx">content</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/```mermaid[\s\S]*?/gi</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="nx">closedMermaidBlocks</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">allMermaidBlocks</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">useMermaidBuffer() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">content</span><span class="p">,</span> <span class="nx">setContent</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">bufferedContent</span><span class="p">,</span> <span class="nx">setBufferedContent</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">contentHasUnclosedMermaid</span> <span class="o">=</span> <span class="nx">hasUnclosedMermaid</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">contentHasUnclosedMermaid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 存在不完整的 mermaid 代码
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 不要更新 bufferedContent
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将最新的 content 更新到 bufferedContent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">setBufferedContent</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setBufferedContent</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">content</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bufferedContent</span><span class="p">,</span> <span class="c1">// 处理之后的内容
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">setContent</span> <span class="c1">// 仅给外部调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>当 Mermaid 语法不完整时，停止输出 bufferedContent：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">MdRender</span>: <span class="kt">React.FC</span><span class="p">&lt;</span><span class="nt">MdRenderProps</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">children</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">bufferedContent</span><span class="p">,</span> <span class="nx">setContent</span>: <span class="kt">updateContent</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">useMermaidBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">children</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">updateContent</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">children</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">Markdown</span><span class="p">&gt;{</span><span class="nx">bufferedContent</span><span class="p">}&lt;/</span><span class="nt">Markdown</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>后来，Vercel 给出了 <a class="link" href="https://streamdown.ai" target="_blank" rel="noopener">Streamdown
</a>，重点优化了 md 渲染的抖动问题，还内置了代码块、Mermaid 渲染。</p><h3 id="xss-问题">XSS 问题</h3><p>react-markdown 自身有有一定的<a class="link" href="https://github.com/remarkjs/react-markdown/issues/55" target="_blank" rel="noopener">
防止 XSS
</a>的能力；如果不放心，可以在渲染之前，使用 <a class="link" href="https://github.com/cure53/DOMPurify" target="_blank" rel="noopener">DOMPurify
</a>过滤一下。</p><h2 id="contextmenu-划词菜单">ContextMenu 划词菜单</h2><p><img src="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/ai.wording.menu.webp" width="1914" height="1075" srcset="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/ai.wording.menu_hu11235593950648169392.png 480w, /p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/ai.wording.menu_hu8798672632740056072.png 1024w" alt="ContextMenu" class="gallery-image" data-flex-grow="178" data-flex-basis="427px" loading="lazy" decoding="async"></p><p>当用户在宿主中选中文字时，如果在 Admin 端配置了<strong>快捷指令</strong>，需要展示一个菜单：</p><ul><li>根据<strong>快捷指令</strong>的数量，菜单的大小不是固定的，但有最大最小宽高；</li><li>当选中的文字在<strong>表单元素</strong>或 ShadowDOM 内部时，不展示菜单；</li><li>当点击菜单时，需要将<strong>选中的文字</strong>和<strong>对应的指令</strong>发送给 AI；</li><li>划词菜单可以通过设置面板，永久关闭。</li></ul><p>做好以上功能，只需要关注以下几点：</p><ul><li>菜单何时渲染：是用户选中文字之后渲染；还是渲染好定位在 viewport 之外；</li><li>如何判断什么情况下展示菜单，什么情况下隐藏菜单；</li><li>用户按下鼠标，是先发送给 AI，还是先隐藏菜单。</li></ul><p>划词菜单通过绝对定位渲染在一个 viewport 大小的 div 上，div 通过设置 pointer-events-none 忽略了所有<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Pointer_events" target="_blank" rel="noopener">
指针事件
</a>；当配置了<strong>快捷指令</strong>、菜单开关打开、用户选中内容存在时，展示菜单：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">"box-border fixed top-0 left-0 w-full h-screen p-0 m-0 overflow-hidden pointer-events-none select-none z-999"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">shortcutsForContextMenu</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">showContextMenu</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="nx">selectionContent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ContextMenu</span>
</span></span><span class="line"><span class="cl">      <span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">contextMenuEle</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="na">reset</span><span class="o">=</span><span class="p">{</span><span class="nx">reset</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="na">selectionContent</span><span class="o">=</span><span class="p">{</span><span class="nx">selectionContent</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="na">style</span><span class="o">=</span><span class="p">{</span><span class="nx">position</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)}</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="确定选区">确定选区</h3><p>如何知道用户选中的内容 selectionContent 呢？我们来封装一个 Hook：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">useSelection</span><span class="p">(</span><span class="nx">interceptor?</span>: <span class="kt">EntranceInterceptor</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">selectionRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">Selection</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">selection</span><span class="p">,</span> <span class="nx">setSelection</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">Selection</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">selectionRangeRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">Range</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">selectionRange</span><span class="p">,</span> <span class="nx">setSelectionRange</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">Range</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">selectionContentRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">selectionContent</span><span class="p">,</span> <span class="nx">setSelectionContent</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">selectionPositionRef</span> <span class="o">=</span> <span class="nx">useRef</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">DOMRect</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">selectionPosition</span><span class="p">,</span> <span class="nx">setSelectionPosition</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">&lt;</span><span class="nt">Partial</span><span class="err">&lt;</span><span class="na">DOMRect</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 选区重置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">reset</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionRangeRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionContentRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionPositionRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelection</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelectionRange</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelectionContent</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelectionPosition</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">handlePointerDown</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">selectionRef</span><span class="o">?</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">removeAllRanges</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionRef</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">removeAllRanges</span><span class="p">();</span> <span class="c1">// 清除选区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">handlePointerUp</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">e</span>: <span class="kt">PointerEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">HTMLElement</span> <span class="o">&amp;&amp;</span> <span class="nx">isFormElement</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelection</span><span class="p">(</span><span class="nx">selectionRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setSelectionRange</span><span class="p">(</span><span class="nx">selectionRangeRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">interceptor</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">isValid</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">interceptor</span><span class="p">(</span><span class="s1">'ContextMenu'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">isValid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setSelectionContent</span><span class="p">(</span><span class="nx">selectionContentRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setSelectionPosition</span><span class="p">(</span><span class="nx">selectionPositionRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setSelectionContent</span><span class="p">(</span><span class="nx">selectionContentRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setSelectionPosition</span><span class="p">(</span><span class="nx">selectionPositionRef</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">handleSelectionChange</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// input/textarea 元素中的 selection 会出现定位错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">selection</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getSelection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">selection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">selection</span><span class="p">.</span><span class="nx">rangeCount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果选区数量存在，选择第一个选区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">selectionRange</span> <span class="o">=</span> <span class="nx">selection</span><span class="o">?</span><span class="p">.</span><span class="nx">getRangeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">selectionContent</span> <span class="o">=</span> <span class="nx">selection</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">selectionPosition</span> <span class="o">=</span> <span class="nx">selectionRange</span><span class="o">?</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">selectionContent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selectionRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">selection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selectionRangeRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">selectionRange</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selectionContentRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">selectionContent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selectionPositionRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">selectionPosition</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行顺序 pointerdown -&gt; pointerup -&gt; click
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'pointerdown'</span><span class="p">,</span> <span class="nx">handlePointerDown</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'pointerup'</span><span class="p">,</span> <span class="nx">handlePointerUp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'selectionchange'</span><span class="p">,</span> <span class="nx">handleSelectionChange</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'pointerdown'</span><span class="p">,</span> <span class="nx">handlePointerDown</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'pointerup'</span><span class="p">,</span> <span class="nx">handlePointerUp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'selectionchange'</span><span class="p">,</span> <span class="nx">handleSelectionChange</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[]);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reset</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selection</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionRange</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">selectionPosition</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这个 Hook 暴露出了几个参数：</p><ul><li>reset，重置选区和内部状态；</li><li><a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection" target="_blank" rel="noopener">selection
</a>，<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getSelection" target="_blank" rel="noopener">
getSelection
</a>的返回值，表示<strong>文本选区</strong>：<ul><li>当 <a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/rangeCount" target="_blank" rel="noopener">rangeCount
</a>不为 0 时，表示<strong>选区存在</strong>。</li></ul></li><li>selectionRange，<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/getRangeAt" target="_blank" rel="noopener">
getRangeAt
</a>的返回值，表示当前选区内容的区域对象；</li><li>selectionContent，<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/toString" target="_blank" rel="noopener">
toString
</a>的返回值，表示选区内的<strong>文本内容</strong>；</li><li>selectionPosition，<a class="link" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/getBoundingClientRect" target="_blank" rel="noopener">
getBoundingClientRect
</a>的返回值；表示选区尺寸，是一个<strong>矩形边界</strong>：<ul><li>MDN 表示这是一个<strong>实验性技术</strong>，但大部分浏览器都<a class="link" href="https://caniuse.com/mdn-api_range_getboundingclientrect" target="_blank" rel="noopener">
支持
</a>了此功能。</li></ul></li></ul><p>我们只需要在<strong>鼠标按下</strong>时，重置选区；在<strong>选区变化</strong>时，更新选区；在<strong>鼠标抬起</strong>时，刷新状态；即可拿到选区的文本内容和位置信息。</p><h3 id="确定定位">确定定位</h3><p>如何确认划词菜单的位置呢？我们已经知道了选区的位置和菜单的尺寸，还知道了菜单默认出现在<strong>选区右侧</strong>，底部和<strong>选区底部齐平</strong>；当选区位置确定时，我们要分三大类：</p><ol><li>选区右侧空间足够：<ol><li>选区顶部空间足够，理想状态；</li><li>选区顶部空间不足，但是底部空间足够，；</li><li>选区顶部空间不足，并且底部空间不足，菜单不能完全展示。</li></ol></li><li>选区右侧空间不足，但是左侧空间足够：<ol><li>选区顶部空间足够；</li><li>选区顶部空间不足，但是底部空间足够；</li><li>选区顶部空间不足，并且底部空间不足，菜单不能完全展示。</li></ol></li><li>选区右侧空间不足，并且左侧空间不足，代表<strong>选区跨行</strong>：<ol><li>选区顶部空间足够；</li><li>选区顶部空间不足，但是底部空间足够；</li><li>选区顶部空间不足，并且底部空间不足，菜单不能完全展示。</li></ol></li></ol><p>为什么先判断<strong>左右</strong>而非<strong>上下</strong>呢？因为中文的书写习惯是<strong>从左到右</strong>，而非<strong>从上到下</strong>；用户可能会选择一<strong>段</strong>文字，而不会选择一<strong>列</strong>文字。</p><p>一共就这九种情况，我们将<strong>选区位置</strong>和<strong>菜单节点</strong>传入 Hook，计算最终的<strong>定位信息</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">usePosition</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selectionPosition</span>: <span class="kt">Partial</span><span class="p">&lt;</span><span class="nt">DOMRect</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">contextMenuEle</span>: <span class="kt">RefObject</span><span class="p">&lt;</span><span class="nt">HTMLElement</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">showChat</span><span class="p">,</span> <span class="nx">showContextMenu</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useSDKStore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">useShallow</span><span class="p">(</span><span class="nx">state</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="nx">state</span><span class="p">.</span><span class="nx">showChat</span><span class="p">,</span> <span class="nx">state</span><span class="p">.</span><span class="nx">showContextMenu</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">rootOffsetWidth</span><span class="p">,</span> <span class="nx">setRootOffsetWidth</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">rootOffsetHeight</span><span class="p">,</span> <span class="nx">setRootOffsetHeight</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">top</span><span class="p">,</span> <span class="nx">setTop</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">setLeft</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 确认边界
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">useLayoutEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">setRootOffset</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setRootOffsetHeight</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">showChat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 划词区域 &amp;&amp; 菜单展示区域需要避开「对话框」
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ChatContainer 的宽度是定死的 1152px
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setRootOffsetWidth</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">-</span> <span class="mi">1152</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setRootOffsetWidth</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setRootOffset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'resize'</span><span class="p">,</span> <span class="nx">setRootOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'resize'</span><span class="p">,</span> <span class="nx">setRootOffset</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="p">[</span><span class="nx">showChat</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useLayoutEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="nx">showContextMenu</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="o">!</span><span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">top</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">left</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">right</span> <span class="o">===</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setTop</span><span class="p">(</span><span class="o">-</span><span class="mi">999999999999999</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setLeft</span><span class="p">(</span><span class="o">-</span><span class="mi">999999999999999</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 左侧是否够用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isLeftSpaceEnough</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">&gt;=</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 右侧是否够用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isRightSpaceEnough</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">right</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">&lt;=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rootOffsetWidth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 顶部是否够用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isTopSpaceEnough</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">top</span> <span class="o">&gt;=</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 底部是否够用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">isBottomSpaceEnough</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">+</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">&lt;=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rootOffsetHeight</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isRightSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setLeft</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">right</span> <span class="o">+</span> <span class="mi">20</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">isTopSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'右侧空间足够，顶部空间足够，理想情况下'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isBottomSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'右侧空间足够，顶部空间不够，底部空间足够'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">'右侧空间足够，上下空间均不够；此时，容器高度小于菜单高度；菜单不能完全展示'</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isLeftSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">setLeft</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetWidth</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">isTopSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'左侧空间足够，顶部空间足够，非理想情况下'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isBottomSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'左侧空间足够，顶部空间不够，底部空间足够'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">top</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">'左侧空间足够，上下空间均不够；此时，容器高度小于菜单高度；菜单不能完全展示'</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'左右两侧空间不够，需要对是否开启对话框进行进一步判断'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">showChat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setLeft</span><span class="p">(</span><span class="nx">rootOffsetWidth</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setLeft</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">isTopSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'左右两侧空间不够，顶部空间足够；此时，用户选择了整行'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">isBottomSpaceEnough</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'左右两侧空间不够，底部空间足够；此时，用户选择了整行'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="s1">'左右两侧空间不够，上下空间均不够；此时，用户选择了页面的所有内容'</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTop</span><span class="p">(</span><span class="nx">selectionPosition</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">contextMenuEle</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">top</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">left</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="文本发送">文本发送</h3><p>选中网页上的一段文字，如果鼠标点击了页面的任何一个地方，选区会消失；我们知道，指针事件的触发顺序是 pointerdown -&gt; pointerup -&gt; click；在 useSelection 中，每次 pointerdown 之后，重置了选区（这也是浏览器的默认行为，所有事件冒泡结束之后，有一个特殊的<strong>默认行为阶段</strong>）；所以，需要在选区消失之前，将选区内容发送出去；也就是说我们只能通过 ContextMenu 内部的 pointerdown 发送内容，click 有点太迟了：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">handlePointerDown</span> <span class="o">=</span> <span class="p">(</span><span class="nx">item</span>: <span class="kt">ShortcutCommandOptionsTemplate</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">showChat</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dispatchShowChatToggle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果不使用异步，快捷指令面板的点击行为会让 ChatInput 失焦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dispatchCurrentContextMenuShortcutsUpdate</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">content</span><span class="o">:</span> <span class="sb">`[</span><span class="si">${</span><span class="nx">item</span><span class="p">.</span><span class="nx">command</span><span class="si">}</span><span class="sb">]:</span><span class="si">${</span><span class="nx">selectionContent</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="s1">'Send'</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reset</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span><span class="nx">shortcutsForContextMenu</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">item</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">      <span class="na">key</span><span class="o">=</span><span class="p">{</span><span class="nx">index</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">cn</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'w-[calc(100%-4px)] text-[12px] leading-[20px] px-[7px] py-[3px] bg-transparent rounded-[6px] cursor-pointer flex justify-start items-start mx-auto'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'hover:bg-[#F5F3FF]'</span>
</span></span><span class="line"><span class="cl">      <span class="p">)}</span>
</span></span><span class="line"><span class="cl">      <span class="na">onPointerDown</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">handlePointerDown</span><span class="p">(</span><span class="nx">item</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">i</span> <span class="na">className</span><span class="o">=</span><span class="s">"i-web-menu-button text-[10px] mr-[6px] leading-[20px] h-[20px] grow-0 shrink-0"</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">className</span><span class="o">=</span><span class="s">"inline-block whitespace-nowrap pr-[5px]"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">))}</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/&gt;;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="entrancebutton-入口按钮">EntranceButton 入口按钮</h2><p>这里借用 EntranceButton 简单说一下 <a class="link" href="https://github.com/react-grid-layout/react-draggable" target="_blank" rel="noopener">react-draggable
</a>，入口按钮需要支持：</p><ol><li>窗口 resize 时，能保持在视口内，并记忆最后位置；</li><li>用户拖拽时，能保持在视口内，并记忆最后位置。</li></ol><p>组件结构很简单：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">Draggable</span>
</span></span><span class="line"><span class="cl">  <span class="na">allowAnyClick</span>
</span></span><span class="line"><span class="cl">  <span class="na">enableUserSelectHack</span>
</span></span><span class="line"><span class="cl">  <span class="na">position</span><span class="o">=</span><span class="p">{</span><span class="nx">entranceButtonPosition</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="na">nodeRef</span><span class="o">=</span><span class="p">{</span><span class="nx">entranceButtonRef</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="na">onStart</span><span class="o">=</span><span class="p">{</span><span class="nx">handleDraggable</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="na">onDrag</span><span class="o">=</span><span class="p">{</span><span class="nx">handleDraggable</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="na">onStop</span><span class="o">=</span><span class="p">{</span><span class="nx">handleDraggable</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">    <span class="na">ref</span><span class="o">=</span><span class="p">{</span><span class="nx">entranceButtonRef</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="na">data-testid</span><span class="o">=</span><span class="s">"entrance-button"</span>
</span></span><span class="line"><span class="cl">    <span class="na">className</span><span class="o">=</span><span class="s">"fixed bottom-[20px] right-0 pointer-events-auto cursor-pointer"</span>
</span></span><span class="line"><span class="cl">  <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="err">入口按钮</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">Draggable</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>可以看到，按钮默认的位置为 bottom-20px right-0；要实现上述功能，需要注意：</p><ol><li>react-draggable 的位置计算是基于<strong>原始位置 bottom-20px right-0</strong> 的；</li><li>向上拖动，<strong>上下位置 y</strong> 会减小；向下拖动，<strong>上下位置 y</strong> 会增大；</li><li>默认位置 bottom-20px，所以 y 增大到 <strong>20</strong> 时，表示<strong>触底</strong>；</li><li>y 减小到 <strong>-(innerHeight - 20 - clientHeight)</strong> 到表示<strong>触顶</strong>。</li></ol><p>那只需要在 resize 时，如果<strong>触底或触顶</strong>，动态调整按钮位置即可：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">handleResize</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">limitY</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">entranceButtonRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">entranceButtonPositionRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">y</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">entranceButtonPositionRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">y</span> <span class="o">!==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dispatchEntranceButtonPositionUpdate</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">y</span>:
</span></span><span class="line"><span class="cl">          <span class="kt">entranceButtonPositionRef.current.y</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="c1">// 触底
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">?</span> <span class="nx">20</span>
</span></span><span class="line"><span class="cl">            : <span class="kt">entranceButtonPositionRef.current.y</span> <span class="o">&lt;=</span> <span class="nx">limitY</span> <span class="c1">// 触顶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">?</span> <span class="nx">limitY</span>
</span></span><span class="line"><span class="cl">            : <span class="kt">entranceButtonPositionRef.current.y</span> <span class="c1">// 保持不变
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'resize'</span><span class="p">,</span> <span class="nx">handleResize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="s1">'resize'</span><span class="p">,</span> <span class="nx">handleResize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="p">[]);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>同理，在用户<strong>结束拖拽</strong>时，也做一次判断即可：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">handleDraggable</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_</span>: <span class="kt">any</span><span class="p">,</span> <span class="nx">data</span>: <span class="kt">DraggableData</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">limitY</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">entranceButtonRef</span><span class="p">.</span><span class="nx">current</span><span class="o">?</span><span class="p">.</span><span class="nx">clientHeight</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="nb">window</span><span class="p">.</span><span class="nx">innerHeight</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dispatchEntranceButtonPositionUpdate</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span>: <span class="kt">data.y</span> <span class="o">&gt;=</span> <span class="mi">20</span> <span class="o">?</span> <span class="nx">20</span> : <span class="kt">data.y</span> <span class="o">&lt;=</span> <span class="nx">limitY</span> <span class="o">?</span> <span class="nx">limitY</span> : <span class="kt">data.y</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="参考">参考</h2><ul><li><a class="link" href="https://github.com/ant-design/x/issues/559" target="_blank" rel="noopener">AntD 样式兼容 Tailwind 情况下，引入 AntDX 会导致 AntD 组件样式失效</a></li><li><a class="link" href="https://github.com/remcohaszing/remark-mermaidjs/issues/20" target="_blank" rel="noopener">MermaidJS with the react-markdown Issue with Remix ESM</a></li><li><a class="link" href="https://juejin.cn/post/7126043888573218823" target="_blank" rel="noopener">探究 tsconfig.node.json 文件和 references 字段的作用</a></li><li><a class="link" href="https://github.com/microsoft/TypeScript/issues/30128" target="_blank" rel="noopener">Type ‘number’ Is not Assignable to Type ‘Timeout’</a></li><li><a class="link" href="https://github.com/tailwindlabs/tailwindcss/issues/15005" target="_blank" rel="noopener">@property Isn’t Supported in ShadowRoots</a></li><li><a class="link" href="https://github.com/vitejs/rolldown-vite/issues/490" target="_blank" rel="noopener">CJS Default Export Is Handled Incorrectly</a></li><li><a class="link" href="https://gemini.google.com/share/925d466d14fd" target="_blank" rel="noopener">ShadowDOM 事件重定向与模式</a></li><li><a class="link" href="https://github.com/rolldown/rolldown/issues/6655" target="_blank" rel="noopener">Antd Translation not Working</a></li><li><a class="link" href="https://www.doubao.com/thread/w5999ff7c72b65da5" target="_blank" rel="noopener">Rolldown 处理 CJS 模块</a></li><li><a class="link" href="https://www.doubao.com/thread/w077ab238b1f5efba" target="_blank" rel="noopener">React 的事件处理机制</a></li><li><a class="link" href="https://github.com/remarkjs/react-markdown/issues/392" target="_blank" rel="noopener">&lt;br&gt; in Table</a></li></ul></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">AI JS-SDK 项目总结（一）</h2></div></a></article><article class="has-image"><a href="/p/%E8%BD%AC%E6%88%91%E5%9C%A8%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E4%B8%AD%E5%8F%AF%E4%BB%A5%E9%9A%8F%E4%BE%BF%E5%86%99%E6%9C%80%E9%80%9A%E4%BF%97%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8E%9F%E7%90%86/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">「转」我在函数组件中可以随便写，最通俗异步组件原理</h2></div></a></article><article class="has-image"><a href="/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%8B/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">React 复习笔记（下）</h2></div></a></article><article class="has-image"><a href="/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%AD/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">React 复习笔记（中）</h2></div></a></article><article class="has-image"><a href="/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%8A/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">React 复习笔记（上）</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2025
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="关闭"></button>
<button class="pswp__button pswp__button--fs" title="全屏"></button>
<button class="pswp__button pswp__button--zoom" title="缩放"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="上一张"></button>
<button class="pswp__button pswp__button--arrow--right" title="下一张"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#antdesign">AntDesign</a><ol><li><a href="#popover-与-tooltip">Popover 与 Tooltip</a></li><li><a href="#usemessage">useMessage</a></li><li><a href="#shadowdom">ShadowDOM</a></li><li><a href="#tailwind-css">Tailwind CSS</a></li><li><a href="#rolldown">Rolldown</a></li></ol></li><li><a href="#shadowdom-1">ShadowDOM</a><ol><li><a href="#样式隔离">样式隔离</a></li><li><a href="#宿主通信">宿主通信</a></li><li><a href="#样式加载">样式加载</a></li><li><a href="#创建模式">创建模式</a></li></ol></li><li><a href="#typescript">TypeScript</a></li><li><a href="#eventsource">EventSource</a></li><li><a href="#markdown-渲染">Markdown 渲染</a><ol><li><a href="#渲染插件">渲染插件</a></li><li><a href="#渲染样式">渲染样式</a></li><li><a href="#元素替换">元素替换</a></li><li><a href="#自定义元素">自定义元素</a></li><li><a href="#mermaid-图表">Mermaid 图表</a><ol><li><a href="#抖动问题">抖动问题</a></li></ol></li><li><a href="#xss-问题">XSS 问题</a></li></ol></li><li><a href="#contextmenu-划词菜单">ContextMenu 划词菜单</a><ol><li><a href="#确定选区">确定选区</a></li><li><a href="#确定定位">确定定位</a></li><li><a href="#文本发送">文本发送</a></li></ol></li><li><a href="#entrancebutton-入口按钮">EntranceButton 入口按钮</a></li><li><a href="#参考">参考</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" crossorigin="anonymous"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>