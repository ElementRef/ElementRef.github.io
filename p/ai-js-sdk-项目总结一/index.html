<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="劳动节之前，公司决定把 AI 融入到内部项目（WMS|ERP|CRM|…）当中；同时，为了能兼顾商业化场景，最好能避免对现有项目做任何业务流程上的修改；最后确定，AI 通过 JS-SDK 插件融入到现有系统；此外，需要一个 Web 端作为独立的 C 端入口，一个 Admin 管理端用来配置 AI（模型、插件、提示词、知识库、智能体预览…）。劳动节回来，我被分到了三块儿任务：
"><title>AI JS-SDK 项目总结（一） · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/"><link rel="stylesheet" href="/scss/style.min.49a542c0449d2ab7de17e0bb72f035d22a011f1361d304a0ff6dc68951166f07.css"><meta property="og:title" content="AI JS-SDK 项目总结（一）"><meta property="og:description" content="劳动节之前，公司决定把 AI 融入到内部项目（WMS|ERP|CRM|…）当中；同时，为了能兼顾商业化场景，最好能避免对现有项目做任何业务流程上的修改；最后确定，AI 通过 JS-SDK 插件融入到现有系统；此外，需要一个 Web 端作为独立的 C 端入口，一个 Admin 管理端用来配置 AI（模型、插件、提示词、知识库、智能体预览…）。劳动节回来，我被分到了三块儿任务：
"><meta property="og:url" content="https://ElementRef.github.io/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2025-07-31T00:00:00+00:00"><meta property="article:modified_time" content="2025-07-31T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/react.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="AI JS-SDK 项目总结（一）"><meta name="twitter:description" content="劳动节之前，公司决定把 AI 融入到内部项目（WMS|ERP|CRM|…）当中；同时，为了能兼顾商业化场景，最好能避免对现有项目做任何业务流程上的修改；最后确定，AI 通过 JS-SDK 插件融入到现有系统；此外，需要一个 Web 端作为独立的 C 端入口，一个 Admin 管理端用来配置 AI（模型、插件、提示词、知识库、智能体预览…）。劳动节回来，我被分到了三块儿任务：
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/react.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta name="robots" content="noarchive, noindex, nofollow"><meta name="theme-color" content="#ffffff"><script defer="" src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2"></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="flex container extended main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu15751654176150258532.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://douban.com/people/nicknoonan" target="_blank" title="DouBan"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-douban"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h16"></path><path d="M5 4h14"></path><path d="M8 8h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-2a2 2 0 012-2z"></path><path d="M16 14l-2 6"></path><path d="M8 17l1 3"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/"><img src="/img/cover/react.webp" alt="AI JS-SDK 项目总结（一）" fetchpriority="high" decoding="async" width="1200" height="720" jampack-sized="true"></a></div><div class="article-details"><header class="article-category"><a href="/categories/react/">React</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/">AI JS-SDK 项目总结（一）</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Jul 31, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：16 分钟</time></div></footer></div></header><section class="article-content"><p>劳动节之前，公司决定把 AI 融入到内部项目（WMS|ERP|CRM|…）当中；同时，为了能兼顾商业化场景，最好能避免对现有项目做任何业务流程上的修改；最后确定，AI 通过 JS-SDK 插件融入到现有系统；此外，需要一个 Web 端作为独立的 C 端入口，一个 Admin 管理端用来配置 AI（模型、插件、提示词、知识库、智能体预览…）。劳动节回来，我被分到了三块儿任务：</p><ul><li>整体项目搭建；</li><li>Web 端 &amp; JS-SDK 插件端（仅交互差别）；</li><li>Admin 管理端中的智能体调试以及提示词对比。</li></ul><p><img src="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.web.webp" width="1915" height="1075" srcset="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.web_hu9900128593854838171.png 480w, /p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.web_hu2887561524651910195.png 1024w" class="gallery-image" data-flex-grow="178" data-flex-basis="427px" alt="" fetchpriority="high" decoding="async">
<img src="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.sdk.webp" width="1915" height="1074" srcset="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.sdk_hu16446031288834576891.png 480w, /p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.sdk_hu12074412435234648201.png 1024w" class="gallery-image" data-flex-grow="178" data-flex-basis="427px" alt="" fetchpriority="high" decoding="async">
<img src="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.admin.webp" width="1916" height="1075" srcset="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.admin_hu12181920454560598798.png 480w, /p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%B8%80/ai.admin_hu6346343709861102356.png 1024w" class="gallery-image" data-flex-grow="178" data-flex-basis="427px" alt="" fetchpriority="high" decoding="async"></p><p>这三个任务都指向了一个功能模块 - AI 对话框；这篇文章就对开发过程做一下简单的记录。</p><h2 id="项目搭建">项目搭建</h2><p>为了最大化的组件复用，提高开发效率，决定基于 <a class="link" href="https://pnpm.io/zh/workspaces" target="_blank" rel="noopener">pnpm workspace
</a>、<a class="link" href="https://turborepo.com/docs" target="_blank" rel="noopener">
Turborepo
</a>、<a class="link" href="https://cn.vite.dev/guide/" target="_blank" rel="noopener">
Vite
</a>搭建一个 monorepo 项目。</p><h3 id="目录结构">目录结构</h3><ul><li>主应用 Admin 和 Web 放在 apps 目录下，每个应用都是完整的 Vite 项目；</li><li>JS-SDK、shared 公共代码和 types 类型共享等子包，放在 packages 目录下；</li><li>SVG 图标文件放在根目录的 icons 文件夹下，根据「应用名称｜子包名称｜是否保留颜色」进行分类；</li><li>env 文件、Lint 配置、Deploy 配置、Turborepo 配置、workspace 配置、TailwindCSS 配置等，均放在根目录下；</li><li>Admin、Web、JS-SDK、Shared 都有自己独立的 tsconfig.json，根目录 tsconfig.json 仅匹配根目录的 *.config.ts|js。</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">apps</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">admin</span>                     <span class="err">主应用一</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">web</span>                       <span class="err">主应用二</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">deploy</span>                        <span class="err">部署配置</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">deployment</span><span class="o">.</span><span class="n">yml</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">icons</span>                         <span class="n">SVG</span> <span class="err">图标文件</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">colorless</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">upload</span><span class="o">.</span><span class="n">svg</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">color</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">└──</span> <span class="n">word</span><span class="o">.</span><span class="n">svg</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">packages</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">js</span><span class="o">-</span><span class="n">sdk</span>                    <span class="n">SDK</span> <span class="err">插件端</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vite</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">├──</span> <span class="n">shared</span>                    <span class="err">公共</span> <span class="n">apis</span><span class="err">、</span><span class="n">hooks</span><span class="err">、</span><span class="n">components</span><span class="err">、</span><span class="n">style</span> <span class="err">等</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">apis</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">chat</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">chat</span><span class="o">.</span><span class="n">oss</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">chat</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vars</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">assets</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">user</span><span class="o">-</span><span class="n">avatar</span><span class="o">.</span><span class="n">png</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">components</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">enums</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">upload</span><span class="o">.</span><span class="n">enums</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">hooks</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">use</span><span class="o">-</span><span class="n">selection</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">http</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">interceptors</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>       <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>       <span class="err">└──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">package</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">tsup</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">vitest</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">stores</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">store</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">constant</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">styles</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">chat</span><span class="o">.</span><span class="n">css</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">highlight</span><span class="o">.</span><span class="n">css</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">├──</span> <span class="n">types</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">utils</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>       <span class="err">├──</span> <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>       <span class="err">├──</span> <span class="n">cn</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">│</span>       <span class="err">└──</span> <span class="n">index</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="n">types</span>                     <span class="err">公共类型</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">├──</span> <span class="n">package</span><span class="o">.</span><span class="n">json</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">├──</span> <span class="n">global</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">├──</span> <span class="n">react</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>       <span class="err">└──</span> <span class="n">vite</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">ts</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">patches</span>                       <span class="err">@</span><span class="n">ant</span><span class="o">-</span><span class="n">design</span><span class="o">/</span><span class="n">x</span> <span class="err">补丁</span>
</span></span><span class="line"><span class="cl"><span class="err">│</span>   <span class="err">└──</span> <span class="err">@</span><span class="n">ant</span><span class="o">-</span><span class="n">design__x</span><span class="o">.</span><span class="n">patch</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">env</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">gitignore</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">npmrc</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="o">.</span><span class="n">nvmrc</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">Dockerfile</span>                    <span class="err">部署配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">nginx</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">conf</span>             <span class="err">部署配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">commitlint</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>          <span class="n">commitlint</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">eslint</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>              <span class="n">ESLint</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">stylelint</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>           <span class="n">Stylelint</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">tailwind</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">js</span>            <span class="n">TailwindCSS</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">pnpm</span><span class="o">-</span><span class="n">lock</span><span class="o">.</span><span class="n">yaml</span>                <span class="err">依赖锁</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">pnpm</span><span class="o">-</span><span class="n">workspace</span><span class="o">.</span><span class="n">yaml</span>           <span class="n">workspace</span> <span class="err">配置：</span><span class="n">packages</span><span class="err">、</span><span class="n">patchedDependencies</span><span class="err">、</span><span class="n">catalog</span> <span class="err">等</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">package</span><span class="o">.</span><span class="n">json</span>                  <span class="n">npm</span><span class="o">-</span><span class="n">script</span><span class="err">、</span><span class="n">git</span><span class="o">-</span><span class="n">hooks</span><span class="err">、</span><span class="n">lint</span><span class="o">-</span><span class="n">staged</span><span class="err">、</span><span class="n">engines</span><span class="err">、</span><span class="n">cli</span><span class="o">-</span><span class="n">dependencies</span> <span class="err">等</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">tsconfig</span><span class="o">.</span><span class="n">json</span>                 <span class="n">TypeScript</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">├──</span> <span class="n">turbo</span><span class="o">.</span><span class="n">json</span>                    <span class="n">Turborepo</span> <span class="err">配置</span>
</span></span><span class="line"><span class="cl"><span class="err">└──</span> <span class="n">README</span><span class="o">.</span><span class="n">md</span>                     <span class="err">说明文件</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="pnpm-workspace">pnpm workspace</h3><p>在之前的项目经历中，使用过 Lerna + yarn workspace 的搭配，但也仅限于使用，好像不久之后，Lerna 停更了；这次使用 pnpm workspace 管理项目：</p><ul><li>pnpx codemod pnpm/catalog 可以将依赖统一到 pnpm-workspace.yaml 中进行管理，不用担心 package 依赖版本混乱；</li><li>pnpm 支持依赖共享，所有依赖都在根目录的 node_modules/.pnpm 中，子包的依赖通过<strong>软连接</strong>指向根目录；</li><li>支持 workspace 协议，package 只需要做好<a class="link" href="https://dev.to/bnb/conditional-exports-supporting-both-import-and-require-3ihg" target="_blank" rel="noopener">
<strong>条件导出</strong>
</a>，别的 package 就能直接引用到当前最新的代码；</li><li>支持 publishConfig，可以在发布时自动修改 package 的导出配置，方便将 package 发布到私有 npm；</li><li>通过 --filter、--recursive、--workspace-root，很方便对 package 进行管理；</li><li>仅暴露 package.json 中声明的依赖，杜绝幽灵依赖问题。</li></ul><p>pnpm-workspace.yaml 包含了：</p><ul><li>子包所在的目录；</li><li>对哪些依赖打了补丁；</li><li>pnpm 包管理的一些配置；</li><li>在安装期间，禁用的一些依赖的安装脚本；</li><li>统一各个子包的依赖版本，搭配<a class="link" href="https://marketplace.visualstudio.com/items?itemName=antfu.pnpm-catalog-lens" target="_blank" rel="noopener">
PNPM Catalog Lens
</a>使用；</li><li><a class="link" href="https://www.pnpm.cn/next/catalogs" target="_blank" rel="noopener">Catalog
</a>的特点官网写的很清楚：<ul><li>减少 package.json 文件的合并冲突；</li><li>保持各个子包的共同的依赖项版本一致；</li><li>升级或者更新依赖项版本时，只需更改一处；</li><li>pnpm update/pnpm up 命令不支持修改 Catalog；</li><li>每次有新加的依赖时，只需执行 pnpx codemod pnpm/catalog 就能同步到 Catalog；</li><li>pnpx codemod pnpm/catalog 还不支持<strong>对等依赖</strong>的同步；</li><li>不方便搭配 <a class="link" href="https://github.com/raineorshine/npm-check-updates" target="_blank" rel="noopener">npm-check-updates
</a>使用。</li></ul></li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">packages</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">apps/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">packages/*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">patchedDependencies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">'@ant-design/x'</span><span class="p">:</span><span class="w"> </span><span class="l">patches/@ant-design__x.patch</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packageManagerStrict</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">packageManagerStrictVersion</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">managePackageManagerVersions</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">ignoredBuiltDependencies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">esbuild</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">simple-git-hooks</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">unrs-resolver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">catalog</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">react</span><span class="p">:</span><span class="w"> </span><span class="l">^18.0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">react-dom</span><span class="p">:</span><span class="w"> </span><span class="l">^18.0.0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="l">...</span><span class="w">
</span></span></span></code></pre></td></tr></tbody></table></div></div><h3 id="commitlintconfigjs">commitlint.config.js</h3><p>pnpm 还不支持直接获取子包名称，这样我们就没办法对 commit-message 中的 scope 字段进行验证；可以通过这个 <a class="link" href="https://github.com/orgs/pnpm/discussions/4150" target="_blank" rel="noopener">issue
</a>中的命令，曲线救国：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">exec</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'node:child_process'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">promisify</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'node:util'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">execAsync</span> <span class="o">=</span> <span class="nx">promisify</span><span class="p">(</span><span class="nx">exec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">extends</span><span class="o">:</span> <span class="p">[</span><span class="s1">'@commitlint/config-conventional'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'body-min-length'</span><span class="o">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'always'</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'subject-case'</span><span class="o">:</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'never'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'scope-enum'</span><span class="o">:</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">stdout</span> <span class="p">}</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">execAsync</span><span class="p">(</span><span class="s1">'pnpm list --recursive --depth -1'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">pkgs</span> <span class="o">=</span> <span class="nx">stdout</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'\n'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">line</span> <span class="p">=&gt;</span> <span class="nx">line</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'@'</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">line</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">' '</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'@example/'</span><span class="p">,</span> <span class="s1">''</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">'@'</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'always'</span><span class="p">,</span> <span class="p">[...</span><span class="nx">pkgs</span><span class="p">,</span> <span class="s1">'root'</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>此时，commitlint 将 scope 限制为 admin、web、js-sdk、shared、types、root。</p><h3 id="eslintconfigjs">eslint.config.js</h3><p>ESLint 规则使用的是 <a class="link" href="https://eslint-config.antfu.me/" target="_blank" rel="noopener">@antfu/eslint-config
</a>，规则非常全面；我做了一些规则修改：</p><ul><li>使用 <a class="link" href="https://github.com/JoshuaKGoldberg/eslint-plugin-package-json" target="_blank" rel="noopener">eslint-plugin-package-json
</a>搭配 <a class="link" href="https://github.com/keithamus/sort-package-json" target="_blank" rel="noopener">sort-package-json
</a>对 package.json 做格式化，同时关闭 <a class="link" href="https://ota-meshi.github.io/eslint-plugin-jsonc/rules/sort-keys.html" target="_blank" rel="noopener">jsonc/sort-keys
</a>规则，或者直接使用 <a class="link" href="https://github.com/camacho/format-package" target="_blank" rel="noopener"><strong>format-package</strong>
</a>；否则，会破坏<strong>条件导出</strong>的字段规则（types -&gt; import -&gt; require）；</li><li>排除了 CI/CD 配置文件、lock 文件、Turborepo 缓存目录、pnpm patch 目录、coverage 测试覆盖率目录、zip|rar 文件；</li><li>对配置文件单独配置了 <a class="link" href="https://github.com/eslint-community/eslint-plugin-n/blob/master/docs/rules/prefer-global/console.md" target="_blank" rel="noopener">n/prefer-global/console
</a>、<a class="link" href="https://github.com/eslint-community/eslint-plugin-n/blob/master/docs/rules/prefer-global/process.md" target="_blank" rel="noopener">
n/prefer-global/process
</a>和 <a class="link" href="https://github.com/mysticatea/eslint-plugin-node/blob/master/docs/rules/prefer-global/process.md" target="_blank" rel="noopener">node/prefer-global/process
</a>规则；</li><li>关闭一些调试限制 <a class="link" href="https://zh-hans.eslint.org/docs/latest/rules/no-console" target="_blank" rel="noopener">no-console
</a>、<a class="link" href="https://zh-hans.eslint.org/docs/latest/rules/no-debugger" target="_blank" rel="noopener">
no-debugger
</a>、<a class="link" href="https://zh-hans.eslint.org/docs/latest/rules/no-new" target="_blank" rel="noopener">
no-new
</a>，Vite 通过配置，会在编译时去除 debugger 和 console。</li></ul><p>这些并非完整配置，仅涉及到了比较重要的<strong>修改点</strong>；</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">antfu</span> <span class="kr">from</span> <span class="s1">'@antfu/eslint-config'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">packageJson</span> <span class="kr">from</span> <span class="s1">'eslint-plugin-package-json'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">antfu</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 忽略目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ignores</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 流水线部署相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'./nginx-config.conf'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'./Dockerfile'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'./deploy/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// lock/workspace 文件由包管理工具管理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'**/pnpm-workspace.yaml'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/package-lock.json'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/pnpm-lock.yaml'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/yarn.lock'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.angular/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.idea/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.pnpm/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.svelte/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.turbo/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/.vscode/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/node_modules/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/coverage/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/dist-ssr/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/patches/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/public/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/static/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/build/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/dist/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/temp/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/tmp/**'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/*.rar'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'**/*.zip'</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://zh-hans.eslint.org/docs/latest/rules/no-console
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'no-console'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://zh-hans.eslint.org/docs/latest/rules/no-debugger
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'no-debugger'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://zh-hans.eslint.org/docs/latest/rules/no-new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'no-new'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://ota-meshi.github.io/eslint-plugin-jsonc/rules/sort-keys.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'jsonc/sort-keys'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://github.com/antfu/eslint-plugin-antfu/blob/main/src/rules/consistent-list-newline.md
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'object-curly-newline'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://github.com/mysticatea/eslint-plugin-node/blob/master/docs/rules/prefer-global/process.md
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'node/prefer-global/process'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'always'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://typescript-eslint.io/rules/ban-ts-comment
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'ts/ban-ts-comment'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// https://github.com/antfu/eslint-config/issues/582
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="s1">'style/max-len'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">files</span><span class="o">:</span> <span class="p">[</span><span class="s1">'**/*.config.js'</span><span class="p">,</span> <span class="s1">'**/*.config.ts'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// https://github.com/eslint-community/eslint-plugin-n/blob/master/docs/rules/prefer-global
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'n/prefer-global/console'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'always'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'n/prefer-global/process'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'error'</span><span class="p">,</span> <span class="s1">'always'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">files</span><span class="o">:</span> <span class="p">[</span><span class="s1">'**/*.d.ts'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'style/curly-newline'</span><span class="o">:</span> <span class="p">[</span><span class="s1">'off'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">files</span><span class="o">:</span> <span class="p">[</span><span class="s1">'**/package.json'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">plugins</span><span class="o">:</span> <span class="p">{</span> <span class="s1">'package-json'</span><span class="o">:</span> <span class="nx">packageJson</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'package-json/order-properties'</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'error'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">order</span><span class="o">:</span> <span class="s1">'sort-package-json'</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>在后续的新项目中尝试了 Biome，决定以后<strong>弃用 ESLint</strong>；ESLint 太慢了，而且很容易损坏大文件。</p><h3 id="stylelintconfigjs">stylelint.config.js</h3><p>Stylelint 需要使用 <a class="link" href="https://github.com/43081j/postcss-lit" target="_blank" rel="noopener">postcss-lit
</a>才能完成对 js(x)、ts(x) 的正确解析；需要使用 <a class="link" href="https://github.com/zhilidali/stylelint-config-tailwindcss" target="_blank" rel="noopener">stylelint-config-tailwindcss
</a>完成对 TailwindCSS 的支持。</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/** @type {import('stylelint').Config} */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">extends</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s1">'stylelint-config-tailwindcss'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'stylelint-config-recess-order'</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">overrides</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">files</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.cjs'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.cts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.mjs'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.mts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.js'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.jsx'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'**/*.tsx'</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">customSyntax</span><span class="o">:</span> <span class="s1">'postcss-lit'</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Stylelint 比较<strong>疯癫</strong>的一点是，他竟然会对<strong>二进制文件</strong>进行校验；最好在 ignoreFiles 中排出项目中的二进制文件。</p><img style="display:block;margin:0 auto;width:100%" src="stylelint.crazy.webp" alt="" loading="lazy" decoding="async" width="643" height="272" jampack-sized="true"><h3 id="tailwindconfigjs">tailwind.config.js</h3><p>虽然 TailwindCSS 4 已经不需要单独的 tailwind.config.js 了；但是，如果有使用第三方插件，还是独立的配置文件比较方便；这里使用了几个插件：</p><ul><li><a class="link" href="https://github.com/egoist/tailwindcss-icons" target="_blank" rel="noopener">@egoist/tailwindcss-icons
</a>，将 Iconify 映射到 TailwindCSS；</li><li><a class="link" href="https://github.com/iconify/tools" target="_blank" rel="noopener">@iconify/tools
</a>，解析本地 SVG 文件并映射为 IconifyJSON；</li><li><a class="link" href="https://github.com/jamiebuilds/tailwindcss-animate" target="_blank" rel="noopener">tailwindcss-animate
</a>，补足动画类名，TailwindCSS 内置的动画比较贫瘠；</li><li><a class="link" href="https://github.com/the-lemonboy/tailwindcss-px-to-viewport" target="_blank" rel="noopener">tailwindcss-px-to-viewport
</a>，不使用 PostCSS 的情况下，将 px 转换为 vw/vh。</li></ul><p><a class="link" href="https://github.com/egoist/tailwindcss-icons" target="_blank" rel="noopener">@egoist/tailwindcss-icons
</a>怎么用，可以查看这个<a class="link" href="https://github.com/egoist/tailwindcss-icons/issues/37" target="_blank" rel="noopener">
栗子
</a>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="cm">/** @type {import('tailwindcss').Config} */</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">resolve</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'node:path'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">iconsPlugin</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@egoist/tailwindcss-icons'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cleanupSVG</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">importDirectorySync</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">isEmptyColor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">parseColors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">runSVGO</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="nx">from</span> <span class="s1">'@iconify/tools'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">animate</span> <span class="nx">from</span> <span class="s1">'tailwindcss-animate'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">pxToViewport</span> <span class="nx">from</span> <span class="s1">'tailwindcss-px-to-viewport'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">workspaceRootSync</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'workspace-root'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 获取 monorepo 根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">workspaceRoot</span> <span class="o">=</span> <span class="nx">workspaceRootSync</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// https://github.com/the-lemonboy/tailwindcss-px-to-viewport/blob/master/README_CN.md
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">theme</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">extend</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">pxToViewPort</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 基准视口配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">PresetScreen</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">width</span><span class="o">:</span> <span class="mi">750</span><span class="p">,</span> <span class="c1">// 默认设计稿宽度（单位：px）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="nx">height</span><span class="o">:</span> <span class="mi">1080</span> <span class="c1">// 默认设计稿高度（单位：px）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 默认配置没有包含对 border-radius 的处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">utilities</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">rounded</span><span class="o">:</span> <span class="p">[</span><span class="s1">'border-radius'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="nx">animate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">iconsPlugin</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">collections</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">colorless</span><span class="o">:</span> <span class="nx">getCollections</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">workspaceRoot</span><span class="p">,</span> <span class="s1">'./icons/colorless'</span><span class="p">)),</span> <span class="c1">// 单色图标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">color</span><span class="o">:</span> <span class="nx">getCollections</span><span class="p">(</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">workspaceRoot</span><span class="p">,</span> <span class="s1">'./icons/color'</span><span class="p">))</span> <span class="c1">// 彩色图标
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pxToViewport</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// https://iconify.design/docs/libraries/tools/import/directory.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">function</span> <span class="nx">getCollections</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 读取 svg 目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">iconSet</span> <span class="o">=</span> <span class="nx">importDirectorySync</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">includeSubDirs</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 遍历目录文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">iconSet</span><span class="p">.</span><span class="nx">forEachSync</span><span class="p">((</span><span class="nx">name</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 文件过滤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">'icon'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">iconSet</span><span class="p">.</span><span class="nx">toSVG</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">svg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">iconSet</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">svg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 清理优化 svg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">cleanupSVG</span><span class="p">(</span><span class="nx">svg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'colorless'</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 单色图标，默认继承父级的颜色
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">parseColors</span><span class="p">(</span><span class="nx">svg</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">defaultColor</span><span class="o">:</span> <span class="s1">'currentColor'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">callback</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s1">'currentColor'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">runSVGO</span><span class="p">(</span><span class="nx">svg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">iconSet</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">svg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 更新 svg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">iconSet</span><span class="p">.</span><span class="nx">fromSVG</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">svg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 导出 icon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nx">iconSet</span><span class="p">.</span><span class="kr">export</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但是，这个配置在子包中，没有了图标类名提示；并且如果 SVG 由更新，需要重启 Vite。</p><p>除此之外，还有两个辅助函数：</p><ul><li><a class="link" href="https://github.com/lukeed/clsx" target="_blank" rel="noopener">clsx
</a>，提升基于条件的 JSX 类名书写体验；</li><li><a class="link" href="https://github.com/dcastil/tailwind-merge" target="_blank" rel="noopener">tailwind-merge
</a>，解决 TailwindCSS 类名合并优先级问题。</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">ClassValue</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'clsx'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">clsx</span> <span class="kr">from</span> <span class="s1">'clsx'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">twMerge</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'tailwind-merge'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// https://dev.to/sheraz4194/mastering-tailwind-css-overcome-styling-conflicts-with-tailwind-merge-and-clsx-1dol
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">cn</span><span class="p">(...</span><span class="nx">inputs</span>: <span class="kt">ClassValue</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">twMerge</span><span class="p">(</span><span class="nx">clsx</span><span class="p">(</span><span class="nx">inputs</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>有了 cn 工具函数，可以提升 JSX 类名的书写体验：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">BubbleFooter</span>: <span class="kt">React.FC</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Partial</span><span class="p">&lt;</span><span class="nt">BubbleFooterProps</span> <span class="err">&amp;</span> <span class="na">React.HTMLAttributes</span><span class="err">&lt;</span><span class="na">HTMLElement</span><span class="p">&gt;</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="o">&gt;</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">className</span><span class="p">,</span> <span class="nx">placement</span> <span class="o">=</span> <span class="s1">'start'</span><span class="p">,</span> <span class="nx">shortcuts</span><span class="p">,</span> <span class="nx">tools</span><span class="p">,</span> <span class="p">...</span><span class="nx">restProps</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="na">...restProps</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="nx">cn</span><span class="p">(</span><span class="s1">'w-full'</span><span class="p">,</span> <span class="nx">className</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'text-left'</span><span class="o">:</span> <span class="nx">placement</span> <span class="o">===</span> <span class="s1">'start'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'text-right'</span><span class="o">:</span> <span class="nx">placement</span> <span class="o">===</span> <span class="s1">'end'</span>
</span></span><span class="line"><span class="cl">      <span class="p">})}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="nx">tools</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="nx">shortcuts</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>在 monorepo 项目中，<a class="link" href="https://github.com/tailwindlabs/tailwindcss-intellisense" target="_blank" rel="noopener">
TailwindCSS IntelliSense
</a>会有一些<a class="link" href="https://github.com/tailwindlabs/tailwindcss-intellisense/issues/1139" target="_blank" rel="noopener">
类名提示的问题
</a>；需要<a class="link" href="https://github.com/tailwindlabs/tailwindcss/issues/13136" target="_blank" rel="noopener">
修改
</a>编辑器配置（WebStorm 同理），指明每个子包的 CSS 入口文件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"tailwindCSS.experimental.configFile"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"packages/js-sdk/index.css"</span><span class="p">:</span> <span class="s2">"**"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"apps/admin/src/index.css"</span><span class="p">:</span> <span class="s2">"**"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"apps/web/src/index.css"</span><span class="p">:</span> <span class="s2">"**"</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="nginx-configconf">nginx-config.conf</h3><p>当前项目是个 monorepo，它们走的同一条流水线，运行在同一个容器内，使用同一个 nginx 配置；Admin 和 SDK 部署在同一个域名的不同路径下；代理 SDK 时，需要借助 alias 指令 cd 到 SDK 的打包目录：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen  80;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    root /usr/share/nginx/html/admin;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 处理主应用请求
</span></span><span class="line"><span class="cl">    location / {
</span></span><span class="line"><span class="cl">        try_files $uri $uri/ /index.html;
</span></span><span class="line"><span class="cl">        proxy_http_version 1.1;
</span></span><span class="line"><span class="cl">        proxy_set_header Upgrade $http_upgrade;
</span></span><span class="line"><span class="cl">        proxy_set_header Connection keep-alive;
</span></span><span class="line"><span class="cl">        proxy_set_header Host $host;
</span></span><span class="line"><span class="cl">        proxy_cache_bypass $http_upgrade;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    # 处理 SDK 静态资源请求
</span></span><span class="line"><span class="cl">    location /sdk/ {
</span></span><span class="line"><span class="cl">        alias /usr/share/nginx/html/sdk/;
</span></span><span class="line"><span class="cl">        add_header Access-Control-Allow-Origin *;
</span></span><span class="line"><span class="cl">        # add_header Cache-Control "no-cache, no-store, must-revalidate";
</span></span><span class="line"><span class="cl">        # add_header Pragma "no-cache";
</span></span><span class="line"><span class="cl">        # add_header Expires "0";
</span></span><span class="line"><span class="cl">        try_files $uri =404;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></tbody></table></div></div><p>由于 SDK 体积比较大，最好启用 gzip 压缩：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_vary</span> <span class="n">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_min_length</span> <span class="mi">1024</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_disable</span> <span class="s2">"msie6"</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_types</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">/</span><span class="n">plain</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">/</span><span class="n">css</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">/</span><span class="n">xml</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span><span class="o">/</span><span class="n">javascript</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">javascript</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">+</span><span class="n">rss</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">json</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">xhtml</span><span class="o">+</span><span class="n">xml</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">xml</span>
</span></span><span class="line"><span class="cl">        <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span>
</span></span><span class="line"><span class="cl">        <span class="n">image</span><span class="o">/</span><span class="n">svg</span><span class="o">+</span><span class="n">xml</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_proxied</span> <span class="n">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_buffers</span> <span class="mi">32</span> <span class="mi">4</span><span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 启用 gzip 压缩的最低 HTTP 协议版本</span>
</span></span><span class="line"><span class="cl">    <span class="n">gzip_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="turbojson">turbo.json</h3><p>Turborepo 可以帮助我们：</p><ul><li>并行执行 npm-script；不然，每次打包都需要单独执行每个子包的命令；</li><li>通过 dependsOn 字段，调整命令执行<a class="link" href="https://turborepo.com/docs/crafting-your-repository/configuring-tasks#running-tasks-in-the-right-order" target="_blank" rel="noopener">
顺序
</a>，先编译<strong>依赖</strong>，再编译<strong>应用</strong>；</li><li>利用<a class="link" href="https://turborepo.com/docs/crafting-your-repository/caching#remote-caching" target="_blank" rel="noopener">
缓存
</a>，跳过未修改子包的命令执行；</li></ul><p>有一点令人费解：outputs 属性值，是相对于「子包根目录」的；不是「turbo.json 所在的目录」，也不是「项目根目录」；下面是<strong>非完整配置</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"$schema"</span><span class="p">:</span> <span class="s2">"https://turborepo.com/schema.json"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"globalDependencies"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"./env"</span><span class="p">,</span> <span class="s2">"./env.development"</span><span class="p">,</span> <span class="s2">"./env.production"</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"concurrency"</span><span class="p">:</span> <span class="s2">"3"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"tasks"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 执行项目中所有的 build 命令
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nt">"dependsOn"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"^build"</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 输出目录是相对于每个子包的根目录的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nt">"outputs"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"../../dist/prod/**"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"test:coverage"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"dependsOn"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"^test:coverage"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 开发环境禁用缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nt">"dev"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"cache"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"persistent"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"dependsOn"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"^dev"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"preview"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"cache"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"persistent"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"dependsOn"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"^preview"</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这样，只需要在项目根目录配置好 npm-script，就可以很方便的执行子包中的命令：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nt">"scripts"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build"</span><span class="p">:</span> <span class="s2">"turbo build"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build:admin"</span><span class="p">:</span> <span class="s2">"turbo @example/admin#build"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build:web"</span><span class="p">:</span> <span class="s2">"turbo @example/web#build"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build:js-sdk"</span><span class="p">:</span> <span class="s2">"turbo @example/js-sdk#build"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"dev"</span><span class="p">:</span> <span class="s2">"turbo dev"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"dev:admin"</span><span class="p">:</span> <span class="s2">"turbo @example/admin#dev"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"dev:web"</span><span class="p">:</span> <span class="s2">"turbo @example/web#dev"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"dev:js-sdk"</span><span class="p">:</span> <span class="s2">"turbo @example/js-sdk#dev"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"postinstall"</span><span class="p">:</span> <span class="s2">"turbo telemetry disable"</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>最后，建议通过 postinstall 钩子，将 Turborepo 的数据收集关闭。</p><h3 id="子包配置">子包配置</h3><p>因为 pnpm 支持 workspace 协议，所以 packages 目录下的子包在配置好<a class="link" href="https://nodejs.org/api/packages.html#packages_conditional_exports" target="_blank" rel="noopener">
<strong>条件导出</strong>
</a>的情况下，可以走<strong>只导出，不编译</strong>的策略：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"name"</span><span class="p">:</span> <span class="s2">"@example/shared"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"version"</span><span class="p">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"private"</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"description"</span><span class="p">:</span> <span class="s2">"公共方法、组件、Hooks，支持源码引用和构建后发布"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"keywords"</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"license"</span><span class="p">:</span> <span class="s2">"ISC"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"author"</span><span class="p">:</span> <span class="s2">"frontend"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"sideEffects"</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"type"</span><span class="p">:</span> <span class="s2">"module"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"exports"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"."</span><span class="p">:</span> <span class="s2">"./index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"./apis"</span><span class="p">:</span> <span class="s2">"./apis/index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"./chat.css"</span><span class="p">:</span> <span class="s2">"./styles/chat.css"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"./highlight.css"</span><span class="p">:</span> <span class="s2">"./styles/highlight.css"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"./components"</span><span class="p">:</span> <span class="s2">"./components/index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"./hooks"</span><span class="p">:</span> <span class="s2">"./hooks/index.ts"</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"main"</span><span class="p">:</span> <span class="s2">"./index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"module"</span><span class="p">:</span> <span class="s2">"./index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./index.ts"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"dependencies"</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"devDependencies"</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"peerDependencies"</span><span class="p">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"scripts"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"build"</span><span class="p">:</span> <span class="s2">"tsup --out-dir ../../dist/prod/shared"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"check-types"</span><span class="p">:</span> <span class="s2">"tsc --noEmit"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"test:coverage"</span><span class="p">:</span> <span class="s2">"vitest run --coverage"</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">"publishConfig"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"exports"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"."</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"import"</span><span class="p">:</span> <span class="s2">"./dist/index.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"require"</span><span class="p">:</span> <span class="s2">"./dist/index.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./dist/index.d.ts"</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"./apis"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"import"</span><span class="p">:</span> <span class="s2">"./dist/apis/index.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"require"</span><span class="p">:</span> <span class="s2">"./dist/apis/index.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./dist/apis/index.d.ts"</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"./chat.css"</span><span class="p">:</span> <span class="s2">"./dist/chat.css"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"./highlight.css"</span><span class="p">:</span> <span class="s2">"./dist/highlight.css"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"./components"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"import"</span><span class="p">:</span> <span class="s2">"./dist/components/index.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"require"</span><span class="p">:</span> <span class="s2">"./dist/components/index.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./dist/components/index.d.ts"</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">"./hooks"</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"import"</span><span class="p">:</span> <span class="s2">"./dist/hooks/index.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"require"</span><span class="p">:</span> <span class="s2">"./dist/hooks/index.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./dist/hooks/index.d.ts"</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"main"</span><span class="p">:</span> <span class="s2">"./dist/index.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"module"</span><span class="p">:</span> <span class="s2">"./dist/index.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">"types"</span><span class="p">:</span> <span class="s2">"./dist/index.d.ts"</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这个策略省去了本地开发时，子包编译的过程；任何修改都能被应用的 HMR 立即捕获，但也意味着 path-alias 在子包中不可用。不过需要注意，条件导出对 package.json 中的字段顺序有<a class="link" href="https://github.com/JoshuaKGoldberg/eslint-plugin-package-json/issues/928" target="_blank" rel="noopener">
要求
</a>，需要<strong>从具体到不具体</strong>。</p><p>如果子包需要单独发布，直接走 tsup 打包即可；以下是<strong>非完整配置</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'tsup'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">peerDependencies</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'./package.json'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">compilerOptions</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'./tsconfig.json'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">entry</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'index.ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'apis/index.ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'components/index.ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'hooks/index.ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'styles/chat.css'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'styles/highlight.css'</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">target</span>: <span class="kt">compilerOptions.target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sourcemap</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">outDir</span><span class="o">:</span> <span class="s1">'dist'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dts</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">splitting</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">clean</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">format</span><span class="o">:</span> <span class="p">[</span><span class="s1">'esm'</span><span class="p">,</span> <span class="s1">'cjs'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">external</span>: <span class="kt">Object.keys</span><span class="p">(</span><span class="nx">peerDependencies</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">publicDir</span><span class="o">:</span> <span class="s1">'.'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loader</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'.css'</span><span class="o">:</span> <span class="s1">'css'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'.js'</span><span class="o">:</span> <span class="s1">'js'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'.jsx'</span><span class="o">:</span> <span class="s1">'jsx'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'.ts'</span><span class="o">:</span> <span class="s1">'ts'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'.tsx'</span><span class="o">:</span> <span class="s1">'tsx'</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">treeshake</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="状态管理">状态管理</h2><p>项目中使用了两个状态库，<a class="link" href="https://zustand-demo.pmnd.rs/" target="_blank" rel="noopener">
Zustand
</a>和 <a class="link" href="https://github.com/dai-shi/use-context-selector" target="_blank" rel="noopener">use-context-selector
</a>；Zustand 存放需要<strong>持久化</strong>的状态，包括：快捷指令列表、入口按钮位置、面板展开状态等；context 存放<strong>不能被序列化</strong>的状态，包括：SDK 认证配置、流式调用方法等。</p><p><a class="link" href="https://github.com/dai-shi/use-context-selector" target="_blank" rel="noopener">use-context-selector
</a>不必多说，相比于 useContext，他的状态颗粒度更细，能跳过不必要的渲染。</p><h3 id="zustand">Zustand</h3><p>持久化状态中，不仅需要保存 JS-SDK 状态，还需要保存：客户端标识 deviceId、登录用户信息 userInfo（Admin 端）、登录凭证 token（Admin 端）等；为了方便创建状态，需要一个 Zustand 工厂函数：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">create</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'zustand'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">combine</span><span class="p">,</span> <span class="nx">persist</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'zustand/middleware'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">cloneDeep</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'lodash-es'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">Updater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span><span class="nx">updater</span><span class="o">:</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">MakeUpdater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">lastUpdateTime</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">markUpdate</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">update</span>: <span class="kt">Updater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">SecondParam</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">T</span> <span class="kr">extends</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">_f</span>: <span class="kt">infer</span> <span class="nx">_F</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">_s</span>: <span class="kt">infer</span> <span class="nx">_S</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span><span class="nx">args</span>: <span class="kt">infer</span> <span class="nx">_U</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="kt">any</span>
</span></span><span class="line"><span class="cl">  <span class="o">?</span> <span class="nx">_S</span>
</span></span><span class="line"><span class="cl">  : <span class="kt">never</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">SetStoreState</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">partial</span>: <span class="kt">T</span> <span class="o">|</span> <span class="nx">Partial</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span> <span class="o">|</span> <span class="p">((</span><span class="nx">state</span>: <span class="kt">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">T</span> <span class="o">|</span> <span class="nx">Partial</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">replace?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kc">undefined</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createPersistStore</span><span class="p">&lt;</span><span class="nt">T</span> <span class="na">extends</span> <span class="na">object</span><span class="err">,</span> <span class="na">M</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">state</span>: <span class="kt">T</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">methods</span><span class="o">:</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kr">set</span><span class="o">:</span> <span class="nx">SetStoreState</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">&amp;</span> <span class="na">MakeUpdater</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">get</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span> <span class="o">&amp;</span> <span class="nx">MakeUpdater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">M</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">persistOptions</span>: <span class="kt">SecondParam</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">persist</span><span class="err">&lt;</span><span class="na">T</span> <span class="err">&amp;</span> <span class="na">M</span> <span class="err">&amp;</span> <span class="na">MakeUpdater</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 创建状态实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nx">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 状态持久化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">persist</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 将状态和状态更新方法合并
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">combine</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">lastUpdateTime</span>: <span class="kt">0</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kr">set</span><span class="p">,</span> <span class="kr">get</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">methods</span><span class="p">(</span><span class="kr">set</span> <span class="kr">as</span> <span class="nx">SetStoreState</span><span class="p">&lt;</span><span class="nt">T</span> <span class="err">&amp;</span> <span class="na">MakeUpdater</span><span class="err">&lt;</span><span class="na">T</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">,</span> <span class="kr">get</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">markUpdate() {</span>
</span></span><span class="line"><span class="cl">              <span class="kr">set</span><span class="p">({</span> <span class="nx">lastUpdateTime</span>: <span class="kt">Date.now</span><span class="p">()</span> <span class="p">}</span> <span class="kr">as</span> <span class="nx">Partial</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">T</span> <span class="o">&amp;</span> <span class="nx">M</span> <span class="o">&amp;</span> <span class="nx">MakeUpdater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="o">&gt;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">update</span><span class="p">(</span><span class="nx">updater</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="kr">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">cloneDeep</span><span class="p">(</span><span class="kr">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">              <span class="nx">updater</span><span class="p">(</span><span class="nx">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="kr">set</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="p">...</span><span class="nx">state</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">lastUpdateTime</span>: <span class="kt">Date.now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">              <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="kr">as</span> <span class="nx">M</span> <span class="o">&amp;</span> <span class="nx">MakeUpdater</span><span class="p">&lt;</span><span class="nt">T</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">persistOptions</span> <span class="kr">as</span> <span class="kt">any</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>通过构造函数，可以快速创建状态实例：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">AUTH_TOKEN</span>: <span class="kt">TokenDto</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">accessToken</span><span class="o">:</span> <span class="s1">''</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">refreshToken</span><span class="o">:</span> <span class="s1">''</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">useAuthTokenStore</span> <span class="o">=</span> <span class="nx">createPersistStore</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span> <span class="p">...</span><span class="nx">AUTH_TOKEN</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reset() {</span>
</span></span><span class="line"><span class="cl">      <span class="kr">set</span><span class="p">(</span><span class="nx">AUTH_TOKEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}),</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">'example-bot-token'</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>以 useAuthTokenStore 为例，有三种调用方式：</p><ol><li>useAuthTokenStore()：在组件中访问整个状态；</li><li>useAuthTokenStore().getState()：获取当前的状态快照，不触发重新渲染；</li><li>useAuthTokenStore(state =&gt; state.accessToken)：在组件中访问部分状态。</li></ol><h2 id="构建-sdk">构建 SDK</h2><p>为了能增强宿主环境的 AI 能力，SDK 需要能满足以下功能：</p><ol><li>宿主环境能够通过划词菜单快捷指令，给 AI 发送消息；<ul><li>方便用户选中内容后，快速给 AI 发消息。</li></ul></li><li>宿主环境能够通过调用 SDK 的方法，给 AI 发送消息；<ul><li>通过 SDK 暴露的方法调用，更灵活，更能融入宿主环境，比如广告位调用 AI。</li></ul></li><li>用户点击 AI 返回的消息，宿主环境能够接收到反馈；<ul><li>AI 生成订单/合同后，用户可以根据 AI 提示，通知宿主跳转到订单/合同详情。</li></ul></li><li>SDK 输入框 placeholder 能够让宿主环境自定义；<ul><li>这算是一种「品牌化」需求，公司想 SDK 向 SaaS 服务方向发展。</li></ul></li><li>SDK 入口按钮能够自定义/显隐控制/位置记忆；<ul><li>敏感页面/打印页面需要暂时隐藏 AI 入口。</li></ul></li><li>统一拦截器，方便宿主环境能对用户操作进行控制。<ul><li>例如，未在宿主环境登录的用户，禁止使用 AI 功能。</li></ul></li></ol><h3 id="sdk-结构">SDK 结构</h3><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">ChatSdk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="nx">name</span>: <span class="kt">string</span> <span class="o">=</span> <span class="s1">'ChatSdk'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="kr">async</span> <span class="nx">configUpdate</span><span class="p">(</span><span class="nx">configFromExternal</span>: <span class="kt">ChatSdkConfig</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="kr">async</span> <span class="nx">unmount</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">beforeUnmountFromHost</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">unmountedFromHost</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="o">:</span> <span class="nx">ChatSdkUnmountParams</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="kr">async</span> <span class="nx">sendMessage</span><span class="p">(</span><span class="nx">message</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">autoSend</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">public</span> <span class="kr">async</span> <span class="nx">toggleEntry</span><span class="p">(</span><span class="nx">hidden</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">configFromExternal</span>: <span class="kt">ChatSdkConfig</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{}</span> <span class="kr">as</span> <span class="nx">ChatSdkConfig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">appRoot</span>: <span class="kt">HTMLDivElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">appInstance</span>: <span class="kt">Root</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">container</span>: <span class="kt">HTMLElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'main'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">shadowRoot</span>: <span class="kt">ShadowRoot</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">static</span> <span class="nx">instance</span>: <span class="kt">ChatSdk</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">mount</span><span class="p">(</span><span class="nx">configFromExternal</span>: <span class="kt">ChatSdkConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">configProduce</span><span class="p">(</span><span class="nx">configFromExternal</span>: <span class="kt">ChatSdkConfig</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">configChanged() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'ChatSdk.configChanged'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">beforeUnmount() {</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">linkStyle() {</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="kr">async</span> <span class="nx">render() {</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ChatSdk</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这里隐去了实现细节，只说一下思路：</p><ol><li>构造函数接收 SDK 的配置，并构造 SDK 实例，需要做两件事：<ol><li>保存 this 实例，确保 SDK 运行在「单例模式」；</li><li>在 try…catch 中调用 mount，完成渲染节点的初始化。</li></ol></li><li>mount 用来完成渲染节点的初始化，需要做三件事：<ol><li>调用 configProduce 校验「用户配置」并标准化输出；</li><li>通过 container.attachShadow 创建 ShadowDOM 节点；</li><li>调用 linkStyle 将样式注入到 ShadowDOM 内部；</li><li>调用 render 函数，完成 React 组件渲染。</li></ol></li><li>render 函数通过调用 React.createRoot 渲染组件；</li><li>unmount 函数用来销毁 SDK 实例：<ol><li>调用宿主传入的 beforeUnmountFromHost(this)；</li><li>调用 beforeUnmount：<ol><li>卸载 React 组件树；</li><li>移除挂载节点 appRoot；</li><li>移除 ShadowDOM 容器 container；</li><li>重置 appRoot 和 container，为下一次 mount 做准备。</li></ol></li><li>调用宿主传入的 unmountedFromHost(null)。</li></ol></li><li>configUpdate 函数接收一个新配置，并重载 React 组件树；</li><li>sendMessage 方便宿主快速给 AI 发送消息；</li><li>toggleEntry 方便宿主隐藏/展示 AI 入口。</li></ol><h3 id="sdk-配置">SDK 配置</h3><p>为了能满足上述需求，我们来看一下初始化时，需要传入哪些配置：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChatSdkConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">releaseKey</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onCustomEvent</span><span class="o">?:</span> <span class="p">(</span><span class="nx">event</span>: <span class="kt">ChatSdkConfigEventParams</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEntranceInterceptor?</span>: <span class="kt">EntranceInterceptor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">userInfo?</span>: <span class="kt">ChatSdkConfigUserInfo</span> <span class="o">|</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">ChatSdkConfigUserInfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">toolContext?</span>: <span class="kt">ChatSdkConfigToolContext</span> <span class="o">|</span> <span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">ChatSdkConfigToolContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">senderPlaceholder?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">title?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">entranceButton?</span>: <span class="kt">HTMLElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">renderContext?</span>: <span class="kt">RenderContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChatSdkConfigEventParams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">eventType</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">eventPayload</span>: <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">EntranceInterceptor</span> <span class="o">=</span> <span class="p">(</span><span class="kr">from</span><span class="o">:</span> <span class="nx">EntranceFrom</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="nx">EntranceFrom</span> <span class="o">=</span> <span class="s1">'ContextMenu'</span> <span class="o">|</span> <span class="s1">'EntranceButton'</span> <span class="o">|</span> <span class="s1">'SmartButton'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChatSdkConfigUserInfo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nickname</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">from</span><span class="o">?:</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">id?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ChatSdkConfigToolContext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">prop</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">RenderContext</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">sendMessageInner</span><span class="o">?:</span> <span class="p">(</span><span class="nx">message</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">autoSend?</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">toggleEntryInner</span><span class="o">?:</span> <span class="p">(</span><span class="nx">hidden</span>: <span class="kt">boolean</span> <span class="o">=</span> <span class="kc">false</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><ol><li>auth.releaseKey 需要是一个 JWT，内部 payload 包含了：配置 ID、生成时间、过期时间、权限、合法域名等；</li><li>onCustomEvent 是一个 AI 向宿主发送消息时，通知宿主的渠道，宿主可以拿到事件类型、事件 payload；返回值决定了 AI 面板的显示｜隐藏；</li><li>onEntranceInterceptor 是一个拦截器，当宿主尝试调用 SDK 的能力时，SDK 内部都会先调用拦截器；通过返回值，判断宿主当前是否允许使用 AI；</li><li>userInfo 和 toolContext 都会在 SDK 内部转换成函数的形式；每次向 AI 提问时，都会作为 SSE 的 payload 的一部分；</li><li>senderPlaceholder、title、entranceButton 是用来自定义 SDK 的 UI 的，entranceButton 通过 dangerouslySetInnerHTML 渲染，并经过了 DOMPurify 净化；</li><li>renderContext 是 SDK 实例，不需要宿主提供；React 将向 renderContext 绑定一些方法，这样宿主通过 SDK 实例，可以调用内部方法。</li></ol><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">_Example_ChatSdk_</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Example</span><span class="p">.</span><span class="nx">ChatSdk</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span> <span class="nx">releaseKey</span>: <span class="kt">environment.releaseKey</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onCustomEvent</span>: <span class="kt">async</span> <span class="p">({</span> <span class="nx">eventPayload</span><span class="p">,</span> <span class="nx">eventType</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// &lt;custom-event eventType='sendToMySelf' eventPayload='eventPayload' /&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Example.ChatSdk.onCustomEvent.eventPayload'</span><span class="p">,</span> <span class="nx">eventPayload</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Example.ChatSdk.onCustomEvent.eventType'</span><span class="p">,</span> <span class="nx">eventType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">eventType</span> <span class="o">===</span> <span class="s1">'sendToMySelf'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">sdkInstance</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">eventPayload</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onEntranceInterceptor</span>: <span class="kt">async</span> <span class="kr">from</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Example.ChatSdk.onEntranceInterceptor.from'</span><span class="p">,</span> <span class="kr">from</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="kr">from</span> <span class="o">===</span> <span class="s1">'ContextMenu'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isLogin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// 未登录，不能使用划词
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 宿主环境用户信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">userInfo</span><span class="o">:</span> <span class="p">{</span> <span class="nx">nickname</span><span class="o">:</span> <span class="s1">'用户昵称'</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="s1">'user-123456'</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">toolContext</span><span class="o">:</span> <span class="p">{</span> <span class="kr">from</span><span class="o">:</span> <span class="s1">'localhost:3000'</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">title</span><span class="o">:</span> <span class="s1">'宿主自定义 AI 标题'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">senderPlaceholder</span><span class="o">:</span> <span class="s1">'宿主自定义 placeholder'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">entranceButton</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'&lt;img src="./assets/host-ai-entrance-button.png" alt="宿主自定义 AI 入口"&gt;'</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这样做有以下好处：</p><ul><li>广告位可以配置为 <strong>&lt;a href=“javascript:window?._Example_ChatSdk_?.sendMessage(‘广告’)"&gt;我是广告&lt;/a&gt;</strong>；用户点击后，直接向 AI 发消息；</li><li>如果要支持更多自定义事件，只需要通过 Admin 端修改 AI 提示词，并更新宿主环境的配置，无需修改 SDK 代码；</li><li>如果要给 AI 调用添加任何<strong>前置条件</strong>，只需要更新宿主环境配置，无需修改 SDK 代码。</li></ul><h3 id="sdk-使用">SDK 使用</h3><p>一开始使用的是 Vite 默认的引入方式：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"module"</span> <span class="na">src</span><span class="o">=</span><span class="s">"./index.tsx"</span> <span class="na">crossorigin</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>SDK 是通过 Vite 的「库」模式进行打包的，这样引入不方便拿到 ChatSdk 构造函数。后来切换到了下面这种：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">"module"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 这里，Example 只是举个例子
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 需要和 viteConfig.build.name 对应
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="kr">import</span> <span class="nx">Example</span> <span class="nx">from</span> <span class="s1">'./index.js'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nx">Example</span><span class="p">.</span><span class="nx">ChatSdk</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但是，上线的时候，肯定不能这么使用：</p><ol><li>在第三方宿主环境使用 ESM 格式的包，是不明智的：<ol><li>crossorigin 作用对于 type=“module” 没那么大；</li><li>受同源策略限制，且限制比普通脚本更严格；</li><li>type=“module” 的 SRI 配置难度较大。</li></ol></li><li>体积较大，打包 UMD 格式时，会将所有依赖打包为一个 JS：<ol><li>和豆包一样，打包产物有 5MB+，即使 gzip 也有 2MB+，这还是去了 sourcemap 的情况下；</li><li>SDK 和宿主的业务逻辑耦合性弱，不需要同宿主环境代码一起加载，拖慢宿主加载速度。</li></ol></li></ol><p>在生产环境，需要使用异步加载：</p><ol><li>使用 loadSDKJS 加载 SDK 资源：<ol><li>因为在本地开发环境，Vite 输出的是 ESM 格式，所以 type=“module”；</li><li>线上部署的 UMD 格式，需要在配置时，改为 type=“text/javascript”；</li><li>这样加载更灵活，比如在后台管理的登录页，引入 SDK 也无意义。</li></ol></li><li>loadSDKJS 接收一个回调函数，用于在加载完成之后初始化 SDK 实例。</li></ol><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">loadSDKJS</span> <span class="o">=</span> <span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="nx">onLoaded</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nx">Example</span><span class="o">?</span><span class="p">.</span><span class="nx">ChatSdk</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">scriptEle</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'script'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scriptEle</span><span class="p">.</span><span class="kr">type</span> <span class="o">=</span> <span class="s1">'module'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scriptEle</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scriptEle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">scriptEle</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">onLoaded</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onLoaded</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">loadSDKJS</span><span class="p">(</span><span class="s1">'http://localhost:3000/index.js'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Example</span><span class="p">.</span><span class="nx">ChatSdk</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="参考">参考</h2><ul><li><a class="link" href="https://github.com/orgs/pnpm/discussions/4150" target="_blank" rel="noopener">In a Workspace, How to List Packages That Exist Internally in the Repository?</a></li><li><a class="link" href="https://github.com/tailwindlabs/tailwindcss/issues/13136" target="_blank" rel="noopener">Automatic Content Detection in Monorepos Only Finds Direct Package</a></li><li><a class="link" href="https://github.com/tailwindlabs/tailwindcss-intellisense/issues/1139" target="_blank" rel="noopener">Intellisense Autocomplete Is not Working for My Project Structure</a></li><li><a class="link" href="https://github.com/JoshuaKGoldberg/eslint-plugin-package-json/issues/928" target="_blank" rel="noopener">Feature: Enforce Order of Imports and Exports</a></li><li><a class="link" href="https://github.com/egoist/tailwindcss-icons/issues/37" target="_blank" rel="noopener">Load SVGs from Filesystem</a></li></ul></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/ai-js-sdk-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93%E4%BA%8C/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">AI JS-SDK 项目总结（二）</h2></div></a></article><article class="has-image"><a href="/p/%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA-suspense-%E6%95%B0%E6%8D%AE%E6%BA%90/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">如何构建 Suspense 数据源</h2></div></a></article><article class="has-image"><a href="/p/%E8%BD%AC%E6%88%91%E5%9C%A8%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6%E4%B8%AD%E5%8F%AF%E4%BB%A5%E9%9A%8F%E4%BE%BF%E5%86%99%E6%9C%80%E9%80%9A%E4%BF%97%E5%BC%82%E6%AD%A5%E7%BB%84%E4%BB%B6%E5%8E%9F%E7%90%86/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">「转」我在函数组件中可以随便写，最通俗异步组件原理</h2></div></a></article><article class="has-image"><a href="/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%8B/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">React 复习笔记（下）</h2></div></a></article><article class="has-image"><a href="/p/react-%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%AD/"><div class="article-image"><img src="/img/cover/react.webp" loading="lazy" data-key="" data-hash="/img/cover/react.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">React 复习笔记（中）</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2025
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="关闭"></button>
<button class="pswp__button pswp__button--fs" title="全屏"></button>
<button class="pswp__button pswp__button--zoom" title="缩放"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="上一张"></button>
<button class="pswp__button pswp__button--arrow--right" title="下一张"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#项目搭建">项目搭建</a><ol><li><a href="#目录结构">目录结构</a></li><li><a href="#pnpm-workspace">pnpm workspace</a></li><li><a href="#commitlintconfigjs">commitlint.config.js</a></li><li><a href="#eslintconfigjs">eslint.config.js</a></li><li><a href="#stylelintconfigjs">stylelint.config.js</a></li><li><a href="#tailwindconfigjs">tailwind.config.js</a></li><li><a href="#nginx-configconf">nginx-config.conf</a></li><li><a href="#turbojson">turbo.json</a></li><li><a href="#子包配置">子包配置</a></li></ol></li><li><a href="#状态管理">状态管理</a><ol><li><a href="#zustand">Zustand</a></li></ol></li><li><a href="#构建-sdk">构建 SDK</a><ol><li><a href="#sdk-结构">SDK 结构</a></li><li><a href="#sdk-配置">SDK 配置</a></li><li><a href="#sdk-使用">SDK 使用</a></li></ol></li><li><a href="#参考">参考</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>