<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1,user-scalable=no'><meta name=description content=' Auth.js 是一个用于用户身份认证的库，之前叫 NextAuth.js ；他提供了四种身份认证方式：
OAuth ，第三方登录，用户需要跳转到可信任的第三方进行授权登录，例如 Google 登录、GitHub 登录，这种模式下，Auth.js 会将 token 保存在 cookie 中： 用户点击登录，浏览器发送一个 POST 请求给 Auth.js 的 RouteHandlers； RouteHandlers 会带上 scope、client_id、response_type、redirect_url 重定向到 GitHub 页面； 用户在 GitHub 上同意授权，GitHub 会带上参数 code 重定向回来，被 RouteHandlers 处理； RouteHandlers 拿着 code、app_id 用 AUTH_SECRET 加密，请求 GitHub； GitHub 会验证这些信息，验证通过，返回 access_token； RouteHandlers 拿着 access_token，向 GitHub 换取用户信息并重定向到首页，并设置 cookie 保存 session。 MagicLinks ，链接登录，用户通过电子邮件/手机短信接收登录链接进行登录；这种模式下，Auth.js 需要使用数据库来保存验证后的 token： MagicLinks 一般都有时效性的要求，并且有效期都很短； token 被嵌入在 MagicLinks 中，token 验证通过，用户也就登录成功了； MagicLinks 的安全性更多的取决于用户的网络环境、接收设备（手机被偷、邮箱被盗）。 Credentials ，账号密码登录，用户需要提交用户名和密码进行登录；这种模式下，Auth.js 需要使用数据库来保存用户名和密码； WebAuthn ，验证器登录，用户通过 PIN、FaceID、验证器登录；这种模式对 Auth.js 来说，这是一个实验性质的功能： WebAuthn 有点类似于建立 HTTPS 连接的过程； 在注册过程中，FaceID 生成一对公私钥（每个用户都不同），将公钥告诉网站； 在验证过程中，网站将一段信息发送给 FaceID，让 FaceID 用他的私钥加密并回传给网站； 网站拿到加密后的信息，用已有的公钥进行解密验证，确认用户身份。 安装 这里以 Next.js 项目为例，首先，需要安装依赖：
'><title>Next.js 之 Auth.js · I AM BEA, I DRINK TEA</title>
<link rel=canonical href=https://ElementRef.github.io/p/next.js-%E4%B9%8B-auth.js/><link rel=stylesheet href=/scss/style.min.497b5f2a752c475722ecfffdb2960cc0a51fcb0c639edf1257c35adfe486dc5f.css><meta property='og:title' content='Next.js 之 Auth.js'><meta property='og:description' content=' Auth.js 是一个用于用户身份认证的库，之前叫 NextAuth.js ；他提供了四种身份认证方式：
OAuth ，第三方登录，用户需要跳转到可信任的第三方进行授权登录，例如 Google 登录、GitHub 登录，这种模式下，Auth.js 会将 token 保存在 cookie 中： 用户点击登录，浏览器发送一个 POST 请求给 Auth.js 的 RouteHandlers； RouteHandlers 会带上 scope、client_id、response_type、redirect_url 重定向到 GitHub 页面； 用户在 GitHub 上同意授权，GitHub 会带上参数 code 重定向回来，被 RouteHandlers 处理； RouteHandlers 拿着 code、app_id 用 AUTH_SECRET 加密，请求 GitHub； GitHub 会验证这些信息，验证通过，返回 access_token； RouteHandlers 拿着 access_token，向 GitHub 换取用户信息并重定向到首页，并设置 cookie 保存 session。 MagicLinks ，链接登录，用户通过电子邮件/手机短信接收登录链接进行登录；这种模式下，Auth.js 需要使用数据库来保存验证后的 token： MagicLinks 一般都有时效性的要求，并且有效期都很短； token 被嵌入在 MagicLinks 中，token 验证通过，用户也就登录成功了； MagicLinks 的安全性更多的取决于用户的网络环境、接收设备（手机被偷、邮箱被盗）。 Credentials ，账号密码登录，用户需要提交用户名和密码进行登录；这种模式下，Auth.js 需要使用数据库来保存用户名和密码； WebAuthn ，验证器登录，用户通过 PIN、FaceID、验证器登录；这种模式对 Auth.js 来说，这是一个实验性质的功能： WebAuthn 有点类似于建立 HTTPS 连接的过程； 在注册过程中，FaceID 生成一对公私钥（每个用户都不同），将公钥告诉网站； 在验证过程中，网站将一段信息发送给 FaceID，让 FaceID 用他的私钥加密并回传给网站； 网站拿到加密后的信息，用已有的公钥进行解密验证，确认用户身份。 安装 这里以 Next.js 项目为例，首先，需要安装依赖：
'><meta property='og:url' content='https://ElementRef.github.io/p/next.js-%E4%B9%8B-auth.js/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-09-06T00:00:00+00:00'><meta property='article:modified_time' content='2024-09-06T00:00:00+00:00'><meta property='og:image' content='https://ElementRef.github.io/img/cover/nextjs.png'><meta name=twitter:title content="Next.js 之 Auth.js"><meta name=twitter:description content=" Auth.js 是一个用于用户身份认证的库，之前叫 NextAuth.js ；他提供了四种身份认证方式：
OAuth ，第三方登录，用户需要跳转到可信任的第三方进行授权登录，例如 Google 登录、GitHub 登录，这种模式下，Auth.js 会将 token 保存在 cookie 中： 用户点击登录，浏览器发送一个 POST 请求给 Auth.js 的 RouteHandlers； RouteHandlers 会带上 scope、client_id、response_type、redirect_url 重定向到 GitHub 页面； 用户在 GitHub 上同意授权，GitHub 会带上参数 code 重定向回来，被 RouteHandlers 处理； RouteHandlers 拿着 code、app_id 用 AUTH_SECRET 加密，请求 GitHub； GitHub 会验证这些信息，验证通过，返回 access_token； RouteHandlers 拿着 access_token，向 GitHub 换取用户信息并重定向到首页，并设置 cookie 保存 session。 MagicLinks ，链接登录，用户通过电子邮件/手机短信接收登录链接进行登录；这种模式下，Auth.js 需要使用数据库来保存验证后的 token： MagicLinks 一般都有时效性的要求，并且有效期都很短； token 被嵌入在 MagicLinks 中，token 验证通过，用户也就登录成功了； MagicLinks 的安全性更多的取决于用户的网络环境、接收设备（手机被偷、邮箱被盗）。 Credentials ，账号密码登录，用户需要提交用户名和密码进行登录；这种模式下，Auth.js 需要使用数据库来保存用户名和密码； WebAuthn ，验证器登录，用户通过 PIN、FaceID、验证器登录；这种模式对 Auth.js 来说，这是一个实验性质的功能： WebAuthn 有点类似于建立 HTTPS 连接的过程； 在注册过程中，FaceID 生成一对公私钥（每个用户都不同），将公钥告诉网站； 在验证过程中，网站将一段信息发送给 FaceID，让 FaceID 用他的私钥加密并回传给网站； 网站拿到加密后的信息，用已有的公钥进行解密验证，确认用户身份。 安装 这里以 Next.js 项目为例，首先，需要安装依赖：
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://ElementRef.github.io/img/cover/nextjs.png'><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=robots content="noarchive, noindex, nofollow"><meta name=theme-color content="#ffffff"><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "9d3fb1ef9fac4cb0b7d041747556f0c4"}'></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7590466716559688570.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>I AM BEA, I DRINK TEA</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/index.xml target=_blank><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>订阅</span></a></li><li><a href=https://github.com/ElementRef/AboutConfig target=_blank><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg>
<span>配置</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/next.js-%E4%B9%8B-auth.js/><img src=/img/cover/nextjs.png loading=lazy alt="Next.js 之 Auth.js"></a></div><div class=article-details><header class=article-category><a href=/categories/next.js/>Next.js</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/next.js-%E4%B9%8B-auth.js/>Next.js 之 Auth.js</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 06, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：9 分钟</time></div></footer></div></header><section class=article-content><p><a class=link href=https://authjs.dev/getting-started target=_blank rel=noopener>Auth.js
</a>是一个用于用户身份认证的库，之前叫 <a class=link href=https://next-auth.js.org/getting-started/introduction target=_blank rel=noopener>NextAuth.js
</a>；他提供了四种身份认证方式：</p><ol><li><a class=link href=https://authjs.dev/concepts/oauth target=_blank rel=noopener>OAuth
</a>，第三方登录，用户需要跳转到可信任的第三方进行授权登录，例如 Google 登录、GitHub 登录，这种模式下，Auth.js 会将 token 保存在 cookie 中：<ul><li>用户点击登录，浏览器发送一个 POST 请求给 Auth.js 的 RouteHandlers；</li><li>RouteHandlers 会带上 scope、client_id、response_type、redirect_url 重定向到 GitHub 页面；</li><li>用户在 GitHub 上同意授权，GitHub 会带上参数 code 重定向回来，被 RouteHandlers 处理；</li><li>RouteHandlers 拿着 code、app_id 用 AUTH_SECRET 加密，请求 GitHub；</li><li>GitHub 会验证这些信息，验证通过，返回 access_token；</li><li>RouteHandlers 拿着 access_token，向 GitHub 换取用户信息并重定向到首页，并设置 cookie 保存 session。</li></ul></li><li><a class=link href=https://www.descope.com/learn/post/magic-links target=_blank rel=noopener>MagicLinks
</a>，链接登录，用户通过电子邮件/手机短信接收登录链接进行登录；这种模式下，Auth.js 需要使用数据库来保存验证后的 token：<ul><li>MagicLinks 一般都有时效性的要求，并且有效期都很短；</li><li>token 被嵌入在 MagicLinks 中，token 验证通过，用户也就登录成功了；</li><li>MagicLinks 的安全性更多的取决于用户的网络环境、接收设备（手机被偷、邮箱被盗）。</li></ul></li><li><a class=link href=https://authjs.dev/getting-started/authentication/credentials target=_blank rel=noopener>Credentials
</a>，账号密码登录，用户需要提交用户名和密码进行登录；这种模式下，Auth.js 需要使用数据库来保存用户名和密码；</li><li><a class=link href=https://baddonkey.cn/detail/39 target=_blank rel=noopener>WebAuthn
</a>，验证器登录，用户通过 PIN、FaceID、验证器登录；这种模式对 Auth.js 来说，这是一个实验性质的功能：<ul><li>WebAuthn 有点类似于建立 HTTPS 连接的过程；</li><li>在注册过程中，FaceID 生成一对公私钥（每个用户都不同），将公钥告诉网站；</li><li>在验证过程中，网站将一段信息发送给 FaceID，让 FaceID 用他的私钥加密并回传给网站；</li><li>网站拿到加密后的信息，用已有的公钥进行解密验证，确认用户身份。</li></ul></li></ol><h2 id=安装>安装</h2><p>这里以 Next.js 项目为例，首先，需要安装依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add next-auth@beta
</span></span></code></pre></td></tr></table></div></div><p>然后，需要生成 <strong>AUTH_SECRET</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npx auth secret
</span></span></code></pre></td></tr></table></div></div><p>他会在项目中生成一个 .env.local 文件，里边保存着所需要的环境变量，用来<a class=link href=https://authjs.dev/getting-started/deployment target=_blank rel=noopener>
加密
</a>token 和验证信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>AUTH_SECRET=&#34;5Z8A6LyP7YlODesoq7XMB2v7xziXPyuXOT8EdY5yTC0=&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>在项目根目录新建 auth.ts，这是 Auth.js 的配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=nx>NextAuth</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>signOut</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 自定义日志输出形式，优先级高于 debug
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>logger</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=p>...</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>warn</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=p>...</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>debug</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=p>...</span><span class=nx>message</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>log</span><span class=p>.</span><span class=nx>debug</span><span class=p>(</span><span class=nx>code</span><span class=p>,</span> <span class=nx>message</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在控制台输出认证过程中的一些信息（包含敏感信息）
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>debug</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，在 app/api/auth/[&mldr;nextauth]/route.ts 路径下，新建 RouteHandlers 文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>handlers</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 处理来自 /api/auth 下的所有 GET、POST 请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>GET</span><span class=p>,</span> <span class=nx>POST</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>handlers</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>在项目根目录新建 middleware.ts：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=p>{</span> <span class=nx>auth</span> <span class=kr>as</span> <span class=nx>middleware</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=oauth-with-github>OAuth with GitHub</h2><p>首先，需要在 GitHub 上注册 <a class=link href=https://github.com/settings/applications/new target=_blank rel=noopener>OAuth 应用
</a>，并提供认证回调 URL，这个回调路径对应着之前我们新建的 RouteHandlers 文件，Auth.js 内部会自动帮我们处理这个请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>http://localhost:3000/api/auth/callback/github
</span></span></code></pre></td></tr></table></div></div><p>在 GitHub 中，每个 OAuth 应用只能配置一个回调地址；所以，如果有需要的话，可以申请多个 OAuth 应用。</p><p>注册完成之后，GitHub 会提供 ClientID（客户端标识）和 ClientSecret（客户端密钥），我们需要将他们保存在环境变量中：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>AUTH_GITHUB_ID=Ov23libVOGCfpFHd1U6F</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>AUTH_GITHUB_SECRET=91bdb38df2fbd0263fe08655f3d9c64947es1778</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>AUTH_GITHUB_ID 和 AUTH_GITHUB_SECRET 是可以自定义的，你只需要将修改后的变量名传入配置文件中即可，更新配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=nx>NextAuth</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>GitHub</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/github&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>signOut</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>GitHub</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 等同于下面这种写法，可以实现自定义环境变量名
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>GitHub</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>clientId</span>: <span class=kt>process.env.AUTH_GITHUB_ID</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>clientSecret</span>: <span class=kt>process.env.AUTH_GITHUB_SECRET</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>我们新建一个表单组件，用来显示登录按钮，Auth.js 会在 ServerComponents 中提供一个 ServerAction 供我们调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// components/sign-in.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>SignIn() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>form</span>
</span></span><span class=line><span class=cl>      <span class=na>action</span><span class=o>=</span><span class=p>{</span><span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;use server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nx>signIn</span><span class=p>(</span><span class=s1>&#39;github&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span><span class=nx>Signin</span> <span class=kd>with</span> <span class=nx>GitHub</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，你也可以在 ClientComponents 中直接调用 signIn 方法进行登录：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=s1>&#39;use client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>SignIn() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>signIn</span><span class=p>(</span><span class=s1>&#39;github&#39;</span><span class=p>)}&gt;</span><span class=nx>Signin</span> <span class=kd>with</span> <span class=nx>GitHub</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>点击之后，我们会跳转到 GitHub 授权页面：</p><p><img src=/p/next.js-%E4%B9%8B-auth.js/login_oauth_authorize.png width=1996 height=1428 srcset="/p/next.js-%E4%B9%8B-auth.js/login_oauth_authorize_hu10690738814290506354.png 480w, /p/next.js-%E4%B9%8B-auth.js/login_oauth_authorize_hu10885829644661472499.png 1024w" class=gallery-image data-flex-grow=139 data-flex-basis=335px loading=lazy></p><p>对应的地址是：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>https://github.com/login/oauth/authorize?scope=read:user+user:email<span class=err>&amp;</span>response_type=code<span class=err>&amp;</span>client_id=Ov23libVOGCfpFHd1U6F<span class=err>&amp;</span>redirect_uri=http://localhost:3000/api/auth/callback/github<span class=err>&amp;</span>code_challenge=cl4C9yHOnx44ARlsrdBUHwesfvmRwjI8LxgR1yqZ054<span class=err>&amp;</span>code_challenge_method=S256
</span></span></code></pre></td></tr></table></div></div><p>可以看到，他携带了一些<a class=link href=https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps target=_blank rel=noopener>
参数
</a>：</p><ul><li>scope=read:user+user:email，表明当前操作会读取我们的用户名和邮箱地址；</li><li>response_type=code，对应着 OAuth 授权方式中的<strong>授权码模式</strong>；</li><li>client_id=Ov23libVOGCfpFHd1U6F，对应着我们在 GitHub 申请的 OAuth 应用的 ClientID；</li><li>redirect_uri=http://localhost:3000/api/auth/callback/github，授权成功后跳转的地址，会被我们的 RouteHandlers 处理；</li><li>code_challenge=cl4C9yHOnx44ARlsrdBUHwesfvmRwjI8LxgR1yqZ054，PKCE 参数；</li><li>code_challenge_method=S256，PKCE 参数。</li></ul><p>验证通过后，会跳回我们的页面；并在 cookie 中保存认证信息：</p><ul><li>authjs.callback-url, http%3A%2F%2Flocalhost%3A3000%2F.</li><li>authjs.csrf-token, 95f7e370377acf306994d0379.</li><li>authjs.session-token, eyJhbGciOiJkaXIiLCiOi.</li></ul><p>官方内置的 providers/github 帮我们隐藏了大量的配置细节，如果需要更改默认配置，请<a class=link href=https://github.com/nextauthjs/next-auth/blob/main/packages/core/src/providers/github.ts target=_blank rel=noopener>
参阅
</a>。</p><h2 id=登录登出>登录/登出</h2><p>如果想让用户在登录成功之后，跳转到我们指定的页面，可以在 signIn 中传入一个对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth.ts&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>SignIn() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>form</span>
</span></span><span class=line><span class=cl>      <span class=na>action</span><span class=o>=</span><span class=p>{</span><span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;use server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nx>signIn</span><span class=p>(</span><span class=s1>&#39;github&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>redirectTo</span><span class=o>:</span> <span class=s1>&#39;/dashboard&#39;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span><span class=nx>Signin</span> <span class=kd>with</span> <span class=nx>GitHub</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>登录成功之后，可以给用户提供一个登出的入口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signOut</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth.ts&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>SignOut() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>form</span>
</span></span><span class=line><span class=cl>      <span class=na>action</span><span class=o>=</span><span class=p>{</span><span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;use server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>await</span> <span class=nx>signOut</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}}</span>
</span></span><span class=line><span class=cl>    <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span><span class=nx>Sign</span> <span class=nx>Out</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>同样，他也提供了 ClientComponents 的版本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=s1>&#39;use client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signOut</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>SignOut() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>signOut</span><span class=p>()}&gt;</span><span class=nx>Sign</span> <span class=nx>Out</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=用户信息>用户信息</h2><h3 id=servercomponents>ServerComponents</h3><p>如何判断用户的登录状态呢？可以通过获取当前用户 session 的方式来判断：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>auth</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;../auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>UserAvatar() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>auth</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserAvatar &gt; session&#39;</span><span class=p>,</span> <span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=p>{</span><span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>image</span><span class=p>}</span> <span class=na>alt</span><span class=o>=</span><span class=s>&#34;User Avatar&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>session 中保存着<strong>用户信息</strong>和<strong>过期时间</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;馬腊咯稽&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;malageji@xxxmail.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;image&#34;</span><span class=p>:</span> <span class=s2>&#34;https://avatars.githubusercontent.com/u/168389156?v=4&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;expires&#34;</span><span class=p>:</span> <span class=s2>&#34;2024-10-05T08:58:22.169Z&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=clientcomponents>ClientComponents</h3><p>如果要在 ClientComponents 中获取 session，需要使用 &lt;SessionProvider/>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// components/next-auth-provider.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s1>&#39;use client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>SessionProvider</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>NextAuthProvider</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>SessionProvider</span><span class=p>&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>SessionProvider</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 RootLayout 中引入 NextAuthProvider 组件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/layout.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>NextAuthProvider</span> <span class=kr>from</span> <span class=s1>&#39;@/components/next-auth-provider&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>RootLayout</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=nx>Readonly</span><span class=o>&lt;</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>&gt;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>NextAuthProvider</span><span class=p>&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>NextAuthProvider</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>之后，就可以在组件中调用 useSession 了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=s1>&#39;use client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useSession</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>UserAvatar() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>data</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserAvatar &gt; data&#39;</span><span class=p>,</span> <span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>data</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>image</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>img</span> <span class=na>src</span><span class=o>=</span><span class=p>{</span><span class=nx>data</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>image</span><span class=p>}</span> <span class=na>alt</span><span class=o>=</span><span class=p>{</span><span class=nx>data</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>name</span> <span class=o>||</span> <span class=s1>&#39;&#39;</span><span class=p>}</span> <span class=p>/&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=routehandlers>RouteHandlers</h3><p>对于 RouteHandlers，可以直接使用 auth 包裹请求处理函数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>auth</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>GET</span> <span class=o>=</span> <span class=nx>auth</span><span class=p>(</span><span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>req</span><span class=o>?</span><span class=p>.</span><span class=nx>auth</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>req</span><span class=o>?</span><span class=p>.</span><span class=nx>auth</span><span class=o>?</span><span class=p>.</span><span class=nx>user</span><span class=o>?</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Login Needed&#39;</span> <span class=p>},</span> <span class=p>{</span> <span class=nx>status</span>: <span class=kt>401</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>POST</span> <span class=o>=</span> <span class=nx>auth</span><span class=p>(</span><span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;POST &gt; req&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=middleware>Middleware</h3><p>首先，我们需要修改 Auth.js 的配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// auth.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>NextAuth</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>GitHub</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/github&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>signOut</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>GitHub</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 新增回调配置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>callbacks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>authorized</span>: <span class=kt>async</span> <span class=p>({</span> <span class=nx>auth</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>!!</span><span class=nx>auth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>然后，修改中间件配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>auth</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>auth</span><span class=p>(</span><span class=nx>req</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;middleware.ts &gt; req&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果没有登录 &amp;&amp; 访问的页面不是 login，就重定向到 login
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>req</span><span class=o>?</span><span class=p>.</span><span class=nx>auth</span> <span class=o>&amp;&amp;</span> <span class=nx>req</span><span class=o>?</span><span class=p>.</span><span class=nx>nextUrl</span><span class=o>?</span><span class=p>.</span><span class=nx>pathname</span> <span class=o>!==</span> <span class=s1>&#39;/login&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newUrl</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=nx>req</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>origin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>newUrl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// 排除静态资源
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=自定义登录页>自定义登录页</h2><p>在之前的例子中，调用 signIn 时，我们都传入了一个参数来明确认证方式；如果我们不明确认证方式，点击登录时，会跳转到 Auth.js 内置的登录页面：</p><p><img src=/p/next.js-%E4%B9%8B-auth.js/inner_login_page.png width=2600 height=1950 srcset="/p/next.js-%E4%B9%8B-auth.js/inner_login_page_hu9368284143056408352.png 480w, /p/next.js-%E4%B9%8B-auth.js/inner_login_page_hu15414165143721209722.png 1024w" class=gallery-image data-flex-grow=133 data-flex-basis=320px loading=lazy></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// components/sign-in.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s1>&#39;use client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>SignIn() {</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * signIn 没有传入 github、google...
</span></span></span><span class=line><span class=cl><span class=cm>   * 此时，如果点击按钮，会跳转到内置的登录页面
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>signIn</span><span class=p>()}&gt;</span><span class=nx>Signin</span> <span class=kd>with</span> <span class=nx>Me</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，页面路径为：·</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>http://localhost:3000/api/auth/signin?callbackUrl=http://localhost:3000/
</span></span></code></pre></td></tr></table></div></div><p>如果业务有需要，我们可以自定义这些页面；我们需要在 auth.ts 中，添加 pages 属性：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// auth.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=nx>NextAuth</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>Provider</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>GitHub</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/github&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Google</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/google&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>providers</span>: <span class=kt>Provider</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[</span><span class=nx>GitHub</span><span class=p>,</span> <span class=nx>Google</span><span class=p>];</span> <span class=c1>// [ [Function: GitHub], [Function: Google] ]
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>providersMap</span> <span class=o>=</span> <span class=nx>providers</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>provide</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>provide</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>name</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>provide</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>name</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>: <span class=kt>provide.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>: <span class=kt>provide.name</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>signOut</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>callbacks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>authorized</span>: <span class=kt>async</span> <span class=p>({</span> <span class=nx>auth</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>!!</span><span class=nx>auth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pages</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>signIn</span><span class=o>:</span> <span class=s1>&#39;/mySignIn&#39;</span> <span class=c1>// 添加自己的 signIn 页面对应的路由
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，点击登录按钮，会跳转到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-md data-lang=md><span class=line><span class=cl>http://localhost:3000/mySignIn?callbackUrl=http://localhost:3000/
</span></span></code></pre></td></tr></table></div></div><p>页面什么都没有，我们需要自己去实现各个按钮，并调用 signIn 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>providersMap</span><span class=p>,</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>MySignIn() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>providersMap</span><span class=p>.</span><span class=nx>map</span><span class=p>(({</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>name</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>form</span>
</span></span><span class=line><span class=cl>          <span class=na>action</span><span class=o>=</span><span class=p>{</span><span class=kr>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s1>&#39;use server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=nx>signIn</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=p>}}</span>
</span></span><span class=line><span class=cl>          <span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>id</span><span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>button</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;submit&#34;</span><span class=p>&gt;</span><span class=nx>Signin</span> <span class=kd>with</span> <span class=p>{</span><span class=nx>name</span><span class=p>}&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>))}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=扩展-session-信息>扩展 session 信息</h2><p>从前面例子看，我们只能从 session 中获取有限的信息（name、email、image）；如果我们想获取更多的信息，我们需要修改 Auth.js 的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=nx>NextAuth</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>Provider</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>GitHub</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/github&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Google</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/google&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>providers</span>: <span class=kt>Provider</span><span class=p>[]</span> <span class=o>=</span> <span class=p>[</span><span class=nx>GitHub</span><span class=p>,</span> <span class=nx>Google</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>providersMap</span> <span class=o>=</span> <span class=nx>providers</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>provide</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>provide</span> <span class=o>===</span> <span class=s1>&#39;function&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>name</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>provide</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>id</span><span class=p>,</span> <span class=nx>name</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>: <span class=kt>provide.id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>: <span class=kt>provide.name</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>signOut</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>callbacks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>authorized</span>: <span class=kt>async</span> <span class=p>({</span> <span class=nx>auth</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>!!</span><span class=nx>auth</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 向 token 添加更多的信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>jwt</span><span class=p>({</span> <span class=nx>token</span><span class=p>,</span> <span class=nx>user</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>user</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>token</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;jwt &gt; token&#39;</span><span class=p>,</span> <span class=nx>token</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span><span class=p>({</span> <span class=nx>session</span><span class=p>,</span> <span class=nx>token</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>session</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>id</span> <span class=kr>as</span> <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;session &gt; session&#39;</span><span class=p>,</span> <span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>session</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 限制用户登录，只有邮箱为 yourdomain.com 的用户才能登录
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>signIn</span><span class=p>({</span> <span class=nx>profile</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>profile</span><span class=p>.</span><span class=nx>email</span><span class=p>.</span><span class=nx>endsWith</span><span class=p>(</span><span class=s1>&#39;@yourdomain.com&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>pages</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>signIn</span><span class=o>:</span> <span class=s1>&#39;/mySignIn&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，用户信息为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;id&#34;</span><span class=p>:</span> <span class=s2>&#34;19b77615-e28f-4267-a988-7a7932uyu8i9&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;馬腊咯稽&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;email&#34;</span><span class=p>:</span> <span class=s2>&#34;malageji@xxxmail.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;image&#34;</span><span class=p>:</span> <span class=s2>&#34;https://avatars.githubusercontent.com/u/168389156?v=4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=自动刷新-token>自动刷新 token</h2><p>因为一些原因（需要对应的第三方开这个口子，比如 refresh_token 和对应的接口；同时，Auth.js 还没能解决请求竞态问题），Auth.js 还没有内置这项功能，不过官网有篇<a class=link href=https://authjs.dev/guides/refresh-token-rotation target=_blank rel=noopener>
教程
</a>。</p><p>用户在授权登录之后，access_token 会有过期时间；通常，当 access_token 过期之后，需要用户再次进行授权。我们可以在 access_token 将要过期的时候，帮用户获取新的 access_token（通常需要依赖第三方提供的 refresh_token 来刷新 access_token）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=nx>NextAuth</span><span class=p>,</span> <span class=p>{</span> <span class=kr>type</span> <span class=nx>User</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Google</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/providers/google&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>declare</span> <span class=nx>module</span> <span class=s1>&#39;next-auth&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>interface</span> <span class=nx>Session</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span><span class=o>?:</span> <span class=s1>&#39;RefreshTokenError&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>declare</span> <span class=nx>module</span> <span class=s1>&#39;next-auth/jwt&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>interface</span> <span class=nx>JWT</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>access_token</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>expires_at</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>refresh_token?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>error</span><span class=o>?:</span> <span class=s1>&#39;RefreshTokenError&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=p>{</span> <span class=nx>handlers</span><span class=p>,</span> <span class=nx>auth</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>NextAuth</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>Google</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 当 access_type 为 offline 时，Google 会提供 refresh_token
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>authorization</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>access_type</span><span class=o>:</span> <span class=s1>&#39;offline&#39;</span><span class=p>,</span> <span class=nx>prompt</span><span class=o>:</span> <span class=s1>&#39;consent&#39;</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>callbacks</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=nx>jwt</span><span class=p>({</span> <span class=nx>token</span><span class=p>,</span> <span class=nx>account</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>account</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 初次登录，保存“过期时间”和“refresh_token”
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=p>...</span><span class=nx>token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>access_token</span>: <span class=kt>account.access_token</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>expires_at</span>: <span class=kt>account.expires_at</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>refresh_token</span>: <span class=kt>account.refresh_token</span>
</span></span><span class=line><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>&lt;</span> <span class=nx>token</span><span class=p>.</span><span class=nx>expires_at</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// access_token 有效，返回 token
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// access_token 过期，用 refresh_token 去拿新的 token
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>token</span><span class=p>.</span><span class=nx>refresh_token</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=nx>TypeError</span><span class=p>(</span><span class=s1>&#39;refresh_token 没找到&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 这个接口需要第三方 Google 提供
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://oauth2.googleapis.com/token&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>method</span><span class=o>:</span> <span class=s1>&#39;POST&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>body</span>: <span class=kt>new</span> <span class=nx>URLSearchParams</span><span class=p>({</span>
</span></span><span class=line><span class=cl>              <span class=nx>client_id</span>: <span class=kt>process.env.AUTH_GOOGLE_ID</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>client_secret</span>: <span class=kt>process.env.AUTH_GOOGLE_SECRET</span><span class=o>!</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>grant_type</span><span class=o>:</span> <span class=s1>&#39;refresh_token&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>refresh_token</span>: <span class=kt>token.refresh_token</span><span class=o>!</span>
</span></span><span class=line><span class=cl>            <span class=p>})</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>tokensOrError</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>response</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=k>throw</span> <span class=nx>tokensOrError</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=kr>const</span> <span class=nx>newTokens</span> <span class=o>=</span> <span class=nx>tokensOrError</span> <span class=kr>as</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>access_token</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>expires_in</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nx>refresh_token?</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>};</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 更新 access_token
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>token</span><span class=p>.</span><span class=nx>access_token</span> <span class=o>=</span> <span class=nx>newTokens</span><span class=p>.</span><span class=nx>access_token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 更新 expires_at
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>token</span><span class=p>.</span><span class=nx>expires_at</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>floor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1000</span> <span class=o>+</span> <span class=nx>newTokens</span><span class=p>.</span><span class=nx>expires_in</span>
</span></span><span class=line><span class=cl>          <span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 有些第三方在刷新接口中不会提供 refresh_token，需要做个判断
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=nx>newTokens</span><span class=p>.</span><span class=nx>refresh_token</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>token</span><span class=p>.</span><span class=nx>refresh_token</span> <span class=o>=</span> <span class=nx>newTokens</span><span class=p>.</span><span class=nx>refresh_token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 刷新出错
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>token</span><span class=p>.</span><span class=nx>error</span> <span class=o>=</span> <span class=s1>&#39;RefreshTokenError&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nx>token</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>session</span><span class=o>:</span> <span class=p>({</span> <span class=nx>session</span><span class=p>,</span> <span class=nx>token</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 将错误信息保存在 session 中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>session</span><span class=p>.</span><span class=nx>error</span> <span class=o>=</span> <span class=nx>token</span><span class=p>.</span><span class=nx>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>session</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>如果 access_token 刷新失败，可以在 session 中获取错误信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;use server&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useEffect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>auth</span><span class=p>,</span> <span class=nx>signIn</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>Page() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>session</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>useSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>error</span> <span class=o>===</span> <span class=s1>&#39;RefreshTokenError&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=nx>signIn</span><span class=p>(</span><span class=s1>&#39;google&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=s1>&#39;use client&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useEffect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>signIn</span><span class=p>,</span> <span class=nx>useSession</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next-auth/react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Page() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>data</span>: <span class=kt>session</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>useSession</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>useEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>error</span> <span class=o>!==</span> <span class=s1>&#39;RefreshTokenError&#39;</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>signIn</span><span class=p>(</span><span class=s1>&#39;google&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>error</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=session-策略>session 策略</h2><p>Auth.js 支持两种 session 策略：<a class=link href=https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html target=_blank rel=noopener>
JWT
</a>和数据库：</p><h3 id=json-web-token>JSON Web Token</h3><p>用户登录成功时，Auth.js 将加密过的 session 保存在 cookie 中，并带上 HttpOnly 属性：</p><ul><li>不需要配置数据库；</li><li>在过期之前，不容易使 session 失效；</li><li>用户凭证保存在客户端并且大小有限制。</li></ul><h3 id=数据库>数据库</h3><p>将 session 保存在数据库并将 sessionId 保存在客户端 cookie 中：</p><ul><li>让 session 失效变得容易；</li><li>处理客户端请求时，每次都要查数据库。</li></ul><h2 id=参考>参考</h2><ul><li><a class=link href=https://www.descope.com/learn/post/magic-links target=_blank rel=noopener>What Are Magic Links and How Do They Work?</a></li><li><a class=link href=https://medium.com/@rohitkumarkhatri/next-auth-in-app-router-of-next-js-7df037f7a2ad target=_blank rel=noopener>Next-Auth in App Router of Next.js</a></li></ul></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/next.js-%E4%B9%8B-optimizations/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 Optimizations</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-datafetching/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 DataFetching</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 Rendering 与 Caching</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-approuter/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 AppRouter</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2025
<a href=https://github.com/ElementRef target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#安装>安装</a></li><li><a href=#oauth-with-github>OAuth with GitHub</a></li><li><a href=#登录登出>登录/登出</a></li><li><a href=#用户信息>用户信息</a><ol><li><a href=#servercomponents>ServerComponents</a></li><li><a href=#clientcomponents>ClientComponents</a></li><li><a href=#routehandlers>RouteHandlers</a></li><li><a href=#middleware>Middleware</a></li></ol></li><li><a href=#自定义登录页>自定义登录页</a></li><li><a href=#扩展-session-信息>扩展 session 信息</a></li><li><a href=#自动刷新-token>自动刷新 token</a></li><li><a href=#session-策略>session 策略</a><ol><li><a href=#json-web-token>JSON Web Token</a></li><li><a href=#数据库>数据库</a></li></ol></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script src=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>