<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="ngTemplateOutlet 从字面来看，就像 <router-outlet/> 之于 router 一样，ngTemplateOutlet 就是 TemplateRef 的“出口”。除了渲染 TemplateRef 之外，它还支持指定一个对象 context 作为“模版内容”的渲染上下文。
"><title>Angular 组件设计 · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/"><link rel="stylesheet" href="/scss/style.min.30cd3e7b84ff4cd8d6b6cf6b1a0f3b6922de6b38f2970fd914982d09106f2eef.css"><meta property="og:title" content="Angular 组件设计"><meta property="og:description" content="ngTemplateOutlet 从字面来看，就像 <router-outlet/> 之于 router 一样，ngTemplateOutlet 就是 TemplateRef 的“出口”。除了渲染 TemplateRef 之外，它还支持指定一个对象 context 作为“模版内容”的渲染上下文。
"><meta property="og:url" content="https://ElementRef.github.io/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-11-03T00:00:00+00:00"><meta property="article:modified_time" content="2022-11-03T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/angular.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="Angular 组件设计"><meta name="twitter:description" content="ngTemplateOutlet 从字面来看，就像 <router-outlet/> 之于 router 一样，ngTemplateOutlet 就是 TemplateRef 的“出口”。除了渲染 TemplateRef 之外，它还支持指定一个对象 context 作为“模版内容”的渲染上下文。
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/angular.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta http-equiv="Content-Security-Policy" content=" default-src 'self'; img-src 'self' data: https:; frame-src 'self' *.bilibili.com *.qq.com *.youtube.com https://youtu.be https://giscus.app; connect-src 'self' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; font-src 'self' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; script-src 'self' 'unsafe-inline' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; style-src 'self' 'unsafe-inline' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; upgrade-insecure-requests"><script src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2" crossorigin="anonymous" defer=""></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="flex container extended main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu15751654176150258532.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://douban.com/people/nicknoonan" target="_blank" title="DouBan"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-douban"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h16"></path><path d="M5 4h14"></path><path d="M8 8h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-2a2 2 0 012-2z"></path><path d="M16 14l-2 6"></path><path d="M8 17l1 3"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/"><img src="/img/cover/angular.png" alt="Angular 组件设计" fetchpriority="high" decoding="async" width="1200" height="720" jampack-sized="true"></a></div><div class="article-details"><header class="article-category"><a href="/categories/angular/">Angular</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/">Angular 组件设计</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Nov 03, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：13 分钟</time></div></footer></div></header><section class="article-content"><h2 id="ngtemplateoutlet">ngTemplateOutlet</h2><p>从字面来看，就像 &lt;router-outlet/&gt; 之于 router 一样，ngTemplateOutlet 就是 <strong>TemplateRef</strong> 的“出口”。除了渲染 TemplateRef 之外，它还支持指定一个对象 context 作为“模版内容”的渲染上下文。</p><p>Vue 的 scopedSlots 和 React 的 renderProps 以及后来的 Composition API 和 Hooks 都在践行“逻辑与 UI”的分离；因为 UI 的自由度非常高，形态千变万化，而数据逻辑的自由度就小不少，UI 更多是数据逻辑的延伸。有了 ngTemplateOutlet，也可以在 Angular 中分离逻辑与 UI（虽然 Angular 在这方面的最佳实践是“依赖注入 Service”）。</p><p>使用 ngTemplateOutlet 构造 DynamicTabListSlotComponent：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// 组件渲染了一个 ng-container，这就是 TemplateRef 的出口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'dynamic-tab-list-slot'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;ng-container
</span></span></span><span class="line"><span class="cl"><span class="sb">      *ngTemplateOutlet="tabListTemplate; context: temp"
</span></span></span><span class="line"><span class="cl"><span class="sb">    &gt;&lt;/ng-container&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ngTemplateOutlet
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 可以拆成
</span></span></span><span class="line"><span class="cl"><span class="cm">   * [ngTemplateOutlet]、[ngTemplateOutletContext]
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 两个属性
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;ng-container
</span></span></span><span class="line"><span class="cl"><span class="sb">      [ngTemplateOutlet]="tabListTemplate"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [ngTemplateOutletContext]="temp"
</span></span></span><span class="line"><span class="cl"><span class="sb">    &gt;&lt;/ng-container&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">DynamicTabListSlotComponent</span> <span class="kr">implements</span> <span class="nx">OnChanges</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 传入的请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">orgId?</span>: <span class="kt">number</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 传入的函数，用来格式化接口返回的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">formatter</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 传入的 tabListTemplate 所指向的 TemplateRef
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">tabListTemplate</span>: <span class="kt">TemplateRef</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 接口返回新的数据之后，通过自定义事件抛出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Output</span><span class="p">()</span> <span class="nx">updated</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * TemplateRef 渲染的上下文，其中包含了：
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 1. 数据集合
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 2. 请求状态
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">temp</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">loading</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tabList</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 依赖注入 ApiService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span>: <span class="kt">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果传入的“请求参数”变化，重新请求接口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">ngOnChanges</span><span class="p">(</span><span class="nx">changes</span>: <span class="kt">SimpleChanges</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span><span class="o">?</span><span class="p">.</span><span class="nx">orgId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">getTabList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 副作用函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">getTabList() {</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">park</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">orgId</span> <span class="o">!==</span> <span class="s1">'number'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nx">tabList</span> <span class="o">=</span> <span class="nx">park</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formatter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">updated</span><span class="p">.</span><span class="nx">emit</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">        <span class="nx">origin</span>: <span class="kt">park</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">formatted</span>: <span class="kt">this.temp.tabList</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 可以直接修改“上下文”中的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">dynamicTabInDailyReconciliation</span><span class="p">({</span> <span class="nx">orgId</span>: <span class="kt">this.orgId</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 请求成功，更新“上下文”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">this</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nx">tabList</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formatter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 通过自定义事件抛出数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">this</span><span class="p">.</span><span class="nx">updated</span><span class="p">.</span><span class="nx">emit</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">origin</span><span class="o">:</span> <span class="p">[...</span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="nx">formatted</span>: <span class="kt">this.temp.tabList</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 请求失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">this</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nx">tabList</span> <span class="o">=</span> <span class="nx">park</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">formatter</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">updated</span><span class="p">.</span><span class="nx">emit</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">origin</span>: <span class="kt">park</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">formatted</span>: <span class="kt">this.temp.tabList</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 更新“请求状态”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">temp</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>使用 DynamicTabListSlotComponent：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">  当 currentOrgId 发生变化
</span></span></span><span class="line"><span class="cl"><span class="c">  会重新发起请求，拉取最新数据
</span></span></span><span class="line"><span class="cl"><span class="c">  更新“上下文”，触发 updated
</span></span></span><span class="line"><span class="cl"><span class="c"> --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">app-dynamic-tab-list-slot</span>
</span></span><span class="line"><span class="cl">  <span class="err">(</span><span class="na">updated</span><span class="err">)="</span><span class="na">handleTabListUpdate</span><span class="err">($</span><span class="na">event</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">tabListTemplate</span><span class="err">]="</span><span class="na">tabListTemplate</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">formatter</span><span class="err">]="</span><span class="na">tabListFormatter</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">orgId</span><span class="err">]="</span><span class="na">currentOrgId</span><span class="err">"</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">     tabListTemplate 指向的 ng-template 包含了“渲染模版”
</span></span></span><span class="line"><span class="cl"><span class="c">     使用 let-* 语法，解构“上下文”中的属性值
</span></span></span><span class="line"><span class="cl"><span class="c">     tabListLoading -&gt; context.loading
</span></span></span><span class="line"><span class="cl"><span class="c">     tabList -&gt; context.tabList
</span></span></span><span class="line"><span class="cl"><span class="c">   --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">ng-template</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span><span class="na">tabListTemplate</span>
</span></span><span class="line"><span class="cl">    <span class="na">let-tabList</span><span class="o">=</span><span class="s">"tabList"</span>
</span></span><span class="line"><span class="cl">    <span class="na">let-tabListLoading</span><span class="o">=</span><span class="s">"loading"</span>
</span></span><span class="line"><span class="cl">  <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">      这里不仅可以是 nz-tabset，也可以是 nz-checkbox、nz-radio、nz-select ...
</span></span></span><span class="line"><span class="cl"><span class="c">     --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">nz-tabset</span>
</span></span><span class="line"><span class="cl">      <span class="na">nzSize</span><span class="o">=</span><span class="s">"small"</span>
</span></span><span class="line"><span class="cl">      <span class="na">nzTabPosition</span><span class="o">=</span><span class="s">"top"</span>
</span></span><span class="line"><span class="cl">      <span class="err">[</span><span class="na">nzTabBarGutter</span><span class="err">]="</span><span class="na">4</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">      <span class="err">[</span><span class="na">nzTabBarExtraContent</span><span class="err">]="</span><span class="na">extraTemplate</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">      <span class="err">[(</span><span class="na">nzSelectedIndex</span><span class="err">)]="</span><span class="na">currentSelectedIndex</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">      <span class="err">(</span><span class="na">nzSelectedIndexChange</span><span class="err">)="</span><span class="na">handleSelectedIndexChange</span><span class="err">($</span><span class="na">event</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">    <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">nz-tab</span> <span class="na">nzTitle</span><span class="o">=</span><span class="s">"代征"</span> <span class="err">*</span><span class="na">ngIf</span><span class="o">=</span><span class="s">"tabList.includes(Service.dz)"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">ng-template</span> <span class="na">nz-tab</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">app-reconciliation</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">orgId</span><span class="err">]="</span><span class="na">currentOrgId</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">platform</span><span class="err">]="</span><span class="na">Service</span><span class="err">.</span><span class="na">dz</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">selectedIndex</span><span class="err">]="</span><span class="na">currentSelectedIndex</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">          <span class="p">&gt;&lt;/</span><span class="nt">app-reconciliation</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">ng-template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">nz-tab</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">nz-tab</span> <span class="na">nzTitle</span><span class="o">=</span><span class="s">"轻税"</span> <span class="err">*</span><span class="na">ngIf</span><span class="o">=</span><span class="s">"tabList.includes(Service.qs)"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">ng-template</span> <span class="na">nz-tab</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">app-reconciliation</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">orgId</span><span class="err">]="</span><span class="na">currentOrgId</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">platform</span><span class="err">]="</span><span class="na">Service</span><span class="err">.</span><span class="na">qs</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">            <span class="err">[</span><span class="na">selectedIndex</span><span class="err">]="</span><span class="na">currentSelectedIndex</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">          <span class="p">&gt;&lt;/</span><span class="nt">app-reconciliation</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">ng-template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">nz-tab</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      ...
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">nz-tabset</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">ng-template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">app-dynamic-tab-list-slot</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>createEmbeddedView 可以替代 ngTemplateOutlet 指令；同时，如果“逻辑组件”仅有一个 ngTemplateOutlet（仅渲染一个 TemplateRef），可以使用 ContentChild 获取 TemplateRef：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-codes'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;ng-container #vcf&gt;&lt;/ng-container&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">CodesComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">AfterViewInit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里不再使用 @Input，而是直接通过 ContentChild 获取 TemplateRef
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@ContentChild</span><span class="p">(</span><span class="nx">TemplateRef</span><span class="p">)</span> <span class="nx">content</span>: <span class="kt">TemplateRef</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里必须使用 { read: ViewContainerRef } 明确 ViewChild 的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@ViewChild</span><span class="p">(</span><span class="s1">'vcf'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">read</span>: <span class="kt">ViewContainerRef</span> <span class="p">})</span> <span class="nx">vcf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Output</span><span class="p">()</span> <span class="nx">update</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">[]</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">codes</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="kr">type</span><span class="o">:</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">list</span>: <span class="kt">CodeItem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="s1">'云票'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">code</span><span class="o">:</span> <span class="s1">'yp'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">children</span><span class="o">:</span> <span class="p">[...</span><span class="nx">adminMenus</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="s1">'账套管理'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">code</span><span class="o">:</span> <span class="s1">'zt'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">children</span><span class="o">:</span> <span class="p">[...</span><span class="nx">adminBatchMenus</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="s1">'记账中心'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">code</span><span class="o">:</span> <span class="s1">'jz'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">children</span><span class="o">:</span> <span class="p">[...</span><span class="nx">adminNoteMenus</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">cdf</span>: <span class="kt">ChangeDetectorRef</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用传来的 codes 对数据进行初始化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[...</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">temp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleInitWithFilter</span><span class="p">(</span><span class="nx">temp</span> <span class="kr">as</span> <span class="nx">CodeItem</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">temp</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleInitWithCodes</span><span class="p">(</span><span class="nx">temp</span> <span class="kr">as</span> <span class="nx">CodeItem</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">active</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">temp</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngAfterViewInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * this.vcf 初始化完成后，在 this.vcf 中渲染 this.content
</span></span></span><span class="line"><span class="cl"><span class="cm">     * createEmbeddedView 的第二个参数为“渲染上下文”
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这里将数据 list 绑定到“缺省”属性 $implicit 上
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 同时将“用户操作”封装在 handleChecked 中
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">?</span><span class="p">.</span><span class="nx">vcf</span><span class="o">?</span><span class="p">.</span><span class="nx">createEmbeddedView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">handleChecked</span><span class="o">:</span> <span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleChecked</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nx">$implicit</span>: <span class="kt">this.list</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">cdf</span><span class="p">.</span><span class="nx">detectChanges</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 下面这些繁琐复杂的逻辑被封装在组件内部，对外只暴露了“渲染上下文”中的两个属性
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">handleInitWithFilter</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleInitWithCodes</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleGenCodes</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span> <span class="nx">temp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleChecked</span><span class="p">({</span> <span class="nx">code</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">temp</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="p">[...</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleItem</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">item</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">handleGenCodes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">,</span> <span class="nx">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">temp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleItem</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleAll</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">checked</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>从 context 中取出 list 和 handleChecked 即可完成 UI 的渲染：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">app-codes</span> <span class="err">[</span><span class="na">type</span><span class="err">]="</span><span class="na">type</span><span class="err">"</span> <span class="err">[</span><span class="na">codes</span><span class="err">]="</span><span class="na">role</span><span class="err">.</span><span class="na">codes</span><span class="err">"</span> <span class="err">(</span><span class="na">update</span><span class="err">)="</span><span class="na">handleUpdate</span><span class="err">($</span><span class="na">event</span><span class="err">)"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">    UI 包含在 ng-template 中，背后的逻辑封装在 CodesComponent 中
</span></span></span><span class="line"><span class="cl"><span class="c">    CodesComponent 内部 ContentChild 的存在使得不再需要“模版变量”
</span></span></span><span class="line"><span class="cl"><span class="c">    CodesComponent 通过 ContentChild 来获取 ng-template 的引用
</span></span></span><span class="line"><span class="cl"><span class="c">    同时，通过 let-* 语法，解构出 context 中的属性
</span></span></span><span class="line"><span class="cl"><span class="c">   --&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">ng-template</span> <span class="na">let-list</span> <span class="na">let-handleChecked</span><span class="o">=</span><span class="s">"handleChecked"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">nz-collapse</span> <span class="err">[</span><span class="na">nzAccordion</span><span class="err">]="</span><span class="na">true</span><span class="err">"</span> <span class="err">[</span><span class="na">nzBordered</span><span class="err">]="</span><span class="na">false</span><span class="err">"</span> <span class="err">[</span><span class="na">nzGhost</span><span class="err">]="</span><span class="na">false</span><span class="err">"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">nz-collapse-panel</span>
</span></span><span class="line"><span class="cl">          <span class="err">*</span><span class="na">ngFor</span><span class="o">=</span><span class="s">"let f1 of list"</span>
</span></span><span class="line"><span class="cl">          <span class="err">[</span><span class="na">nzHeader</span><span class="err">]="</span><span class="na">collapsePanelHeader</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">          <span class="err">[(</span><span class="na">nzActive</span><span class="err">)]="</span><span class="na">f1</span><span class="err">.</span><span class="na">active</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">          <span class="err">[</span><span class="na">nzShowArrow</span><span class="err">]="</span><span class="na">false</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">        <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"collapse-panel-content"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-row</span> <span class="err">*</span><span class="na">ngFor</span><span class="o">=</span><span class="s">"let f2 of f1.children"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-col</span> <span class="na">nzSpan</span><span class="o">=</span><span class="s">"6"</span> <span class="na">class</span><span class="o">=</span><span class="s">"left-cell label-cell"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">label</span>
</span></span><span class="line"><span class="cl">                  <span class="na">nz-checkbox</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModel</span><span class="err">]="</span><span class="na">f2</span><span class="err">.</span><span class="na">checked</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModelOptions</span><span class="err">]="{</span> <span class="na">standalone:</span> <span class="na">true</span> <span class="err">}"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">(</span><span class="na">ngModelChange</span><span class="err">)="</span><span class="na">handleChecked</span><span class="err">($</span><span class="na">event</span><span class="err">,</span> <span class="na">f2</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">                <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  {{ f2.name }}
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-col</span> <span class="na">nzSpan</span><span class="o">=</span><span class="s">"18"</span> <span class="na">class</span><span class="o">=</span><span class="s">"right-cell label-cell"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">label</span>
</span></span><span class="line"><span class="cl">                  <span class="err">*</span><span class="na">ngFor</span><span class="o">=</span><span class="s">"let f3 of f2.children"</span>
</span></span><span class="line"><span class="cl">                  <span class="na">nz-checkbox</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModel</span><span class="err">]="</span><span class="na">f3</span><span class="err">.</span><span class="na">checked</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModelOptions</span><span class="err">]="{</span> <span class="na">standalone:</span> <span class="na">true</span> <span class="err">}"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">(</span><span class="na">ngModelChange</span><span class="err">)="</span><span class="na">handleChecked</span><span class="err">($</span><span class="na">event</span><span class="err">,</span> <span class="na">f3</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">                <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  {{ f3.name }}
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;</span><span class="nt">ng-template</span> <span class="err">#</span><span class="na">collapsePanelHeader</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-row</span> <span class="na">class</span><span class="o">=</span><span class="s">"collapse-panel-header"</span> <span class="na">nzAlign</span><span class="o">=</span><span class="s">"middle"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-col</span> <span class="err">[</span><span class="na">nzSpan</span><span class="err">]="</span><span class="na">12</span><span class="err">"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">label</span>
</span></span><span class="line"><span class="cl">                  <span class="na">nz-checkbox</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModel</span><span class="err">]="</span><span class="na">f1</span><span class="err">.</span><span class="na">checked</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">[</span><span class="na">ngModelOptions</span><span class="err">]="{</span> <span class="na">standalone:</span> <span class="na">true</span> <span class="err">}"</span>
</span></span><span class="line"><span class="cl">                  <span class="err">(</span><span class="na">ngModelChange</span><span class="err">)="</span><span class="na">handleChecked</span><span class="err">($</span><span class="na">event</span><span class="err">,</span> <span class="na">f1</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">                <span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  {{ f1.name }}
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-col</span> <span class="err">[</span><span class="na">nzSpan</span><span class="err">]="</span><span class="na">12</span><span class="err">"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">nz-row</span> <span class="na">nzJustify</span><span class="o">=</span><span class="s">"end"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">nz-button</span> <span class="na">nzType</span><span class="o">=</span><span class="s">"link"</span> <span class="err">*</span><span class="na">ngIf</span><span class="o">=</span><span class="s">"f1.active"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    收起
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">nz-icon</span> <span class="na">nzType</span><span class="o">=</span><span class="s">"up"</span> <span class="na">nzTheme</span><span class="o">=</span><span class="s">"outline"</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">nz-button</span> <span class="na">nzType</span><span class="o">=</span><span class="s">"link"</span> <span class="err">*</span><span class="na">ngIf</span><span class="o">=</span><span class="s">"!f1.active"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                    展开
</span></span><span class="line"><span class="cl">                    <span class="p">&lt;</span><span class="nt">i</span> <span class="na">nz-icon</span> <span class="na">nzType</span><span class="o">=</span><span class="s">"down"</span> <span class="na">nzTheme</span><span class="o">=</span><span class="s">"outline"</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="p">&lt;/</span><span class="nt">ng-template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;/</span><span class="nt">nz-collapse-panel</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">nz-collapse</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">ng-template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">app-codes</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="ngcomponentoutlet">ngComponentOutlet</h2><p>组件类装饰器中有一个可选的属性 selector，selector 决定了组件的实例化位置；当组件装饰器中缺少 selector 属性（或者 selector 属性值为空）时，Ng 会为其生成一个 &lt;ng-component/&gt; 标签。</p><p>没有 selector 属性的组件可以通过以下两种方式渲染到页面中：</p><ol><li>ngComponentOutlet；</li><li>router-outlet。</li></ol><p>&lt;router-outlet/&gt; 不用多说了；和 ngTemplateOutlet 一样，ngComponentOutlet 也是通过 ng-container 渲染组件的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-ng-component-outlet-example'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;ng-container *ngComponentOutlet="component"&gt;&lt;/ng-container&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;button type="button" (click)="handleComponentSwitch()"&gt;switch&lt;/button&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">NgComponentOutletExampleComponent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">component</span>: <span class="kt">any</span> <span class="o">=</span> <span class="nx">AComponent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleComponentSwitch() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">component</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'A'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">component</span> <span class="o">=</span> <span class="nx">BComponent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">component</span> <span class="o">=</span> <span class="nx">AComponent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>是不是眼熟<a class="link" href="https://cn.vuejs.org/api/built-in-special-elements.html#component" target="_blank" rel="noopener">
&lt;component/&gt;</a></p><h2 id="formcontrolname">formControlName</h2><p>在自定义元素上使用 formControlName：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 首先，需要明确一点
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 无论是“模版驱动表单（ngModel）”
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 还是“响应式表单（formControlName）”
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 内部实现都是 FormControl
</span></span></span><span class="line"><span class="cl"><span class="cm"> * NgModel 内部继承了 FormControl
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">OnChangeType</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">OnTouchedType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-administrative-division'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这里没有使用 forwardRef 的必要
</span></span></span><span class="line"><span class="cl"><span class="cm">     * forwardRef 的作用是“返回对‘值’的引用”
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 因为，“类修饰符”是在“类被定义”之后才生效的
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 所以，无需使用 forwardRef 将“类的引用”捕获在闭包里
</span></span></span><span class="line"><span class="cl"><span class="cm">     * useExisting 的意思是，复用已经存在的实例，而不是重新创建一个私有实例
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// useExisting: forwardRef(() =&gt; AdministrativeDivisionComponent),
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">useExisting</span>: <span class="kt">AdministrativeDivisionComponent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">provide</span>: <span class="kt">NG_VALUE_ACCESSOR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">multi</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">AdministrativeDivisionComponent</span>
</span></span><span class="line"><span class="cl">  <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">ControlValueAccessor</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ControlValueAccessor 在“Form API”和“DOM”之间扮演者桥梁的角色
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 组件通过将自身注册为 NG_VALUE_ACCESSOR
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 并且 implements ControlValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 任何自定义组件都能和“Form API”进行沟通
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 原生表单元素能和“Form API”沟通的原因是
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Angular 内部已经帮助实现了一部分“指令”：
</span></span></span><span class="line"><span class="cl"><span class="cm">   * SelectMultipleControlValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * CheckboxControlValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * SelectControlValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * RadioControlValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * DefaultValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * NumberValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   * RangeValueAccessor
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzDisabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">placeholder</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Output</span><span class="p">()</span> <span class="kr">readonly</span> <span class="nx">nzValueChange</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@ViewChild</span><span class="p">(</span><span class="s1">'buttonElement'</span><span class="p">)</span> <span class="nx">buttonElement</span><span class="o">!:</span> <span class="nx">ElementRef</span><span class="p">&lt;</span><span class="nt">HTMLButtonElement</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@ViewChild</span><span class="p">(</span><span class="s1">'selectElement'</span><span class="p">)</span> <span class="nx">selectElement</span><span class="o">!:</span> <span class="nx">ElementRef</span><span class="p">&lt;</span><span class="nt">HTMLSelectElement</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">provinceValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cityValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">areaValue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">currentProvinceList</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">currentCityList</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">currentAreaList</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loadingProvinceList</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loadingCityList</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loadingAreaList</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">isEditMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">onChange</span>: <span class="kt">OnChangeType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onTouched</span>: <span class="kt">OnTouchedType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span>: <span class="kt">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentProvinceList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">focus</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isEditMode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">selectElement</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">buttonElement</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">blur</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isEditMode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">selectElement</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">buttonElement</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 接收 FormControl 传来的 value
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 将 value 更新到 UI 上
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">writeValue</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * registerOnChange 会被 FormControl 用来注册回调 fn
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 当 UI 中的值变化时，fn 会被调用
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registerOnChange</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">OnChangeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 用来处理用户对组件的交互
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 通常可以不用处理交互
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registerOnTouched</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">OnTouchedType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onTouched</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setDisabledState</span><span class="p">(</span><span class="nx">disabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzDisabled</span> <span class="o">=</span> <span class="nx">disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleSwitch2Edit() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">isEditMode</span> <span class="o">=</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isEditMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleProvinceValueChange</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">provinceValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentCityList</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleCityValueChange</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">cityValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">getCurrentAreaList</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleAreaValueChange</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">areaValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">provinceName</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">provinceValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">cityName</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">cityValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">areaName</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">areaValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="sb">`</span><span class="si">${</span><span class="nx">provinceName</span><span class="si">}${</span><span class="nx">cityName</span><span class="si">}${</span><span class="nx">areaName</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">isEditMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzValueChange</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getCurrentProvinceList() {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getCurrentCityList</span><span class="p">({</span> <span class="nx">provinceId</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getCurrentAreaList</span><span class="p">({</span> <span class="nx">cityId</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>将自身注册为 NG_VALUE_ACCESSOR 这种方式有一些局限，它在 Validator 被触发时，不能根据验证结果作出反应；但是优势是<strong>可以绑定自定义事件</strong>。</p><p>如果需要对 Validator 作出反应，可以依赖注入 <strong>NgControl</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">OnChangeType</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">null</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">type</span> <span class="nx">OnTouchedType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'hema-quarterly-picker'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">'./hema-quarterly-picker.component.html'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">styleUrls</span><span class="o">:</span> <span class="p">[</span><span class="s1">'./hema-quarterly-picker.component.scss'</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HemaQuarterlyPickerComponent</span> <span class="kr">implements</span> <span class="nx">ControlValueAccessor</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzValue</span>: <span class="kt">string</span><span class="p">[];</span> <span class="c1">// 默认日期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzDisabled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzPlaceHolder</span> <span class="o">=</span> <span class="s1">'请选择'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">nzAllowClear</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">style</span>: <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">onChange</span>: <span class="kt">OnChangeType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onTouched</span>: <span class="kt">OnTouchedType</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">quarterMonth</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">quarterly</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">year</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cachYear</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">interval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">showClose</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">isError() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">dirty</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">invalid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">control</span>: <span class="kt">NgControl</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取 NgControl 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">control</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">control</span><span class="p">.</span><span class="nx">valueAccessor</span> <span class="o">=</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">writeValue</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">string</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">handleInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registerOnChange</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">OnChangeType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">registerOnTouched</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">OnTouchedType</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onTouched</span> <span class="o">=</span> <span class="nx">fn</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setDisabledState</span><span class="p">(</span><span class="nx">disabled</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzDisabled</span> <span class="o">=</span> <span class="nx">disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleChange</span><span class="p">(</span><span class="nx">value</span>: <span class="kt">string</span><span class="p">[])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nzValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="asyncpipe">asyncPipe</h2><p>一般情况下，我们会在 ngOnInit 中请求组件需要的初始化数据；但是这会导致相关的副作用散落在组件的各个部分。</p><p>借助 Angular 提供的 AsyncPipe，组件可以以流的形式来处理这部分逻辑；这样，相关逻辑就被数据流“串联”起来了：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;nz-table
</span></span></span><span class="line"><span class="cl"><span class="sb">      (nzPageIndexChange)="handlePageIndexChange($event)"
</span></span></span><span class="line"><span class="cl"><span class="sb">      (nzPageSizeChange)="handlePageSizeChange($event)"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [nzData]="banlanceList$ | async as banlanceList"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [nzPageIndex]="paginationData.pageIndex"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [nzPageSize]="paginationData.pageSize"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [nzTotal]="paginationData.total"
</span></span></span><span class="line"><span class="cl"><span class="sb">      [nzLoading]="loading"
</span></span></span><span class="line"><span class="cl"><span class="sb">    &gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">      &lt;tbody&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">        &lt;tr *ngFor="let item of banlanceList"&gt;...&lt;/tr&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">      &lt;/tbody&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;/nz-table&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ExclusiveAccountBalanceComponent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 数据流起始于路由查询参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">banlanceList$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">queryParams</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行“请求发起前”的副作用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tap</span><span class="p">((</span><span class="nx">params</span>: <span class="kt">SearchParams</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">lastQueryParams</span> <span class="o">=</span> <span class="nx">params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 切换到数据请求数据流，发起请求并会自动舍弃上次请求（自动处理竞态问题）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">switchMap</span><span class="p">(</span><span class="nx">params</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">exclusiveDailyAccountBalancePage</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行“请求发起后”的副作用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tap</span><span class="p">(({</span> <span class="nx">pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">paginationData</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">paginationData</span> <span class="o">=</span> <span class="nx">paginationData</span> <span class="kr">as</span> <span class="nx">PaginationData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">pages</span> <span class="o">=</span> <span class="nx">pages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 对数据流进行格式化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">map</span><span class="p">(({</span> <span class="nx">records</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">records</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">paginationData</span>: <span class="kt">PaginationData</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">pageIndex</span>: <span class="kt">1</span><span class="p">,</span> <span class="nx">pageSize</span>: <span class="kt">10</span><span class="p">,</span> <span class="nx">total</span>: <span class="kt">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pages</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">lastQueryParams</span>: <span class="kt">SearchParams</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">loading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">apiService</span>: <span class="kt">ApiService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">router</span>: <span class="kt">Router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">route</span>: <span class="kt">ActivatedRoute</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">handleSearched</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 路由查询参数变化，新的数据被放入数据流中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([],</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">relativeTo</span>: <span class="kt">this.route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">queryParams</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">queryParamsHandling</span><span class="o">:</span> <span class="s1">'merge'</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleRefreshed() {</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将上次的查询数据，重新放入数据流中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">banlanceList$</span> <span class="kr">as</span> <span class="nx">AnonymousSubject</span><span class="p">&lt;</span><span class="nt">SearchParams</span><span class="p">&gt;).</span><span class="nx">next</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">lastQueryParams</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="directive">directive</h2><p>指令的好处是，可以在同一元素上叠加多个指令来完成不同的逻辑。</p><p><img src="/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/directive.svg" alt="LocalImage" loading="lazy" decoding="async"></p><ul><li>指令 carousel 绑定了三个 key：from、autoplay、withDelay；</li><li>对应传入的值也有三个：images、‘on’、2000。</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Directive</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'[carousel]'</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">CarouselDirective</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">(</span><span class="nx">carouselFrom</span><span class="p">)</span> <span class="nx">images</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">(</span><span class="nx">carouselAutoplay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span> <span class="nx">autoplay</span><span class="p">(</span><span class="nx">autoplay</span><span class="o">:</span> <span class="s1">'on'</span> <span class="o">|</span> <span class="s1">'off'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">autoplay</span> <span class="o">===</span> <span class="s1">'on'</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAutoplayTimer</span><span class="p">()</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">clearAutoplayTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Input</span><span class="p">(</span><span class="nx">carouselWithDelay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">set</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">delay</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">_autoplayDelay</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">delay() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_autoplayDelay</span> <span class="o">||</span> <span class="mi">1000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">_autoplayDelay</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">setAutoplayTimer() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">timerId</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">delay</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">clearAutoplayTimer() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">clearInterval</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timerId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">context</span>: <span class="kt">CarouselContext</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">timerId</span>: <span class="kt">number</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">index</span>: <span class="kt">number</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">tpl</span>: <span class="kt">TemplateRef</span><span class="p">&lt;</span><span class="nt">CarouselContext</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">vcr</span>: <span class="kt">ViewContainerRef</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">$implicit</span>: <span class="kt">this.images</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">controller</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">next</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">next</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">prev</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">prev</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">vcr</span><span class="p">.</span><span class="nx">createEmbeddedView</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tpl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnDestroy() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">clearAutoplayTimer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">next() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">$implicit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">prev() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">$implicit</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">images</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>使用指令：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="err">*</span><span class="na">carousel</span><span class="o">=</span><span class="s">"let item from images autoplay 'on' withDelay 1500"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">img</span> <span class="err">[</span><span class="na">src</span><span class="err">]="</span><span class="na">item</span><span class="err">"</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span> <span class="err">*</span><span class="na">carousel</span><span class="o">=</span><span class="s">"let item from images; let ctrl = controller autoplay 'off'"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">img</span> <span class="err">[</span><span class="na">src</span><span class="err">]="</span><span class="na">item</span><span class="err">"</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">ctrl</span><span class="err">.</span><span class="na">prev</span><span class="err">()"</span><span class="p">&gt;</span><span class="ni">&amp;lt;</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">button</span> <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">ctrl</span><span class="err">.</span><span class="na">next</span><span class="err">()"</span><span class="p">&gt;</span><span class="ni">&amp;gt;</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="intersectiondirective">IntersectionDirective</h3><p>在实际业务中，遇到了评论自动加载的场景，这里借助 IntersectionObserver 实现这个指令：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Directive</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'[intersection]'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">standalone</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">IntersectionDirective</span> <span class="kr">implements</span> <span class="nx">OnChanges</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Output</span><span class="p">()</span> <span class="nx">intersectionChange</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">&lt;</span><span class="nt">boolean</span><span class="p">&gt;();</span> <span class="c1">// 事件回调
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">root</span>: <span class="kt">HTMLElement</span> <span class="o">|</span> <span class="kc">null</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span> <span class="c1">// 交叉元素
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">debounceTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// 去抖时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">@Input</span><span class="p">()</span> <span class="nx">threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 交叉阈值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">isIntersecting</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">observer</span>: <span class="kt">IntersectionObserver</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 初始化一个 Observer 对象，Subject 不需要初始值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">private</span> <span class="nx">subject$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">isIntersecting</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 注入 ElementRef 之后，能拿到指令的「绑定元素」
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">element</span>: <span class="kt">ElementRef</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 当入参有变化，重新 observer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">ngOnChanges</span><span class="p">(</span><span class="nx">changes</span>: <span class="kt">SimpleChanges</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">changes</span><span class="p">.</span><span class="nx">debounceTime</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">changes</span><span class="p">.</span><span class="nx">threshold</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 注销之前的 observer，并重新初始化 IntersectionObserver
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">.</span><span class="nx">unobserve</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="o">?</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">createObservable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 卸载时，销毁状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">ngOnDestroy</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">subject$</span><span class="p">.</span><span class="nx">complete</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">observer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">createObservable() {</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">root</span>: <span class="kt">this.root</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rootMargin</span><span class="o">:</span> <span class="s1">'0px'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">threshold</span>: <span class="kt">this.threshold</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">observer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">IntersectionObserver</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handleIntersect</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">observer</span><span class="p">.</span><span class="nx">observe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">element</span><span class="o">?</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 将结果抛出去
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">subject$</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">debounceTime</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">debounceTime</span><span class="p">),</span> <span class="nx">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(({</span> <span class="nx">isIntersecting</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">intersectionChange</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">isIntersecting</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleIntersect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">entries</span>: <span class="kt">IntersectionObserverEntry</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nx">observer</span>: <span class="kt">IntersectionObserver</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">isIntersectingHandler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">entry</span>: <span class="kt">IntersectionObserverEntry</span><span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">entry</span><span class="p">.</span><span class="nx">isIntersecting</span> <span class="o">||</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">intersectionRatio</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">threshold</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">entries</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">entry</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">isIntersectingHandler</span><span class="p">(</span><span class="nx">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 当结果变化时，再向 subject$ 写入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isIntersecting</span> <span class="o">!==</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">isIntersecting</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">subject$</span><span class="p">.</span><span class="nx">next</span><span class="p">({</span> <span class="nx">isIntersecting</span>: <span class="kt">result</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>使用：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">div</span>
</span></span><span class="line"><span class="cl">  <span class="na">intersection</span>
</span></span><span class="line"><span class="cl">  <span class="err">(</span><span class="na">intersectionChange</span><span class="err">)="</span><span class="na">handleLoadMore</span><span class="err">($</span><span class="na">event</span><span class="err">)"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">root</span><span class="err">]="</span><span class="na">remarkListContainer</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">debounceTime</span><span class="err">]="</span><span class="na">50</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">  <span class="err">[</span><span class="na">threshold</span><span class="err">]="</span><span class="na">0.5</span><span class="err">"</span>
</span></span><span class="line"><span class="cl">  <span class="na">class</span><span class="o">=</span><span class="s">"h-[4px]"</span>
</span></span><span class="line"><span class="cl"><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">handleLoadMore</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">canNextPage</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 加载下一页数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">pageParams</span><span class="p">.</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">handleRemarkList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="runoutsideangular">runOutsideAngular</h2><p>在 Angular 中，DOM 事件的触发会导致 Ng 进行“变更检测”；如果该事件的副作用最终没有造成“绑定值”的更新；那么当前的“变更检测”就是多余的。</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-event-listener'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;button nz-button nzType="primary" (click)="handleClick($event)"&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">      点击
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;/button&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">EventListenerComponent</span> <span class="kr">implements</span> <span class="nx">AfterViewChecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngAfterViewChecked</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 每次“变更检测”之后调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'AfterViewChecked'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleClick</span><span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 执行的副作用和 Angular 无关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 每次点击按钮，控制台依次输出：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PointerEvent {...}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AfterViewChecked
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这么看来，最理想的状态是，只对<strong>会造成“绑定值”更新的副作用</strong>进行“变更检测”（这不就是 Vue 吗？）；但是，Ng 没有响应式系统，它只能通过 NgZone 拦截所有可能导致数据变更的函数调用来处理数据“响应”。好在 NgZone 提供了一个 runOutsideAngular 方法，可以使副作用的执行不触发“变更检测”：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-event-listener'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;button nz-button nzType="primary" (click)="handleClick($event)"&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">      点击
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;/button&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">EventListenerComponent</span> <span class="kr">implements</span> <span class="nx">AfterViewChecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">zone</span>: <span class="kt">NgZone</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngAfterViewChecked</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 每次“变更检测”之后调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'AfterViewChecked'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">handleClick</span><span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 使用 runOutsideAngular 包裹“副作用”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">runOutsideAngular</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 每次点击按钮，控制台依次输出：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PointerEvent {...}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * AfterViewChecked
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>可以看到 runOutsideAngular 并没有起作用，原因是事件回调 handleClick 已经注册在了 Ng 内部：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-event-listener'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;button #btn nz-button nzType="primary"&gt;点击&lt;/button&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">EventListenerComponent</span> <span class="kr">implements</span> <span class="nx">AfterViewInit</span><span class="p">,</span> <span class="nx">AfterViewChecked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@ViewChild</span><span class="p">(</span><span class="s1">'btn'</span><span class="p">)</span> <span class="nx">btn</span><span class="o">!:</span> <span class="nx">ElementRef</span><span class="p">&lt;</span><span class="nt">HTMLButtonElement</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">renderer</span>: <span class="kt">Renderer2</span><span class="p">,</span> <span class="kr">private</span> <span class="nx">zone</span>: <span class="kt">NgZone</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngAfterViewInit</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">runOutsideAngular</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 以下三种均在 runOutsideAngular 内部完成事件的绑定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">setupClickListener1</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">setupClickListener2</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">setupClickListener3</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngAfterViewChecked</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'AfterViewChecked'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setupClickListener1() {</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">btn</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">elementRef</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'click'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setupClickListener2() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">btn</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">elementRef</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'click'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setupClickListener3() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fromEvent</span><span class="p">((</span><span class="k">this</span><span class="p">.</span><span class="nx">btn</span> <span class="kr">as</span> <span class="kt">any</span><span class="p">).</span><span class="nx">elementRef</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">,</span> <span class="s1">'click'</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 以上三种绑定方式，每次点击按钮，控制台依次输出：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PointerEvent {...}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>可以使用“指令”将这部分逻辑进行封装：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Directive</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'[click.zoneless]'</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ClickZonelessDirective</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">@Output</span><span class="p">(</span><span class="s1">'click.zoneless'</span><span class="p">)</span> <span class="nx">clickZoneless</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventEmitter</span><span class="p">&lt;</span><span class="nt">MouseEvent</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">removeListener</span>: <span class="kt">Function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">zone</span>: <span class="kt">NgZone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">el</span>: <span class="kt">ElementRef</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">renderer</span>: <span class="kt">Renderer2</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">zone</span><span class="p">.</span><span class="nx">runOutsideAngular</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">setupListener</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnDestroy() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">setupListener() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">removeListener</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">nativeElement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'click'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="nx">e</span>: <span class="kt">MouseEvent</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">clickZoneless</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 每次点击按钮，控制台依次输出：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * PointerEvent {...}
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但是这种方式不够灵活，总不能一种事件就写一个指令。可以借助 <a class="link" href="https://angular.cn/api/platform-browser/EventManager" target="_blank" rel="noopener">EventManager
</a>实现同样的效果。</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// zoneless-event.service.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">@Injectable</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">providedIn</span><span class="o">:</span> <span class="s1">'root'</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ZonelessEventService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">manager</span>: <span class="kt">EventManager</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">supports</span><span class="p">(</span><span class="nx">eventName</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'.zoneless'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">addEventListener</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">element</span>: <span class="kt">HTMLElement</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">eventName</span>: <span class="kt">keyof</span> <span class="nx">HTMLElementEventMap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handler</span>: <span class="kt">EventListener</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">[</span><span class="nx">nativeEventName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">eventName</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">manager</span><span class="p">.</span><span class="nx">getZone</span><span class="p">().</span><span class="nx">runOutsideAngular</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">nativeEventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">element</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">nativeEventName</span><span class="p">,</span> <span class="nx">handler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// app.module.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">@NgModule</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bootstrap</span><span class="o">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">declarations</span><span class="o">:</span> <span class="p">[</span><span class="nx">AppComponent</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">imports</span><span class="o">:</span> <span class="p">[</span><span class="nx">BrowserModule</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// @Inject(EVENT_MANAGER_PLUGINS) 就可以拿到 ZonelessEventService
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">provide</span>: <span class="kt">EVENT_MANAGER_PLUGINS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">useClass</span>: <span class="kt">ZonelessEventService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">multi</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">AppModule</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="expressionchangedafterithasbeencheckederror">ExpressionChangedAfterItHasBeenCheckedError</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">template</span><span class="o">:</span> <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;label nz-checkbox [(ngModel)]="checkbox"&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">      &lt;span [textContent]="time | date : 'hh:mm:ss:SSS'"&gt;&lt;/span&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">    &lt;/label&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">  `</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-example'</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ListComponent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">checkbox</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">time() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 每次勾选多选框，控制台输出：
</span></span></span><span class="line"><span class="cl"><span class="cm"> * NG0100: ExpressionChangedAfterItHasBeenCheckedError: Expression has changed after it was checked.
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ...
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>控制台会报**<a class="link" href="https://angular.cn/errors/NG0100" target="_blank" rel="noopener">
NG100 错误
</a>**，原因是多选框的勾选会改变 checkbox，从而触发“变更检测”，导致 DOM 更新，在 DOM 重新渲染的过程中，timeGetter 的返回值和在“变更检测”过程中的返回值不同；渲染前后的值的不同被“发现”了，导致错误被抛出。</p><p>值的变化是什么时候被发现的呢？在组件被渲染到页面的过程中，组件内部会有一个被称为 View 的数据结构，保存着<strong>对组件实例的引用</strong>和<strong>绑定表达式的值</strong>；在变更检测过程中，编译器会将需要更新的 DOM 属性打上标记；对于每个被标记的属性，编译器都会创建一个绑定，该绑定定义了<strong>要更新的属性名称</strong>以及<strong>用来获取新值的表达式</strong>。</p><p>在“变更检测”过程中，会运行<strong>编译器为视图生成的</strong>所有绑定表达式，并将执行结果和<strong>储存在 View 中的 oldValue</strong>进行比较，这就是“脏”检查的由来；如果值有变化，那么就会更新“界面”和“oldValue”；当前组件的“变更检测”进行完毕，就会对“子组件”进行相同的操作。</p><p>在上述例子中，Angular 在 spanView 和 timeGetter 之间建立了一种绑定关系；在每次检测过程中，绑定表达式被执行，timeGetter 返回的时间戳并被日期管道处理，日期管道返回的值会和 oldValue 进行比较，如果检测到值的差异，spanView 的 textContent 会被更新。</p><p>在开发环境中，每个“变更检测周期（整个组件树完成变更检测）”之后会<strong>同步</strong>进行一次“额外的检测”，以确保“最终值”和变更检测过程中的值一致；不同于“变更检测”，在“额外检测”过程中，如果检测到“值的不同”，不会进行<strong>视图更新</strong>，而是抛出<strong>ExpressionChangedAfterItHasBeenCheckedError</strong>错误。</p><p>简单的说，如果值<strong>总是</strong>在“变更检测”期间发生变化，就会造成“变更检测死循环”；“ExpressionChangedAfterItHasBeenCheckedError”错误就是在出现“变更检测死循环”的情况下被抛出的；或者说，当应用<strong>内部状态</strong>和<strong>渲染结果</strong>不匹配时，就会抛出“ExpressionChangedAfterItHasBeenCheckedError”。</p><h2 id="参考">参考</h2><ul><li><a class="link" href="https://indepth.dev/posts/1467/how-to-use-controlvalueaccessor-to-enhance-date-input-with-automatic-conversion-and-validation" target="_blank" rel="noopener">How To Use ControlValueAccessor To Enhance Date Input With Automatic Conversion And Validation</a></li><li><a class="link" href="https://indepth.dev/posts/1508/structure-initialization-logic-without-ngoninit-utilize-observables-and-ngonchanges" target="_blank" rel="noopener">Component Initialization Without ngOnInit With Async Pipes For Observables And ngOnChanges</a></li><li><a class="link" href="https://indepth.dev/posts/1058/a-gentle-introduction-into-change-detection-in-angular" target="_blank" rel="noopener">A Gentle Introduction Into Change Detection in Angular</a></li><li><a class="link" href="https://indepth.dev/posts/1434/running-event-listeners-outside-of-the-ngzone" target="_blank" rel="noopener">Running Event Listeners Outside Of The NgZone</a></li><li><a class="link" href="https://netbasal.com/understanding-angular-structural-directives-659acd0f67e" target="_blank" rel="noopener">Understanding Angular Structural Directives</a></li></ul></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/angular-%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8/"><div class="article-image"><img src="/img/cover/angular.png" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Angular 路由复用</h2></div></a></article><article class="has-image"><a href="/p/%E5%B0%81%E8%A3%85-prosearch-%E4%B8%8E-protable-%E7%BB%84%E4%BB%B6/"><div class="article-image"><img src="/img/cover/angular.png" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">封装 ProSearch 与 ProTable 组件</h2></div></a></article><article class="has-image"><a href="/p/angular-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"><div class="article-image"><img src="/img/cover/angular.png" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Angular 快速上手</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2026
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="关闭"></button>
<button class="pswp__button pswp__button--fs" title="全屏"></button>
<button class="pswp__button pswp__button--zoom" title="缩放"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="上一张"></button>
<button class="pswp__button pswp__button--arrow--right" title="下一张"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#ngtemplateoutlet">ngTemplateOutlet</a></li><li><a href="#ngcomponentoutlet">ngComponentOutlet</a></li><li><a href="#formcontrolname">formControlName</a></li><li><a href="#asyncpipe">asyncPipe</a></li><li><a href="#directive">directive</a><ol><li><a href="#intersectiondirective">IntersectionDirective</a></li></ol></li><li><a href="#runoutsideangular">runOutsideAngular</a></li><li><a href="#expressionchangedafterithasbeencheckederror">ExpressionChangedAfterItHasBeenCheckedError</a></li><li><a href="#参考">参考</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" crossorigin="anonymous"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>