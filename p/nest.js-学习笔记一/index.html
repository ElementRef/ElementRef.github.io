<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1,user-scalable=no'><meta name=description content='是什么 Nest.js 是一个抽象于 Express/Fasify、参考了 Angular 设计哲学的开箱即用的后端框架。
开始使用 需要全局安装 @nestjs/cli：
1 2 3 4 5 pnpm add @nestjs/cli -g nest new project-name cd project-name # 使用 swc，编译速度更快 pnpm run start -- -b swc 如果不想使用 @nestjs/cli，可以尝试官方 推荐指南 。
'><title>Nest.js 学习笔记（一） · I AM BEA, I DRINK TEA</title>
<link rel=canonical href=https://ElementRef.github.io/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80/><link rel=stylesheet href=/scss/style.min.497b5f2a752c475722ecfffdb2960cc0a51fcb0c639edf1257c35adfe486dc5f.css><meta property='og:title' content='Nest.js 学习笔记（一）'><meta property='og:description' content='是什么 Nest.js 是一个抽象于 Express/Fasify、参考了 Angular 设计哲学的开箱即用的后端框架。
开始使用 需要全局安装 @nestjs/cli：
1 2 3 4 5 pnpm add @nestjs/cli -g nest new project-name cd project-name # 使用 swc，编译速度更快 pnpm run start -- -b swc 如果不想使用 @nestjs/cli，可以尝试官方 推荐指南 。
'><meta property='og:url' content='https://ElementRef.github.io/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-10-18T00:00:00+00:00'><meta property='article:modified_time' content='2024-10-18T00:00:00+00:00'><meta property='og:image' content='https://ElementRef.github.io/img/cover/nestjs.png'><meta name=twitter:title content="Nest.js 学习笔记（一）"><meta name=twitter:description content="是什么 Nest.js 是一个抽象于 Express/Fasify、参考了 Angular 设计哲学的开箱即用的后端框架。
开始使用 需要全局安装 @nestjs/cli：
1 2 3 4 5 pnpm add @nestjs/cli -g nest new project-name cd project-name # 使用 swc，编译速度更快 pnpm run start -- -b swc 如果不想使用 @nestjs/cli，可以尝试官方 推荐指南 。
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://ElementRef.github.io/img/cover/nestjs.png'><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=robots content="noarchive, noindex, nofollow"><meta name=theme-color content="#ffffff"><script defer src=https://umami.pavilion0321907.workers.dev/elementref.js data-website-id=87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7590466716559688570.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>I AM BEA, I DRINK TEA</h2></div></header><ol class=social-menu><li><a href=https://space.bilibili.com/593541941 target=_blank title=Bilibili><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"/><path d="M8 3l2 3"/><path d="M16 3l-2 3"/><path d="M9 13v-2"/><path d="M15 11v2"/></svg></a></li><li><a href=https://github.com/ElementRef target=_blank title=GitHub><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://www.last.fm/zh/user/SpiciComic/listening-report target=_blank title=Last.fm><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"/></svg></a></li><li><a href=https://x.com/SpiciComic target=_blank title=Twitter><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://m.weibo.cn/u/6447635754 target=_blank title=Weibo><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"/><path d="M15 4h1a5 5 0 015 5v1"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/index.xml target=_blank><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>订阅</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80/><img src=/img/cover/nestjs.png loading=lazy alt="Nest.js 学习笔记（一）"></a></div><div class=article-details><header class=article-category><a href=/categories/nest.js/>Nest.js</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80/>Nest.js 学习笔记（一）</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 18, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：24 分钟</time></div></footer></div></header><section class=article-content><h2 id=是什么>是什么</h2><p>Nest.js 是一个抽象于 Express/Fasify、参考了 Angular 设计哲学的开箱即用的后端框架。</p><h2 id=开始使用>开始使用</h2><p>需要全局安装 @nestjs/cli：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add @nestjs/cli -g
</span></span><span class=line><span class=cl>nest new project-name
</span></span><span class=line><span class=cl><span class=nb>cd</span> project-name
</span></span><span class=line><span class=cl><span class=c1># 使用 swc，编译速度更快</span>
</span></span><span class=line><span class=cl>pnpm run start -- -b swc
</span></span></code></pre></td></tr></table></div></div><p>如果不想使用 @nestjs/cli，可以尝试官方<a class=link href=https://dev.to/micalevisk/5-steps-to-create-a-bare-minimum-nestjs-app-from-scratch-5c3b target=_blank rel=noopener>
推荐指南
</a>。</p><p>项目新建完成之后，src 目录下的结构如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>src
</span></span><span class=line><span class=cl> ├── app.controller.spec.ts 单元测试文件
</span></span><span class=line><span class=cl> ├── app.controller.ts      处理当前路由下请求的控制器
</span></span><span class=line><span class=cl> ├── app.module.ts          应用根模块（同 Angular 模块系统）
</span></span><span class=line><span class=cl> ├── app.service.ts         提供具体业务逻辑实现（同 Angular 服务）
</span></span><span class=line><span class=cl> └── main.ts                应用入口，会调用 NestFactory 创建应用实例
</span></span></code></pre></td></tr></table></div></div><p>main.ts 文件的内容为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 当程序出错，默认将会退出应用进程
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果想要抛出错误，将 abortOnError 改为 false
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>abortOnError</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=controller>Controller</h2><p>控制器用来处理来自客户端的请求，一个控制器可能对应着一条或多条路由，不同的路由对应着不同的业务逻辑。</p><p>我们先执行一条命令，这条命令会初始化 user 模块以及对应的控制器、Service、数据模型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nest g resource user
</span></span></code></pre></td></tr></table></div></div><p>这条命令会快速创建一个 CRUD 控制器，这个过程中，Nest 会询问 API 风格，这里选择 REST API，执行之后的目录结构：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>src
</span></span><span class=line><span class=cl> ├── app.controller.spec.ts
</span></span><span class=line><span class=cl> ├── app.controller.ts
</span></span><span class=line><span class=cl> ├── app.module.ts
</span></span><span class=line><span class=cl> ├── app.service.ts
</span></span><span class=line><span class=cl> ├── main.ts
</span></span><span class=line><span class=cl> └── user
</span></span><span class=line><span class=cl>     ├── dto
</span></span><span class=line><span class=cl>     │   ├── create-user.dto.ts
</span></span><span class=line><span class=cl>     │   └── update-user.dto.ts
</span></span><span class=line><span class=cl>     ├── entities
</span></span><span class=line><span class=cl>     │   └── user.entity.ts
</span></span><span class=line><span class=cl>     ├── user.controller.spec.ts
</span></span><span class=line><span class=cl>     ├── user.controller.ts
</span></span><span class=line><span class=cl>     ├── user.module.ts
</span></span><span class=line><span class=cl>     ├── user.service.spec.ts
</span></span><span class=line><span class=cl>     └── user.service.ts
</span></span></code></pre></td></tr></table></div></div><p>user.controller.ts 的内容如下，Nest 使用装饰器 + 元数据来定义路由：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Body</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Delete</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HostParam</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpCode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Next</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Param</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Patch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Redirect</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Req</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Res</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Session</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span><span class=p>,</span> <span class=nx>Response</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=k>of</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CreateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/create-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UpdateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/update-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span> <span class=c1>// 当前控制器将处理 /user 路径下的请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 依赖注入 UserService，内部封装了具体的业务逻辑
</span></span></span><span class=line><span class=cl><span class=cm>   * UserController 声明了一个依赖 UserService
</span></span></span><span class=line><span class=cl><span class=cm>   * NestIoC 会找到 UserService，实例化并缓存
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果其他地方也使用了 UserService 作为依赖
</span></span></span><span class=line><span class=cl><span class=cm>   * UserService 实例将会直接从缓存返回
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>()</span> <span class=c1>// 当客户端对 /user 发起 POST 请求时，会走到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 使用 @Body 装饰器，可以直接获取请求主体
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>@Body</span><span class=p>()</span> <span class=nx>createUserDto</span>: <span class=kt>CreateUserDto</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>createUserDto</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 使用 @HttpCode 对状态码进行控制
</span></span></span><span class=line><span class=cl><span class=cm>   * 通常，状态码并非静态的，需要根据具体业务进行调整
</span></span></span><span class=line><span class=cl><span class=cm>   * 所以 @HttpCode 并不那么常用，通常通过 @Res 返回状态码
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>@HttpCode</span><span class=p>(</span><span class=mi>204</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAll() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;admin&#39;</span><span class=p>)</span> <span class=c1>// 当客户端对 /user/admin 发起 GET 请求时，会走到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>findAllAdmin() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 这里可以直接返回 JS 数据
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是 string、number 等会直接返回
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果是对象、数组，会被序列化为 JSON
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span> <span class=c1>// 当客户端对 /user/guest 发起 GET 请求时，会走到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>findAllGuest</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 使用 @Req|@Res 装饰器，可以拿到原始 request|response
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据底层库不同，request|response 可能有所不同
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Req</span><span class=p>()</span> <span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// passthrough:true 使得对 response 的处理更灵活
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>@Res</span><span class=p>({</span> <span class=nx>passthrough</span>: <span class=kt>true</span> <span class=p>})</span> <span class=nx>response</span>: <span class=kt>Response</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Next</span><span class=p>()</span> <span class=nx>next</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Session</span><span class=p>()</span> <span class=nx>session</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Query</span><span class=p>()</span> <span class=nx>query</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Headers</span><span class=p>()</span> <span class=nx>headers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Ip</span><span class=p>()</span> <span class=nx>ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@HostParam</span><span class=p>()</span> <span class=nx>hostparam</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; request&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; next&#39;</span><span class=p>,</span> <span class=nx>next</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; session&#39;</span><span class=p>,</span> <span class=nx>session</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; query&#39;</span><span class=p>,</span> <span class=nx>query</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; headers&#39;</span><span class=p>,</span> <span class=nx>headers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; ip&#39;</span><span class=p>,</span> <span class=nx>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; hostparam&#39;</span><span class=p>,</span> <span class=nx>hostparam</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=mi>200</span><span class=p>).</span><span class=nx>send</span><span class=p>([]);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要放在 @Get(&#39;:id&#39;) 之前，否则会被 @Get(&#39;:id&#39;) 覆盖掉
</span></span></span><span class=line><span class=cl><span class=cm>   * @Redirect 用于重定向，该方法返回的路径可以覆盖传入的 URL
</span></span></span><span class=line><span class=cl><span class=cm>   * https://localhost:3000/user/docs?version=5
</span></span></span><span class=line><span class=cl><span class=cm>   * 跳转到 https://docs.nestjs.com/v5/
</span></span></span><span class=line><span class=cl><span class=cm>   * https://localhost:3000/user/docs
</span></span></span><span class=line><span class=cl><span class=cm>   * 跳转到 https://docs.nestjs.com/
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;docs&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Redirect</span><span class=p>(</span><span class=s1>&#39;https://docs.nestjs.com&#39;</span><span class=p>,</span> <span class=mi>302</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getDocs</span><span class=p>(</span><span class=kd>@Query</span><span class=p>(</span><span class=s1>&#39;version&#39;</span><span class=p>)</span> <span class=nx>version</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nx>version</span> <span class=o>&amp;&amp;</span> <span class=nx>version</span> <span class=o>===</span> <span class=s1>&#39;5&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span> <span class=nx>url</span><span class=o>:</span> <span class=s1>&#39;https://docs.nestjs.com/v5/&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span> <span class=c1>// 当客户端对 /user/:id 发起 GET 请求时，会走到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>async</span> <span class=nx>findOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 使用 @Param 装饰器，可以直接获取请求 URL 中的路径参数
</span></span></span><span class=line><span class=cl><span class=cm>     * @Param(&#39;id&#39;) id: string 返回 1
</span></span></span><span class=line><span class=cl><span class=cm>     * @Param() params 返回 { id: 1 }
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; id&#39;</span><span class=p>,</span> <span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span> <span class=c1>// 你甚至可以返回一个 RxJS 对象
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Patch</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>update</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 形参先后顺序不重要，不同参数使用对应的装饰器即可
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>@Body</span><span class=p>()</span> <span class=nx>updateUserDto</span>: <span class=kt>UpdateUserDto</span><span class=p>,</span> <span class=c1>// UpdateUserDto 定义了 DataTransferObject 格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>update</span><span class=p>(</span><span class=o>+</span><span class=nx>id</span><span class=p>,</span> <span class=nx>updateUserDto</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Delete</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=o>+</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，user.controller.ts 包含了对 user 资源的增删改查接口；在装饰器下，有各种方法名称（create|findAll|findAllAdmin&mldr;），这些名称都是无关紧要的，Nest 不会去匹配这些。</p><p>除了 user.controller.ts，同目录下还包含了一个 dto 文件夹，用来定义 DataTransferObject 的类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/user/dto/create-user.dto.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CreateUserDto</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sex</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// src/user/dto/update-user.dto.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>PartialType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/mapped-types&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CreateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./create-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UpdateUserDto</span> <span class=kr>extends</span> <span class=nx>PartialType</span><span class=p>(</span><span class=nx>CreateUserDto</span><span class=p>)</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>文档中推荐使用 class 而不是 interface 来定义 DataTransferObject：</p><ul><li>class 属于 JS 规范，在编译后会保留；</li><li>interface 在编译过程中会被移除；</li><li>Nest 需要在运行时使用 DTO。</li></ul><h2 id=service>Service</h2><p>同 Angular 一样，Service 同样负责处理具体的业务细节；通过依赖注入 Service，Controller 将具体逻辑移交给 Service 实例中的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CreateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/create-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UpdateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/update-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Service 应当是一个可注入 class
</span></span></span><span class=line><span class=cl><span class=cm> * 或者说，每个 Provider 都应该是 Injectable 的
</span></span></span><span class=line><span class=cl><span class=cm> * @Injectable 表示当前 class 可以被 NestIoC 管理
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>create</span><span class=p>(</span><span class=nx>createUserDto</span>: <span class=kt>CreateUserDto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;This action adds a new user&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>findAll() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`This action returns all user`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>findOne</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`This action returns a #</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb> user`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>update</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>number</span><span class=p>,</span> <span class=nx>updateUserDto</span>: <span class=kt>UpdateUserDto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`This action updates a #</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb> user`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`This action removes a #</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb> user`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>和 Angular 不同的是，NgService 有一个 providedIn 参数，可以控制 Service 实例的注入范围；而 NestService 通常需要在<strong>当前模块</strong>的 provides 中声明之后（或者在导入的模块中被 exports），才可以依赖注入<strong>当前模块</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/user/user.module.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>CONFIG</span> <span class=o>=</span> <span class=nx>Symbol</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserController</span><span class=p>],</span> <span class=c1>// UserModule 中的控制器
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 可被依赖注入的 Service
</span></span></span><span class=line><span class=cl><span class=cm>   * 整个 UserModule 中共享一个 UserService 实例
</span></span></span><span class=line><span class=cl><span class=cm>   * NgModule 中也有这种用法，但是不常用，因为不够灵活
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 上边是下边的简写
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>UserService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>UserService</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>ConfService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>:
</span></span><span class=line><span class=cl>        <span class=kt>process.env.NODE_ENV</span> <span class=o>===</span> <span class=s1>&#39;development&#39;</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>DevConfService</span>
</span></span><span class=line><span class=cl>          : <span class=kt>ProdConfService</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>CONFIG</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useFactory</span>: <span class=kt>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>NODE_ENV</span> <span class=o>===</span> <span class=s1>&#39;development&#39;</span> <span class=o>?</span> <span class=nx>devConfig</span> : <span class=kt>prodConfig</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[],</span> <span class=c1>// 导入到 UserModule 的内容
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 从 UserModule 导出的内容
</span></span></span><span class=line><span class=cl><span class=cm>   * 当 UserModule 被其他 Module 引入时
</span></span></span><span class=line><span class=cl><span class=cm>   * exports 中的内容会暴露给其他 Module
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=module>Module</h2><p>同 Angular 一样，每个 Nest 应用都有一个 RootModule 和若干的子 Module，RootModule 会被传入 NestFactory.create 中，完成整个应用的构建：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>在 Nest 中，Module 默认是单例的；在模块间 imports/exports 的都是用一个实例；所以，每个模块都是一个 SharedModule：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/user/user.module.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 当 UserModule 被其他模块 imports 时，自动就拥有了 UserService
</span></span></span><span class=line><span class=cl><span class=cm>   * 并且几个模块之间共享同一个 UserService 实例
</span></span></span><span class=line><span class=cl><span class=cm>   * 如果将 UserService 单独注入别的模块
</span></span></span><span class=line><span class=cl><span class=cm>   * 则别的模块独享一个 UserService 实例
</span></span></span><span class=line><span class=cl><span class=cm>   * 独享实例这种行为会增加内存消耗
</span></span></span><span class=line><span class=cl><span class=cm>   * 并且使得实例内部状态不一致
</span></span></span><span class=line><span class=cl><span class=cm>   * 独享实例，慎重使用
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 Angular 中，如果在 AppModule 中 provides 了一些 Service，这些 Service 将在整个应用中可用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@NgModule</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>declarations</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppComponent</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>AppRoutingModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BaseModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BrowserAnimationsModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BrowserModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpClientModule</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>NZ_I18N</span><span class=p>,</span> <span class=nx>useValue</span>: <span class=kt>zh_CN</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>TaxAgencyInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>TokenInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>ErrorInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>SpinInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>ErrorHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useValue</span>: <span class=kt>Sentry.createErrorHandler</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>showDialog</span>: <span class=kt>false</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>Sentry.TraceService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>deps</span><span class=o>:</span> <span class=p>[</span><span class=nx>Router</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_INITIALIZER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useFactory</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{},</span>
</span></span><span class=line><span class=cl>      <span class=nx>deps</span><span class=o>:</span> <span class=p>[</span><span class=nx>Sentry</span><span class=p>.</span><span class=nx>TraceService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>multi</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>bootstrap</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppComponent</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 NestModule 中，providers 默认被当前模块内部持有，不会暴露到全局；如果需要的话，可以使用 @Global 修饰符进行修饰：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Global</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserModule</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span> <span class=c1>// AppService 将在整个应用内可用，而且不需要导入 AppModule
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>@Global 就像全局变量一样，应当少用；过多使用会使依赖关系不可控，只在 SharedModule 中使用即可。</p><p>在 NestModule 中，还存在一种叫 DynamicModule 的东西，他会动态返回一个对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span><span class=p>,</span> <span class=nx>DynamicModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createDatabaseProviders</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./database.providers&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Connection</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./connection.provider&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>Connection</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>Connection</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>DatabaseModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>forRoot</span><span class=p>(</span><span class=nx>entities</span> <span class=o>=</span> <span class=p>[],</span> <span class=nx>options</span><span class=o>?</span><span class=p>)</span><span class=o>:</span> <span class=nx>DynamicModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>providers</span> <span class=o>=</span> <span class=nx>createDatabaseProviders</span><span class=p>(</span><span class=nx>options</span><span class=p>,</span> <span class=nx>entities</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>module</span>: <span class=kt>DatabaseModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>providers</span>: <span class=kt>providers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>exports</span>: <span class=kt>providers</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>DynamicModule 可以这样使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>DatabaseModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./database/database.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserEntity</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./users/entities/user.entity&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>DatabaseModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>([</span><span class=nx>UserEntity</span><span class=p>])],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>DatabaseModule</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果你用过 Angular 的话，你可能会想到 <a class=link href=https://github.com/angular/angular/blob/main/packages/router/src/router_module.ts target=_blank rel=noopener>RouterModule
</a>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@NgModule</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=p>{})],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppRoutingModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>@NgModule</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>.</span><span class=nx>forChild</span><span class=p>(</span><span class=nx>routes</span><span class=p>)],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>BillsQueryRoutingModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>对的，他们就是一种东西，forRoot 仅仅返回了一个 Module 元数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@NgModule</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span>: <span class=kt>ROUTER_DIRECTIVES</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span>: <span class=kt>ROUTER_DIRECTIVES</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>RouterModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kd>@Optional</span><span class=p>()</span> <span class=kd>@Inject</span><span class=p>(</span><span class=nx>ROUTER_FORROOT_GUARD</span><span class=p>)</span> <span class=nx>guard</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>forRoot</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>routes</span>: <span class=kt>Routes</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>config?</span>: <span class=kt>ExtraOptions</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>ModuleWithProviders</span><span class=p>&lt;</span><span class=nt>RouterModule</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ngModule</span>: <span class=kt>RouterModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=nx>ROUTER_PROVIDERS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>ROUTES</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span><span class=p>,</span> <span class=nx>useValue</span>: <span class=kt>routes</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>provide</span>: <span class=kt>ROUTER_FORROOT_GUARD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>useFactory</span>: <span class=kt>provideForRootGuard</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>deps</span><span class=o>:</span> <span class=p>[[</span><span class=nx>Router</span><span class=p>,</span> <span class=k>new</span> <span class=nx>Optional</span><span class=p>(),</span> <span class=k>new</span> <span class=nx>SkipSelf</span><span class=p>()]]</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>errorHandler</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>provide</span>: <span class=kt>NAVIGATION_ERROR_HANDLER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>useValue</span>: <span class=kt>config.errorHandler</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>ROUTER_CONFIGURATION</span><span class=p>,</span> <span class=nx>useValue</span>: <span class=kt>config</span> <span class=o>?</span> <span class=nx>config</span> <span class=o>:</span> <span class=p>{}</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>useHash</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>provideHashLocationStrategy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=nx>providePathLocationStrategy</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>provideRouterScroller</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>preloadingStrategy</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>withPreloading</span><span class=p>(</span><span class=nx>config</span><span class=p>.</span><span class=nx>preloadingStrategy</span><span class=p>).</span><span class=err>ɵ</span><span class=nx>providers</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>initialNavigation</span> <span class=o>?</span> <span class=nx>provideInitialNavigation</span><span class=p>(</span><span class=nx>config</span><span class=p>)</span> <span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>bindToComponentInputs</span>
</span></span><span class=line><span class=cl>          <span class=o>?</span> <span class=nx>withComponentInputBinding</span><span class=p>().</span><span class=err>ɵ</span><span class=nx>providers</span>
</span></span><span class=line><span class=cl>          <span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=nx>config</span><span class=o>?</span><span class=p>.</span><span class=nx>enableViewTransitions</span> <span class=o>?</span> <span class=nx>withViewTransitions</span><span class=p>().</span><span class=err>ɵ</span><span class=nx>providers</span> <span class=o>:</span> <span class=p>[],</span>
</span></span><span class=line><span class=cl>        <span class=nx>provideRouterInitializer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>forChild</span><span class=p>(</span><span class=nx>routes</span>: <span class=kt>Routes</span><span class=p>)</span><span class=o>:</span> <span class=nx>ModuleWithProviders</span><span class=p>&lt;</span><span class=nt>RouterModule</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>ngModule</span>: <span class=kt>RouterModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>providers</span><span class=o>:</span> <span class=p>[{</span> <span class=nx>provide</span>: <span class=kt>ROUTES</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span><span class=p>,</span> <span class=nx>useValue</span>: <span class=kt>routes</span> <span class=p>}]</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=中间件>中间件</h2><p>Nest 中间件和 Express 中间件相同，是一个运行在控制器之前的函数，接受 request 和 response 并通过 next 调用下一个中间件：</p><ul><li>修改 request 和 response 对象；</li><li>可提前终止请求响应过程；</li><li>调用其他中间件。</li></ul><p>Nest 中间件可以是一个函数，也可以是一个 class，如果是 class 的话，需要 implements NestMiddleware 并提供一个 use 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>NestMiddleware</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span><span class=p>,</span> <span class=nx>Response</span><span class=p>,</span> <span class=nx>NextFunction</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>LoggerMiddleware</span> <span class=kr>implements</span> <span class=nx>NestMiddleware</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>use</span><span class=p>(</span><span class=nx>req</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>res</span>: <span class=kt>Response</span><span class=p>,</span> <span class=nx>next</span>: <span class=kt>NextFunction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Request...&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>或者直接使用函数形式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span><span class=p>,</span> <span class=nx>Response</span><span class=p>,</span> <span class=nx>NextFunction</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>logger</span><span class=p>(</span><span class=nx>req</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>res</span>: <span class=kt>Response</span><span class=p>,</span> <span class=nx>next</span>: <span class=kt>NextFunction</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`Request...`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要使用中间件，需要 implements NestModule 并实现 configure 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Global</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>MiddlewareConsumer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Module</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>NestModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RequestMethod</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>LoggerMiddleware</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./logger.middleware&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user/user.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user/user.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Global</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserModule</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=kr>implements</span> <span class=nx>NestModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>configure</span><span class=p>(</span><span class=nx>consumer</span>: <span class=kt>MiddlewareConsumer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 为 /user 路由下的所有请求都启用中间件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>consumer</span><span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>LoggerMiddleware</span><span class=p>).</span><span class=nx>forRoutes</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 仅对 /user/:id 路由下的 GET 请求启用中间件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>consumer</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>LoggerMiddleware</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>forRoutes</span><span class=p>({</span> <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;user/:id&#39;</span><span class=p>,</span> <span class=nx>method</span>: <span class=kt>RequestMethod.GET</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 对 UserController 启用中间件，除了来自 user/:id 的 PUT 请求
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>consumer</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这里可以传入多个中间件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>LoggerMiddleware</span>
</span></span><span class=line><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>exclude</span><span class=p>({</span> <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;user/:id&#39;</span><span class=p>,</span> <span class=nx>method</span>: <span class=kt>RequestMethod.PUT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>forRoutes</span><span class=p>(</span><span class=nx>UserController</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要对每个路由 .forRoutes(&rsquo;*&rsquo;) 启用中间件，可以在应用实例上调用 use 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>((</span><span class=nx>req</span><span class=p>,</span> <span class=nx>res</span><span class=p>,</span> <span class=nx>next</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;Global Middleware&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=异常过滤>异常过滤</h2><p>Nest 内部提供了 HttpException 用来抛出 HTTP 相关的错误：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>HttpException</span><span class=p>,</span> <span class=nx>HttpStatus</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAllGuest() {</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 这里并不会使应用退出，而是将 403 状态码发送给客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>throw</span> <span class=k>new</span> <span class=nx>HttpException</span><span class=p>(</span><span class=s1>&#39;禁止访问&#39;</span><span class=p>,</span> <span class=nx>HttpStatus</span><span class=p>.</span><span class=nx>FORBIDDEN</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 选填，这里可以提供一些内部的错误信息，可以用来链路追踪
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cause</span>: <span class=kt>error</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端将会收到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;statusCode&#34;</span><span class=p>:</span> <span class=mi>403</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;禁止访问&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>除了 HttpException，Nest 还内置了一些其他的继承于 HttpException 的<a class=link href=https://docs.nestjs.com/exception-filters#built-in-http-exceptions target=_blank rel=noopener>
错误构造函数
</a>。</p><p>当内置的错误处理不能满足业务需要（例如：错误收集、日志收集）时，可以构造自定义错误处理程序：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ArgumentsHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Catch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ExceptionFilter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpException</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span><span class=p>,</span> <span class=nx>Response</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Catch</span><span class=p>(</span><span class=nx>HttpException</span><span class=p>)</span> <span class=c1>// 告诉 Nest，这个用来捕获 HttpException
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>HttpExceptionFilter</span> <span class=kr>implements</span> <span class=nx>ExceptionFilter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>catch</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当前异常对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>exception</span>: <span class=kt>HttpException</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span>: <span class=kt>ArgumentsHost</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>status</span> <span class=o>=</span> <span class=nx>exception</span><span class=p>.</span><span class=nx>getStatus</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>context</span> <span class=o>=</span> <span class=nx>host</span><span class=p>.</span><span class=nx>switchToHttp</span><span class=p>();</span> <span class=c1>// 通过 context 获取原始 request|response
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>getResponse</span><span class=p>&lt;</span><span class=nt>Response</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>getRequest</span><span class=p>&lt;</span><span class=nt>Request</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>status</span><span class=p>(</span><span class=nx>status</span><span class=p>).</span><span class=nx>json</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span>: <span class=kt>request.url</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>status</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>timestamp</span>: <span class=kt>Date.now</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>要使用 HttpExceptionFilter，需要通过 @UseFilters 装饰器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>HttpException</span><span class=p>,</span> <span class=nx>HttpStatus</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>HttpExceptionFilter</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;src/http-exception.filter&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;guest&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseFilters</span><span class=p>(</span><span class=k>new</span> <span class=nx>HttpExceptionFilter</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAllGuest() {</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 这里并不会使应用退出，而是将 403 状态码发送给客户端
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>throw</span> <span class=k>new</span> <span class=nx>HttpException</span><span class=p>(</span><span class=s1>&#39;禁止访问&#39;</span><span class=p>,</span> <span class=nx>HttpStatus</span><span class=p>.</span><span class=nx>FORBIDDEN</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 选填，这里可以提供一些内部的错误信息，可以用来链路追踪
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>cause</span>: <span class=kt>error</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 也可以处理整个 Controller 的异常
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@UseFilters</span><span class=p>(</span><span class=k>new</span> <span class=nx>HttpExceptionFilter</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 也可以注册为整个模块的 Filters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_FILTER</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_FILTER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>HttpExceptionFilter</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// 也可以注册为全局 Filters
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>useGlobalFilters</span><span class=p>(</span><span class=k>new</span> <span class=nx>HttpExceptionFilter</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>客户端将会收到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;path&#34;</span><span class=p>:</span> <span class=s2>&#34;/user/guest&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;status&#34;</span><span class=p>:</span> <span class=mi>403</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;timestamp&#34;</span><span class=p>:</span> <span class=mi>1729596747346</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要捕获所有异常（不止 HttpException），则 @Cache 装饰器不要传入任何参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ExceptionFilter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Catch</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ArgumentsHost</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpException</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpStatus</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>HttpAdapterHost</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Catch</span><span class=p>()</span> <span class=c1>// 将会捕获所有异常
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CatchEverythingFilter</span> <span class=kr>implements</span> <span class=nx>ExceptionFilter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>httpAdapterHost</span>: <span class=kt>HttpAdapterHost</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>catch</span><span class=p>(</span><span class=nx>exception</span>: <span class=kt>unknown</span><span class=p>,</span> <span class=nx>host</span>: <span class=kt>ArgumentsHost</span><span class=p>)</span><span class=o>:</span> <span class=k>void</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>httpAdapter</span> <span class=p>}</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>httpAdapterHost</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ctx</span> <span class=o>=</span> <span class=nx>host</span><span class=p>.</span><span class=nx>switchToHttp</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>httpStatus</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>      <span class=nx>exception</span> <span class=k>instanceof</span> <span class=nx>HttpException</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=nx>exception</span><span class=p>.</span><span class=nx>getStatus</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>HttpStatus</span><span class=p>.</span><span class=nx>INTERNAL_SERVER_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>responseBody</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>statusCode</span>: <span class=kt>httpStatus</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>timestamp</span>: <span class=kt>new</span> <span class=nb>Date</span><span class=p>().</span><span class=nx>toISOString</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>      <span class=nx>path</span>: <span class=kt>httpAdapter.getRequestUrl</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>getRequest</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>httpAdapter</span><span class=p>.</span><span class=nx>reply</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>getResponse</span><span class=p>(),</span> <span class=nx>responseBody</span><span class=p>,</span> <span class=nx>httpStatus</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果仅仅想对内置的全局异常处理 Filter 的默认行为进行修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Catch</span><span class=p>,</span> <span class=nx>ArgumentsHost</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>BaseExceptionFilter</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Catch</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AllExceptionsFilter</span> <span class=kr>extends</span> <span class=nx>BaseExceptionFilter</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>catch</span><span class=p>(</span><span class=nx>exception</span>: <span class=kt>unknown</span><span class=p>,</span> <span class=nx>host</span>: <span class=kt>ArgumentsHost</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>super</span><span class=p>.</span><span class=k>catch</span><span class=p>(</span><span class=nx>exception</span><span class=p>,</span> <span class=nx>host</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用 useGlobalFilters 注册
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>httpAdapter</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>HttpAdapterHost</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>useGlobalFilters</span><span class=p>(</span><span class=k>new</span> <span class=nx>AllExceptionsFilter</span><span class=p>(</span><span class=nx>httpAdapter</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=管道>管道</h2><p>管道是一个被 @Injectable 装饰的、需要 implements PipeTransform 的 class；他将会对传入 RouteHandler 中的数据进行处理；和 NgPipe 不同的是，NgPipe 使用 @Pipe 装饰器；他的使用场景是：</p><ul><li>数据转换；</li><li>数据验证。</li></ul><p>同 Angular 一样，Nest 也内置了一些管道：</p><ul><li>DefaultValuePipe；</li><li>ValidationPipe；</li><li>ParseArrayPipe；</li><li>ParseBoolPipe；</li><li>ParseEnumPipe；</li><li>ParseFilePipe；</li><li>ParseFloatPipe；</li><li>ParseIntPipe；</li><li>ParseUUIDPipe。</li></ul><p>管道可以直接用在 RouteHandler 形参中，他会在 RouteHandler 执行之前对参数进行转换和校验：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=nx>findOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=nx>ParseIntPipe</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>number</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * http://localhost:3000/user/a
</span></span></span><span class=line><span class=cl><span class=cm>   * 抛出 Validation failed，RouteHandler 不会执行
</span></span></span><span class=line><span class=cl><span class=cm>   * http://localhost:3000/user/2
</span></span></span><span class=line><span class=cl><span class=cm>   * 打印 UserController &gt; id number
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; id&#39;</span><span class=p>,</span> <span class=k>typeof</span> <span class=nx>id</span><span class=p>);</span> <span class=c1>// number，数据被隐式转换
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=nx>findOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 也可以使用管道实例，通过实例可以传入一个 Option 来自定义管道行为
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=k>new</span> <span class=nx>ParseIntPipe</span><span class=p>({</span> <span class=nx>errorHttpStatusCode</span>: <span class=kt>HttpStatus.NOT_ACCEPTABLE</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; id&#39;</span><span class=p>,</span> <span class=k>typeof</span> <span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要实现自定义管道，需要借助 PipeTransform：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ArgumentMetadata</span><span class=p>,</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>PipeTransform</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserPipe</span> <span class=kr>implements</span> <span class=nx>PipeTransform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>transform</span><span class=p>(</span><span class=nx>value</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>metadata</span>: <span class=kt>ArgumentMetadata</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 当访问 http://localhost:3000/user/abc
</span></span></span><span class=line><span class=cl><span class=cm>     * UserPipe &gt; transform &gt; value     abc
</span></span></span><span class=line><span class=cl><span class=cm>     * UserPipe &gt; transform &gt; metadata  { metatype: [Function: Number], type: &#39;param&#39;, data: &#39;id&#39; }
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserPipe &gt; transform &gt; value&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserPipe &gt; transform &gt; metadata&#39;</span><span class=p>,</span> <span class=nx>metadata</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=nx>findOne</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>,</span> <span class=nx>UserPipe</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>number</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>of</span><span class=p>(</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如何验证 DTO 呢？</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PartialType</span><span class=p>,</span> <span class=nx>OmitType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/mapped-types&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CreateUserDto</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>age</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>sex</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 用于数据更新的 DTO 并不需要每一项都是必传的
</span></span></span><span class=line><span class=cl><span class=cm> * 可以使用 PartialType 将 CreateUserDto 中的属性变为可选的
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UpdateUserDto</span> <span class=kr>extends</span> <span class=nx>PartialType</span><span class=p>(</span><span class=nx>CreateUserDto</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UpdateUserDto</span> <span class=kr>extends</span> <span class=nx>OmitType</span><span class=p>(</span><span class=nx>CreateUserDto</span><span class=p>,</span> <span class=p>[</span><span class=s1>&#39;name&#39;</span><span class=p>]</span> <span class=kr>as</span> <span class=kr>const</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>create</span><span class=p>(</span><span class=kd>@Body</span><span class=p>()</span> <span class=nx>createUserDto</span>: <span class=kt>CreateUserDto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>createUserDto</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 使用 ParseArrayPipe 表示 CreateUserDto 数组
</span></span></span><span class=line><span class=cl><span class=cm>   * 单靠 TS 并不能完成对入参的验证
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>createBulk</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Body</span><span class=p>(</span><span class=k>new</span> <span class=nx>ParseArrayPipe</span><span class=p>({</span> <span class=nx>item</span>: <span class=kt>CreateUserDto</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=nx>createUserDtos</span>: <span class=kt>CreateUserDto</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>createBulk</span><span class=p>(</span><span class=nx>createUserDtos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 假设请求 URL 为 GET /?ids=1,2,3
</span></span></span><span class=line><span class=cl><span class=cm>   * 可以使用 separator 指定数据分割符
</span></span></span><span class=line><span class=cl><span class=cm>   * ids 将会自动根据分割符分解为数组
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>findByIds</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Query</span><span class=p>(</span><span class=s1>&#39;ids&#39;</span><span class=p>,</span> <span class=k>new</span> <span class=nx>ParseArrayPipe</span><span class=p>({</span> <span class=nx>items</span>: <span class=kt>Number</span><span class=p>,</span> <span class=nx>separator</span><span class=o>:</span> <span class=s1>&#39;,&#39;</span> <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=nx>ids</span>: <span class=kt>number</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>findByIds</span><span class=p>(</span><span class=nx>ids</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最直接的，可以在 RouteHandler 中验证，但是这破坏了职责单一性原则；我们更希望数据在进入 RouteHandler 之前就完成验证。</p><h3 id=zod>Zod</h3><p>这里，我们需要使用 Zod 这个库：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add zod
</span></span></code></pre></td></tr></table></div></div><p>我们使用 Zod 创建一个管道 ZodValidationPipe，他将在实例化时注入 ZodSchema，数据验证将交给 Zod：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ArgumentMetadata</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>BadRequestException</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>PipeTransform</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ZodSchema</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserZodPipe</span> <span class=kr>implements</span> <span class=nx>PipeTransform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>schema</span>: <span class=kt>ZodSchema</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>transform</span><span class=p>(</span><span class=nx>value</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>metadata</span>: <span class=kt>ArgumentMetadata</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=nx>parsedValue</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>schema</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nx>parsedValue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>throw</span> <span class=k>new</span> <span class=nx>BadRequestException</span><span class=p>(</span><span class=s1>&#39;Validation failed&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了配合 ZodValidationPipe，CreateUserDto 需要从 TS 改为 Zod 的写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>z</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;zod&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// export class CreateUserDto {
</span></span></span><span class=line><span class=cl><span class=c1>//   name: string;
</span></span></span><span class=line><span class=cl><span class=c1>//   age: number;
</span></span></span><span class=line><span class=cl><span class=c1>//   sex: string;
</span></span></span><span class=line><span class=cl><span class=c1>// }
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>createUserSchema</span> <span class=o>=</span> <span class=nx>z</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=kt>object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span>: <span class=kt>z.string</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>age</span>: <span class=kt>z.number</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>sex</span>: <span class=kt>z.string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nx>required</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>type</span> <span class=nx>CreateUserDto</span> <span class=o>=</span> <span class=nx>z</span><span class=p>.</span><span class=k>infer</span><span class=p>&lt;</span><span class=nt>typeof</span> <span class=na>createUserSchema</span><span class=p>&gt;;</span>
</span></span></code></pre></td></tr></table></div></div><p>user.controller 也需要进行修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Body</span><span class=p>,</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Post</span><span class=p>,</span> <span class=nx>UsePipes</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>CreateUserDto</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/create-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createUserSchema</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dto/create-user.dto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserZodPipe</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.zod.pipe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UsePipes</span><span class=p>(</span><span class=k>new</span> <span class=nx>UserZodPipe</span><span class=p>(</span><span class=nx>createUserSchema</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>create</span><span class=p>(</span><span class=kd>@Body</span><span class=p>()</span> <span class=nx>createUserDto</span>: <span class=kt>CreateUserDto</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserController &gt; create &gt; createUserDto&#39;</span><span class=p>,</span> <span class=nx>createUserDto</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>createUserDto</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果请求数据不满足条件，根本不会进入 RouteHandler：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Validation failed&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Bad Request&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;statusCode&#34;</span><span class=p>:</span> <span class=mi>400</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=全局管道>全局管道</h3><p>有两种方式注册全局管道，一种是调用 useGlobalPipes 注册：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>useGlobalPipes</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=k>new</span> <span class=nx>ValidationPipe</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * whitelist:true 选项会对请求参数进行过滤
</span></span></span><span class=line><span class=cl><span class=cm>       * 任何没出现在 DTO 中的参数，将入参被过滤
</span></span></span><span class=line><span class=cl><span class=cm>       * forbidNonWhitelisted:true 更激进
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果有多余的参数，将返回错误信息
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>whitelist</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>forbidNonWhitelisted</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 通常，请求传入的数据都是经过序列化的，所以都为字符串类型
</span></span></span><span class=line><span class=cl><span class=cm>       * transform:true 会将入参隐式转化为符合 DTO 类型的数据
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>transform</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>另一种可以在应用根模块通过 APP_PIPE 依赖注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_PIPE</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_PIPE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>ValidationPipe</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=守卫>守卫</h2><p>同 Angular 中的路由守卫一样，Nest 允许我们通过 implements CanActivate 生成一个可被注入的 class，作为路由守卫；守卫会在中间件之后、管道和拦截器之前执行；他的唯一作用就是对传进来的请求进行判断（验证权限/角色&mldr;），是否应该交给 RouteHandler 处理；在 Express 中，这部分功能通常由中间件负责。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CanActivate</span><span class=p>,</span> <span class=nx>ExecutionContext</span><span class=p>,</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Observable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AuthGuard</span> <span class=kr>implements</span> <span class=nx>CanActivate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>canActivate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ExecutionContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=o>|</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ExecutionContext 继承自 ArgumentsHost
</span></span></span><span class=line><span class=cl><span class=cm>     * 这里通过 getRequest 获取请求对象
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>request</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>switchToHttp</span><span class=p>().</span><span class=nx>getRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AuthGuard &gt; request&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span> <span class=c1>// 返回值同 Angular 一样，决定了当前请求是否被拦截
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>同管道、异常捕获一样，守卫可以作用于<strong>全局</strong>、<strong>整个控制器</strong>、<strong>某个 RouteHandler</strong> 上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 作用于全局
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>useGlobalGuards</span><span class=p>(</span><span class=k>new</span> <span class=nx>RolesGuard</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=c1>// 作用于某个控制器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@UseGuards</span><span class=p>(</span><span class=nx>AuthGuard</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>同样的，全局守卫可以在根模块通过 APP_GUARD 依赖注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_GUARD</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_GUARD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>AuthGuard</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=自定义装饰器>自定义装饰器</h3><p>如果当前路由控制器下，包含了适用于不同权限的不同接口：一些接口只有管理员才能请求、一些接口只有客服才能请求、一些管理员和客服都能请求但普通用户不可以。这种场景下怎么能最大化完成接口复用呢？</p><p>Nest 给出的方案是，通过装饰器元数据解决；使用 createDecorator 创建一个装饰器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Reflector</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>Roles</span> <span class=o>=</span> <span class=nx>Reflector</span><span class=p>.</span><span class=nx>createDecorator</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>[]</span><span class=p>&gt;();</span>
</span></span></code></pre></td></tr></table></div></div><p>并将装饰器应用到对应的 RouteHandler 上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Delete</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Param</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseFilters</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseGuards</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AuthGuard</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.auth.guard&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Roles</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.decorator&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@UseGuards</span><span class=p>(</span><span class=nx>AuthGuard</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Delete</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Roles</span><span class=p>([</span><span class=s1>&#39;admin&#39;</span><span class=p>,</span> <span class=s1>&#39;service&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=nx>remove</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>remove</span><span class=p>(</span><span class=o>+</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当对 http://localhost:3000/user/1 发起 DELETE 请求时，AuthGuard 便会拿到 Roles 信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CanActivate</span><span class=p>,</span> <span class=nx>ExecutionContext</span><span class=p>,</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Reflector</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Observable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Roles</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.decorator&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AuthGuard</span> <span class=kr>implements</span> <span class=nx>CanActivate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>reflector</span>: <span class=kt>Reflector</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>canActivate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ExecutionContext</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=o>|</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 读取 @Roles 元数据信息
</span></span></span><span class=line><span class=cl><span class=cm>     * 我们的 @Roles 使用在了 RouteHandler 上，所以这里使用 context.getHandler
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 @Roles 用在了 Controller 上，需要使用 context.getClass 获取元数据信息
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 @Roles 既用在了 Controller 上，又用在了 RouteHandler 上，需要使用 getAllAndOverride|getAllAndMerge
</span></span></span><span class=line><span class=cl><span class=cm>     * const roles = this.reflector.getAllAndMerge(Roles, [context.getHandler(), context.getClass()])
</span></span></span><span class=line><span class=cl><span class=cm>     * 将两种元数据进行简单的合并
</span></span></span><span class=line><span class=cl><span class=cm>     * const roles = this.reflector.getAllAndOverride(Roles, [context.getHandler(), context.getClass()])
</span></span></span><span class=line><span class=cl><span class=cm>     * 将两种元数据进行比较，生成一个数据，优先级低的被覆盖
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>roles</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>reflector</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>Roles</span><span class=p>,</span> <span class=nx>context</span><span class=p>.</span><span class=nx>getHandler</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>user</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>context</span><span class=p>.</span><span class=nx>switchToHttp</span><span class=p>().</span><span class=nx>getRequest</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * AuthGuard &gt; roles [ &#39;admin&#39;, &#39;service&#39; ]
</span></span></span><span class=line><span class=cl><span class=cm>     * 可以根据 roles 和 user 来判断是否应该放行
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AuthGuard &gt; roles&#39;</span><span class=p>,</span> <span class=nx>roles</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在实际业务场景中，如果 AuthGuard 返回 false，客户端将会收到 403 状态码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;message&#34;</span><span class=p>:</span> <span class=s2>&#34;Forbidden resource&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;error&#34;</span><span class=p>:</span> <span class=s2>&#34;Forbidden&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nt>&#34;statusCode&#34;</span><span class=p>:</span> <span class=mi>403</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=拦截器>拦截器</h2><p>就像前端常用的请求拦截器一样，Nest 为 Interceptors 提供了以下能力：</p><ul><li>在 RouteHandler 调用前后添加额外的处理逻辑；</li><li>扩展 RouteHandler 功能；</li><li>错误信息转换；</li><li>数据转换；</li><li>重写逻辑。</li></ul><p>同 NgInterceptor 一样，NestInterceptor 同样需要实现一个 intercept 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>CallHandler</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ExecutionContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Injectable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>NestInterceptor</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>catchError</span><span class=p>,</span> <span class=nx>finalize</span><span class=p>,</span> <span class=nx>Observable</span><span class=p>,</span> <span class=nx>tap</span><span class=p>,</span> <span class=nx>throwError</span><span class=p>,</span> <span class=nx>map</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>// 在 Angular 中，我们一般需要 implements HttpInterceptor
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserInterceptor</span> <span class=kr>implements</span> <span class=nx>NestInterceptor</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>intercept</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>context</span>: <span class=kt>ExecutionContext</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span>: <span class=kt>CallHandler</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>any</span><span class=p>&gt;</span> <span class=o>|</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Observable</span><span class=err>&lt;</span><span class=na>any</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果不调用 handle，请求流程将永远走不到 RouteHandler，next.handle() 将返回 Observable 对象
</span></span></span><span class=line><span class=cl><span class=cm>     * 在调用 next.handle 之前，可以处理 RouteHandler 之前需要处理的逻辑
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;RouteHandler 调用之前&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>next</span><span class=p>.</span><span class=nx>handle</span><span class=p>().</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 处理 RouteHandler 之后需要处理的逻辑
</span></span></span><span class=line><span class=cl><span class=cm>       * 例如，错误对象的包装之类的工作
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>catchError</span><span class=p>((</span><span class=nx>error</span><span class=p>,</span> <span class=nx>caught</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>throwError</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=nx>tap</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;RouteHandler 调用之后&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=nx>map</span><span class=p>(</span><span class=nx>data</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// data 包含了 RouteHandler 的返回值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=nx>data</span> <span class=o>||</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=nx>finalize</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>同管道、异常捕获一样，拦截器可以作用于<strong>全局</strong>、<strong>整个控制器</strong>、<strong>某个 RouteHandler</strong> 上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 作用于全局
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>app</span><span class=p>.</span><span class=nx>useGlobalInterceptors</span><span class=p>(</span><span class=k>new</span> <span class=nx>LoggingInterceptor</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=c1>// 作用于某个控制器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>UserInterceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>同样的，全局拦截器可以在根模块通过 APP_INTERCEPTOR 依赖注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_INTERCEPTOR</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_INTERCEPTOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>UserInterceptor</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=动态模块>动态模块</h2><p>一般情况下，一个模块导入另一个模块，就自动注入了被导入模块的 exports：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// UsersModule 通过 exports 将 UsersService 暴露
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UsersService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>UsersService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UsersModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * AuthModule 通过 imports 导入了 UsersModule
</span></span></span><span class=line><span class=cl><span class=cm> * AuthModule 作用域内，都可以访问 UsersService
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>UsersModule</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AuthService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AuthModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// AuthService 可以将 UsersService 注入
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AuthService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>usersService</span>: <span class=kt>UsersService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这被称为<strong>静态模块</strong>，A 模块无论被哪个模块 imports，所能暴露的内容都是一致的；当然这很好，至少在写 Angular 的时候是能满足业务需求的，RouterModule 例外。</p><p><strong>动态模块</strong>就是能够根据被导入的模块的不同，动态的改变自己 exports 的内容；这很像插件的概念，或者多态的概念；见人说人话，见鬼说鬼话。</p><p>官方文档举了一个 ConfigModule 的例子：后端因为需要和不同的外部模块交换信息（网关、代理、数据库&mldr;），需要一个 ConfigModule 将各种配置信息整合起来，在不同的模块 imports 时，能够 exports 不同的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过调用 ConfigModule 的静态方法，传入参数
</span></span></span><span class=line><span class=cl><span class=cm>     * 静态方法 register 将返回 exports 内容
</span></span></span><span class=line><span class=cl><span class=cm>     * 这个静态方法名字随意，叫 aaa 都行
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>register</span><span class=p>({</span> <span class=nx>folder</span><span class=o>:</span> <span class=s1>&#39;./config&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>你会发现，动态模块返回的内容只有当代码<strong>运行起来</strong>时，才能被确定；这是他和静态模块的差别，静态模块的导出内容在他<strong>被定义</strong>时，就已经确定了。</p><p>既然<strong>动态模块</strong>就是动态返回<strong>模块配置</strong>，那么他的<strong>静态方法</strong>返回的元数据至少应该满足模块配置的<strong>类型</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>AModule</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>BController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>CService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>CService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，和静态模块元数据一样，这些配置都是可选的；另外还有一个 module 属性必须要有（对应着 Angular 中的 ngModule）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>DynamicModule</span><span class=p>,</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./config.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ConfigModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * register 接收到的配置参数怎么传递到模块内部的组件的呢？
</span></span></span><span class=line><span class=cl><span class=cm>   * 这些配置对于 ConfigModule 本人来说，并没有什么意义
</span></span></span><span class=line><span class=cl><span class=cm>   * 他需要将配置通过某种手段传递到 ConfigService 中
</span></span></span><span class=line><span class=cl><span class=cm>   * 上文中，我们提到了几种 providers 形式
</span></span></span><span class=line><span class=cl><span class=cm>   * 我们可以通过依赖注入来传递配置
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>register</span><span class=p>(</span><span class=nx>options</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;)</span><span class=o>:</span> <span class=nx>DynamicModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// ngModule: RouterModule, Angular 中的动态模块不能少了 ngModule 属性
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>module</span>: <span class=kt>ConfigModule</span><span class=p>,</span> <span class=c1>// 同样，这个 module 属性不能少
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>ConfigService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>ConfigService</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>静态方法 register 拿到的配置对于 ConfigModule 没什么直接意义，因为 ConfigModule 本身并不会去消费这些配置；我们需要某种方法将配置传递到 ConfigService 中，这就用到来上文提到的 useValue 属性，将配置本身注入到模块作用域：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>DynamicModule</span><span class=p>,</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./config.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>CONFIG_OPTIONS</span> <span class=o>=</span> <span class=nx>Symbol</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ConfigModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>static</span> <span class=nx>register</span><span class=p>(</span><span class=nx>options</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;)</span><span class=o>:</span> <span class=nx>DynamicModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>module</span>: <span class=kt>ConfigModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 通过 useValue，options 将以 CONFIG_OPTIONS 的形式呈现
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nx>provide</span>: <span class=kt>CONFIG_OPTIONS</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>useValue</span>: <span class=kt>options</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>ConfigService</span>
</span></span><span class=line><span class=cl>      <span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>ConfigService</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ConfigService 在内部注入 CONFIG_OPTIONS 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>ConfigService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>options</span>: <span class=kt>CONFIG_OPTIONS</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>文档后续还介绍了异步静态方法，这里就不介绍了，因为：</p><ul><li>不知道具体的使用场景，我在 Ng 里都没有碰到过；</li><li>太复杂了，对于我这个初学者。</li></ul><h2 id=注入作用域>注入作用域</h2><p>不同于 NgProvider 的<a class=link href=https://elementref.github.io/p/angular-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/#%E6%9C%8D%E5%8A%A1 target=_blank rel=noopener>
四种
</a>注入作用域，NestProvider 有三种注入作用域：</p><ul><li>DEFAULT，Provider 实例以单例存在，共享于整个应用，和应用共存亡；</li><li>REQUEST，每个实例和每个请求共存亡；请求开始，实例被创建；请求结束，实例被销毁：<ul><li>有<strong>冒泡</strong>特性，如果 UserService 是 Scope.REQUEST，依赖 UserService 的 Controller 也会变为 Scope.REQUEST；</li><li>可能会对应用性能产生不好的影响，因为<strong>每次请求</strong>过程都涉及到实例的创建和销毁，会降低接口响应时间；</li><li>没有<strong>捕获</strong>特性，UserService 的依赖不会受到影响，继续保持原有的作用域；</li><li>警惕其他组件被<strong>隐士转换</strong>为 Scope.REQUEST。</li></ul></li><li>TRANSIENT，每此被注入，都提供一个独享的 Provider 实例。</li></ul><p>如何改变注入作用域呢？一种是通过 @Injectable 装饰器的元数据进行修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Scope</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在 Angular 中，是使用 providedIn 进行声明的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>scope</span>: <span class=kt>Scope.DEFAULT</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>一种是在 Providers 声明中进行修改：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=err>provide:</span> <span class=err>&#39;CACHE_MANAGER&#39;,</span>
</span></span><span class=line><span class=cl>  <span class=err>useClass:</span> <span class=err>CacheManager,</span>
</span></span><span class=line><span class=cl>  <span class=err>scope:</span> <span class=err>Scope.TRANSIENT,</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>不止 Provider，Controller 也有作用域的概念。Controller 作用域将应用于名下的 RouteHandler：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>scope</span>: <span class=kt>Scope.REQUEST</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nest 作为基于 Express|Fastify 的框架，如果想要获取<strong>原始请求</strong>对象，可以在依赖注入时，指明 REQUEST 令牌：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Scope</span><span class=p>,</span> <span class=nx>Inject</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>REQUEST</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.REQUEST</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kd>@Inject</span><span class=p>(</span><span class=nx>REQUEST</span><span class=p>)</span> <span class=kr>private</span> <span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 Scope.TRANSIENT 的情况下，如果想要获取当前 class 在哪里被实例化的，可以在通过 INQUIRER 令牌访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Inject</span><span class=p>,</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Scope</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>INQUIRER</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.TRANSIENT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过 INQUIRER 能拿到父类
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>constructor</span><span class=p>(</span><span class=kd>@Inject</span><span class=p>(</span><span class=nx>INQUIRER</span><span class=p>)</span> <span class=kr>private</span> <span class=nx>parentClass</span>: <span class=kt>object</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>sayHello</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>parentClass</span><span class=o>?</span><span class=p>.</span><span class=kr>constructor</span><span class=o>?</span><span class=p>.</span><span class=nx>name</span><span class=si>}</span><span class=sb>: </span><span class=si>${</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在父组件正常依赖注入 UserService 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>getRoot</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>sayHello</span><span class=p>(</span><span class=s1>&#39;My name is getRoot&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;Hello world!&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=循环依赖>循环依赖</h2><p>简单的讲就是：classA 依赖 classB，同时 classB 依赖 classA。Nest 使用 forwardRef 解决循环依赖。</p><p>forwardRef 的作用是引用尚未存在的变量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Inject</span><span class=p>(</span><span class=nx>forwardRef</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=nx>CommonService</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>commonService</span>: <span class=kt>CommonService</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CommonService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Inject</span><span class=p>(</span><span class=nx>forwardRef</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=nx>UserService</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>UserService 和 CommonService 谁先被实例化是不确定，所以最好不要依赖于实例化顺序来实现业务逻辑。</p><p>forwardRef 还可以直接用于模块之间的引用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>forwardRef</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=nx>UserModule</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CommonModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>forwardRef</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=nx>CommonModule</span><span class=p>)]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=moduleref>ModuleRef</h2><p>Nest 内部维护了一个列表，保存着被 @Injectable 修饰的 Provider，及其对应的作为<strong>查找依据</strong>的 InjectionToken。ModuleRef 就是用来访问这个列表的，ModuleRef 还提供了一个方法来<strong>动态实例化</strong> Provider。</p><p>一个 class 可以通过注入 ModuleRef 来访问 ModuleRef 实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.DEFAULT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>moduleRef</span>: <span class=kt>ModuleRef</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ModuleRef 实例中有一个 get 方法，需要传入一个<strong>查找凭证</strong>，会返回在<strong>当前模块</strong>下已经注册并实例化的 Provider|Controller|Injectable（守卫、拦截器&mldr;）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.DEFAULT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=c1>// 同 Angular 一样，如果要使用对应的生命周期，需要先 implements
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>moduleRef</span>: <span class=kt>ModuleRef</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里，我们传入了 UserService 作为查找对象
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>UserService</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * true   在当前模块中查找
</span></span></span><span class=line><span class=cl><span class=cm>       * false  全局上下文中查找
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>strict</span>: <span class=kt>false</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;UserService &gt; onModuleInit &gt; this.userService&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>userService</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>若要查找一个作用域为 Scope:REQUEST 或 Scope:TRANSIENT 的模块，使用 resolve 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.DEFAULT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>moduleRef</span>: <span class=kt>ModuleRef</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// resolve 是异步的，使用 Promise/await
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>UserService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;UserService &gt; onModuleInit &gt; this.userService&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>userService</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 Scope:TRANSIENT 模块中每次调用 resolve 的返回值是唯一的，因为他是从自身的 DI 容器的子树中查找的，每个子树都有唯一的上下文标识符：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.TRANSIENT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>moduleRef</span>: <span class=kt>ModuleRef</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>UserService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>temp</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>UserService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 注意 @Injectable 中的参数，为 Scope:TRANSIENT ===&gt; false
</span></span></span><span class=line><span class=cl><span class=cm>     * 当 Scope.DEFAULT ===&gt; true，文档上没提到这一点
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>===</span> <span class=nx>temp</span><span class=p>);</span> <span class=c1>// false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span></code></pre></td></tr></table></div></div><p>resolve 方法还会接受一个上下文标识符，用于确定查找上下文：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.TRANSIENT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>moduleRef</span>: <span class=kt>ModuleRef</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>ContextId</span> <span class=o>=</span> <span class=nx>ContextIdFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>UserService</span><span class=p>,</span> <span class=nx>ContextId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>temp</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>moduleRef</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=nx>UserService</span><span class=p>,</span> <span class=nx>ContextId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>userService</span> <span class=o>===</span> <span class=nx>temp</span><span class=p>);</span> <span class=c1>// 指定为同一个上下文之后，返回 true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=模块懒加载>模块懒加载</h2><p>第一次知道，后端也可以有懒加载；印象中 Node 在不兼容 ESM 之前，CommonJS 的依赖都是同步加载的；在 Angular 的路由系统中，如果想要懒加载一个模块，需要使用 loadChildren 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>routes</span>: <span class=kt>Routes</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;login&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>loadChildren</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;./login/login.module&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=nx>m</span><span class=p>.</span><span class=nx>LoginModule</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>canActivate</span><span class=o>:</span> <span class=p>[</span><span class=nx>LoginGuard</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kd>@NgModule</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(</span><span class=nx>routes</span><span class=p>,</span> <span class=p>{})],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>RouterModule</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppRoutingModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>回到 Nest，懒加载主要是为了通过异步加载的方式提升应用冷启动速度。不过需要注意的是，被懒加载的模块中的生命周期函数<strong>不会执行</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>({</span> <span class=nx>scope</span>: <span class=kt>Scope.DEFAULT</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>lazyModuleLoader</span>: <span class=kt>LazyModuleLoader</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>moduleRef</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>lazyModuleLoader</span><span class=p>.</span><span class=nx>load</span><span class=p>(()</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>      <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../lazy/lazy.module&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>m</span> <span class=o>=&gt;</span> <span class=nx>m</span><span class=p>.</span><span class=nx>LazyModule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserService &gt; onModuleInit &gt; moduleRef&#39;</span><span class=p>,</span> <span class=nx>moduleRef</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>LazyService</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;../lazy/lazy.service&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>lazyService</span> <span class=o>=</span> <span class=nx>moduleRef</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>LazyService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserService &gt; onModuleInit &gt; lazyService&#39;</span><span class=p>,</span> <span class=nx>lazyService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>被懒加载的模块一旦加载成功，加载结果会被缓存；如果被二次加载，直接从缓存中返回；</li><li>懒加载模块和普通模块一样，同样存在于<strong>依赖图谱</strong>中；</li><li>Controllers 作为路由的集合不能被懒加载；</li><li>懒加载模块不能被 @Global 修饰符装饰。</li></ul><p>懒加载更多是用在<strong>根据不同的输入，启用不同的服务模块</strong>的场景，例如：Serverless|WebHook|CronSchdule&mldr;</p><h2 id=生命周期>生命周期</h2><p>同 Angular 组件一样，Nest 中的每个元素（模块、控制器、Provider）都有（Scope.REQUEST 的元素除外）生命周期钩子：</p><ul><li>开始，执行顺序取决于模块的导入顺序：<ul><li>Nest 核心完成启动；</li><li><strong>onModuleInit</strong>，依赖关系被确认时调用，Controller & Provider -> Module；</li><li><strong>onApplicationBootstrap</strong>，应用完成初始化时调用，Controller & Provider -> Module；</li></ul></li><li>运行：HTTP|WebSocket|MicroService 监听传入的请求，程序正常运行；</li><li>结束，当调用 app.close/process 收到退出信号，并且在应用引导时调用了 enableShutdownHooks 时：<ul><li>接收到退出信号；</li><li><strong>onModuleDestroy</strong>，接收到退出信号时调用，Controller & Provider -> Module；</li><li><strong>beforeApplicationShutdown</strong>，所有连接将被关闭，Controller & Provider -> Module；</li><li>HTTP|WebSocket|MicroService 停止监听请求；</li><li><strong>onApplicationShutdown</strong>，所有连接被关闭后调用，Controller & Provider -> Module</li><li>进程退出。</li></ul></li><li>注入作用域为 Scope.REQUEST 的元素除外，他们的生命周期不可预测（跟 request 共生）；</li><li>除了这些，Nest 还会调用内部的底层钩子。</li></ul><p>我们分别在 UserController、UserModule、AppController、AppModule 中实现生命周期：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>BeforeApplicationShutdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Module</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>OnApplicationBootstrap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>OnApplicationShutdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>OnModuleDestroy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>OnModuleInit</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./user.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>UserService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserModule</span>
</span></span><span class=line><span class=cl>  <span class=kr>implements</span>
</span></span><span class=line><span class=cl>    <span class=nx>OnModuleInit</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>OnApplicationBootstrap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>OnModuleDestroy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>BeforeApplicationShutdown</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>OnApplicationShutdown</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserModule &gt; onModuleInit&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onApplicationBootstrap() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserModule &gt; onApplicationBootstrap&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onModuleDestroy() {</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserModule &gt; onModuleDestroy&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>beforeApplicationShutdown</span><span class=p>(</span><span class=nx>signal?</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserModule &gt; beforeApplicationShutdown&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>onApplicationShutdown</span><span class=p>(</span><span class=nx>signal?</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;UserModule &gt; onApplicationShutdown&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>打印结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>UserController &gt; onModuleInit
</span></span><span class=line><span class=cl>UserModule &gt; onModuleInit
</span></span><span class=line><span class=cl>AppController &gt; onModuleInit
</span></span><span class=line><span class=cl>AppModule &gt; onModuleInit
</span></span><span class=line><span class=cl>---------------------------------------
</span></span><span class=line><span class=cl>UserController &gt; onApplicationBootstrap
</span></span><span class=line><span class=cl>UserModule &gt; onApplicationBootstrap
</span></span><span class=line><span class=cl>AppController &gt; onApplicationBootstrap
</span></span><span class=line><span class=cl>AppModule &gt; onApplicationBootstrap
</span></span></code></pre></td></tr></table></div></div><p>onModuleInit 从最里层组件执行，<strong>向上冒泡</strong>，直到最外层组件调用完毕；接着又从最里层组件开始调用 onApplicationBootstrap&mldr;</p><p>对于<strong>结束阶段</strong>的钩子，需要在入口调用 app.enableShutdownHooks：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableShutdownHooks</span><span class=p>();</span> <span class=c1>// 这里调用一下
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>setTimeout</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * app.close 仅仅会触发生命周期
</span></span></span><span class=line><span class=cl><span class=cm>     * 并不会真的让应用进程退出
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>app</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>应用运行起来之后，^C 退出程序，打印结果如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>UserController &gt; onModuleDestroy
</span></span><span class=line><span class=cl>UserModule &gt; onModuleDestroy
</span></span><span class=line><span class=cl>AppController &gt; onModuleDestroy
</span></span><span class=line><span class=cl>AppModule &gt; onModuleDestroy
</span></span><span class=line><span class=cl>------------------------------------------
</span></span><span class=line><span class=cl>UserController &gt; beforeApplicationShutdown
</span></span><span class=line><span class=cl>UserModule &gt; beforeApplicationShutdown
</span></span><span class=line><span class=cl>AppController &gt; beforeApplicationShutdown
</span></span><span class=line><span class=cl>AppModule &gt; beforeApplicationShutdown
</span></span><span class=line><span class=cl>--------------------------------------
</span></span><span class=line><span class=cl>UserController &gt; onApplicationShutdown
</span></span><span class=line><span class=cl>UserModule &gt; onApplicationShutdown
</span></span><span class=line><span class=cl>AppController &gt; onApplicationShutdown
</span></span><span class=line><span class=cl>AppModule &gt; onApplicationShutdown
</span></span></code></pre></td></tr></table></div></div><p>和<strong>开始阶段</strong>一致，也是具有<strong>冒泡</strong>特征，从里到外开始调用。</p><p>文档上提到，<strong>结束阶段</strong>的钩子可能在 Widnows 平台上不能正常工作；并且 enableShutdownHooks 内部是使用事件监听的方式实现的，可能会占用更多内存，所以没有默认开启。</p><h2 id=总结>总结</h2><ul><li>Module，用来划分资源/业务模块，每个 Module 包含了 Controller、Service、Entity、DTO 等等；</li><li>Guard，请求到达对应路由内部之前，检验是否满足对应的条件，保证 Handler  内部逻辑的单一性；</li><li>Controller，路由控制，对请求进行分流，交给不同的 Service 处理，并将结果返回；</li><li>Service，通过不同的方法，实现具体的业务逻辑；例如调用数据库和第三方接口；</li><li>Entity（Model），结合 ORM 使用，用来定义数据库结构和数据类型；</li><li>Decorator，一个函数，用来完成对方法的修改，实现不同的功能；</li><li>DTO，数据传输对象定义了传输数据的格式类型，用于数据验证。</li></ul></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C/><div class=article-image><img src=/img/cover/nestjs.png loading=lazy data-key data-hash=/img/cover/nestjs.png></div><div class=article-details><h2 class=article-title>Nest.js 学习笔记（二）</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2025
<a href=https://github.com/ElementRef target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#是什么>是什么</a></li><li><a href=#开始使用>开始使用</a></li><li><a href=#controller>Controller</a></li><li><a href=#service>Service</a></li><li><a href=#module>Module</a></li><li><a href=#中间件>中间件</a></li><li><a href=#异常过滤>异常过滤</a></li><li><a href=#管道>管道</a><ol><li><a href=#zod>Zod</a></li><li><a href=#全局管道>全局管道</a></li></ol></li><li><a href=#守卫>守卫</a><ol><li><a href=#自定义装饰器>自定义装饰器</a></li></ol></li><li><a href=#拦截器>拦截器</a></li><li><a href=#动态模块>动态模块</a></li><li><a href=#注入作用域>注入作用域</a></li><li><a href=#循环依赖>循环依赖</a></li><li><a href=#moduleref>ModuleRef</a></li><li><a href=#模块懒加载>模块懒加载</a></li><li><a href=#生命周期>生命周期</a></li><li><a href=#总结>总结</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script src=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>