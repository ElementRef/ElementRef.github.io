<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="最近在看一个 SASS 项目，涉及到了路由复用的概念；在搞清楚之后，发现很早就接触过相关的需求，那么路由复用适用于什么场景呢？
之前在花瓣网做基于 Next.js 的官网重构时，产品设计希望在用户从瀑布流进入到详情页时，保留瀑布流页面的渲染状态，方便用户在进行回退操作时，能够接着上次的内容继续浏览。在此之前，花瓣网是一个基于 Node 的 MPA，页面状态的保留依赖于浏览器的 bfcache；在重构的过程中，发现 React 和 Next.js 都没有提供路由复用的功能；当时找遍了社区，有一些基于 react-router 的实现方案，但在 Next.js 环境下无法使用。后来官方 有计划 提供一个 off-screen 组件来实现组件实例缓存的功能；六年后的今天，off-screen 已经更名为 activity ，但还是没有正式到来。
"><title>Angular 路由复用 · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/angular-%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8/"><link rel="stylesheet" href="/scss/style.min.e3ada81a20a36442eda74d5f51c493f0cd2a5917209f79dbc224fe2348d41d2e.css"><meta property="og:title" content="Angular 路由复用"><meta property="og:description" content="最近在看一个 SASS 项目，涉及到了路由复用的概念；在搞清楚之后，发现很早就接触过相关的需求，那么路由复用适用于什么场景呢？
之前在花瓣网做基于 Next.js 的官网重构时，产品设计希望在用户从瀑布流进入到详情页时，保留瀑布流页面的渲染状态，方便用户在进行回退操作时，能够接着上次的内容继续浏览。在此之前，花瓣网是一个基于 Node 的 MPA，页面状态的保留依赖于浏览器的 bfcache；在重构的过程中，发现 React 和 Next.js 都没有提供路由复用的功能；当时找遍了社区，有一些基于 react-router 的实现方案，但在 Next.js 环境下无法使用。后来官方 有计划 提供一个 off-screen 组件来实现组件实例缓存的功能；六年后的今天，off-screen 已经更名为 activity ，但还是没有正式到来。
"><meta property="og:url" content="https://ElementRef.github.io/p/angular-%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2025-02-16T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-16T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/angular.png"><meta name="twitter:title" content="Angular 路由复用"><meta name="twitter:description" content="最近在看一个 SASS 项目，涉及到了路由复用的概念；在搞清楚之后，发现很早就接触过相关的需求，那么路由复用适用于什么场景呢？
之前在花瓣网做基于 Next.js 的官网重构时，产品设计希望在用户从瀑布流进入到详情页时，保留瀑布流页面的渲染状态，方便用户在进行回退操作时，能够接着上次的内容继续浏览。在此之前，花瓣网是一个基于 Node 的 MPA，页面状态的保留依赖于浏览器的 bfcache；在重构的过程中，发现 React 和 Next.js 都没有提供路由复用的功能；当时找遍了社区，有一些基于 react-router 的实现方案，但在 Next.js 环境下无法使用。后来官方 有计划 提供一个 off-screen 组件来实现组件实例缓存的功能；六年后的今天，off-screen 已经更名为 activity ，但还是没有正式到来。
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/angular.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta name="robots" content="noarchive, noindex, nofollow"><meta name="theme-color" content="#ffffff"><script defer="" src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2"></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu7590466716559688570.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://space.bilibili.com/593541941" target="_blank" title="Bilibili"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"></path><path d="M8 3l2 3"></path><path d="M16 3l-2 3"></path><path d="M9 13v-2"></path><path d="M15 11v2"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/index.xml" target="_blank"><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="5" cy="19" r="1"></circle><path d="M4 4a16 16 0 0116 16"></path><path d="M4 11a9 9 0 019 9"></path></svg>
<span>订阅</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/angular-%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8/"><img src="/img/cover/angular.webp" alt="Angular 路由复用" fetchpriority="high" decoding="async" width="1998" height="1200"></a></div><div class="article-details"><header class="article-category"><a href="/categories/angular/">Angular</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/angular-%E8%B7%AF%E7%94%B1%E5%A4%8D%E7%94%A8/">Angular 路由复用</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Feb 16, 2025</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：7 分钟</time></div></footer></div></header><section class="article-content"><p>最近在看一个 SASS 项目，涉及到了<strong>路由复用</strong>的概念；在搞清楚之后，发现很早就接触过相关的需求，那么路由复用适用于什么场景呢？</p><p>之前在花瓣网做基于 Next.js 的官网重构时，产品设计希望在用户从瀑布流进入到详情页时，保留瀑布流页面的渲染状态，方便用户在进行回退操作时，能够接着上次的内容继续浏览。在此之前，花瓣网是一个基于 Node 的 MPA，页面状态的保留依赖于浏览器的 bfcache；在重构的过程中，发现 React 和 Next.js 都没有提供路由复用的功能；当时找遍了社区，有一些基于 react-router 的实现方案，但在 Next.js 环境下无法使用。后来官方<a class="link" href="https://zh-hans.react.dev/blog/2022/06/15/react-labs-what-we-have-been-working-on-june-2022#offscreen" target="_blank" rel="noopener">
有计划
</a>提供一个 off-screen 组件来实现组件实例缓存的功能；六年后的今天，off-screen 已经更名为 <a class="link" href="https://zh-hans.react.dev/blog/2024/02/15/react-labs-what-we-have-been-working-on-february-2024#offscreen-renamed-to-activity" target="_blank" rel="noopener">activity
</a>，但还是没有正式到来。</p><h2 id="vue">Vue</h2><p>在说 Angular 之前，我想先说一下 Vue 内置的 keep-alive，它可以搭配 router-view 实现<strong>路由复用</strong>；被复用的组件不会被重新挂载/卸载，组件的内部状态被完整保留：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-vue" data-lang="vue"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">setup</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ts"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">KeepAlive</span><span class="p">,</span> <span class="nx">onMounted</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">watchEffect</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'vue'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">isNavigationFailure</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Router</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouterLink</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouterView</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">useRouter</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="nx">from</span> <span class="s1">'vue-router'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">keepAliveRef</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">&lt;</span><span class="nt">KeepAlive</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'App.vue:4 &gt; keepAliveRef'</span><span class="p">,</span> <span class="nx">keepAliveRef</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">temp</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">&lt;</span><span class="nt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span><span class="o">&gt;</span><span class="p">([]);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">afterEach</span> <span class="p">}</span><span class="o">:</span> <span class="nx">Router</span> <span class="o">=</span> <span class="nx">useRouter</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="nx">afterEach</span><span class="p">((</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">failure</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isNavigationFailure</span><span class="p">(</span><span class="nx">failure</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">temp</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">temp</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">watchEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 似乎没办法知道 keep-alive 中的缓存数量
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 特别是当 keep-alive 配置了缓存策略时
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'App.vue:21 &gt; watchEffect &gt; temp.value.length'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">temp</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">name</span><span class="o">=</span><span class="s">"home"</span> <span class="o">:</span><span class="na">to</span><span class="o">=</span><span class="s">"{ name: 'home' }"</span><span class="p">&gt;</span><span class="nx">home</span><span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">name</span><span class="o">=</span><span class="s">"posts"</span> <span class="o">:</span><span class="na">to</span><span class="o">=</span><span class="s">"{ name: 'posts' }"</span><span class="p">&gt;</span><span class="nx">posts</span><span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">router-link</span> <span class="na">name</span><span class="o">=</span><span class="s">"about"</span> <span class="o">:</span><span class="na">to</span><span class="o">=</span><span class="s">"{ name: 'about' }"</span><span class="p">&gt;</span><span class="nx">about</span><span class="p">&lt;/</span><span class="nt">router-link</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">router-view</span> <span class="nt">v-slot</span><span class="o">=</span><span class="s">"{ Component: RouteComponent }"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">keep-alive</span> <span class="na">ref</span><span class="o">=</span><span class="s">"keepAliveRef"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">component</span> <span class="nt">:is</span><span class="o">=</span><span class="s">"RouteComponent"</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">keep-alive</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">router-view</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>我们在 HomeView 组件的生命周期中打印一些信息：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-vue" data-lang="vue"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">script</span> <span class="na">setup</span> <span class="na">lang</span><span class="o">=</span><span class="s">"ts"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onActivated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onDeactivated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onMounted</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onUnmounted</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ref</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">watchEffect</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="nx">from</span> <span class="s1">'vue'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">&lt;</span><span class="nt">number</span><span class="p">&gt;(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">watchEffect</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">currentIndex</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">ref</span><span class="p">&lt;</span><span class="nt">typeof</span> <span class="na">setInterval</span><span class="p">&gt;(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">restartInterval</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">interval</span><span class="p">.</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">interval</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">currentIndex</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">currentIndex</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="nx">onMounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeView onMounted'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">restartInterval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">onUnmounted</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeView onUnmounted'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">interval</span><span class="p">.</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">onActivated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeView onActivated'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">restartInterval</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">onDeactivated</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeView onDeactivated'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">interval</span><span class="p">.</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">interval</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">"home"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="nx">This</span> <span class="nx">is</span> <span class="nx">an</span> <span class="nx">home</span> <span class="nx">page</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>通过控制台，我们能知道：当我们通过 router-link 将路由切换到 /posts 或者 /about 时，onDeactivated 执行，onUnmounted 没有执行，这表示组件没有被卸载；同时，当 HomeView 切回台前时，watchEffect 将接着上次的 currentIndex 值继续向控制台打印；这说明 HomeView 内部的状态及关联的副作用并没有被<strong>清除</strong>。</p><p>通过浏览器的前进/后退功能进行页面导航时，结论依然成立；此外，我们还可以通过 onActivated/onDeactivated 来执行/清理一些副作用。</p><h2 id="angular">Angular</h2><p>上述功能对 Ng 来说，就没那么容易实现了；Ng 并没有提供 keep-alive 组件，也没有提供 onActivated/onDeactivated 钩子。如果要在 Ng 中实现相同的功能，需要借助 <a class="link" href="https://angular.cn/api/router/RouteReuseStrategy" target="_blank" rel="noopener">RouteReuseStrategy
</a>。</p><p>我们可以通过查找 DefaultRouteReuseStrategy 关键字查找 Ng 默认的<a class="link" href="https://github.com/angular/angular/blob/628ab4033bd3d165f235806632484895bb1f056f/packages/router/src/route_reuse_strategy.ts#L80" target="_blank" rel="noopener">
路由复用策略
</a>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DetachedRouteHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouteReuseStrategy</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RouteReuseStrategyExample</span> <span class="kr">implements</span> <span class="nx">RouteReuseStrategy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 将分离的 ActivatedRouteSnapshot，重新连接
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果返回 true，retrieve 方法会被调用
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果返回 false，组件会被重新创建
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">shouldAttach</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 是否分离 ActivatedRouteSnapshot，方便复用
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果返回 true，store 方法会被调用
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 拿到分离的路由信息
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">shouldDetach</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ActivatedRouteSnapshot 是否被复用
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果返回 true，路由不会跳转
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果返回 false，路由会跳转
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">shouldReuseRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">future</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span> <span class="c1">// 表示将要进入的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">curr</span>: <span class="kt">ActivatedRouteSnapshot</span> <span class="c1">// 表示将要离开的路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 当我们从 Home 切换到 Posts 时
</span></span></span><span class="line"><span class="cl"><span class="cm">     * future.routeConfig?.path -&gt; posts
</span></span></span><span class="line"><span class="cl"><span class="cm">     * curr.routeConfig?.path   -&gt; home
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">future</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'route.reuse.strategy.example.ts:20 &gt; RouteReuseStrategyExample &gt; future'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">future</span><span class="p">.</span><span class="nx">routeConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curr</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'route.reuse.strategy.example.ts:20 &gt; RouteReuseStrategyExample &gt; curr'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">curr</span><span class="p">.</span><span class="nx">routeConfig</span><span class="o">?</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">future</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">===</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">routeConfig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 拿到被分离的 ActivatedRouteSnapshot 对应的 DetachedRouteHandle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">store</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handle</span>: <span class="kt">DetachedRouteHandle</span> <span class="o">|</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 查找并返回 ActivatedRouteSnapshot 对应的缓存
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">retrieve</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="nx">DetachedRouteHandle</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>此时，我们在组件的生命周期钩子中输出日志，发现路由对应的组件是会被卸载和重新挂载的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnDestroy</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-home'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">'./home.component.html'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">styleUrls</span><span class="o">:</span> <span class="p">[</span><span class="s1">'./home.component.css'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">imports</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">standalone</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HomeComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnInit'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnDestroy</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnDestroy'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>很显然，路由复用还没有启用，我们在 ApplicationConfig 中引入 RouteReuseStrategyExample：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">ApplicationConfig</span><span class="p">,</span> <span class="nx">provideZoneChangeDetection</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">provideRouter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouteReuseStrategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">withComponentInputBinding</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">routes</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'./app.routes'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RouteReuseStrategyExample</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'./route.reuse.strategy.example'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">appConfig</span>: <span class="kt">ApplicationConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">providers</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="nx">provideZoneChangeDetection</span><span class="p">({</span> <span class="nx">eventCoalescing</span>: <span class="kt">true</span> <span class="p">}),</span>
</span></span><span class="line"><span class="cl">    <span class="nx">provideRouter</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">withComponentInputBinding</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">provide</span>: <span class="kt">RouteReuseStrategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">useClass</span>: <span class="kt">RouteReuseStrategyExample</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>当然，这还不够；我们 RouteReuseStrategyExample 中使用的是默认策略，我们来修改一下：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DetachedRouteHandle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">RouteReuseStrategy</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/router'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RouteReuseStrategyExample</span> <span class="kr">implements</span> <span class="nx">RouteReuseStrategy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 在静态属性上设置一个缓存，当然也可以在外部定义一个变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">static</span> <span class="nx">handlers</span><span class="o">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">key</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="kt">any</span> <span class="p">}</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 这里拿 path 作为缓存的 key；当缓存存在时，将分离的路由重新连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">shouldAttach</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!!</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 当路由对象存在时，分离路由
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">shouldDetach</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">!!</span><span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 是否复用，这里使用默认配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">shouldReuseRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">future</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curr</span>: <span class="kt">ActivatedRouteSnapshot</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">future</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">===</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">routeConfig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 将缓存添加到 RouteReuseStrategyExample.handlers 上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">store</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handle</span>: <span class="kt">DetachedRouteHandle</span> <span class="o">|</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 这里要同时判断一下 path 和 handle
</span></span></span><span class="line"><span class="cl"><span class="cm">     * path 是我们存储的索引
</span></span></span><span class="line"><span class="cl"><span class="cm">     * handle 有可能是 null
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">handle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 能找到分离路由对应的缓存时，返回缓存数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">retrieve</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">)</span><span class="o">:</span> <span class="nx">DetachedRouteHandle</span> <span class="o">|</span> <span class="kc">null</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>经过上述配置，路由复用策略生效了；当我们从 Home 切换到 Posts 时，Home 组件的 ngOnDestroy 并没有执行，内部状态得到保留。</p><p>但是 Ng 并没有提供 onActivated/onDeactivated 钩子函数；使得组件不能知晓自己是否处于活动状态。从 RouteReuseStrategy 的类型可以看出，只有 shouldReuseRoute 有能力同时访问到新旧的路由对象。</p><p>那么，我们怎么能获取组件实例呢？查看 ActivatedRouteSnapshot 的类型，发现只能获取到组件的<strong>构造函数</strong>：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">declare</span> <span class="kr">class</span> <span class="nx">ActivatedRouteSnapshot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">component</span>: <span class="kt">Type</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">data</span>: <span class="kt">Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fragment</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">outlet</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">params</span>: <span class="kt">Params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queryParams</span>: <span class="kt">Params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">toString</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">url</span>: <span class="kt">UrlSegment</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">readonly</span> <span class="nx">routeConfig</span>: <span class="kt">Route</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">children</span><span class="p">()</span><span class="o">:</span> <span class="nx">ActivatedRouteSnapshot</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">firstChild</span><span class="p">()</span><span class="o">:</span> <span class="nx">ActivatedRouteSnapshot</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">paramMap</span><span class="p">()</span><span class="o">:</span> <span class="nx">ParamMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">parent</span><span class="p">()</span><span class="o">:</span> <span class="nx">ActivatedRouteSnapshot</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">pathFromRoot</span><span class="p">()</span><span class="o">:</span> <span class="nx">ActivatedRouteSnapshot</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">queryParamMap</span><span class="p">()</span><span class="o">:</span> <span class="nx">ParamMap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">root</span><span class="p">()</span><span class="o">:</span> <span class="nx">ActivatedRouteSnapshot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">title</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>其实，Ng 已经帮我们做好了；对组件实例的引用存在于 store 的第二个参数内；虽然 Ng 在 d.ts 中并没有告诉我们 <a class="link" href="https://angular.cn/api/router/DetachedRouteHandle" target="_blank" rel="noopener">DetachedRouteHandle
</a>的具体类型；我们打印一下：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RouteReuseStrategyExample</span> <span class="kr">implements</span> <span class="nx">RouteReuseStrategy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">store</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handle</span>: <span class="kt">DetachedRouteHandle</span> <span class="o">|</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">path</span> <span class="o">&amp;&amp;</span> <span class="nx">handle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * componentRef
</span></span></span><span class="line"><span class="cl"><span class="cm">       * contexts
</span></span></span><span class="line"><span class="cl"><span class="cm">       * route
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'route.reuse.strategy.example.ts:37 &gt; RouteReuseStrategyExample &gt; handle'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">handle</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>发现，DetachedRouteHandle 上存在一个 <a class="link" href="https://angular.cn/api/core/ComponentRef" target="_blank" rel="noopener">componentRef
</a>属性，它是 <a class="link" href="https://angular.cn/api/core/ComponentFactory" target="_blank" rel="noopener">ComponentFactory
</a>的返回值；它的 instance 属性指向的就是组件实例；知道了这一点，我们就可以手动调用组件实例内部的方法了：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RouteReuseStrategyExample</span> <span class="kr">implements</span> <span class="nx">RouteReuseStrategy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">shouldReuseRoute</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">future</span>: <span class="kt">ActivatedRouteSnapshot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curr</span>: <span class="kt">ActivatedRouteSnapshot</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span>: <span class="kt">futurePath</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">future</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span>: <span class="kt">currPath</span> <span class="o">=</span> <span class="kc">null</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">curr</span><span class="o">?</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">futurePath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">componentRef</span>: <span class="kt">futureComponentRef</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="o">?</span><span class="p">.[</span><span class="nx">futurePath</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">instance</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">futureComponentRef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">onActivated</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 这里需要做一下判断，因为部分组件可能没有 onActivated/onDeactivated 方法
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onActivated</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onActivated</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span> <span class="c1">// 需要修正 this 指向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">currPath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">componentRef</span>: <span class="kt">currComponentRef</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nx">RouteReuseStrategyExample</span><span class="p">.</span><span class="nx">handlers</span><span class="o">?</span><span class="p">.[</span><span class="nx">currPath</span><span class="p">]</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">instance</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">currComponentRef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">onDeactivated</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">onDeactivated</span> <span class="o">===</span> <span class="s1">'function'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onDeactivated</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">future</span><span class="p">.</span><span class="nx">routeConfig</span> <span class="o">===</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">routeConfig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>我们在 RouteReuseStrategyExample.handlers 缓存中拿到组件实例，并执行组件实例中的 onActivated/onDeactivated 方法：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">OnDestroy</span><span class="p">,</span> <span class="nx">OnInit</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Component</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">selector</span><span class="o">:</span> <span class="s1">'app-home'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">'./home.component.html'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">styleUrls</span><span class="o">:</span> <span class="p">[</span><span class="s1">'./home.component.css'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">imports</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="nx">standalone</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HomeComponent</span> <span class="kr">implements</span> <span class="nx">OnInit</span><span class="p">,</span> <span class="nx">OnDestroy</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnInit() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnInit'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ngOnDestroy</span><span class="p">()</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnDestroy'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onActivated() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnActivated'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onDeactivated() {</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'HomeComponent OnDeactivated'</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>此时，在多个路由之前来回切换，你会发现 onActivated/onDeactivated 方法正常执行了。</p><p>但是，Ng 提供的 RouteReuseStrategy 还存在一些问题：</p><ul><li>keep-alive 是会调用整个组件树上的所有组件的 onActivated/onDeactivated 钩子的；而 RouteReuseStrategy 只会影响路由配置中指向的那个组件；</li><li>没有 keep-alive 的 include ｜ exclude ｜ max 缓存控制策略，需要自己在 RouteReuseStrategy 中实现。</li></ul><p>对于第一个问题，DetachedRouteHandle 中只能获取到路由直接绑定的组件实例；除了使用模版变量 + ViewChild 之外，Ng 也没有提供额外的获取子组件实例的 API。</p><p>为了能调用子孙组件的 onActivated/onDeactivated 方法，我们不得不在组件中通过 ViewChild 来获取子组件实例并手动调用对应方法。或者，维护一个全局状态；每个组件在 OnInit 时，手动将自己（实例）添加到路由对应的组件实例数组中。这样，我们在 shouldReuseRoute 方法中，可以从全局状态中获取路由对应的组件实例集合，通过遍历数组集合来调用实例内部的对应的 onActivated/onDeactivated 方法。</p><p>这两种解决方式都对组件原本的逻辑有较大的侵入，并不优雅；RouteReuseStrategy 和 keep-alive 两者的功能出发点本来就不一样，所以上述存在的问题也说得通。</p><p>对于第二个问题，我们可以自己实现缓存控制，而且缓存策略的灵活性会比 keep-alive 更能贴近业务场景。</p></section><footer class="article-footer"><section class="article-copyright"><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><path d="M14.5 9a3.5 4 0 100 6"></path></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/%E5%B0%81%E8%A3%85-prosearch-%E4%B8%8E-protable-%E7%BB%84%E4%BB%B6/"><div class="article-image"><img src="/img/cover/angular.webp" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1998" height="1200"></div><div class="article-details"><h2 class="article-title">封装 ProSearch 与 ProTable 组件</h2></div></a></article><article class="has-image"><a href="/p/angular-%E7%BB%84%E4%BB%B6%E8%AE%BE%E8%AE%A1/"><div class="article-image"><img src="/img/cover/angular.webp" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1998" height="1200"></div><div class="article-details"><h2 class="article-title">Angular 组件设计</h2></div></a></article><article class="has-image"><a href="/p/angular-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/"><div class="article-image"><img src="/img/cover/angular.webp" loading="lazy" data-key="" data-hash="/img/cover/angular.png" alt="" decoding="async" width="1998" height="1200"></div><div class="article-details"><h2 class="article-title">Angular 快速上手</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright">©
2017 -
2025
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽</a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="widget-title section-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#vue">Vue</a></li><li><a href="#angular">Angular</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>