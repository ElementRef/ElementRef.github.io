<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1,user-scalable=no'><meta name=description content='应用配置 一般来说，不同的运行环境需要有不同的应用配置；比如测试环境需要连接测试库，生产环境需要连接生产库。你肯定想到了通过 dotenv 将环境变量映射到 process.env 上；当然，在 Nest 中继续使用 dotenv 不是不可以；但是 Nest 提供了一种更为优雅的方式 @nestjs/config，当然内部还是依赖于 dotenv：
'><title>Nest.js 学习笔记（二） · I AM BEA, I DRINK TEA</title>
<link rel=canonical href=https://ElementRef.github.io/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C/><link rel=stylesheet href=/scss/style.min.d6809e5639fb998c6711f9853fc8acf566af544fac0fefc29782b521a7f47931.css><meta property='og:title' content='Nest.js 学习笔记（二）'><meta property='og:description' content='应用配置 一般来说，不同的运行环境需要有不同的应用配置；比如测试环境需要连接测试库，生产环境需要连接生产库。你肯定想到了通过 dotenv 将环境变量映射到 process.env 上；当然，在 Nest 中继续使用 dotenv 不是不可以；但是 Nest 提供了一种更为优雅的方式 @nestjs/config，当然内部还是依赖于 dotenv：
'><meta property='og:url' content='https://ElementRef.github.io/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-10-28T00:00:00+00:00'><meta property='article:modified_time' content='2024-10-28T00:00:00+00:00'><meta property='og:image' content='https://ElementRef.github.io/img/cover/nestjs.png'><meta name=twitter:title content="Nest.js 学习笔记（二）"><meta name=twitter:description content="应用配置 一般来说，不同的运行环境需要有不同的应用配置；比如测试环境需要连接测试库，生产环境需要连接生产库。你肯定想到了通过 dotenv 将环境变量映射到 process.env 上；当然，在 Nest 中继续使用 dotenv 不是不可以；但是 Nest 提供了一种更为优雅的方式 @nestjs/config，当然内部还是依赖于 dotenv：
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://ElementRef.github.io/img/cover/nestjs.png'><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=robots content="noarchive, noindex, nofollow"><meta name=theme-color content="#ffffff"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7590466716559688570.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>I AM BEA, I DRINK TEA</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/index.xml target=_blank><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>订阅</span></a></li><li><a href=https://github.com/ElementRef/AboutConfig target=_blank><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg>
<span>配置</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C/><img src=/img/cover/nestjs.png loading=lazy alt="Nest.js 学习笔记（二）"></a></div><div class=article-details><header class=article-category><a href=/categories/nest.js/>Nest.js</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%BA%8C/>Nest.js 学习笔记（二）</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Oct 28, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：26 分钟</time></div></footer></div></header><section class=article-content><h2 id=应用配置>应用配置</h2><p>一般来说，不同的运行环境需要有不同的应用配置；比如测试环境需要连接测试库，生产环境需要连接生产库。你肯定想到了通过 dotenv 将环境变量映射到 process.env 上；当然，在 Nest 中继续使用 dotenv 不是不可以；但是 Nest 提供了一种更为优雅的方式 @nestjs/config，当然内部还是依赖于 dotenv：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add @nestjs/config
</span></span></code></pre></td></tr></table></div></div><p>ConfigModule 是一个动态模块，并且需要在根模块 AppModule 中导入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * ConfigModule 会自动解析项目根目录下的 .env 文件
</span></span></span><span class=line><span class=cl><span class=cm>     * 并将内容合并到 process.env 上
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>envFilePath</span><span class=o>:</span> <span class=s1>&#39;.env.production&#39;</span><span class=p>,</span> <span class=c1>// 指定一个 .env
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>envFilePath</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;.env.local&#39;</span><span class=p>,</span> <span class=s1>&#39;.env.development&#39;</span><span class=p>],</span> <span class=c1>// 指定多个 .env
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>ignoreEnvFile</span>: <span class=kt>true</span><span class=p>,</span> <span class=c1>// 禁止加载 .env
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>isGlobal</span>: <span class=kt>true</span><span class=p>,</span> <span class=c1>// 使用全局导入，不需要在其他模块导入
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>load</span><span class=o>:</span> <span class=p>[</span><span class=nx>configuration</span><span class=p>],</span> <span class=c1>// 加载自定义配置文件
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>cache</span>: <span class=kt>true</span> <span class=c1>// 启用缓存，性能更好
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// 自定义配置文件，config/configuration.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>configuration</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span>: <span class=kt>parseInt</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span> <span class=o>||</span> <span class=mi>3000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>database</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>host</span>: <span class=kt>process.env.DATABASE_HOST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>port</span>: <span class=kt>parseInt</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATABASE_PORT</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span> <span class=o>||</span> <span class=mi>5432</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>forRoot 方法接受一个 options 并会向应用中注入 ConfigService：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>class</span> <span class=nx>ConfigModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>static</span> <span class=kr>async</span> <span class=nx>forRoot</span><span class=p>(</span><span class=nx>options</span> <span class=o>=</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 根据 options，解析 env 文件
</span></span></span><span class=line><span class=cl><span class=cm>     * 并对 env 数据进行验证
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理变量冲突和优先级问题
</span></span></span><span class=line><span class=cl><span class=cm>     * shell 优先级高于 .env
</span></span></span><span class=line><span class=cl><span class=cm>     * ...
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>module</span>: <span class=kt>ConfigModule_1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=kr>global</span><span class=o>:</span> <span class=nx>options</span><span class=p>.</span><span class=nx>isGlobal</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>providers</span>: <span class=kt>isConfigToLoad</span>
</span></span><span class=line><span class=cl>        <span class=o>?</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=p>...</span><span class=nx>providers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nx>provide</span>: <span class=kt>config_constants_1.CONFIGURATION_LOADER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=nx>useFactory</span><span class=o>:</span> <span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=p>...</span><span class=nx>configurations</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>configurations</span><span class=p>.</span><span class=nx>forEach</span><span class=p>((</span><span class=nx>item</span><span class=p>,</span> <span class=nx>index</span><span class=p>)</span> <span class=o>=&gt;</span>
</span></span><span class=line><span class=cl>                  <span class=k>this</span><span class=p>.</span><span class=nx>mergePartial</span><span class=p>(</span><span class=nx>host</span><span class=p>,</span> <span class=nx>item</span><span class=p>,</span> <span class=nx>providers</span><span class=p>[</span><span class=nx>index</span><span class=p>])</span>
</span></span><span class=line><span class=cl>                <span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>},</span>
</span></span><span class=line><span class=cl>              <span class=nx>inject</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=nx>config_constants_1</span><span class=p>.</span><span class=nx>CONFIGURATION_TOKEN</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=p>...</span><span class=nx>configProviderTokens</span>
</span></span><span class=line><span class=cl>              <span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=o>:</span> <span class=nx>providers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 导出了 ConfigService
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>config_service_1</span><span class=p>.</span><span class=nx>ConfigService</span><span class=p>,</span> <span class=p>...</span><span class=nx>configProviderTokens</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ConfigService 提供了一个 get 方法，用于访问环境变量内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果 ConfigModule 不是全局模块
</span></span></span><span class=line><span class=cl><span class=cm>     * 需要先在对应模块导入 ConfigModule
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>configService</span>: <span class=kt>ConfigService</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;AppController &gt; configService&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 第二个参数是默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>configService</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;(</span><span class=s1>&#39;PASSWORD&#39;</span><span class=p>,</span> <span class=s1>&#39;00000&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=命名空间>命名空间</h3><p>ConfigModule 还支持环境变量命名空间，需要使用 registerAs 自定义配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>registerAs</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=nx>registerAs</span><span class=p>(</span><span class=s1>&#39;database&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>post</span><span class=o>:</span> <span class=s1>&#39;5432&#39;</span>
</span></span><span class=line><span class=cl><span class=p>}));</span>
</span></span></code></pre></td></tr></table></div></div><p>并通过 load 属性加载配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>databaseConfig</span> <span class=kr>from</span> <span class=s1>&#39;../config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>load</span><span class=o>:</span> <span class=p>[</span><span class=nx>databaseConfig</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，便可以通过 ConfigService 进行访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>configService</span>: <span class=kt>ConfigService</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 访问 database 下的 host 配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;AppController &gt; configService&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>configService</span><span class=p>.</span><span class=kr>get</span><span class=p>&lt;</span><span class=nt>string</span><span class=p>&gt;(</span><span class=s1>&#39;database.host&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=局部注册>局部注册</h3><p>如果你的应用很庞大，每个部分使用的配置不一样，可以采取局部注册的方式；ConfigModule 提供了局部注册的静态方法 forFeature：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>databaseConfig</span> <span class=kr>from</span> <span class=s1>&#39;../config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=c1>// databaseConfig 不会暴露到别的模块去
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>forFeature</span><span class=p>(</span><span class=nx>databaseConfig</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>DatabaseModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是，局部注册的变量可能在构造函数中访问不到；因为 forFeature 是在模块初始化的过程中运行的，所以请在 onModuleInit 中获取局部注册的环境变量。</p><h3 id=变量验证>变量验证</h3><p>在上一节，我们提到<strong>验证前置</strong>；在请求真正进入 RouteHandler 之前，最好把参数、权限等验证逻辑提前，尽早抛出错误；而不是将验证逻辑和具体业务逻辑参杂在 RouteHandler 中；这里同样，在应用启动之前，应验证所有环境变量，而不是将问题留到运行时再解决。</p><p>ConfigModule 允许我们自定义验证函数，来对环境变量进行验证；这里，我们需要用到 <a class=link href=https://github.com/hapijs/joi target=_blank rel=noopener>Joi
</a>；当然，你也可以试试上一节用到的 Zod：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add joi
</span></span></code></pre></td></tr></table></div></div><p>并在 AppModule 中添加验证逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>Joi</span> <span class=kr>from</span> <span class=s1>&#39;joi&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>databaseConfig</span> <span class=kr>from</span> <span class=s1>&#39;../config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>load</span><span class=o>:</span> <span class=p>[</span><span class=nx>databaseConfig</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>validationSchema</span>: <span class=kt>Joi.object</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 对 NODE_ENV 进行验证并提供默认值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>NODE_ENV</span>: <span class=kt>Joi.string</span><span class=p>()</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>valid</span><span class=p>(</span><span class=s1>&#39;development&#39;</span><span class=p>,</span> <span class=s1>&#39;production&#39;</span><span class=p>,</span> <span class=s1>&#39;test&#39;</span><span class=p>,</span> <span class=s1>&#39;provision&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=k>default</span><span class=p>(</span><span class=s1>&#39;development&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>host</span>: <span class=kt>Joi.string</span><span class=p>().</span><span class=k>default</span><span class=p>(</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span>: <span class=kt>Joi.number</span><span class=p>().</span><span class=nx>port</span><span class=p>().</span><span class=k>default</span><span class=p>(</span><span class=mi>3000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=nx>validationOptions</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>allowUnknown</span>: <span class=kt>true</span><span class=p>,</span> <span class=c1>// 允许 validationSchema 中，未定义的环境变量存在
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>abortEarly</span>: <span class=kt>true</span> <span class=c1>// 发现错误，立即返回（true）；将所有错误返回（false）
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=可扩展变量>可扩展变量</h3><p>@nestjs/config 支持在 .env 文件中使用变量扩展：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>PASSWORD=1234567</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>SUPPORT_EMAIL=support@${PASSWORD}.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>&lt;!-- SUPPORT_EMAIL 的值为 support@1234567.com --&gt;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果要使用变量扩展，需要传入 expandVariables 属性：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ConfigModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>expandVariables</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=maints-中使用>main.ts 中使用</h3><p>如果要在应用入口 main.ts 中使用 ConfigService，需要调用 app.get：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConfigService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/config&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>configService</span> <span class=o>=</span> <span class=nx>app</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>ConfigService</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;bootstrap &gt; configService&#39;</span><span class=p>,</span> <span class=nx>configService</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;SUPPORT_EMAIL&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=数据库集成>数据库集成</h2><p>文档上介绍了 TypeORM 和 SequelizeORM，但是社区好像更青睐 Prisma；好在 Nest 也对 Prisma 做了<a class=link href=https://docs.nestjs.com/recipes/prisma target=_blank rel=noopener>
官方指南
</a>。</p><p>首先，需要安装并运行 PrismaCLI：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add prisma
</span></span><span class=line><span class=cl>npx prisma init
</span></span></code></pre></td></tr></table></div></div><p>执行完毕后，会生成 prisma/schema.prisma 文件，指定了数据库类型和模式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>generator client {
</span></span><span class=line><span class=cl>  provider = &#34;prisma-client-js&#34;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>datasource db {
</span></span><span class=line><span class=cl>  // 我这里连接的 Supabase，需要加上 DIRECT_URL
</span></span><span class=line><span class=cl>  directUrl = env(&#34;DIRECT_URL&#34;)
</span></span><span class=line><span class=cl>  url       = env(&#34;DATABASE_URL&#34;)
</span></span><span class=line><span class=cl>  provider  = &#34;postgres&#34;
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>并更新了 .env 文件，新增了 DATABASE_URL：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=l>DATABASE_URL=&#34;postgresql://postgres.vvclzaevlgvyzgb:agcjowndrzlgpei@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>DIRECT_URL=&#34;postgresql://postgres.vvclzaevlgvyzgb:agcjowndrzlgpei@aws-0-us-east-1.pooler.supabase.com:5432/postgres&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>接着，我们更新 schema.prisma 文件，定义两张表：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>model User {
</span></span><span class=line><span class=cl>  id    Int     @default(autoincrement()) @id
</span></span><span class=line><span class=cl>  email String  @unique
</span></span><span class=line><span class=cl>  name  String?
</span></span><span class=line><span class=cl>  posts Post[]
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>model Post {
</span></span><span class=line><span class=cl>  id        Int      @default(autoincrement()) @id
</span></span><span class=line><span class=cl>  title     String
</span></span><span class=line><span class=cl>  content   String?
</span></span><span class=line><span class=cl>  published Boolean? @default(false)
</span></span><span class=line><span class=cl>  author    User?    @relation(fields: [authorId], references: [id])
</span></span><span class=line><span class=cl>  authorId  Int?
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>插播一下，表与表有四种关系：</p><ul><li>一对一，当前表中的一条数据，只对应外表中的一条数据；</li><li>一对多，当前表中的一条数据，对应着外表中的多条数据；</li><li>多对一，当前表中的多条数据，都指向外表中的单条数据；</li><li>多对多，每条数据在外表中对应多行，外表中的数据同样。</li></ul><p>这里 User.posts，就是一对多关系；Post.author 就是多对一关系。</p><p>接着，使用 PrismaMigrate 创建表：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>npx prisma migrate dev --name init
</span></span></code></pre></td></tr></table></div></div><p>PrismaMigrate 是用来对数据库进行增量更新的工具，可以让数据库表结构与本地的 schema.prisma 保持同步，同时保留数据。</p><p>此时，命令提示“同步成功”：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=ne>Environment</span> <span class=n>variables</span> <span class=n>loaded</span> <span class=n>from</span> <span class=o>.</span><span class=n>env</span>
</span></span><span class=line><span class=cl><span class=n>Prisma</span> <span class=n>schema</span> <span class=n>loaded</span> <span class=n>from</span> <span class=n>prisma</span><span class=o>/</span><span class=n>schema</span><span class=o>.</span><span class=n>prisma</span>
</span></span><span class=line><span class=cl><span class=n>Datasource</span> <span class=s2>&#34;db&#34;</span><span class=p>:</span> <span class=n>PostgreSQL</span> <span class=n>database</span> <span class=s2>&#34;postgres&#34;</span><span class=p>,</span> <span class=n>schema</span> <span class=s2>&#34;public&#34;</span> <span class=n>at</span> <span class=s2>&#34;aws-0-us-east-1.pooler.supabase.com:5432&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Applying</span> <span class=n>migration</span> <span class=err>`</span><span class=mi>20241029082021</span><span class=n>_init</span><span class=err>`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>following</span> <span class=n>migration</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=n>have</span> <span class=n>been</span> <span class=n>created</span> <span class=ow>and</span> <span class=n>applied</span> <span class=n>from</span> <span class=n>new</span> <span class=n>schema</span> <span class=n>changes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>migrations</span><span class=o>/</span>
</span></span><span class=line><span class=cl>  <span class=err>└─</span> <span class=mi>20241029082021</span><span class=n>_init</span><span class=o>/</span>
</span></span><span class=line><span class=cl>    <span class=err>└─</span> <span class=n>migration</span><span class=o>.</span><span class=n>sql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Your</span> <span class=n>database</span> <span class=n>is</span> <span class=n>now</span> <span class=ow>in</span> <span class=n>sync</span> <span class=n>with</span> <span class=n>your</span> <span class=n>schema</span><span class=o>.</span>
</span></span></code></pre></td></tr></table></div></div><p>接着，还需要在项目中安装 PrismaClient，用来实现对数据库的访问：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add @prisma/client
</span></span></code></pre></td></tr></table></div></div><p>并在 src 目录下创建 PrismaService：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/prisma.service.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>OnModuleInit</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PrismaClient</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PrismaService</span> <span class=kr>extends</span> <span class=nx>PrismaClient</span> <span class=kr>implements</span> <span class=nx>OnModuleInit</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 可选，Prisma 会在你第一次访问数据库时，自动连接
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>async</span> <span class=nx>onModuleInit() {</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>$connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>接着，在对应模块引入 PrismaService 并注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/post/post.module.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PrismaService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;src/prisma.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./post.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./post.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>PostController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>PostService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 这里别忘了
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>PrismaService</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PostModule</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// src/post/post.service.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Post</span><span class=p>,</span> <span class=nx>Prisma</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PrismaService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;src/prisma.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PostService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>prisma</span>: <span class=kt>PrismaService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>post</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>postWhereUniqueInput</span>: <span class=kt>Prisma.PostWhereUniqueInput</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Post</span> <span class=err>|</span> <span class=na>null</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>post</span><span class=p>.</span><span class=nx>findUnique</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span>: <span class=kt>postWhereUniqueInput</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>posts</span><span class=p>(</span><span class=nx>params</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>skip?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>take?</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>cursor?</span>: <span class=kt>Prisma.PostWhereUniqueInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>where?</span>: <span class=kt>Prisma.PostWhereInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>orderBy?</span>: <span class=kt>Prisma.PostOrderByWithRelationInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Post</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>skip</span><span class=p>,</span> <span class=nx>take</span><span class=p>,</span> <span class=nx>cursor</span><span class=p>,</span> <span class=nx>where</span><span class=p>,</span> <span class=nx>orderBy</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>post</span><span class=p>.</span><span class=nx>findMany</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>skip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>take</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>cursor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>orderBy</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>createPost</span><span class=p>(</span><span class=nx>data</span>: <span class=kt>Prisma.PostCreateInput</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Post</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>post</span><span class=p>.</span><span class=nx>create</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>updatePost</span><span class=p>(</span><span class=nx>params</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span>: <span class=kt>Prisma.PostWhereUniqueInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span>: <span class=kt>Prisma.PostUpdateInput</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Post</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>data</span><span class=p>,</span> <span class=nx>where</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>params</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>post</span><span class=p>.</span><span class=nx>update</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>deletePost</span><span class=p>(</span><span class=nx>where</span>: <span class=kt>Prisma.PostWhereUniqueInput</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>Post</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>prisma</span><span class=p>.</span><span class=nx>post</span><span class=p>.</span><span class=k>delete</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，在 Controller 中调用 PostService 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Body</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Delete</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Param</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Put</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Post</span> <span class=kr>as</span> <span class=nx>PostModel</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@prisma/client&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;../src/post/post.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>postService</span>: <span class=kt>PostService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;post/:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getPostById</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 通过 ID 获取单个文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>post</span><span class=p>({</span> <span class=nx>id</span>: <span class=kt>Number</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;feed&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getPublishedPosts</span><span class=p>()</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 查找所以已发布文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>posts</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>published</span>: <span class=kt>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;filtered-posts/:searchString&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getFilteredPosts</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;searchString&#39;</span><span class=p>)</span> <span class=nx>searchString</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=err>[]</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 按照“标题”｜“内容”筛选文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>posts</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>OR</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>title</span><span class=o>:</span> <span class=p>{</span> <span class=nx>contains</span>: <span class=kt>searchString</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>content</span><span class=o>:</span> <span class=p>{</span> <span class=nx>contains</span>: <span class=kt>searchString</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;post&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>createDraft</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Body</span><span class=p>()</span> <span class=nx>postData</span><span class=o>:</span> <span class=p>{</span> <span class=nx>title</span>: <span class=kt>string</span><span class=p>;</span> <span class=nx>content?</span>: <span class=kt>string</span><span class=p>;</span> <span class=nx>authorEmail</span>: <span class=kt>string</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建新文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=p>{</span> <span class=nx>title</span><span class=p>,</span> <span class=nx>content</span><span class=p>,</span> <span class=nx>authorEmail</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>postData</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>createPost</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>title</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>content</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>author</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>connect</span><span class=o>:</span> <span class=p>{</span> <span class=nx>email</span>: <span class=kt>authorEmail</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Put</span><span class=p>(</span><span class=s1>&#39;publish/:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>publishPost</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 发布文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>updatePost</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>where</span><span class=o>:</span> <span class=p>{</span> <span class=nx>id</span>: <span class=kt>Number</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>published</span>: <span class=kt>true</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Delete</span><span class=p>(</span><span class=s1>&#39;post/:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>deletePost</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>PostModel</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 删除文章
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>postService</span><span class=p>.</span><span class=nx>deletePost</span><span class=p>({</span> <span class=nx>id</span>: <span class=kt>Number</span><span class=p>(</span><span class=nx>id</span><span class=p>)</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=缓存>缓存</h2><p>为了提高性能，Nest 通过 @nestjs/cache-manager 提供了缓存管理；安装 cache-manager：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># cache-manager@6 已经发布，但是直接使用会报错，建议使用 @5</span>
</span></span><span class=line><span class=cl>pnpm add @nestjs/cache-manager cache-manager@5
</span></span></code></pre></td></tr></table></div></div><p>@nestjs/cache-manager 提供了一个内存缓存，只能保存<a class=link href=https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Structured_clone_algorithm#javascript_types target=_blank rel=noopener>
可被结构化算法复制
</a>的数据；当然，你也可以切换为别的服务，比如 Redis：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CacheModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>CacheModule</span><span class=p>.</span><span class=nx>register</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要访问缓存，需要注入 CACHE_MANAGER：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CACHE_MANAGER</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Inject</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Cache</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kd>@Inject</span><span class=p>(</span><span class=nx>CACHE_MANAGER</span><span class=p>)</span> <span class=kr>private</span> <span class=nx>cacheManager</span>: <span class=kt>Cache</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getHello() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 写入缓存的数据，默认只有 5 秒的生存期
</span></span></span><span class=line><span class=cl><span class=cm>     * 可以传入第三个参数，指定过期时长
</span></span></span><span class=line><span class=cl><span class=cm>     * 传入 0，则表示数据永不过期
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>cacheManager</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>,</span> <span class=mi>1000</span><span class=p>);</span> <span class=c1>// 写入缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>const</span> <span class=nx>value</span> <span class=o>=</span> <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>cacheManager</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>);</span> <span class=c1>// 读取缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; getHello &gt; value&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>cacheManager</span><span class=p>.</span><span class=nx>del</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>);</span> <span class=c1>// 删除对应缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>cacheManager</span><span class=p>.</span><span class=nx>reset</span><span class=p>();</span> <span class=c1>// 清空整个缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=s1>&#39;Hello From the Nest&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果想要自动缓存响应数据，使用 CacheInterceptor 拦截器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CACHE_MANAGER</span><span class=p>,</span> <span class=nx>CacheInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Inject</span><span class=p>,</span> <span class=nx>UseInterceptors</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Cache</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 自动缓存 GET 请求返回的响应数据
</span></span></span><span class=line><span class=cl><span class=cm> * 如果使用了 @Res 装饰器，就不能被缓存
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>CacheInterceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kd>@Inject</span><span class=p>(</span><span class=nx>CACHE_MANAGER</span><span class=p>)</span> <span class=kr>private</span> <span class=nx>cacheManager</span>: <span class=kt>Cache</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getHello() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;Hello From the Nest&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，CacheInterceptor 也可以通过 AppModule 注入：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CacheInterceptor</span><span class=p>,</span> <span class=nx>CacheModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_INTERCEPTOR</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>CacheModule</span><span class=p>.</span><span class=nx>register</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_INTERCEPTOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>CacheInterceptor</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，缓存都有过期时间；如果想更改过期时间，可以在 register 时传入一个对象：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>CacheModule</span><span class=p>.</span><span class=nx>register</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 默认，缓存仅存在于当前 module 内
</span></span></span><span class=line><span class=cl><span class=cm>   * 可以通过设置，让其他 module 访问
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>isGlobal</span>: <span class=kt>true</span> <span class=c1>// 作为全局缓存使用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>max</span>: <span class=kt>10</span><span class=p>,</span> <span class=c1>// 最多放入 10 个值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>ttl</span>: <span class=kt>5</span><span class=p>,</span> <span class=c1>// 5 秒过期
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>如果注册为了全局缓存，还是可以通过 @CacheKey 和 @CacheTTL 对缓存做单独配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CacheKey</span><span class=p>,</span> <span class=nx>CacheTTL</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kd>@CacheTTL</span><span class=p>(</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 这两个装饰器可以单独使用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@CacheKey</span><span class=p>(</span><span class=s1>&#39;custom_key&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@CacheTTL</span><span class=p>(</span><span class=mi>20</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAll</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span><span class=p>[]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>cache-manager 还可以搭配 Redis 使用，需要安装 cache-manager-redis-yet 并调用 registerAsync：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>CacheInterceptor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>CacheModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>CacheStore</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/cache-manager&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>APP_INTERCEPTOR</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>redisStore</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;cache-manager-redis-yet&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>CacheModule</span><span class=p>.</span><span class=nx>registerAsync</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>useFactory</span>: <span class=kt>async</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kr>const</span> <span class=nx>store</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>redisStore</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>socket</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nx>port</span>: <span class=kt>6666</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>});</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>store</span>: <span class=kt>store</span> <span class=kr>as</span> <span class=kt>unknown</span> <span class=kr>as</span> <span class=nx>CacheStore</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>ttl</span>: <span class=kt>60000</span> <span class=o>*</span> <span class=mi>3</span> <span class=c1>// 有效期 3 分钟
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>};</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>provide</span>: <span class=kt>APP_INTERCEPTOR</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>CacheInterceptor</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=序列化>序列化</h2><p>请求/响应 payload 在客户端服务端之间传递，在发送之前，需要被序列化为字符串（数据流除外）；在这个过程中，我们可以对数据进行整理/转换。例如，对信息进行加密、剔除敏感信息等。Nest 内置了序列化拦截器 ClassSerializerInterceptor 方便我们对数据进行序列化操作：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Exclude</span><span class=p>,</span> <span class=nx>Expose</span><span class=p>,</span> <span class=nx>Transform</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;class-transformer&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserEntity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>firstName</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>lastName</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Exclude</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>password</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置 getter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Expose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kr>get</span> <span class=nx>fullName</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=sb>`</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>firstName</span><span class=si>}</span><span class=sb> </span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>lastName</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回 RoleEntity 中的 role.name
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Transform</span><span class=p>(({</span> <span class=nx>value</span> <span class=p>})</span> <span class=o>=&gt;</span> <span class=nx>value</span><span class=p>.</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>role</span>: <span class=kt>RoleEntity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>partial</span>: <span class=kt>Partial</span><span class=p>&lt;</span><span class=nt>UserEntity</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>Object</span><span class=p>.</span><span class=nx>assign</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=nx>partial</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>同时，需要在对应的 ControllerHandler 中使用 ClassSerializerInterceptor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>UserEntity</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./entities/user.entity&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>ClassSerializerInterceptor</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>SerializeOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseInterceptors</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 排除带有 _ 前缀的属性
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@SerializeOptions</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>excludePrefixes</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;_&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回的数据将不会携带 password 字段
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>ClassSerializerInterceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;:id&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>findOne</span><span class=p>(</span><span class=kd>@Param</span><span class=p>(</span><span class=s1>&#39;id&#39;</span><span class=p>)</span> <span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span><span class=o>:</span> <span class=nx>UserEntity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 必须直接返回 UserEntity 实例，否则过滤将不会生效
</span></span></span><span class=line><span class=cl><span class=cm>     * DTO 是用来定义前后端数据传输类型的
</span></span></span><span class=line><span class=cl><span class=cm>     * Entity 是用来定义数据库模型的
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>UserEntity</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span>: <span class=kt>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>firstName</span><span class=o>:</span> <span class=s1>&#39;John&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>lastName</span><span class=o>:</span> <span class=s1>&#39;Doe&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>password</span><span class=o>:</span> <span class=s1>&#39;password&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不想在 ControllerHandler 中返回 UserEntity 实例，可以借助 SerializeOptions 做类型约束：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>ClassSerializerInterceptor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>// 确保返回值满足 UserEntity 类型
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@SerializeOptions</span><span class=p>({</span> <span class=kr>type</span><span class=o>:</span> <span class=nx>UserEntity</span> <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>findOne</span><span class=p>(</span><span class=kd>@Query</span><span class=p>()</span> <span class=p>{</span> <span class=nx>id</span> <span class=p>}</span><span class=o>:</span> <span class=p>{</span> <span class=nx>id</span>: <span class=kt>number</span> <span class=p>})</span><span class=o>:</span> <span class=nx>UserEntity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>id</span> <span class=o>===</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>id</span>: <span class=kt>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>firstName</span><span class=o>:</span> <span class=s1>&#39;John&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>lastName</span><span class=o>:</span> <span class=s1>&#39;Doe&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>password</span><span class=o>:</span> <span class=s1>&#39;password&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>: <span class=kt>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>firstName</span><span class=o>:</span> <span class=s1>&#39;Kamil&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>lastName</span><span class=o>:</span> <span class=s1>&#39;Mysliwiec&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>password</span><span class=o>:</span> <span class=s1>&#39;password2&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=版本控制>版本控制</h2><p>Nest 允许开发者单独为 Controller 或某个路由定义版本，毕竟破坏性的升级的同时还要做好老版本应用的兼容工作。Nest 支持以下四种方式进行版本控制：</p><ul><li>通过 URI，默认情况下，可以通过 URI 区分版本；</li><li>通过请求头，使用自定义请求头字段区分版本；</li><li>通过 MediaType，通过 Accept 字段区分；</li><li>自定义，需要实现一个 extractor 函数。</li></ul><h3 id=uri>URI</h3><p>可以通过在 URL 中添加版本路径来控制接口版本：</p><ul><li>/api/v1/finance/exportBatchProtocol</li><li>/api/v2/finance/exportBatchProtocol</li></ul><p>要通过这种方式，需要在全局调用 enableVersioning：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>URI</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>如果开启了 VersioningType.URI，他会在所有路径前添加一个版本路径 v1|v2&mldr;</p><h3 id=请求头>请求头</h3><p>VersioningType.HEADER 允许我们通过自定义请求头来实现版本控制：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>HEADER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 此时，你必须提供用于版本控制的自定义字段
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>header</span><span class=o>:</span> <span class=s1>&#39;Version-Control&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=accept>Accept</h3><p>通过 Accept 请求头字段传递版本（Accept: application/json;v=2）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>MEDIA_TYPE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 必传的 key 字段
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;v=&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=自定义>自定义</h3><p>如果要自己实现版本控制逻辑，需要实现一个 extractor 来匹配版本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * extractor 需要将版本号按照倒序（从高到低）排列：[...3,2,1]
</span></span></span><span class=line><span class=cl><span class=cm> * 如果 extractor 返回了空字符串或空数组，将返回 404
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>extractor</span> <span class=o>=</span> <span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>Array</span><span class=p>.</span><span class=nx>isArray</span><span class=p>(</span><span class=nx>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>?</span> <span class=nx>version</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>filter</span><span class=p>(</span><span class=nx>v</span> <span class=o>=&gt;</span> <span class=o>!!</span><span class=nx>v</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>sort</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>reverse</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>:</span> <span class=nx>version</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;,&#39;</span><span class=p>).</span><span class=nx>sort</span><span class=p>().</span><span class=nx>reverse</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>CUSTOM</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>extractor</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=路由适配>路由适配</h3><p>如果开启了版本控制，而 Controller/Route 没有适配版本，任何进入到 Controller/Route 的请求都将接收到 404 状态码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>version</span><span class=o>:</span> <span class=s1>&#39;1&#39;</span> <span class=c1>// 仅适配一个版本
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>version</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;1&#39;</span><span class=p>,</span><span class=s1>&#39;2&#39;</span><span class=p>]</span> <span class=c1>// 适配多个版本
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>version</span>: <span class=kt>VERSION_NEUTRAL</span><span class=p>,</span> <span class=c1>// 适配所有版本
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Version</span><span class=p>(</span><span class=s1>&#39;2&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAll() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不想在每个 Controller/Route 上单独设置版本，可以全局提供一个版本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VERSION_NEUTRAL</span><span class=p>,</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>defaultVersion</span>: <span class=kt>VERSION_NEUTRAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>URI</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要为中间件适配版本，只需要在 forRoutes 中指定版本号即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>MiddlewareConsumer</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Module</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>NestModule</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>RequestMethod</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>LoggerMiddleware</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;src/logger.middleware&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PrismaService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;src/prisma.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./post.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./post.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>PostController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>PostService</span><span class=p>,</span> <span class=nx>PrismaService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>PostModule</span> <span class=kr>implements</span> <span class=nx>NestModule</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>configure</span><span class=p>(</span><span class=nx>consumer</span>: <span class=kt>MiddlewareConsumer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>consumer</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>apply</span><span class=p>(</span><span class=nx>LoggerMiddleware</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>.</span><span class=nx>forRoutes</span><span class=p>({</span> <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;*&#39;</span><span class=p>,</span> <span class=nx>method</span>: <span class=kt>RequestMethod.ALL</span><span class=p>,</span> <span class=nx>version</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;3&#39;</span><span class=p>,</span> <span class=s1>&#39;2&#39;</span><span class=p>]</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=任务调度>任务调度</h2><p>任务调度允许：在<strong>固定时间</strong>或<strong>周期性地</strong>执行某块逻辑，比如 GitHub Actions 就支持 cron 配置来执行定时任务。@nestjs/schedule 也提供了同样的功能。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ScheduleModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 需要在 AppModule 引入 ScheduleModule 模块
</span></span></span><span class=line><span class=cl><span class=cm>   * forRoot 会注册 cron/interval/timeout
</span></span></span><span class=line><span class=cl><span class=cm>   * 注册发生在“应用完成初始化”
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>ScheduleModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>()],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>执行 nest g service task，新建一个 TaskService 管理调度任务；关于 cron，可以参考<a class=link href="https://cloud.google.com/scheduler/docs/configuring/cron-job-schedules?hl=zh-cn" target=_blank rel=noopener>
这里
</a>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Logger</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Cron</span><span class=p>,</span> <span class=nx>CronExpression</span><span class=p>,</span> <span class=nx>Interval</span><span class=p>,</span> <span class=nx>Timeout</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>TaskService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>logger</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Logger</span><span class=p>(</span><span class=nx>TaskService</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Cron</span><span class=p>(</span><span class=s1>&#39;45 * * * * *&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 也可以使用 CronExpression 枚举来简化配置
</span></span></span><span class=line><span class=cl><span class=cm>   * 被 @Cron 装饰的方法会被放到 try...catch 中执行
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Cron</span><span class=p>(</span><span class=nx>CronExpression</span><span class=p>.</span><span class=nx>EVERY_30_MINUTES</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>timeZone</span><span class=o>:</span> <span class=s1>&#39;Europe/Paris&#39;</span><span class=p>,</span> <span class=c1>// 支持时区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>disabled</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;example&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nx>handleCron() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;每分钟的第 45 秒执行&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 底层使用 setInterval 执行
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Interval</span><span class=p>(</span><span class=mi>600000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>handleInterval() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;每 10 分钟执行一次&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 底层使用 setTimeout 执行
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Timeout</span><span class=p>(</span><span class=mi>600000</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>handleTimeout() {</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;10 分钟后执行一次&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=动态调度>动态调度</h3><p>上边的事例都是“静态”的，都是提前写死在代码里的；如果我们想通过 API 动态触发/暂停这些任务呢？@nestjs/schedule 同样也提供了这种能力：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>SchedulerRegistry</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>schedulerRegistry</span>: <span class=kt>SchedulerRegistry</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>getHello() {</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * getCronJob 返回了 name:example 的 CronJob：
</span></span></span><span class=line><span class=cl><span class=cm>     * job.stop()，停止一个计划任务
</span></span></span><span class=line><span class=cl><span class=cm>     * job.start()，重启一个计划任务
</span></span></span><span class=line><span class=cl><span class=cm>     * job.setTime(time: CronTime)，停止一个计划任务，再设置一个新的时间，再重启
</span></span></span><span class=line><span class=cl><span class=cm>     * job.lastDate()，上一次的执行时间
</span></span></span><span class=line><span class=cl><span class=cm>     * job.nextDate()，下一次的执行时间
</span></span></span><span class=line><span class=cl><span class=cm>     * job.nextDates(count: number)，下一次的执行时间的集合
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>job</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>getCronJob</span><span class=p>(</span><span class=s1>&#39;example&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// { ts: 2024-11-09T10:30:00.000+01:00, zone: Europe/Paris, locale: zh-CN }
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; getHello &gt; job &gt; nextDate&#39;</span><span class=p>,</span> <span class=nx>job</span><span class=p>.</span><span class=nx>nextDate</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s1>&#39;Hello From the Nest&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们可以使用 CronJob 构造一个新的定时任务，并用 addCronJob 注册任务：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Logger</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>SchedulerRegistry</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>CronJob</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;cron&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>TaskService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>logger</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Logger</span><span class=p>(</span><span class=nx>TaskService</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>schedulerRegistry</span>: <span class=kt>SchedulerRegistry</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addCronJob</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>seconds</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>job</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>CronJob</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>seconds</span><span class=si>}</span><span class=sb> * * * * *`</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`任务 </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> 开始执行`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>addCronJob</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>job</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>job</span><span class=p>.</span><span class=nx>start</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`任务 </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> 已被添加`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>getCronJobs() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>jobs</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>getCronJobs</span><span class=p>();</span> <span class=c1>// Map 类型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;TaskService &gt; getCronJobs &gt; jobs&#39;</span><span class=p>,</span> <span class=nx>jobs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`共有定时任务 </span><span class=si>${</span><span class=nx>jobs</span><span class=p>.</span><span class=nx>size</span><span class=si>}</span><span class=sb> 个`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>deleteCronJob</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>deleteCronJob</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`任务 </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> 已被删除`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>相比于 CronJob，定时器任务就真的是在调用 setInterval/setTimeout：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>Logger</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>SchedulerRegistry</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>TaskService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>logger</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Logger</span><span class=p>(</span><span class=nx>TaskService</span><span class=p>.</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>schedulerRegistry</span>: <span class=kt>SchedulerRegistry</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>addInterval</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>milliseconds</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>callback</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sb>`计时器任务 </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> 将会每 </span><span class=si>${</span><span class=nx>milliseconds</span> <span class=o>/</span> <span class=mi>1000</span><span class=si>}</span><span class=sb> 秒执行一次`</span>
</span></span><span class=line><span class=cl>      <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>interval</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=nx>callback</span><span class=p>,</span> <span class=nx>milliseconds</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>addInterval</span><span class=p>(</span><span class=nx>name</span><span class=p>,</span> <span class=nx>interval</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>getIntervals() {</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>intervals</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>getIntervals</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`共有计时器任务 </span><span class=si>${</span><span class=nx>intervals</span><span class=p>.</span><span class=nx>length</span><span class=si>}</span><span class=sb> 个`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>deleteInterval</span><span class=p>(</span><span class=nx>name</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>schedulerRegistry</span><span class=p>.</span><span class=nx>deleteInterval</span><span class=p>(</span><span class=nx>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>warn</span><span class=p>(</span><span class=sb>`计时器任务 </span><span class=si>${</span><span class=nx>name</span><span class=si>}</span><span class=sb> 已被删除`</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=队列>队列</h2><p>队列是一种设计模式，帮助解决应用的扩展性和性能问题：</p><ul><li>对资源密集型任务进行缓冲，减少性能波动；</li><li>拆分任务，将消耗大的任务委托给空闲进程，防止阻塞主进程；</li><li>作为各个服务间的信道，将任务缓存进队列，并在其他服务中执行。</li></ul><p>Nest 提供了两种相关方案的集成，@nestjs/bullmq 和@nestjs/bull：</p><ul><li>BullMQ 提供了 TS 支持，并处于活跃状态；</li><li>Bull 已经转为了维护模式，仅会修复 bug；</li><li>两者都依赖 Redis 做数据持久化。</li></ul><p>使用 Redis 有个好处，Redis 并不局限于某个平台，任务队列完全独立于平台之外；可以在多个服务之间共享队列。</p><p>首先，安装 BullMQ：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>brew install redis
</span></span><span class=line><span class=cl>brew services start redis
</span></span><span class=line><span class=cl>pnpm add @nestjs/bullmq bullmq
</span></span></code></pre></td></tr></table></div></div><p>然后，在 AppModule 中引入 BullModule；BullModule 同样是一个动态模块，注册时需要传入一些配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>BullModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/bullmq&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ScheduleModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskServiceService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task-service/task-service.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task/task.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ScheduleModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>BullModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>connection</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>host</span><span class=o>:</span> <span class=s1>&#39;localhost&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>port</span>: <span class=kt>6379</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>TaskServiceService</span><span class=p>,</span> <span class=nx>TaskService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>使用 BullModule.registerQueue 注册队列，并且可以传入多个配置来创建多个队列；如果队列连接了同一个 Redis 并且使用了相同的连接凭证，那么这个队列会在不同的模块和进程之间共享：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>BullModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/bullmq&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ScheduleModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskServiceService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task-service/task-service.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task/task.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ScheduleModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>BullModule</span><span class=p>.</span><span class=nx>registerQueue</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 每个队列需要有一个 name 属性
</span></span></span><span class=line><span class=cl><span class=cm>         * name 将被用作 InjectionToken，需要唯一
</span></span></span><span class=line><span class=cl><span class=cm>         * 也被用作装饰器参数，关联 consumer 和 listener
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;cat&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;dog&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 可以单独设置连接配置
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>connection</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>port</span>: <span class=kt>6380</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>TaskServiceService</span><span class=p>,</span> <span class=nx>TaskService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，任务之间是独立的；如果要使任务之间有层级关系，可以使用 BullModule.registerFlowProducer：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>BullModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/bullmq&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ScheduleModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/schedule&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskServiceService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task-service/task-service.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>TaskService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./task/task.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ScheduleModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>BullModule</span><span class=p>.</span><span class=nx>registerFlowProducer</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;relationshipJobs&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>TaskServiceService</span><span class=p>,</span> <span class=nx>TaskService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>BullModule 注册的任务存在于 Redis 中，每当队列被实例化（例如，应用重启），队列将首先尝试执行此前未完成的任务；每个队列有一个/多个 Producers、Consumers 和 Listeners；Jobs 默认按照<strong>先进先出</strong>的顺序出列，也可以<strong>后进先出</strong>或者根据任务优先级出列。</p><h2 id=日志>日志</h2><p>@nestjs/common 中内置了一个 Logger 用来在控制台输出一些提示信息，我们可以对 Logger 做一些扩展来实现一些额外的功能：</p><ul><li>完全禁用日志记录；</li><li>指定日志级别（错误、警告、调试&mldr;）；</li><li>自定义日志输出格式；</li><li>重写内置的 Logger；</li><li>继承 Logger 来扩展功能。</li></ul><p>如果要完全禁用日志输出，传入 logger:false 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在调用 app.useLogger 之前，不会输出任何日志信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>logger</span>: <span class=kt>false</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要仅输出错误日志，可以传入一个数组：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * 内置了七个级别的日志：
</span></span></span><span class=line><span class=cl><span class=cm>   * log | fatal | error | warn | debug | verbose
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;error&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><p>如果上述不能满足业务要求，可以扩展内部的 LoggerService 实现自定义日志：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// src/main.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>CustomLogger</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./custom.logger.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * CustomLogger 虽是一个可注入对象
</span></span></span><span class=line><span class=cl><span class=cm>   * 但没有通过依赖注入被使用
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=nx>logger</span>: <span class=kt>new</span> <span class=nx>CustomLogger</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl><span class=c1>// src/custom.logger.service.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>LoggerService</span><span class=p>,</span> <span class=nx>LogLevel</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CustomLogger</span> <span class=kr>implements</span> <span class=nx>LoggerService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>warn</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>debug</span><span class=o>?</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>verbose</span><span class=o>?</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>fatal</span><span class=o>?</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=p>...</span><span class=nx>optionalParams</span>: <span class=kt>any</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>setLogLevels</span><span class=o>?</span><span class=p>(</span><span class=nx>levels</span>: <span class=kt>LogLevel</span><span class=p>[])</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>LoggerService 是一个比较偏低层的服务，什么功能都需要自己去实现；官方内置了一个 ConsoleLogger，是 LoggerService 的一种实现；我们可以继承 ConsoleLogger 来对日志系统的部分功能进行定制：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ConsoleLogger</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>CustomLogger</span> <span class=kr>extends</span> <span class=nx>ConsoleLogger</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span><span class=p>(</span><span class=nx>message</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>stack?</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>context?</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 实现自定义逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>super</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=nx>stack</span><span class=p>,</span> <span class=nx>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以上都是直接在应用入口直接使用 LoggerService 的，这没有利用 Nest 的依赖注入优势；当你想在 CustomLogger 中使用别的 Service 或者在别的 Service 中使用 CustomLogger 时，最好使用依赖注入；我们可以新建一个 LoggerModule：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>MyLoggerService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./logger.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>MyLoggerService</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>[</span><span class=nx>MyLoggerService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>LoggerModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，为了能在应用入口处使用 MyLoggerService，我们需要在项目中的任何一个 Module 中引入 LoggerModule：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>ScheduleModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=nx>BullModule</span><span class=p>.</span><span class=nx>registerFlowProducer</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;relationshipJobs&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>LoggerModule</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>TaskServiceService</span><span class=p>,</span> <span class=nx>TaskService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>为什么要这么做呢？当我们启动应用时，NestFactory.create 是独立于模块系统运行的，为了让 Nest 能够帮我们实例化 LoggerModule，我们需要在任何一个 Module 中引入 LoggerModule；这么我们就可以通过 app.get 拿到存在于依赖树中的 MyLoggerService 实例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>VERSION_NEUTRAL</span><span class=p>,</span> <span class=nx>VersioningType</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>MyLoggerService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./logger/logger.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 默认为 true，可以自动抛出缓存的日志
</span></span></span><span class=line><span class=cl><span class=cm>     * 为 false 时，可以调用 Logger.flush 清空缓存
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>autoFlushLogs</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 缓冲日志，直到 MyLoggerService 实例化完成
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果在此期间发生了错误，会通过 ConsoleLogger 打印日志
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>bufferLogs</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过 app.get 拿到 MyLoggerService 实例
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>app</span><span class=p>.</span><span class=nx>useLogger</span><span class=p>(</span><span class=nx>app</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>MyLoggerService</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>enableVersioning</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>defaultVersion</span>: <span class=kt>VERSION_NEUTRAL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>type</span><span class=o>:</span> <span class=nx>VersioningType</span><span class=p>.</span><span class=nx>URI</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>如果想要展示当前日志距离上一条日志的时间差，可以传入 timestamp 配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>logger</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>MyLoggerService</span><span class=p>(</span><span class=nx>UserService</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>timestamp</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=cookieexpress>cookie（Express）</h2><p>要在 Nest 中使用 cookie，需要安装 cookie-parser：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add cookie-parser
</span></span><span class=line><span class=cl>pnpm add -D @types/cookie-parser
</span></span></code></pre></td></tr></table></div></div><p>并将 cookie-parser 注册为全局中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>CookieParser</span> <span class=kr>from</span> <span class=s1>&#39;cookie-parser&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>,</span> <span class=p>{});</span>
</span></span><span class=line><span class=cl>  <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>CookieParser</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 可选参数，用来加密 cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=s1>&#39;signToken&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         * 可选参数，对 cookieValue 的解码函数
</span></span></span><span class=line><span class=cl><span class=cm>         * 默认值为 decodeURIComponent
</span></span></span><span class=line><span class=cl><span class=cm>         */</span>
</span></span><span class=line><span class=cl>        <span class=nx>decode</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>CookieParser 中间件将会解析请求头中的 cookie 字段，并暴露给内部的 request.cookies；如果配置了 signToken，将会通过 request.signedCookies 暴露：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Req</span><span class=p>,</span> <span class=nx>Res</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Request</span><span class=p>,</span> <span class=nx>Response</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;/all&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>findAll</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Req</span><span class=p>()</span> <span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kd>@Res</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 响应逻辑不用手动处理
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>passthrough</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span>: <span class=kt>Response</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 向客户端的 cookie 中添加新的键值对
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>response</span><span class=p>.</span><span class=nx>cookie</span><span class=p>(</span><span class=s1>&#39;key&#39;</span><span class=p>,</span> <span class=s1>&#39;value&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=eventemitter>EventEmitter</h2><p>@nestjs/event-emitter 通过 <a class=link href=https://github.com/EventEmitter2/EventEmitter2 target=_blank rel=noopener>eventemitter2
</a>向 Nest 提供观察者模式的实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Module</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>EventEmitterModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/event-emitter&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppController</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.controller&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 这个过程中，会初始化 EventEmitter 并注册对应的事件监听
</span></span></span><span class=line><span class=cl><span class=cm>     * 注册过程发生在 onApplicationBootstrap 钩子中
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>EventEmitterModule</span><span class=p>.</span><span class=nx>forRoot</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>wildcard</span>: <span class=kt>false</span><span class=p>,</span> <span class=c1>// 通配符
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>delimiter</span><span class=o>:</span> <span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=c1>// 命名空间分隔符
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果要触发 newListener 事件，请置为 true
</span></span></span><span class=line><span class=cl><span class=cm>       * this.emit(&#39;newListener&#39;, type, listener);
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>newListener</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>removeListener</span>: <span class=kt>false</span><span class=p>,</span> <span class=c1>// 如果要触发 removeListener 事件，请置为 true
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>maxListeners</span>: <span class=kt>10</span><span class=p>,</span> <span class=c1>// 每个事件最多有几个监听器
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>       * 如果监听器的数量超过了 maxListeners
</span></span></span><span class=line><span class=cl><span class=cm>       * 是否在【内存泄露】消息中展示 EventName
</span></span></span><span class=line><span class=cl><span class=cm>       */</span>
</span></span><span class=line><span class=cl>      <span class=nx>verboseMemoryLeak</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>ignoreErrors</span>: <span class=kt>false</span> <span class=c1>// 如果一个事件没有对应的监听器，是否抛出错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><p>怎么触发和监听事件呢？我们在 UserController 中 emit 一个事件并带上 payload：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>(</span><span class=s1>&#39;user&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>UserController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>userService</span>: <span class=kt>UserService</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>eventEmitter</span>: <span class=kt>EventEmitter2</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAll() {</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 当我们请求接口是，会 emit 事件 user.findAll
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>eventEmitter</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;user.findAll&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Emit From UserController.findAll Method&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>userService</span><span class=p>.</span><span class=nx>findAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们在 AppController 中监听这个事件，使用 OnEvent 修饰符：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@OnEvent</span><span class=p>(</span><span class=s1>&#39;**&#39;</span><span class=p>)</span> <span class=c1>// 监听所有事件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@OnEvent</span><span class=p>(</span><span class=s1>&#39;user.*&#39;</span><span class=p>)</span> <span class=c1>// 监听 user 下的所有事件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@OnEvent</span><span class=p>(</span><span class=s1>&#39;user.findAll&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// OnEvent 还可以接受这些选项
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kr>async</span><span class=o>:</span> <span class=kr>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>nextTick</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>objectify</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>promisify</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>prependListener</span>: <span class=kt>boolean</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>suppressErrors</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl>  <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=nx>handleUserFindAll</span><span class=p>(</span><span class=nx>payload</span><span class=o>:</span> <span class=p>{</span> <span class=nx>message</span>: <span class=kt>string</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 此时的 payload 就是 { message: &#39;Emit From UserController.findAll Method&#39; }
</span></span></span><span class=line><span class=cl><span class=cm>     * 这个过程中，我们并没有在 UserModule 中导入 EventEmitterModule
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; handleUserFindAll &gt; payload&#39;</span><span class=p>,</span> <span class=nx>payload</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们上边提到过，事件监听的注册发生在 AppModule 的 onApplicationBootstrap 生命周期中；这就可能导致事件回调发生遗漏，因为事件的触发可能会早于 EventSubscribersLoader 设置事件回调的时机。所以，emit 最好发生在 waitUntilReady 之后：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>eventEmitterReadinessWatcher</span><span class=p>.</span><span class=nx>waitUntilReady</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=k>await</span> <span class=k>this</span><span class=p>.</span><span class=nx>eventEmitter</span><span class=p>.</span><span class=nx>emit</span><span class=p>(</span><span class=s1>&#39;order.created&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;blah blah...&#39;</span> <span class=p>});</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=响应压缩express>响应压缩（Express）</h2><p>Nest 支持通过中间件来压缩响应主体；当然，在生产环境下，这部分工作通常由反向代理来完成；先来安装 compression：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add compression
</span></span></code></pre></td></tr></table></div></div><p>然后，注册 compression 中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>compression</span> <span class=kr>from</span> <span class=s1>&#39;compression&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span><span class=nx>compression</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=文件上传express>文件上传（Express）</h2><p>在 Express 模式下，Nest 内置了基于 <a class=link href=https://github.com/expressjs/multer target=_blank rel=noopener>multer
</a>的模块来处理文件上传；multer <strong>仅支持</strong>处理 Content-Type:multipart/form-data 的数据：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UploadedFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseInterceptors</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FileInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/platform-express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>appService</span><span class=p>.</span><span class=nx>getHello</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;file&#39;</span> <span class=c1>// 表单名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span><span class=kd>@UploadedFile</span><span class=p>()</span> <span class=nx>file</span>: <span class=kt>Express.Multer.File</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; file&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要对文件元数据进行验证，可以使用自定义管道：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>ArgumentMetadata</span><span class=p>,</span> <span class=nx>Injectable</span><span class=p>,</span> <span class=nx>PipeTransform</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>FileSizeValidationPipe</span> <span class=kr>implements</span> <span class=nx>PipeTransform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>transform</span><span class=p>(</span><span class=nx>value</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>metadata</span>: <span class=kt>ArgumentMetadata</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>value</span><span class=p>.</span><span class=nx>size</span> <span class=o>&lt;</span> <span class=mi>1000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 UploadedFile 中直接实例化 FileSizeValidationPipe：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UploadedFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseInterceptors</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FileInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/platform-express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FileSizeValidationPipe</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./file.size.validation.pipe&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>appService</span><span class=p>.</span><span class=nx>getHello</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;file&#39;</span> <span class=c1>// 表单名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFile</span><span class=p>(</span><span class=k>new</span> <span class=nx>FileSizeValidationPipe</span><span class=p>())</span> <span class=nx>file</span>: <span class=kt>Express.Multer.File</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; file&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此外，Nest 内置了一个 ParseFilePipe 管道，它可以满足大部分业务场景：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpStatus</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ParseFilePipe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UploadedFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseInterceptors</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FileInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/platform-express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>appService</span><span class=p>.</span><span class=nx>getHello</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;file&#39;</span> <span class=c1>// 表单名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=nx>ParseFilePipe</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>validators</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 需要传入验证器
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果验证失败，返回的状态码，默认为 400
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>errorHttpStatusCode</span>: <span class=kt>HttpStatus.BAD_REQUEST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 接收错误信息并返回新的错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>exceptionFactory</span><span class=o>:</span> <span class=p>(</span><span class=nx>error</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是否必传
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fileIsRequired</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>file</span>: <span class=kt>Express.Multer.File</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; file&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>对于 validators 来说，我们需要实现一个 FileValidator 构成的数组，先来看一下 FileValidator 的类型：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>interface</span> <span class=nx>IFile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mimetype</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>size</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>declare</span> <span class=kr>abstract</span> <span class=kr>class</span> <span class=nx>FileValidator</span><span class=o>&lt;</span>
</span></span><span class=line><span class=cl>  <span class=nx>TValidationOptions</span> <span class=o>=</span> <span class=nx>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;,</span>
</span></span><span class=line><span class=cl>  <span class=nx>TFile</span> <span class=kr>extends</span> <span class=nx>IFile</span> <span class=o>=</span> <span class=nx>IFile</span>
</span></span><span class=line><span class=cl><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>protected</span> <span class=kr>readonly</span> <span class=nx>validationOptions</span>: <span class=kt>TValidationOptions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=nx>validationOptions</span>: <span class=kt>TValidationOptions</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回 boolean，表示是否通过验证
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>abstract</span> <span class=nx>isValid</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>file?</span>: <span class=kt>TFile</span> <span class=o>|</span> <span class=nx>TFile</span><span class=p>[]</span> <span class=o>|</span> <span class=nx>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>TFile</span><span class=err>[]</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span><span class=o>:</span> <span class=kr>boolean</span> <span class=o>|</span> <span class=nx>Promise</span><span class=p>&lt;</span><span class=nt>boolean</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 用于构建错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>abstract</span> <span class=nx>buildErrorMessage</span><span class=p>(</span><span class=nx>file</span>: <span class=kt>any</span><span class=p>)</span><span class=o>:</span> <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Nest 内置了两个 FileValidator，MaxFileSizeValidator 和 FileTypeValidator；正好对应了 IFile 的两个属性，用于验证文件大小和文件 MIMEtype：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>Controller</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>FileTypeValidator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Get</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>HttpStatus</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>MaxFileSizeValidator</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>ParseFilePipe</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>Post</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UploadedFile</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>UseInterceptors</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>FileInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/platform-express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>()</span><span class=o>:</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>appService</span><span class=p>.</span><span class=nx>getHello</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;file&#39;</span> <span class=c1>// 表单名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=nx>ParseFilePipe</span><span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>validators</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 需要传入验证器
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>new</span> <span class=nx>MaxFileSizeValidator</span><span class=p>({</span> <span class=nx>maxSize</span>: <span class=kt>1000</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>          <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>           * 根据文件后缀名来判断 MIMEtype
</span></span></span><span class=line><span class=cl><span class=cm>           * 所以，可能不够可靠
</span></span></span><span class=line><span class=cl><span class=cm>           */</span>
</span></span><span class=line><span class=cl>          <span class=k>new</span> <span class=nx>FileTypeValidator</span><span class=p>({</span> <span class=nx>fileType</span><span class=o>:</span> <span class=s1>&#39;image/jpeg&#39;</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>],</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 如果验证失败，返回的状态码，默认为 400
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>errorHttpStatusCode</span>: <span class=kt>HttpStatus.BAD_REQUEST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 接收错误信息并返回新的错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>exceptionFactory</span><span class=o>:</span> <span class=p>(</span><span class=nx>error</span>: <span class=kt>string</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是否必传
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fileIsRequired</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>file</span>: <span class=kt>Express.Multer.File</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; file&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>ParseFilePipe 需要传入一个配置对象来完成文件验证，并且需要手动实例化验证器；如果你不想使用这种 API 风格，Nest 还提供了另一种 API 风格 ParseFilePipeBuilder；他支持链式调用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileInterceptor</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;file&#39;</span> <span class=c1>// 表单名称
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFile</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=k>new</span> <span class=nx>ParseFilePipeBuilder</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>addFileTypeValidator</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>fileType</span><span class=o>:</span> <span class=s1>&#39;jpeg&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>addMaxSizeValidator</span><span class=p>({</span> <span class=nx>maxSize</span>: <span class=kt>1000</span> <span class=p>})</span>
</span></span><span class=line><span class=cl>        <span class=p>.</span><span class=nx>build</span><span class=p>({</span>
</span></span><span class=line><span class=cl>          <span class=nx>errorHttpStatusCode</span>: <span class=kt>HttpStatus.BAD_REQUEST</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>fileIsRequired</span>: <span class=kt>false</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>file</span>: <span class=kt>Express.Multer.File</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; file&#39;</span><span class=p>,</span> <span class=nx>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=多文件上传>多文件上传</h3><p>如果多个文件对应一个字段，只需要将 UploadedFile 改为 UploadedFiles 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>FileInterceptor</span><span class=p>(</span><span class=s1>&#39;files&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFiles</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>files</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Express.Multer.File</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; files&#39;</span><span class=p>,</span> <span class=nx>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>files</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果多个文件分别对应着不同字段，需要将 FileInterceptor 替换为 FileFieldsInterceptor，并明确每个字段名：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>FileFieldsInterceptor</span><span class=p>([</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;avatar&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxCount</span>: <span class=kt>1</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;background&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxCount</span>: <span class=kt>1</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>])</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFiles</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>files</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>avatar?</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Express.Multer.File</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>      <span class=nx>background?</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Express.Multer.File</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; files&#39;</span><span class=p>,</span> <span class=nx>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>files</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果接收<strong>任何字段</strong>传来的文件，需要使用 AnyFilesInterceptor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>AnyFilesInterceptor</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=kd>@UploadedFiles</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>files</span>: <span class=kt>Array</span><span class=p>&lt;</span><span class=nt>Express.Multer.File</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; files&#39;</span><span class=p>,</span> <span class=nx>files</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>files</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果不接受任何文件，使用 NoFilesInterceptor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Post</span><span class=p>(</span><span class=s1>&#39;upload&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@UseInterceptors</span><span class=p>(</span><span class=nx>NoFilesInterceptor</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>fileUpload</span><span class=p>(</span><span class=kd>@Body</span><span class=p>()</span> <span class=nx>body</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s1>&#39;AppController &gt; fileUpload &gt; body&#39;</span><span class=p>,</span> <span class=nx>body</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>body</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=流式传输>流式传输</h3><p>当遇到需要将文件传输至客户端的场景时，可以将数据 pipe 到 Response 中去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Res</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Response</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createReadStream</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;fs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>join</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;getRaw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getFile</span><span class=p>(</span><span class=kd>@Res</span><span class=p>()</span> <span class=nx>res</span>: <span class=kt>Response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>createReadStream</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>(),</span> <span class=s1>&#39;package.json&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>stream</span><span class=p>.</span><span class=nx>pipe</span><span class=p>(</span><span class=nx>res</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>这种通过 pipe 连接 Response 的方式会导致响应拦截器失效；所以，官网介绍了一种返回 StreamableFile 的写法；StreamableFile 暂存了数据流：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>StreamableFile</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createReadStream</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;fs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>join</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;getRaw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getFile</span><span class=p>()</span><span class=o>:</span> <span class=nx>StreamableFile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>createReadStream</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>(),</span> <span class=s1>&#39;package.json&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 直接返回 StreamableFile 实例
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=k>new</span> <span class=nx>StreamableFile</span><span class=p>(</span><span class=nx>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>默认情况下，响应头中的 Content-Type 为 application/octet-stream；如果想要 Content-Type：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 在 StreamableFile 中传入 Options
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;getRaw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getFile</span><span class=p>()</span><span class=o>:</span> <span class=nx>StreamableFile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>createReadStream</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>(),</span> <span class=s1>&#39;package.json&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>StreamableFile</span><span class=p>(</span><span class=nx>stream</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>disposition</span><span class=o>:</span> <span class=s1>&#39;attachment; filename=&#34;package.json&#34;&#39;</span><span class=p>,</span> <span class=c1>// 自定义 Content-Disposition
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span> <span class=c1>// 自定义 Content-Type
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用 Response 去设置响应头部
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;getRaw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getFile</span><span class=p>(</span><span class=kd>@Res</span><span class=p>({</span> <span class=nx>passthrough</span>: <span class=kt>true</span> <span class=p>})</span> <span class=nx>res</span>: <span class=kt>Response</span><span class=p>)</span><span class=o>:</span> <span class=nx>StreamableFile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>createReadStream</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>(),</span> <span class=s1>&#39;package.json&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>res</span><span class=p>.</span><span class=kr>set</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Content-Disposition&#39;</span><span class=o>:</span> <span class=s1>&#39;attachment; filename=&#34;package.json&#34;&#39;</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>StreamableFile</span><span class=p>(</span><span class=nx>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用 Header 装饰器
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>(</span><span class=s1>&#39;getRaw&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Header</span><span class=p>(</span><span class=s1>&#39;Content-Type&#39;</span><span class=p>,</span> <span class=s1>&#39;application/json&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Header</span><span class=p>(</span><span class=s1>&#39;Content-Disposition&#39;</span><span class=p>,</span> <span class=s1>&#39;attachment; filename=&#34;package.json&#34;&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>getFile</span><span class=p>()</span><span class=o>:</span> <span class=nx>StreamableFile</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>createReadStream</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>cwd</span><span class=p>(),</span> <span class=s1>&#39;package.json&#39;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>StreamableFile</span><span class=p>(</span><span class=nx>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=http-模块>HTTP 模块</h2><p>Nest 基于 Axios 构建了 HttpModule，HttpModule 导出了 HttpService，HttpService 会自动将响应转换为 RxJS 对象；要使用 HttpModule，需要安装@nestjs/axios：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add @nestjs/axios axios
</span></span></code></pre></td></tr></table></div></div><p>然后，导入 HttpModule，依赖注入 HttpService 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>HttpService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/axios&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Injectable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AxiosResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;axios&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Observable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppService</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=kr>readonly</span> <span class=nx>httpService</span>: <span class=kt>HttpService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>  <span class=nx>findAll</span><span class=p>()</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>AxiosResponse</span><span class=err>&lt;</span><span class=na>any</span><span class=p>&gt;</span><span class=o>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=nx>httpService</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;https://randomuser.me&#39;</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>catchError</span><span class=p>((</span><span class=nx>error</span>: <span class=kt>AxiosError</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>logger</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要对 HttpModule 进行配置，需要在模块导入的时候，调用 register|registerAsync 方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// 通过 HttpModuleOptionsFactory 创建配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Injectable</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>class</span> <span class=nx>HttpConfigService</span> <span class=kr>implements</span> <span class=nx>HttpModuleOptionsFactory</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>createHttpOptions</span><span class=p>()</span><span class=o>:</span> <span class=nx>HttpModuleOptions</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>timeout</span>: <span class=kt>5000</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>maxRedirects</span>: <span class=kt>5</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 在导入时，传入配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>@Module</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpModule</span><span class=p>.</span><span class=nx>register</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>maxRedirects</span>: <span class=kt>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>timeout</span>: <span class=kt>5000</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpModule</span><span class=p>.</span><span class=nx>registerAsync</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>useFactory</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxRedirects</span>: <span class=kt>5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>timeout</span>: <span class=kt>5000</span>
</span></span><span class=line><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpModule</span><span class=p>.</span><span class=nx>registerAsync</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>imports</span><span class=o>:</span> <span class=p>[</span><span class=nx>ConfigModule</span><span class=p>],</span>
</span></span><span class=line><span class=cl>      <span class=nx>useFactory</span>: <span class=kt>async</span> <span class=p>(</span><span class=nx>configService</span>: <span class=kt>ConfigService</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>maxRedirects</span>: <span class=kt>configService.get</span><span class=p>(</span><span class=s1>&#39;HTTP_MAX_REDIRECTS&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>timeout</span>: <span class=kt>configService.get</span><span class=p>(</span><span class=s1>&#39;HTTP_TIMEOUT&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=nx>inject</span><span class=o>:</span> <span class=p>[</span><span class=nx>ConfigService</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>}),</span>
</span></span><span class=line><span class=cl>    <span class=nx>HttpModule</span><span class=p>.</span><span class=nx>registerAsync</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=nx>useClass</span>: <span class=kt>HttpConfigService</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>controllers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppController</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=nx>providers</span><span class=o>:</span> <span class=p>[</span><span class=nx>AppService</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppModule</span> <span class=p>{}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=sessionexpress>Session（Express）</h2><p>要在 Nest 中启用 Session，需要安装两个依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add express-session
</span></span><span class=line><span class=cl>pnpm add -D @types/express-session
</span></span></code></pre></td></tr></table></div></div><p>并注册全局中间件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=o>*</span> <span class=kr>as</span> <span class=nx>session</span> <span class=kr>from</span> <span class=s1>&#39;express-session&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>use</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 默认情况下，session 存在服务端内存中，所以这个仅限于开发调试
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果要在生产环境使用，请访问 CompatibleSessionStores
</span></span></span><span class=line><span class=cl><span class=cm>     * 或者，直接使用 JSONWebToken 认证
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span><span class=p>({</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 如果为 true，在每次请求过程中，都将 session 保存一次
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>resave</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 是否保存未初始化的 session，可用于实现登录会话
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>saveUninitialized</span>: <span class=kt>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 用来给保存了 SessionID 的 cookie 做签名
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>secret</span><span class=o>:</span> <span class=s1>&#39;session-example&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>配置完中间件之后，可以通过 request.session 访问 session 内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Req</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>Request</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>(</span><span class=kd>@Req</span><span class=p>()</span> <span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=p>.</span><span class=nx>session</span><span class=p>.</span><span class=nx>visits</span> <span class=o>=</span> <span class=nx>request</span><span class=o>?</span><span class=p>.</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>visits</span>
</span></span><span class=line><span class=cl>      <span class=o>?</span> <span class=nx>request</span><span class=o>?</span><span class=p>.</span><span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>visits</span> <span class=o>+</span> <span class=nx>1</span>
</span></span><span class=line><span class=cl>      : <span class=kt>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>此时，你会看到 TS 报错信息「Property visits does not exist on type Session & Partial&lt;SessionData>」，原因是 @types/express-session 的问题；我们需要在根目录创建一个 x.d.ts 文件，使用 interface 扩展一下 SessionData 类型即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=c1>// ./global.d.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;express-session&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>declare</span> <span class=nx>module</span> <span class=s1>&#39;express-session&#39;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>interface</span> <span class=nx>SessionData</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>visits</span>: <span class=kt>number</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>或者直接使用 @Session 装饰器，这样可以不用扩展 express-session：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Session</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>getHello</span><span class=p>(</span><span class=kd>@Session</span><span class=p>()</span> <span class=nx>session</span>: <span class=kt>Record</span><span class=p>&lt;</span><span class=nt>string</span><span class=err>,</span> <span class=na>any</span><span class=p>&gt;)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>session</span><span class=p>.</span><span class=nx>visits</span> <span class=o>=</span> <span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>visits</span> <span class=o>?</span> <span class=nx>session</span><span class=o>?</span><span class=p>.</span><span class=nx>visits</span> <span class=o>+</span> <span class=nx>1</span> : <span class=kt>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=mvcexpress>MVC（Express）</h2><p>不用管 MVC 是什么，简单地讲，就是 Nest 调用模版引擎，渲染 HTML。Nest 推荐使用 <a class=link href=https://github.com/pillarjs/hbs target=_blank rel=noopener>hbs
</a>模版引擎：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pnpm add hbs
</span></span></code></pre></td></tr></table></div></div><p>配置完成之后，需要调用 setViewEngine 指定模版引擎：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestFactory</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/core&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NestExpressApplication</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/platform-express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>join</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;path&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppModule</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.module&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>bootstrap() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>app</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>NestFactory</span><span class=p>.</span><span class=nx>create</span><span class=p>&lt;</span><span class=nt>NestExpressApplication</span><span class=p>&gt;(</span><span class=nx>AppModule</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>useStaticAssets</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>,</span> <span class=s1>&#39;public&#39;</span><span class=p>));</span> <span class=c1>// 静态资源
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>setBaseViewsDir</span><span class=p>(</span><span class=nx>join</span><span class=p>(</span><span class=nx>__dirname</span><span class=p>,</span> <span class=s1>&#39;..&#39;</span><span class=p>,</span> <span class=s1>&#39;views&#39;</span><span class=p>));</span> <span class=c1>// 模版内容
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>setViewEngine</span><span class=p>(</span><span class=s1>&#39;hbs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>app</span><span class=p>.</span><span class=nx>listen</span><span class=p>(</span><span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>PORT</span> <span class=o>??</span> <span class=mi>3000</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>bootstrap</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p>我们在 views 目录新建一个 index.hbs：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>App<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    {{message}}
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>并使用 @Render 装饰器装饰对应的方法，方法的返回值将是 index.hbs 的渲染上下文：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Render</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Render</span><span class=p>(</span><span class=s1>&#39;index&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>renderRoot() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Hello&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>如果要根据业务逻辑渲染不同的 hbs 模版，可以使用 response.render：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Get</span><span class=p>,</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>Res</span><span class=p>,</span> <span class=nx>Render</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Response</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;express&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>AppService</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./app.service&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>constructor</span><span class=p>(</span><span class=kr>private</span> <span class=nx>appService</span>: <span class=kt>AppService</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kd>@Get</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>root</span><span class=p>(</span><span class=kd>@Res</span><span class=p>()</span> <span class=nx>res</span>: <span class=kt>Response</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>render</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>appService</span><span class=p>.</span><span class=nx>getViewName</span><span class=p>(),</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;Hello&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=eventsource>EventSource</h2><p>Nest 也简化了 EventSource 的使用，如果直接使用 Node 处理 EventSource，需要配置 Content-Type:text/event-stream；在 Nest 中，只需要使用 @Sse 即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Controller</span><span class=p>,</span> <span class=nx>MessageEvent</span><span class=p>,</span> <span class=nx>Sse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@nestjs/common&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>interval</span><span class=p>,</span> <span class=nx>map</span><span class=p>,</span> <span class=nx>Observable</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;rxjs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>@Controller</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>AppController</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kd>@Sse</span><span class=p>(</span><span class=s1>&#39;sse&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>see</span><span class=p>()</span><span class=o>:</span> <span class=nx>Observable</span><span class=p>&lt;</span><span class=nt>MessageEvent</span><span class=p>&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>interval</span><span class=p>(</span><span class=mi>1000</span><span class=p>).</span><span class=nx>pipe</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=nx>map</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>        <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>hello</span><span class=o>:</span> <span class=s1>&#39;world&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}))</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/nest.js-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B8%80/><div class=article-image><img src=/img/cover/nestjs.png loading=lazy data-key data-hash=/img/cover/nestjs.png></div><div class=article-details><h2 class=article-title>Nest.js 学习笔记（一）</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2024
<a href=https://github.com/ElementRef target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#应用配置>应用配置</a><ol><li><a href=#命名空间>命名空间</a></li><li><a href=#局部注册>局部注册</a></li><li><a href=#变量验证>变量验证</a></li><li><a href=#可扩展变量>可扩展变量</a></li><li><a href=#maints-中使用>main.ts 中使用</a></li></ol></li><li><a href=#数据库集成>数据库集成</a></li><li><a href=#缓存>缓存</a></li><li><a href=#序列化>序列化</a></li><li><a href=#版本控制>版本控制</a><ol><li><a href=#uri>URI</a></li><li><a href=#请求头>请求头</a></li><li><a href=#accept>Accept</a></li><li><a href=#自定义>自定义</a></li><li><a href=#路由适配>路由适配</a></li></ol></li><li><a href=#任务调度>任务调度</a><ol><li><a href=#动态调度>动态调度</a></li></ol></li><li><a href=#队列>队列</a></li><li><a href=#日志>日志</a></li><li><a href=#cookieexpress>cookie（Express）</a></li><li><a href=#eventemitter>EventEmitter</a></li><li><a href=#响应压缩express>响应压缩（Express）</a></li><li><a href=#文件上传express>文件上传（Express）</a><ol><li><a href=#多文件上传>多文件上传</a></li><li><a href=#流式传输>流式传输</a></li></ol></li><li><a href=#http-模块>HTTP 模块</a></li><li><a href=#sessionexpress>Session（Express）</a></li><li><a href=#mvcexpress>MVC（Express）</a></li><li><a href=#eventsource>EventSource</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script src=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>