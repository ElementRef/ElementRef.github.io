<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="ServerComponents ServerComponents 会在服务端进行渲染并被缓存；Next.js 一般会基于路由进行 CodeSplit，结合 Suspense 将渲染工作尽可能的分割成更小的单位：
服务端组件可以直接在服务端获取数据，可以减少来自客户端的 HTTP 数据请求； 服务端渲染可以减少敏感数据在客户端暴露的风险； 渲染内容可以被缓存在服务端，提高性能； 提升首屏渲染性能； SEO 友好； 流式渲染。 在服务端渲染时，Next.js 会将 ServerComponents 渲染成 ReactServerComponentPayload，然后构建出 HTML；在客户端渲染出 HTML 之后，ReactServerComponentPayload 会被用来和客户端 Fiber 进行 Hydrate，为页面添加交互。
"><title>Next.js 之 Rendering 与 Caching · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/"><link rel="stylesheet" href="/scss/style.min.a4da387b20ce5a8b806cf676eb75d9139ad7b5f550cccaa0d6f935c8c4982f6c.css"><meta property="og:title" content="Next.js 之 Rendering 与 Caching"><meta property="og:description" content="ServerComponents ServerComponents 会在服务端进行渲染并被缓存；Next.js 一般会基于路由进行 CodeSplit，结合 Suspense 将渲染工作尽可能的分割成更小的单位：
服务端组件可以直接在服务端获取数据，可以减少来自客户端的 HTTP 数据请求； 服务端渲染可以减少敏感数据在客户端暴露的风险； 渲染内容可以被缓存在服务端，提高性能； 提升首屏渲染性能； SEO 友好； 流式渲染。 在服务端渲染时，Next.js 会将 ServerComponents 渲染成 ReactServerComponentPayload，然后构建出 HTML；在客户端渲染出 HTML 之后，ReactServerComponentPayload 会被用来和客户端 Fiber 进行 Hydrate，为页面添加交互。
"><meta property="og:url" content="https://ElementRef.github.io/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2024-08-18T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-18T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/nextjs.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="Next.js 之 Rendering 与 Caching"><meta name="twitter:description" content="ServerComponents ServerComponents 会在服务端进行渲染并被缓存；Next.js 一般会基于路由进行 CodeSplit，结合 Suspense 将渲染工作尽可能的分割成更小的单位：
服务端组件可以直接在服务端获取数据，可以减少来自客户端的 HTTP 数据请求； 服务端渲染可以减少敏感数据在客户端暴露的风险； 渲染内容可以被缓存在服务端，提高性能； 提升首屏渲染性能； SEO 友好； 流式渲染。 在服务端渲染时，Next.js 会将 ServerComponents 渲染成 ReactServerComponentPayload，然后构建出 HTML；在客户端渲染出 HTML 之后，ReactServerComponentPayload 会被用来和客户端 Fiber 进行 Hydrate，为页面添加交互。
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/nextjs.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta http-equiv="Content-Security-Policy" content="frame-src *.bilibili.com *.qq.com *.youtube.com https://youtu.be"><script src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2" crossorigin="anonymous" defer=""></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="flex container extended main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu15751654176150258532.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://douban.com/people/nicknoonan" target="_blank" title="DouBan"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-douban"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h16"></path><path d="M5 4h14"></path><path d="M8 8h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-2a2 2 0 012-2z"></path><path d="M16 14l-2 6"></path><path d="M8 17l1 3"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/"><img src="/img/cover/nextjs.webp" alt="Next.js 之 Rendering 与 Caching" fetchpriority="high" decoding="async" width="1200" height="720" jampack-sized="true"></a></div><div class="article-details"><header class="article-category"><a href="/categories/next.js/">Next.js</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/">Next.js 之 Rendering 与 Caching</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Aug 18, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：9 分钟</time></div></footer></div></header><section class="article-content"><h2 id="servercomponents">ServerComponents</h2><p><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>会在服务端进行渲染并被缓存；Next.js 一般会基于路由进行 CodeSplit，结合 Suspense 将渲染工作尽可能的分割成更小的单位：</p><ul><li>服务端组件可以直接在服务端获取数据，可以减少来自客户端的 HTTP 数据请求；</li><li>服务端渲染可以减少敏感数据在客户端暴露的风险；</li><li>渲染内容可以被缓存在服务端，提高性能；</li><li>提升首屏渲染性能；</li><li>SEO 友好；</li><li>流式渲染。</li></ul><p>在服务端渲染时，Next.js 会将 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>渲染成 ReactServerComponentPayload，然后构建出 HTML；在客户端渲染出 HTML 之后，ReactServerComponentPayload 会被用来和客户端 Fiber 进行 Hydrate，为页面添加交互。</p><p>ReactServerComponentPayload 可以被理解为服务端的组件树，是一种二进制数据，他包含了：</p><ul><li><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>的渲染结果；</li><li><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>占位符以及相关文件；</li><li><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>到 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>的 props。</li></ul><p>Next.js 服务端渲染分为三种：</p><ul><li>静态渲染：<ul><li>适用于数据非“千人千面”而且内容都是可以被事先知道的情况下；</li><li>初始化渲染发生在打包阶段，并将结果进行缓存，后台会定期进行数据验证；</li><li>打包的内容可以被静态部署或被部署在 CDN 上。</li></ul></li><li>动态渲染：<ul><li>渲染发生在每次客户端发起请求时，渲染内容和用户相关性较高；</li><li>在渲染阶段，如果遇到动态函数（请求发生时才能获取的信息）或者没有缓存的数据请求，Next.js 会自动将路由切换至动态渲染；</li><li>使用了 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/cookies" target="_blank" rel="noopener">cookies()
</a>、<a class="link" href="https://nextjs.org/docs/app/api-reference/functions/headers" target="_blank" rel="noopener">
headers()
</a>、<a class="link" href="https://nextjs.org/docs/app/api-reference/file-conventions/page#searchparams-optional" target="_blank" rel="noopener">
searchParams
</a>这些动态 API 的函数（动态函数）。</li></ul></li><li>流式渲染：借助 Suspense，将渲染工作拆分，先渲染 FallbackUI，当组件渲染好了之后，替换 FallbackUI。</li></ul><h2 id="clientcomponents">ClientComponents</h2><p><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>一般用在有复杂交互的场景下，使用 ‘use client’ 标识；如果没有标识而使用浏览器 API 或者 Hook，会导致出错。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/use-client-directive.webp" width="1600" height="1325" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/use-client-directive_hu2573575773554967057.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/use-client-directive_hu5235297197619615780.png 1024w" alt="use client" class="gallery-image" data-flex-grow="120" data-flex-basis="289px" fetchpriority="high" decoding="async"></p><p>但不必在所有的地方都使用 ‘use client’ 标识；被导入 ‘use client’ 标识的文件的模块都会运行在客户端。</p><p>为了提升首屏渲染性能，在页面初次加载时，<a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">
ClientComponents
</a>和 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>都会在服务端被渲染为 HTML，然后再 Hydrate，为页面添加交互；在后续页面导航的时候，<a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">
ClientComponents
</a>会在浏览器里被 JS 渲染，不会有相应的 HTML。</p><h2 id="servercomponents-与-clientcomponents-混合模式">ServerComponents 与 ClientComponents 混合模式</h2><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/composition-patterns.webp" width="1288" height="1204" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/composition-patterns_hu11873395126182275178.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/composition-patterns_hu18117202578168058506.png 1024w" alt="ServerComponents 与 ClientComponents" class="gallery-image" data-flex-grow="106" data-flex-basis="256px" loading="lazy" decoding="async"></p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// lib/data.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="s1">'server-only'</span><span class="p">;</span> <span class="c1">// ClientComponents 导入，会在编译阶段报错
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">async</span> <span class="kd">function</span> <span class="nx">getData() {</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://external-service.com/data'</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">authorization</span>: <span class="kt">process.env.API_KEY</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>API_KEY 是一个只能在服务端访问的私有变量（没有以 NEXT_PUBLIC 作为前缀）；为了不泄漏敏感信息，即使 getData 被导入客户端，在客户端也会调用失败。</p><p>可以安装 server-only，并在代码中导入；这样如果 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>导入了 getData，会在打包阶段将错误抛出，避免错误发生在生产环境。</p><p>相应的，还有 client-only。</p><p>如果要使用 ReactContext 怎么办？大部分 Context 会在根组件导入，而 Context 只能在客户端运行：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// app/layout.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">createContext</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ThemeContext</span> <span class="o">=</span> <span class="nx">createContext</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">RootLayout</span><span class="p">({</span> <span class="nx">children</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">ThemeContext.Provider</span> <span class="na">value</span><span class="o">=</span><span class="s">"dark"</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">ThemeContext.Provider</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>为了能正常运行，需要将 Provider 标志为 ‘use client’ 再进行导出：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// app/theme-provider.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s1">'use client'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createContext</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">ThemeContext</span> <span class="o">=</span> <span class="nx">createContext</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">ThemeProvider</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>: <span class="kt">React.ReactNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">&lt;</span><span class="nt">ThemeContext.Provider</span> <span class="na">value</span><span class="o">=</span><span class="s">"dark"</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">ThemeContext.Provider</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// app/layout.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">ThemeProvider</span> <span class="kr">from</span> <span class="s1">'./theme-provider'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">RootLayout</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>: <span class="kt">React.ReactNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">ThemeProvider</span><span class="p">&gt;{</span><span class="nx">children</span><span class="p">}&lt;/</span><span class="nt">ThemeProvider</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>为了充分利用服务端渲染的优势，最好将交互逻辑尽可能的与静态数据做分离，降低客户端代码体积。</p><h3 id="在-clientcomponents-中渲染-servercomponents">在 ClientComponents 中渲染 ServerComponents</h3><p><a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>的渲染工作晚于 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>，所以不能将 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>直接导入到 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>中；但是可以通过 props，将 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>传给 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>。</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// app/client-component.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s1">'use client'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 这样不行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">ServerComponent</span> <span class="kr">from</span> <span class="s1">'./Server-Component'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">ClientComponent</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>: <span class="kt">React.ReactNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">ServerComponent</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>一般使用 props.children 来实现（都行，其实只要是 renderProps 都行）：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// app/client-component.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="s1">'use client'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">useState</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'react'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">ClientComponent</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">children</span>: <span class="kt">React.ReactNode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">[</span><span class="nx">count</span><span class="p">,</span> <span class="nx">setCount</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="o">=&gt;</span> <span class="nx">setCount</span><span class="p">(</span><span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;{</span><span class="nx">count</span><span class="p">}&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="nx">children</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// app/page.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">ClientComponent</span> <span class="kr">from</span> <span class="s1">'./client-component'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">ServerComponent</span> <span class="kr">from</span> <span class="s1">'./server-component'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Page() {</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">ClientComponent</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">ServerComponent</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;/</span><span class="nt">ClientComponent</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="部分预渲染">部分预渲染</h2><p>部分预渲染是指，在同一路由下，既有静态组件又有动态组件；为了保证渲染流程不被阻塞，需要将动态部分用 Suspense 包裹。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/thinking-in-ppr.webp" width="3200" height="1264" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/thinking-in-ppr_hu1293542452487226529.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/thinking-in-ppr_hu5864339341234362380.png 1024w" alt="PPR" class="gallery-image" data-flex-grow="253" data-flex-basis="607px" loading="lazy" decoding="async"></p><p>使用<strong>部分预渲染</strong>，需要更改 Next.js 配置，并在需要部分预渲染的组件中导出 experimental_ppr：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// next.config.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">NextConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'next'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">nextConfig</span>: <span class="kt">NextConfig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">experimental</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Next.js 15+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ppr</span><span class="o">:</span> <span class="s1">'incremental'</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Next.js 14 中，这样启用，所有的路由都将“部分预渲染”
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ppr</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">nextConfig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// app/page.tsx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">Suspense</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">"react"</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">StaticComponent</span><span class="p">,</span> <span class="nx">DynamicComponent</span><span class="p">,</span> <span class="nx">Fallback</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">"@/app/ui"</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 需要导出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kr">const</span> <span class="nx">experimental_ppr</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">Page() {</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="p">&lt;&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">StaticComponent</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;</span><span class="nt">Suspense</span> <span class="na">fallback</span><span class="o">=</span><span class="p">{&lt;</span><span class="nt">Fallback</span> <span class="p">/&gt;}&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="p">&lt;</span><span class="nt">DynamicComponent</span> <span class="p">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="p">&lt;/</span><span class="nt">Suspense</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">     <span class="p">&lt;/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>酱紫，当前路由及其子级路由都将启用<strong>部分预渲染</strong>；如果子路由不需要部分预渲染，需要导出 experimental_ppr=false。</p><h2 id="缓存">缓存</h2><p>Next.js 通过对渲染内容和请求数据加缓存来提高性能，下图列出了 Next.js 用到的缓存。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching.webp" width="1288" height="698" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching_hu8480329876571747312.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching_hu16440169985859351539.png 1024w" alt="缓存" class="gallery-image" data-flex-grow="184" data-flex-basis="442px" loading="lazy" decoding="async"></p><ul><li>RequestMemoization，合并<strong>当前路由渲染中</strong>遇到的<strong>相同</strong>的请求，并将请求结果缓存；路由渲染完成，清空缓存；</li><li>DataCache，持久缓存，不止存在于当前路由的渲染过程中，侧重于对结果的缓存；</li><li>FullRouteCache，持久缓存，保存在服务端，对 ReactServerComponentPayload 和 HTML 的缓存，提升服务端渲染性能；</li><li>RouterCache，保存在客户端的，对 ReactServerComponentPayload 的缓存，用来提升导航性能；Next 15 对这部分有<a class="link" href="https://nextjs.org/blog/next-15-rc#client-router-cache-no-longer-caches-page-components-by-default" target="_blank" rel="noopener">
修改
</a>。</li></ul><p>下图列出了<strong>默认</strong>的缓存行为：</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching-overview.webp" width="1600" height="1179" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching-overview_hu14082063773198639693.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/caching-overview_hu16885526207029918075.png 1024w" alt="缓存行为" class="gallery-image" data-flex-grow="135" data-flex-basis="325px" loading="lazy" decoding="async"></p><p>实际上的缓存行为，取决于路由是静态还是动态、数据是缓存还是未缓存、请求是初始访问还是后续导航的一部分。</p><h3 id="requestmemoization">RequestMemoization</h3><p>Next.js 扩展了 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>，会把具有相同 URL 和 Payload 的请求视为相同的请求：</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/deduplicated-fetch-requests.webp" width="1600" height="857" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/deduplicated-fetch-requests_hu7521536171305019080.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/deduplicated-fetch-requests_hu2288725721745528735.png 1024w" alt="RequestMemoization" class="gallery-image" data-flex-grow="186" data-flex-basis="448px" loading="lazy" decoding="async"></p><p>这样，我们不必为了优化请求并发数，而将状态提升。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/request-memoization.webp" width="1600" height="800" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/request-memoization_hu8674427383026937398.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/request-memoization_hu16111258177087835728.png 1024w" alt="RequestMemoization" class="gallery-image" data-flex-grow="200" data-flex-basis="480px" loading="lazy" decoding="async"></p><ul><li>接口第一次被请求时，会在内存中查找，当前请求有没有对应的缓存；</li><li>很显然第一次请求，没有缓存；执行请求逻辑，并将结果缓存在内存中；</li><li>随着渲染的进行，当相同请求被多次调用时，如果命中了缓存，将直接返回缓存结果；</li><li>一旦<strong>当前路由渲染</strong>完毕，缓存就会被清空；</li><li>RequestMemoization 只适用于 <strong><a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>发起的 GET 请求</strong>；</li><li>RequestMemoization 只适用于 React 组件树：<ul><li>只会发生在 <a class="link" href="https://nextjs.org/docs/app/api-reference/file-conventions/layout" target="_blank" rel="noopener">layout.tsx
</a>、<a class="link" href="https://nextjs.org/docs/app/api-reference/file-conventions/page" target="_blank" rel="noopener">
page.tsx
</a>、<a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">
ServerComponents
</a>、<a class="link" href="https://nextjs.org/docs/app/api-reference/functions/generate-metadata" target="_blank" rel="noopener">
generateMetadata
</a>、<a class="link" href="https://nextjs.org/docs/app/api-reference/functions/generate-static-params" target="_blank" rel="noopener">
generateStaticParams
</a>中 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>发起的请求；</li><li>不会发生在 <a class="link" href="https://nextjs.org/docs/app/building-your-application/routing/route-handlers" target="_blank" rel="noopener">RouteHandlers
</a>，因为他不是 React 组件树的一部分。</li></ul></li><li>对于 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>不适用的场景，可以使用 ReactCache；</li><li>缓存只存在于渲染 React 组件树的过程中，因此无需进行数据验证。</li></ul><h3 id="datacache">DataCache</h3><p>DataCache 可以在服务器请求和部署之间保留数据。</p><p>在浏览器中，缓存选项用来控制<strong>请求如何与浏览器的 HTTP 缓存</strong>进行交互；在 Next.js 中，缓存选项用来控制<strong>服务器请求如何与服务器的数据缓存</strong>进行交互：</p><ul><li>对于不可变的静态文件，头部 Cache-Control 会被设置为 ‘public, max-age=31536000, immutable’；并且这些文件在打包过程中，文件名会带上自己的 hash，所以可以被永久缓存，而不用担心超长的缓存时间带来的副作用；</li><li>对于配置了 revalidate 的资源，头部 Cache-Control 会被设置为 ‘max-age=&lt;revalidateValue&gt;, stale-while-revalidate’；确保缓存会在合适的时间失效；</li><li>对于动态渲染的内容，头部 Cache-Control 会被设置为 ‘private, no-cache, no-store, max-age=0, must-revalidate’；阻止内容被缓存。</li></ul><p>默认情况下，<a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">
fetch
</a>发起的数据请求不会被缓存，可以通过 cache 和 revalidate 来配置缓存。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/data-cache.webp" width="1600" height="661" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/data-cache_hu4805390933340356204.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/data-cache_hu1910865050779551095.png 1024w" alt="DataCache" class="gallery-image" data-flex-grow="242" data-flex-basis="580px" loading="lazy" decoding="async"></p><ul><li>当使用 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>发起一个带有 ‘force-cache’ 的请求时，Next.js 会去检查缓存；</li><li>如果没有命中缓存，就发起请求，并将请求结果保存到缓存中；</li><li>当使用 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/fetch" target="_blank" rel="noopener">fetch
</a>发起一个带有 ’no-store’ 的请求时，Next.js 会略过缓存检查，直接发起请求；这在 Next 15 中，成为了<a class="link" href="https://nextjs.org/blog/next-15-rc#fetch-requests-are-no-longer-cached-by-default" target="_blank" rel="noopener">
默认行为
</a>；</li><li>DataCache 和 RequestMemoization 不冲突：<ul><li>RequestMemoization 侧重于合并相同的请求，减少渲染过程中的重复的请求带来的性能浪费；</li><li>DataCache 侧重于对请求结果的缓存，缓存时间可配置（revalidate）。</li></ul></li></ul><p>DataCache 的缓存可以配置数据验证：</p><ul><li>基于时间的验证，比如每隔 60 秒验证一次，适用于时效性没那么重要的数据；</li><li>按需验证，比如，表单提交（发生了数据的修改）之后，需要对缓存进行验证。</li></ul><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// 每小时验证一次（如果一个小时之后，接口又被请求了的话）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://...'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">next</span><span class="o">:</span> <span class="p">{</span> <span class="nx">revalidate</span>: <span class="kt">3600</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/time-based-revalidation.webp" width="1600" height="1252" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/time-based-revalidation_hu4299946095901519555.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/time-based-revalidation_hu4739437299694106962.png 1024w" alt="按需验证" class="gallery-image" data-flex-grow="127" data-flex-basis="306px" loading="lazy" decoding="async"></p><ul><li>请求第一次被发起时，没有缓存；从外部拿到数据后，缓存起来；</li><li>在配置的验证时间<strong>内</strong>，再次发起请求时，使用命中的缓存数据；</li><li>在配置的验证时间<strong>外</strong>，再次发起请求时：<ul><li>仍将过期的缓存返回；</li><li>在后台对过期缓存进行验证，更新缓存；</li><li>如果数据验证失败，接着使用过期的缓存。</li></ul></li></ul><p>按需验证需要使用 <a class="link" href="https://nextjs.org/docs/app/api-reference/functions/revalidatePath" target="_blank" rel="noopener">revalidatePath
</a>/<a class="link" href="https://nextjs.org/docs/app/api-reference/functions/revalidateTag" target="_blank" rel="noopener">
revalidateTag
</a>进行数据验证。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/on-demand-revalidation.webp" width="1600" height="1082" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/on-demand-revalidation_hu10991108473224408887.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/on-demand-revalidation_hu2439861442373344194.png 1024w" alt="按需验证" class="gallery-image" data-flex-grow="147" data-flex-basis="354px" loading="lazy" decoding="async"></p><ul><li>请求第一次被发起时，没有缓存；从外部拿到数据后，缓存起来；</li><li>当触发按需验证时，相应缓存会被清空；而基于时间的验证不会清空缓存；</li><li>下次请求时，没有命中缓存，数据会从外部重新获取。</li></ul><h3 id="fullroutecache-与-routercache">FullRouteCache 与 RouterCache</h3><p>Next.js 在服务端执行渲染时，通过路由配置和 Suspense，将渲染工作拆分为更小的单元；每个渲染单元会分成两部进行渲染：</p><ul><li>React 将 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/server-components" target="_blank" rel="noopener">ServerComponents
</a>转化为 ReactServerComponentPayload，这种数据结构是为流式传输优化过的二进制；</li><li>Next.js 将 ReactServerComponentPayload 和 <a class="link" href="https://nextjs.org/docs/app/building-your-application/rendering/client-components" target="_blank" rel="noopener">ClientComponents
</a>在服务端渲染为 HTML。</li></ul><p>这意味着，不必等待所有内容都渲染完毕之后，才能进行缓存或响应请求。相反，我们可以在渲染单元完成时流式传输渲染结果。</p><p><img src="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/full-route-cache.webp" width="1600" height="888" srcset="/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/full-route-cache_hu14060736909186865757.png 480w, /p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/full-route-cache_hu5239382295182788191.png 1024w" alt="FullRouteCache" class="gallery-image" data-flex-grow="180" data-flex-basis="432px" loading="lazy" decoding="async"></p><p>默认情况下，Next.js 会缓存路由对应的 ReactServerComponentPayload 和 HTML，这一步发生在打包部署/数据验证阶段。</p><p>在客户端，ReactServerComponentPayload 会按照路由配置缓存在内存里，用来提升路由导航/预加载的体验；这部分缓存被称为 RouterCache。</p><p>在后续的路由导航过程中，Next.js 会检查 RouterCache 中的 ReactServerComponentPayload，如果命中缓存，则不会对服务器发起请求。</p><p>有两种方式可以使 FullRouteCache 失效：</p><ul><li>对 DataCache 进行数据验证，这会反过来重新渲染服务端组件，使得 RouterCache 失效；</li><li>重新部署，在重新部署的过程中，FullRouteCache 会被清空并重建。</li></ul><p>如果不想使用 FullRouteCache，每次都动态渲染，可以使用一下方法：</p><ul><li>使用 dynamic=‘force-dynamic’ 或 revalidate=0 路由配置，这将完全跳过 DataCache 和 FullRouteCache，RouterCache 仍存在于客户端；</li><li>不使用 DataCache；</li><li>使用动态函数。</li></ul><p>RouterCache 保存在客户端内存中；记录着访问过的路由缓存和预读取的可能被访问的路由；这样能后加快路由之间导航的性能：</p><ul><li>layout 会被缓存，在路由导航之间复用；</li><li>loading 也会被缓存，在路由导航之间复用；</li><li>page 默认不会被缓存，但是会在浏览器前进后退的过程中被复用；</li><li>RouterCache 会在页面刷新之后被清除；</li><li>默认的 prefetch，不会对动态页面生成 RouterCache，对静态页面有 5 分钟的缓存；</li><li>prefetch={ true }，动态和静态页面都会有 5 分钟的缓存时间。</li></ul><p>有两种方式可以使 RouterCache 失效：</p><ul><li>在 <a class="link" href="https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations" target="_blank" rel="noopener">ServerActions
</a>中，执行缓存按需验证；</li><li>在 <a class="link" href="https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations" target="_blank" rel="noopener">ServerActions
</a>中，对 cookie 进行修改；</li><li>调用 router.refresh。</li></ul><h3 id="缓存之间的影响">缓存之间的影响</h3><ul><li>对 DataCache 进行数据验证，会使得 FullRouteCache 失效；</li><li>FullRouteCache 的失效，不会对 DataCache 造成影响；</li><li>对缓存进行按需验证，会使得 DataCache 和 RouterCache 失效；</li><li>在 <a class="link" href="https://nextjs.org/docs/app/building-your-application/routing/route-handlers" target="_blank" rel="noopener">RouteHandlers
</a>中，对 DataCache 进行数据验证，不会使 RouterCache 失效。</li></ul></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/next.js-%E4%B9%8B-auth.js/"><div class="article-image"><img src="/img/cover/nextjs.webp" loading="lazy" data-key="" data-hash="/img/cover/nextjs.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Next.js 之 Auth.js</h2></div></a></article><article class="has-image"><a href="/p/next.js-%E4%B9%8B-optimizations/"><div class="article-image"><img src="/img/cover/nextjs.webp" loading="lazy" data-key="" data-hash="/img/cover/nextjs.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Next.js 之 Optimizations</h2></div></a></article><article class="has-image"><a href="/p/next.js-%E4%B9%8B-datafetching/"><div class="article-image"><img src="/img/cover/nextjs.webp" loading="lazy" data-key="" data-hash="/img/cover/nextjs.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Next.js 之 DataFetching</h2></div></a></article><article class="has-image"><a href="/p/next.js-%E4%B9%8B-approuter/"><div class="article-image"><img src="/img/cover/nextjs.webp" loading="lazy" data-key="" data-hash="/img/cover/nextjs.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Next.js 之 AppRouter</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2025
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="关闭"></button>
<button class="pswp__button pswp__button--fs" title="全屏"></button>
<button class="pswp__button pswp__button--zoom" title="缩放"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="上一张"></button>
<button class="pswp__button pswp__button--arrow--right" title="下一张"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#servercomponents">ServerComponents</a></li><li><a href="#clientcomponents">ClientComponents</a></li><li><a href="#servercomponents-与-clientcomponents-混合模式">ServerComponents 与 ClientComponents 混合模式</a><ol><li><a href="#在-clientcomponents-中渲染-servercomponents">在 ClientComponents 中渲染 ServerComponents</a></li></ol></li><li><a href="#部分预渲染">部分预渲染</a></li><li><a href="#缓存">缓存</a><ol><li><a href="#requestmemoization">RequestMemoization</a></li><li><a href="#datacache">DataCache</a></li><li><a href="#fullroutecache-与-routercache">FullRouteCache 与 RouterCache</a></li><li><a href="#缓存之间的影响">缓存之间的影响</a></li></ol></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" crossorigin="anonymous"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>