<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1,user-scalable=no'><meta name=description content='Next.js 有两种路由，官网上是这样说的：
AppRouter 是一种新的路由模式，可以支持 React 最新的功能，例如：ServerComponents、StreamingWithSuspense 和 ServerActions ； PagesRouter 是原来 Next.js 的路由模式，用来兼容已有的旧的 Next.js 应用； 两者同时存在时，AppRouter 优先级更高。 但两者都属于基于文件系统的路由。
'><title>Next.js 之 AppRouter · I AM BEA, I DRINK TEA</title>
<link rel=canonical href=https://ElementRef.github.io/p/next.js-%E4%B9%8B-approuter/><link rel=stylesheet href=/scss/style.min.497b5f2a752c475722ecfffdb2960cc0a51fcb0c639edf1257c35adfe486dc5f.css><meta property='og:title' content='Next.js 之 AppRouter'><meta property='og:description' content='Next.js 有两种路由，官网上是这样说的：
AppRouter 是一种新的路由模式，可以支持 React 最新的功能，例如：ServerComponents、StreamingWithSuspense 和 ServerActions ； PagesRouter 是原来 Next.js 的路由模式，用来兼容已有的旧的 Next.js 应用； 两者同时存在时，AppRouter 优先级更高。 但两者都属于基于文件系统的路由。
'><meta property='og:url' content='https://ElementRef.github.io/p/next.js-%E4%B9%8B-approuter/'><meta property='og:site_name' content='馬腊咯稽'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-08-15T00:00:00+00:00'><meta property='article:modified_time' content='2024-08-15T00:00:00+00:00'><meta property='og:image' content='https://ElementRef.github.io/img/cover/nextjs.png'><meta name=twitter:title content="Next.js 之 AppRouter"><meta name=twitter:description content="Next.js 有两种路由，官网上是这样说的：
AppRouter 是一种新的路由模式，可以支持 React 最新的功能，例如：ServerComponents、StreamingWithSuspense 和 ServerActions ； PagesRouter 是原来 Next.js 的路由模式，用来兼容已有的旧的 Next.js 应用； 两者同时存在时，AppRouter 优先级更高。 但两者都属于基于文件系统的路由。
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://ElementRef.github.io/img/cover/nextjs.png'><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><meta name=robots content="noarchive, noindex, nofollow"><meta name=theme-color content="#ffffff"><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "9d3fb1ef9fac4cb0b7d041747556f0c4"}'></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu7590466716559688570.png width=300 height=404 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>馬腊咯稽</a></h1><h2 class=site-description>I AM BEA, I DRINK TEA</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/index.xml target=_blank><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg>
<span>订阅</span></a></li><li><a href=https://github.com/ElementRef/AboutConfig target=_blank><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg>
<span>配置</span></a></li><li><a href=/%E5%90%AF%E5%8F%91/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>启发</span></a></li><li><a href=/%E5%91%BD%E4%BB%A4/><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 7l5 5-5 5"/><line x1="12" y1="19" x2="19" y2="19"/></svg>
<span>命令</span></a></li><li><a href=/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>深色</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/next.js-%E4%B9%8B-approuter/><img src=/img/cover/nextjs.png loading=lazy alt="Next.js 之 AppRouter"></a></div><div class=article-details><header class=article-category><a href=/categories/next.js/>Next.js</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/next.js-%E4%B9%8B-approuter/>Next.js 之 AppRouter</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Aug 15, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长：16 分钟</time></div></footer></div></header><section class=article-content><p>Next.js 有两种路由，官网上是这样说的：</p><ul><li>AppRouter 是一种新的路由模式，可以支持 React 最新的功能，例如：ServerComponents、StreamingWithSuspense 和 <a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>ServerActions
</a>；</li><li>PagesRouter 是原来 Next.js 的路由模式，用来兼容已有的旧的 Next.js 应用；</li><li>两者同时存在时，AppRouter 优先级更高。</li></ul><p>但两者都属于<strong>基于文件系统</strong>的路由。</p><p>Next.js 会基于路由，对代码做 CodeSplit；并在合适的时候对路由进行<strong>预加载</strong>（仅在生产环境）：</p><ul><li><a class=link href=https://nextjs.org/docs/app/api-reference/components/link target=_blank rel=noopener>&lt;Link>
</a>出现在可视区域时；<ul><li>仅预加载子 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/loading target=_blank rel=noopener>loading.tsx
</a>之上的内容（可以通过 prefetch=true 加载全部内容）；</li><li>可以通过 prefetch=false 禁用这一默认行为；</li><li>仅缓存 30s。</li></ul></li><li>router.prefetch() 被调用时。</li></ul><p>AppRouter 存在于项目的 app 目录下，该目录下的组件默认为 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/route-segments-to-path-segments.png width=1600 height=594 srcset="/p/next.js-%E4%B9%8B-approuter/route-segments-to-path-segments_hu14137648594397591852.png 480w, /p/next.js-%E4%B9%8B-approuter/route-segments-to-path-segments_hu7965242293831906340.png 1024w" class=gallery-image data-flex-grow=269 data-flex-basis=646px loading=lazy></p><p>因为 Next.js 的路由基于文件系统，所以路由的层级取决于文件目录嵌套的层级。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/file-conventions-component-hierarchy.png width=1600 height=641 srcset="/p/next.js-%E4%B9%8B-approuter/file-conventions-component-hierarchy_hu12224364019672940287.png 480w, /p/next.js-%E4%B9%8B-approuter/file-conventions-component-hierarchy_hu18397332817583681338.png 1024w" class=gallery-image data-flex-grow=249 data-flex-basis=599px loading=lazy></p><h2 id=路由相关特殊文件>路由相关（特殊）文件</h2><ul><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>，当前路由及其子路由共享的 UI；不会被二次渲染；在页面跳转时，会被缓存和复用；app/layout.tsx 用来取代 PagesRouter 中的 pages/_app.js 与 pages/_document.js；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>，当前路由的 UI；默认为 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>，可被置为 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/client-components target=_blank rel=noopener>ClientComponents
</a>；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/loading target=_blank rel=noopener>loading.tsx
</a>，当前路由及其子路由共享的 LoadingUI（Suspense），实现流式渲染；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/not-found target=_blank rel=noopener>not-found.tsx
</a>，当前路由及其子路由共享的 404 UI，如果路由不匹配，就会渲染此组件；用来取代 PagesRouter 中的 pages/404.js；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/error target=_blank rel=noopener>error.tsx
</a>，当前路由及其子路由共享的 ErrorUI (ErrorBoundary)，必须为 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/client-components target=_blank rel=noopener>ClientComponents
</a>；用来取代 PagesRouter 中的 pages/_error.js；</li><li><a class=link href=https://nextjs.org/docs/app/building-your-application/routing/error-handling#handling-global-errors target=_blank rel=noopener>global-error.tsx
</a>，全局 ErrorUI，必须为 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/client-components target=_blank rel=noopener>ClientComponents
</a>；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/route target=_blank rel=noopener>route.ts
</a>，服务器端 API；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/template target=_blank rel=noopener>template.tsx
</a>，路由导航时，会重新渲染的 LayoutUI；可以用来代替 LayoutUI；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/default target=_blank rel=noopener>default.tsx
</a>，并行路由的 FallbackUI，可以理解为插槽的默认内容。</li></ul><p>通常会在 RootLayout 中定义 html 和 body 标签：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/layout.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>RootLayout</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;en&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>可以接收动态路由参数，但是不能接收 searchParams；因为 Layout 在路由导航的过程中是共享的，不会重新渲染；同样的，也获取不到 pathname；因为默认情况下，Layout 是一个 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>，在客户端路由导航的过程中不会重新渲染</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/shop/[tag]/[item]/layout.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>ShopLayout</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>item</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>tag</span>: <span class=kt>string</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// /shop/shoes/nike-air-max-97 对应的 params 为 { tag: &#39;shoes&#39;, item: &#39;nike-air-max-97&#39; }
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>section</span><span class=p>&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>section</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>可以接收到 params 和 queryParams：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/blog/[slug]/page.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Page</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>searchParams</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>slug</span>: <span class=kt>string</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>searchParams</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span>: <span class=kt>string</span><span class=p>]</span><span class=o>:</span> <span class=kt>string</span> <span class=o>|</span> <span class=kt>string</span><span class=p>[]</span> <span class=o>|</span> <span class=kc>undefined</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span><span class=nx>My</span> <span class=nx>Page</span><span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * params
</span></span></span><span class=line><span class=cl><span class=cm> *    app/shop/[slug]/page.js              /shop/1           { slug: &#39;1&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> *    app/shop/[category]/[item]/page.js   /shop/1/2         { category: &#39;1&#39;, item: &#39;2&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> *    app/shop/[...slug]/page.js           /shop/1/2         { slug: [&#39;1&#39;, &#39;2&#39;] }
</span></span></span><span class=line><span class=cl><span class=cm> * searchParams
</span></span></span><span class=line><span class=cl><span class=cm> *    /shop?a=1              { a: &#39;1&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> *    /shop?a=1&amp;b=2          { a: &#39;1&#39;, b: &#39;2&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> *    /shop?a=1&amp;a=2          { a: [&#39;1&#39;, &#39;2&#39;] }
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/route target=_blank rel=noopener>route.ts
</a>相当于 PagesRouter 下的 APIRoutes：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// 当前，context 只包含 params 一个参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>HEAD</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>PUT</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>DELETE</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>PATCH</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=c1>// 如果 OPTIONS 没有显式定义，Next.js 会自动实现来响应 Allow-* 请求头
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>OPTIONS</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span> <span class=nx>context</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span>: <span class=kt>Params</span> <span class=p>})</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * app/dashboard/[team]/route.js      /dashboard/1      { team: &#39;1&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> * app/shop/[tag]/[item]/route.js     /shop/1/2         { tag: &#39;1&#39;, item: &#39;2&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> * app/blog/[...slug]/route.js        /blog/1/2         { slug: [&#39;1&#39;, &#39;2&#39;] }
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/template target=_blank rel=noopener>template.tsx
</a>作为一个 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>的替身，适用于以下情况：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/template.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Template</span><span class=p>({</span> <span class=nx>children</span> <span class=p>}</span><span class=o>:</span> <span class=p>{</span> <span class=nx>children</span>: <span class=kt>React.ReactNode</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// Template 获取不到 params
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>div</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>Layout</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span><span class=cm>/* Template 需要一个唯一 key */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>Template</span> <span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>routeParam</span><span class=p>}&gt;{</span><span class=nx>children</span><span class=p>}&lt;/</span><span class=nt>Template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>Layout</span><span class=p>&gt;;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>依赖 Hook 实现一些逻辑；</li><li>改变 Next.js 默认行为：<ul><li>LayoutUI 中的 SuspenseFallbackUI 只会在初始化渲染的时候展示，后续路由导航都不会再展示；</li><li>TemplateUI 中的 SuspenseFallbackUI 会在每次路由导航时都展示。</li></ul></li></ul><h2 id=路由的嵌套表现为组件的嵌套>路由的嵌套表现为组件的嵌套</h2><p><img src=/p/next.js-%E4%B9%8B-approuter/nested-file-conventions-component-hierarchy.png width=1600 height=863 srcset="/p/next.js-%E4%B9%8B-approuter/nested-file-conventions-component-hierarchy_hu14517507632620461504.png 480w, /p/next.js-%E4%B9%8B-approuter/nested-file-conventions-component-hierarchy_hu4967827862930534255.png 1024w" class=gallery-image data-flex-grow=185 data-flex-basis=444px loading=lazy></p><p>除了上述<strong>相关</strong>文件之外，目录下的其他文件（业务组件、样式、测试文件&mldr;）会被排除在路由系统之外，这一行为被称为 Colocation：</p><p><img src=/p/next.js-%E4%B9%8B-approuter/project-organization-colocation.png width=1600 height=1011 srcset="/p/next.js-%E4%B9%8B-approuter/project-organization-colocation_hu17546377726041336534.png 480w, /p/next.js-%E4%B9%8B-approuter/project-organization-colocation_hu14869515282502260156.png 1024w" class=gallery-image data-flex-grow=158 data-flex-basis=379px loading=lazy></p><p>这是和 PagesRouter 的不同点之一，PagesRouter 中，pages 目录下的任何文件都对应着一条路由记录。</p><h2 id=路由导航有四种方式>路由导航有四种方式</h2><ul><li><a class=link href=https://nextjs.org/docs/app/api-reference/components/link target=_blank rel=noopener>&lt;Link>
</a>组件；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/use-router target=_blank rel=noopener>useRouter
</a>Hook，用在 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/client-components target=_blank rel=noopener>ClientComponents
</a>；准确的说，所有 Hook 都只能运行在客户端；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>函数，用在 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>：<ul><li>组件中 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>会返回 307 状态码；</li><li><a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>ServerActions
</a>中 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>会返回 303 状态码；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>内部是通过 throwError 实现的，所以不能用 try&mldr;catch 中调用，否则失效；</li><li>在 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/client-components target=_blank rel=noopener>ClientComponents
</a><strong>渲染过程</strong>中也可调用，在事件处理回调中不行；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>可以传入<strong>外部链接</strong>。</li></ul></li><li>原生的 History API，Next.js 对 History 做了特殊处理，只能用在客户端。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Link</span> <span class=kr>from</span> <span class=s1>&#39;next/link&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>redirect</span><span class=p>,</span> <span class=nx>usePathname</span><span class=p>,</span> <span class=nx>useRouter</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/navigation&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// Link
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>PostList</span><span class=p>({</span> <span class=nx>posts</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>posts</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>post</span> <span class=o>=&gt;</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>li</span> <span class=na>key</span><span class=o>=</span><span class=p>{</span><span class=nx>post</span><span class=p>.</span><span class=nx>id</span><span class=p>}&gt;</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>            每次用户触发导航会滚动到页面顶部或者锚点位置
</span></span></span><span class=line><span class=cl><span class=cm>            当使用浏览器的前进后退功能是，会保留滚动位置
</span></span></span><span class=line><span class=cl><span class=cm>            可通过 scroll={false} 禁用这种默认行为
</span></span></span><span class=line><span class=cl><span class=cm>           */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;</span><span class=nt>Link</span> <span class=na>href</span><span class=o>=</span><span class=p>{</span><span class=sb>`/blog/</span><span class=si>${</span><span class=nx>post</span><span class=p>.</span><span class=nx>slug</span><span class=si>}</span><span class=sb>#content`</span><span class=p>}</span> <span class=na>scroll</span><span class=o>=</span><span class=p>{</span><span class=kc>false</span><span class=p>}&gt;</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span><span class=nx>post</span><span class=p>.</span><span class=nx>title</span><span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>&lt;/</span><span class=nt>Link</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;/</span><span class=nt>li</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>))}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>ul</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// Hook 只能在客户端使用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>Links() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathname</span> <span class=o>=</span> <span class=nx>usePathname</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>router</span> <span class=o>=</span> <span class=nx>useRouter</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Link</span> <span class=na>className</span><span class=o>=</span><span class=p>{</span><span class=nx>pathname</span> <span class=o>===</span> <span class=s1>&#39;/&#39;</span> <span class=o>?</span> <span class=s1>&#39;active&#39;</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>}</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Home</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>Link</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span>
</span></span><span class=line><span class=cl>        <span class=na>type</span><span class=o>=</span><span class=s>&#34;button&#34;</span>
</span></span><span class=line><span class=cl>        <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>router</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=s1>&#39;/dashboard&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>scroll</span>: <span class=kt>false</span> <span class=p>})}</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Dashboard</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Link</span> <span class=na>className</span><span class=o>=</span><span class=p>{</span><span class=nx>pathname</span> <span class=o>===</span> <span class=s1>&#39;/about&#39;</span> <span class=o>?</span> <span class=s1>&#39;active&#39;</span> <span class=o>:</span> <span class=s1>&#39;&#39;</span><span class=p>}</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/about&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>About</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>Link</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>nav</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// redirect
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>async</span> <span class=kd>function</span> <span class=nx>fetchTeam</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://baidu.com/team&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>res</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=k>return</span> <span class=kc>undefined</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>Profile</span><span class=p>({</span> <span class=nx>params</span> <span class=p>}</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>id</span>: <span class=kt>string</span> <span class=p>}</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>team</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetchTeam</span><span class=p>(</span><span class=nx>params</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>team</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;{</span><span class=nx>team</span><span class=p>.</span><span class=nx>id</span><span class=p>}&lt;/</span><span class=nt>div</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// History API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kd>function</span> <span class=nx>LocaleSwitcher() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathname</span> <span class=o>=</span> <span class=nx>usePathname</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kd>function</span> <span class=nx>switchLocale</span><span class=p>(</span><span class=nx>locale</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>newPath</span> <span class=o>=</span> <span class=sb>`/</span><span class=si>${</span><span class=nx>locale</span><span class=si>}${</span><span class=nx>pathname</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>history</span><span class=p>.</span><span class=nx>replaceState</span><span class=p>(</span><span class=kc>null</span><span class=p>,</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=nx>newPath</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>switchLocale</span><span class=p>(</span><span class=s1>&#39;en&#39;</span><span class=p>)}&gt;</span><span class=nx>English</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>switchLocale</span><span class=p>(</span><span class=s1>&#39;fr&#39;</span><span class=p>)}&gt;</span><span class=nx>French</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=部分渲染>部分渲染</h2><p>当路由切换仅发生在嵌套的子路由之间（/dashboard/settings 2 /dashboard/analytics）时：</p><p><img src=/p/next.js-%E4%B9%8B-approuter/partial-rendering.png width=1600 height=945 srcset="/p/next.js-%E4%B9%8B-approuter/partial-rendering_hu16176107522066677376.png 480w, /p/next.js-%E4%B9%8B-approuter/partial-rendering_hu8895459430932105553.png 1024w" class=gallery-image data-flex-grow=169 data-flex-basis=406px loading=lazy></p><p>Next.js 只会增量渲染 analytics，而不是整个页面。</p><h2 id=错误处理>错误处理</h2><ul><li>预期错误：一般发生在 <a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>ServerActions
</a>中，例如参数验证失败、失败请求等，避免用 try&mldr;catch 处理；例如前文提到的 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>；</li><li>未知错误：一般为未知 bug，使用错误边界做处理，例如 [global-]error.tsx</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>useActionState</span><span class=p>,</span> <span class=nx>useEffect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>createUser</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/app/actions&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用 useActionState 从 ServerActions 拿到错误信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>initialState</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>Signup() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>[</span><span class=nx>state</span><span class=p>,</span> <span class=nx>formAction</span><span class=p>]</span> <span class=o>=</span> <span class=nx>useActionState</span><span class=p>(</span><span class=nx>createUser</span><span class=p>,</span> <span class=nx>initialState</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>form</span> <span class=na>action</span><span class=o>=</span><span class=p>{</span><span class=nx>formAction</span><span class=p>}&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>label</span> <span class=na>htmlFor</span><span class=o>=</span><span class=s>&#34;email&#34;</span><span class=p>&gt;</span><span class=nx>Email</span><span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>input</span> <span class=na>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;email&#34;</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;email&#34;</span> <span class=na>required</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=cm>/* ... */</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>p</span> <span class=na>aria-live</span><span class=o>=</span><span class=s>&#34;polite&#34;</span><span class=p>&gt;{</span><span class=nx>state</span><span class=o>?</span><span class=p>.</span><span class=nx>message</span><span class=p>}&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span><span class=p>&gt;</span><span class=nx>Sign</span> <span class=nx>up</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>form</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用错误边界（app/../../error.tsx）处理未知错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nb>Error</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>reset</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span>: <span class=kt>Error</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>digest?</span>: <span class=kt>string</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>reset</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>useEffect</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 可以上报至服务器
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>console</span><span class=p>.</span><span class=nx>error</span><span class=p>(</span><span class=nx>error</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>[</span><span class=nx>error</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span><span class=nx>Something</span> <span class=nx>went</span> <span class=nx>wrong</span><span class=o>!</span><span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span>
</span></span><span class=line><span class=cl>        <span class=na>onClick</span><span class=o>=</span><span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 尝试重新渲染出错的地方
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>()</span> <span class=o>=&gt;</span> <span class=nx>reset</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nx>Try</span> <span class=nx>again</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 如果使用 global-error.tsx，需要在内部定义 &lt;html&gt;
</span></span></span><span class=line><span class=cl><span class=cm> * 因为他会替换整个 RootLayout
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>GlobalError</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>reset</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>error</span>: <span class=kt>Error</span> <span class=o>&amp;</span> <span class=p>{</span> <span class=nx>digest?</span>: <span class=kt>string</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>reset</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=k>void</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>h2</span><span class=p>&gt;</span><span class=nx>Something</span> <span class=nx>went</span> <span class=nx>wrong</span><span class=o>!</span><span class=p>&lt;/</span><span class=nt>h2</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>button</span> <span class=na>onClick</span><span class=o>=</span><span class=p>{()</span> <span class=o>=&gt;</span> <span class=nx>reset</span><span class=p>()}&gt;</span><span class=nx>Try</span> <span class=nx>again</span><span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=流式渲染>流式渲染</h2><p><img src=/p/next.js-%E4%B9%8B-approuter/server-rendering-without-streaming-chart.png width=1600 height=612 srcset="/p/next.js-%E4%B9%8B-approuter/server-rendering-without-streaming-chart_hu14118026931120027712.png 480w, /p/next.js-%E4%B9%8B-approuter/server-rendering-without-streaming-chart_hu4303208095345198893.png 1024w" class=gallery-image data-flex-grow=261 data-flex-basis=627px loading=lazy></p><p>在服务端渲染的应用中，用户访问页面会发生一些事情：</p><ol><li>在服务端获取页面渲染所需要所有的数据；</li><li>服务端渲染出 HTMLString；</li><li>HTML、静态资源和 JS 被发往客户端；</li><li>用户看到不可交互的静态页面；</li><li>React 通过 Hydrate，为页面添加交互。</li></ol><p>服务器必须拿到数据，才能开始渲染工作；所以，这个过程是<strong>阻塞</strong>的；为了让用户尽快看到页面，而不用等到所有数据都准备好；Next.js 引入了 Streaming。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/loading-overview.png width=1600 height=766 srcset="/p/next.js-%E4%B9%8B-approuter/loading-overview_hu15893346405950964548.png 480w, /p/next.js-%E4%B9%8B-approuter/loading-overview_hu13362119269183837118.png 1024w" class=gallery-image data-flex-grow=208 data-flex-basis=501px loading=lazy></p><p>通过 Suspense 将整个页面分割为多个“小页面”，分别发往客户端。路由跳转时，页面初次渲染，<a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/loading target=_blank rel=noopener>
loading.tsx
</a>作为备胎参与渲染；当异步内容准备好时，借助 Suspense 替换为真正的内容。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming.png width=1600 height=785 srcset="/p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming_hu8880335520008794299.png 480w, /p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming_hu83588046903187833.png 1024w" class=gallery-image data-flex-grow=203 data-flex-basis=489px loading=lazy></p><p>此时，渲染流程变成了酱紫；大的流程被拆分为多个并行的渲染任务；这样，TTFB 和 FCP 指标会更好看，也会改善 TTI。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming-chart.png width=1600 height=730 srcset="/p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming-chart_hu14006761641724616986.png 480w, /p/next.js-%E4%B9%8B-approuter/server-rendering-with-streaming-chart_hu615478645303074172.png 1024w" class=gallery-image data-flex-grow=219 data-flex-basis=526px loading=lazy></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>Suspense</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;react&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>PostFeed</span><span class=p>,</span> <span class=nx>Weather</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./Components&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 页面渲染被拆分为了两个更小的渲染任务
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Posts() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>section</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Suspense</span> <span class=na>fallback</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>p</span><span class=p>&gt;</span><span class=nx>Loading</span> <span class=nx>feed</span><span class=p>...&lt;/</span><span class=nt>p</span><span class=p>&gt;}&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>PostFeed</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;</span><span class=nt>Suspense</span> <span class=na>fallback</span><span class=o>=</span><span class=p>{&lt;</span><span class=nt>p</span><span class=p>&gt;</span><span class=nx>Loading</span> <span class=nx>weather</span><span class=p>...&lt;/</span><span class=nt>p</span><span class=p>&gt;}&gt;</span>
</span></span><span class=line><span class=cl>        <span class=p>&lt;</span><span class=nt>Weather</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>&lt;/</span><span class=nt>Suspense</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/</span><span class=nt>section</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>为了保证 SEO 不受影响，Next.js 会保证 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/generate-metadata target=_blank rel=noopener>generateMetadata
</a>数据获取完成之后，再 StreamingUI。</p><h2 id=重定向>重定向</h2><p>在 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>、<a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>
ServerActions
</a>、<a class=link href=https://nextjs.org/docs/app/building-your-application/routing/route-handlers target=_blank rel=noopener>
RouteHandlers
</a>中使用 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>进行重定向：</p><ul><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>默认使用 307 状态码（暂时重定向）；在 <a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>ServerActions
</a>中使用 303 状态码（重定向到结果页面）；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>不能在 try&mldr;catch 中使用，因为他是通过抛出一个错误来完成重定向的；</li><li>在客户端，仅能在渲染过程中调用 <a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/redirect target=_blank rel=noopener>redirect
</a>可以跳转到外部网站。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>redirect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/navigation&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>revalidatePath</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/cache&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>createPost</span><span class=p>(</span><span class=nx>id</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 请求数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理错误
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>revalidatePath</span><span class=p>(</span><span class=s1>&#39;/posts&#39;</span><span class=p>);</span> <span class=c1>// 更新缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>redirect</span><span class=p>(</span><span class=sb>`/post/</span><span class=si>${</span><span class=nx>id</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span> <span class=c1>// 重定向到对应页面
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p><a class=link href=https://nextjs.org/docs/app/api-reference/functions/permanentRedirect target=_blank rel=noopener>permanentRedirect
</a>函数用来处理<strong>永久重定向</strong>，同样只能在 <a class=link href=https://nextjs.org/docs/app/building-your-application/rendering/server-components target=_blank rel=noopener>ServerComponents
</a>、<a class=link href=https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations target=_blank rel=noopener>
ServerActions
</a>、<a class=link href=https://nextjs.org/docs/app/building-your-application/routing/route-handlers target=_blank rel=noopener>
RouteHandlers
</a>中使用。当修改用户名导致用户页面被映射到新的 URL 时使用：</p><ul><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/permanentRedirect target=_blank rel=noopener>permanentRedirect
</a>默认使用 308 状态码；</li><li><a class=link href=https://nextjs.org/docs/app/api-reference/functions/permanentRedirect target=_blank rel=noopener>permanentRedirect
</a>可以跳转到外部网站。</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>permanentRedirect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/navigation&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>revalidateTag</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/cache&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>updateUsername</span><span class=p>(</span><span class=nx>username</span>: <span class=kt>string</span><span class=p>,</span> <span class=nx>formData</span>: <span class=kt>FormData</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 请求数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理错误
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>revalidateTag</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>);</span> <span class=c1>// 更新用户名
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>permanentRedirect</span><span class=p>(</span><span class=sb>`/profile/</span><span class=si>${</span><span class=nx>username</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span> <span class=c1>// 重定向到新的用户页
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>在 next.config.js 中配置重定向，重定向发生在数据请求/<a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/middleware target=_blank rel=noopener>
中间件
</a>之前；可以通过 permanent 属性来决定是 307 还是 308。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=nx>module</span><span class=p>.</span><span class=nx>exports</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>async</span> <span class=nx>redirects() {</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>source</span><span class=o>:</span> <span class=s1>&#39;/about&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>destination</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>permanent</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>source</span><span class=o>:</span> <span class=s1>&#39;/blog/:slug&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>destination</span><span class=o>:</span> <span class=s1>&#39;/news/:slug&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=nx>permanent</span>: <span class=kt>true</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>使用<a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/middleware target=_blank rel=noopener>
中间件
</a>来重定向，<a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/middleware target=_blank rel=noopener>
中间件
</a>会在请求完成之前运行（晚于 next.config.js 中的 redirects）；这种方式可以基于登录状态、用户权限等信息来完成重定向；更灵活，更贴近业务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span><span class=p>,</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>authenticate</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;auth-provider&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isAuthenticated</span> <span class=o>=</span> <span class=nx>authenticate</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isAuthenticated</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 没有登录就重定向到登录页
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;/login&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=s1>&#39;/dashboard/:path*&#39;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>当有大量的重定向场景时，使用中间件更为合适。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// 需要创建一个重定向的配置，记录从哪里到哪里，例如这样，可以保存到数据库中：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;/old&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;destination&#34;</span><span class=o>:</span> <span class=s2>&#34;/new&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;permanent&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;/blog/post-old&#34;</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;destination&#34;</span><span class=o>:</span> <span class=s2>&#34;/blog/post-new&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;permanent&#34;</span><span class=o>:</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span><span class=p>,</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=kr>get</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@vercel/edge-config&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>RedirectEntry</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>destination</span>: <span class=kt>string</span>
</span></span><span class=line><span class=cl>  <span class=nx>permanent</span>: <span class=kt>boolean</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 在数据库中查询要重定向到的新位置，这一步的查询性能很重要
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathname</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>pathname</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 可以放在缓存中，例如 Redis、BloomFilter
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>redirectData</span> <span class=o>=</span> <span class=k>await</span> <span class=kr>get</span><span class=p>(</span><span class=nx>pathname</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>redirectData</span> <span class=o>&amp;&amp;</span> <span class=k>typeof</span> <span class=nx>redirectData</span> <span class=o>===</span> <span class=s1>&#39;string&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>redirectEntry</span>: <span class=kt>RedirectEntry</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>redirectData</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>statusCode</span> <span class=o>=</span> <span class=nx>redirectEntry</span><span class=p>.</span><span class=nx>permanent</span> <span class=o>?</span> <span class=nx>308</span> : <span class=kt>307</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>redirectEntry</span><span class=p>.</span><span class=nx>destination</span><span class=p>,</span> <span class=nx>statusCode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 放行
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=路由组>路由组</h2><p>Next.js 中，路由是基于文件系统用的，目录的嵌套会导致路由的嵌套；如果只想基于业务，将文件目录分组而不影响路由配置，可以使用路由组。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/route-group-organisation.png width=1600 height=930 srcset="/p/next.js-%E4%B9%8B-approuter/route-group-organisation_hu16555292231885863461.png 480w, /p/next.js-%E4%B9%8B-approuter/route-group-organisation_hu13895929495438154134.png 1024w" class=gallery-image data-flex-grow=172 data-flex-basis=412px loading=lazy></p><p>(marketing) 和 (shop) 都属于<strong>根</strong>层级；也可以在分组下使用 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>使得不同组别有不同的 LayoutUI。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/route-group-multiple-layouts.png width=1600 height=768 srcset="/p/next.js-%E4%B9%8B-approuter/route-group-multiple-layouts_hu14444393441882975077.png 480w, /p/next.js-%E4%B9%8B-approuter/route-group-multiple-layouts_hu13925418577127412131.png 1024w" class=gallery-image data-flex-grow=208 data-flex-basis=500px loading=lazy></p><p>通过移除根 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>，在路由组内配置自己的 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>，可以实现不同路由有不同的 UI 风格。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/route-group-multiple-root-layouts.png width=1600 height=687 srcset="/p/next.js-%E4%B9%8B-approuter/route-group-multiple-root-layouts_hu6708217700665180000.png 480w, /p/next.js-%E4%B9%8B-approuter/route-group-multiple-root-layouts_hu14845612240984953829.png 1024w" class=gallery-image data-flex-grow=232 data-flex-basis=558px loading=lazy></p><ul><li>路由组可以随意命名，因为不会影响 URL；</li><li>(marketing)/about/page.tsx 和 (shop)/about/page.tsx 会导致路由冲突而报错；</li><li>跨路由组跳转，会导致整个页面刷新。</li></ul><h2 id=私有目录>私有目录</h2><p>目录名称以_开头的目录，当前及子目录都不会被解析为路由；它主要用来在路由逻辑中分离 UI 逻辑（没什么用）。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/project-organization-private-folders.png width=1600 height=849 srcset="/p/next.js-%E4%B9%8B-approuter/project-organization-private-folders_hu3954404499626862747.png 480w, /p/next.js-%E4%B9%8B-approuter/project-organization-private-folders_hu11237389017126900757.png 1024w" class=gallery-image data-flex-grow=188 data-flex-basis=452px loading=lazy></p><h2 id=动态路由>动态路由</h2><p>目录以 [folder] 或 [&mldr;folder] 命名，例如 [userId]、[&mldr;slug] 等，动态参数通过 props.params 传递。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * app/blog/[slug]/page.tsx
</span></span></span><span class=line><span class=cl><span class=cm> * /blog/a，此时 props.params 为 { slug: &#39;a&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> * /blog/b，此时 props.params 为 { slug: &#39;b&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> * /blog/c，此时 props.params 为 { slug: &#39;c&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Page</span><span class=p>({</span> <span class=nx>params</span> <span class=p>}</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>slug</span>: <span class=kt>string</span> <span class=p>}</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span><span class=nx>My</span> <span class=nx>Post</span><span class=o>:</span> <span class=p>{</span><span class=nx>params</span><span class=p>.</span><span class=nx>slug</span><span class=p>}&lt;/</span><span class=nt>div</span><span class=p>&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * generateStaticParams 可以用来获取所有可能的动态路由的枚举值
</span></span></span><span class=line><span class=cl><span class=cm> * 好让 Next.js 在 SSG 模式下，可以在打包阶段完成预渲染
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>generateStaticParams() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>posts</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://.../posts&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>res</span> <span class=o>=&gt;</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>());</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>posts</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>post</span> <span class=o>=&gt;</span> <span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>slug</span>: <span class=kt>post.slug</span>
</span></span><span class=line><span class=cl>  <span class=p>}));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[folder] 只可以捕获一个 RouteParams，[&mldr;folder] 可以捕获多个 RouteParams，对于 app/shop/[&mldr;slug]/page.tsx：</p><ul><li>/shop/a 对应的 props.params 为 { slug: [&lsquo;a&rsquo;] }；</li><li>/shop/a/b 对应的 props.params 为 { slug: [&lsquo;a&rsquo;, &lsquo;b&rsquo;] }；</li><li>/shop/a/b/c 对应的 props.params 为 { slug: [&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;] }。</li></ul><p>[[&mldr;folder]] 比 [&mldr;folder] 更进一步，对于 app/shop/[[&mldr;slug]]/page.tsx 他可以匹配 /shop、/shop/clothes、/shop/clothes/tops、/shop/clothes/tops/t-shirts：</p><ul><li>/shop 对应的 props.params 为 {}；</li><li>/shop/a 对应的 props.params 为 { slug: [&lsquo;a&rsquo;] }；</li><li>/shop/a/b 对应的 props.params 为 { slug: [&lsquo;a&rsquo;, &lsquo;b&rsquo;] }；</li><li>/shop/a/b/c 对应的 props.params 为 { slug: [&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;] }。</li></ul><h2 id=并行路由>并行路由</h2><p>官网上说，并行路由相当于<strong>具名插槽</strong>；在我看来，也就是 renderProps；[@folder] 定义的目录不会被解析为路由，而是被解析为同目录下 layout.tsx 的 props。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/parallel-routes.png width=1600 height=942 srcset="/p/next.js-%E4%B9%8B-approuter/parallel-routes_hu6656460999428923809.png 480w, /p/next.js-%E4%B9%8B-approuter/parallel-routes_hu5602655638713100270.png 1024w" class=gallery-image data-flex-grow=169 data-flex-basis=407px loading=lazy></p><p>或者你可以这么理解，app/page.tsx 就相当于 app/@children/page.tsx。</p><p>除了默认的 props.children，还可以拿到 props.folder 用来渲染。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/layout.tsx
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Layout</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>analytics</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>team</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>analytics</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>children</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>team</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;&gt;</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>analytics</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>children</span><span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span><span class=nx>team</span><span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;/&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>[@folder] 下还可以为不同的路由路径匹配不同的内容；当匹配不到时，[@folder] 下最好有 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/default target=_blank rel=noopener>default.tsx
</a>作为 FallbackUI（插槽的默认内容），否则，会渲染 404。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/parallel-routes-unmatched-routes.png width=1600 height=930 srcset="/p/next.js-%E4%B9%8B-approuter/parallel-routes-unmatched-routes_hu14720743028441766868.png 480w, /p/next.js-%E4%B9%8B-approuter/parallel-routes-unmatched-routes_hu2223358553106614925.png 1024w" class=gallery-image data-flex-grow=172 data-flex-basis=412px loading=lazy></p><p>比如，@team 下提供了 /settings 路径下，要提供给 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>渲染的内容；而 @analytics 下没有，这时如果没有 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/default target=_blank rel=noopener>default.tsx
</a>，就会返回 404。</p><p>官网上说并行路由可以用来条件渲染，我觉得有点牵强了，因为 admin 和 user 不一定非要通过 props 去拿：</p><p><img src=/p/next.js-%E4%B9%8B-approuter/conditional-routes-ui.png width=1600 height=898 srcset="/p/next.js-%E4%B9%8B-approuter/conditional-routes-ui_hu15492991379474494306.png 480w, /p/next.js-%E4%B9%8B-approuter/conditional-routes-ui_hu10089257959417389555.png 1024w" class=gallery-image data-flex-grow=178 data-flex-basis=427px loading=lazy></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>checkUserRole</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@/lib/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kd>function</span> <span class=nx>Layout</span><span class=p>({</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span>
</span></span><span class=line><span class=cl><span class=p>}</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>admin</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>user</span>: <span class=kt>React.ReactNode</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>role</span> <span class=o>=</span> <span class=nx>checkUserRole</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>&lt;&gt;{</span><span class=nx>role</span> <span class=o>===</span> <span class=s1>&#39;admin&#39;</span> <span class=o>?</span> <span class=nx>admin</span> : <span class=kt>user</span><span class=p>}&lt;/&gt;;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=路由拦截>路由拦截</h2><p>比如，当你点击一张图片，路径为 /photo/flower，然而你不想跳转到新页面，而仅仅想用弹窗的形式预览图片时：</p><p><img src=/p/next.js-%E4%B9%8B-approuter/intercepting-routes-soft-navigate.png width=1600 height=617 srcset="/p/next.js-%E4%B9%8B-approuter/intercepting-routes-soft-navigate_hu6137020550994612279.png 480w, /p/next.js-%E4%B9%8B-approuter/intercepting-routes-soft-navigate_hu3293895636187992744.png 1024w" class=gallery-image data-flex-grow=259 data-flex-basis=622px loading=lazy></p><p>同时，当用户手动访问 /photo/flower 时，图片又以页面的形式被展示（有点像花瓣网的交互，当时是通过 History API 实现的）：</p><p><img src=/p/next.js-%E4%B9%8B-approuter/intercepting-routes-hard-navigate.png width=1600 height=604 srcset="/p/next.js-%E4%B9%8B-approuter/intercepting-routes-hard-navigate_hu7668115502941520810.png 480w, /p/next.js-%E4%B9%8B-approuter/intercepting-routes-hard-navigate_hu12698031352039014030.png 1024w" class=gallery-image data-flex-grow=264 data-flex-basis=635px loading=lazy></p><p>可以通过路由拦截来实现：</p><ul><li>(.)folder，匹配同级路由；</li><li>(..)folder，匹配上级路由；</li><li>(..)(..)folder，匹配上上级路由；</li><li>(&mldr;)folder，匹配从根到当前的所有路由；</li></ul><p><img src=/p/next.js-%E4%B9%8B-approuter/intercepted-routes-modal-example.png width=1600 height=976 srcset="/p/next.js-%E4%B9%8B-approuter/intercepted-routes-modal-example_hu2424377475695924984.png 480w, /p/next.js-%E4%B9%8B-approuter/intercepted-routes-modal-example_hu329268502395151473.png 1024w" class=gallery-image data-flex-grow=163 data-flex-basis=393px loading=lazy></p><h2 id=路由处理程序>路由处理程序</h2><p>用来取代 PagesRouter 中的 APIRoutes，可以用来做 BFF、请求转发、直接操作数据库、解决跨域问题甚至做全栈开发等。</p><p><img src=/p/next.js-%E4%B9%8B-approuter/route-special-file.png width=1600 height=444 srcset="/p/next.js-%E4%B9%8B-approuter/route-special-file_hu8691299078494752287.png 480w, /p/next.js-%E4%B9%8B-approuter/route-special-file_hu12742836558919334048.png 1024w" class=gallery-image data-flex-grow=360 data-flex-basis=864px loading=lazy></p><p>只有在 app/**/ 目录下的才叫做路由处理程序；<a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/route target=_blank rel=noopener>
route.ts
</a>同级目录下不能有 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>；他支持 GET、POST、PUT、PATCH、DELETE、HEAD 和 OPTIONS 请求，如果遇到不支持的请求方式，会返回 405 状态码（Method Not Allowed）。</p><p><a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/layout target=_blank rel=noopener>layout.tsx
</a>| <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>| <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/route target=_blank rel=noopener>route.ts
</a>相关配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 控制路由的动态行为
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;auto&#39; 默认值，尽可能的缓存，但不阻止动态行为
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;force-dynamic&#39; 强制动态渲染
</span></span></span><span class=line><span class=cl><span class=cm> *    相当于 PagesRouter 中的 getServerSideProps
</span></span></span><span class=line><span class=cl><span class=cm> *    每个请求的配置都为 { cache: &#39;no-store&#39;, next: { revalidate: 0 } }
</span></span></span><span class=line><span class=cl><span class=cm> *    并设置了 fetchCache = &#39;force-no-store&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;error&#39; 强制静态渲染，如果使用了任何动态数据，会抛出错误
</span></span></span><span class=line><span class=cl><span class=cm> *    相当于 PagesRouter 中的 getStaticProps
</span></span></span><span class=line><span class=cl><span class=cm> *    每个请求的配置都为 { cache: &#39;force-cache&#39; }
</span></span></span><span class=line><span class=cl><span class=cm> *    并设置了 fetchCache = &#39;only-cache&#39;, dynamicParams = false
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;force-static&#39; 通过强制 cookies()、headers()、useSearchParams() 返回空值来实现强制静态渲染
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>dynamic</span> <span class=o>=</span> <span class=s1>&#39;auto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 控制，当访问的不是使用 generateStaticParams 生成的动态 params 时会发生什么
</span></span></span><span class=line><span class=cl><span class=cm> * true 默认值，当 params 不在 generateStaticParams 的返回值里时，按需生成内容
</span></span></span><span class=line><span class=cl><span class=cm> * false 当 params 不在 generateStaticParams 的返回值里时，返回 404
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>dynamicParams</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 控制对缓存的验证行为，不会覆盖 fetch 里单独配置的 revalidate 值
</span></span></span><span class=line><span class=cl><span class=cm> * false，默认值，强制无限期缓存，相当于 revalidate: Infinity
</span></span></span><span class=line><span class=cl><span class=cm> * 0，每次请求都动态渲染
</span></span></span><span class=line><span class=cl><span class=cm> * number，验证时间间隔，单位：秒；不能设置为 3*2，因为 revalidate 需要可以被静态分析
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>revalidate</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 用来对当前组件中的所有缓存配置做修改
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;auto&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;default-cache&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;only-cache&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;force-cache&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;force-no-store&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;default-no-store&#39;
</span></span></span><span class=line><span class=cl><span class=cm> * &#39;only-no-store&#39;
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>fetchCache</span> <span class=o>=</span> <span class=s1>&#39;auto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 配置运行时环境
</span></span></span><span class=line><span class=cl><span class=cm> * nodejs
</span></span></span><span class=line><span class=cl><span class=cm> * edge
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>runtime</span> <span class=o>=</span> <span class=s1>&#39;nodejs&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>preferredRegion</span> <span class=o>=</span> <span class=s1>&#39;auto&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// 服务端逻辑最长执行时间
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>maxDuration</span> <span class=o>=</span> <span class=mi>5</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>路由处理程序的优先级相对较低，他不直接参与页面渲染；也不参与客户端页面导航；要注意与 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>的冲突：</p><ul><li>app/page.tsx 与 app/route.ts 会发生冲突；</li><li>app/page.tsx 与 app/api/route.ts 不会发生冲突；</li><li>app/[user]/page.tsx 与 app/api/route.ts 不会发生冲突。</li></ul><p>原因是 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/route target=_blank rel=noopener>route.ts
</a>与 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>都会接管路由的所有请求，所以不能在同目录下共存。</p><p>默认情况下，路由处理程序不会被缓存；可以通过 export const dynamic = &lsquo;force-static&rsquo; 缓存 GET 请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/items/route.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>const</span> <span class=nx>dynamic</span> <span class=o>=</span> <span class=s1>&#39;force-static&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://data.mongodb-api.com/...&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;API-Key&#39;</span><span class=o>:</span> <span class=nx>process</span><span class=p>.</span><span class=nx>env</span><span class=p>.</span><span class=nx>DATA_API_KEY</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;application/json&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>data</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>重新验证缓存：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>revalidate</span> <span class=o>=</span> <span class=mi>60</span><span class=p>;</span> <span class=c1>// 也可以这样配置数据验证
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=s1>&#39;https://data.mongodb-api.com/...&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 如果当前请求距离上一次请求已经过了 60s
</span></span></span><span class=line><span class=cl><span class=cm>     * 那么本次需要对缓存数据做验证
</span></span></span><span class=line><span class=cl><span class=cm>     * 本次请求，还是返回之前的数据
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nx>next</span><span class=o>:</span> <span class=p>{</span> <span class=nx>revalidate</span>: <span class=kt>60</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>data</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span><span class=nx>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>设置客户端 cookie：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>cookies</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/headers&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>cookieStore</span> <span class=o>=</span> <span class=nx>cookies</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>cookieStore</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=s1>&#39;Hello, Next.js!&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>status</span>: <span class=kt>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span> <span class=s1>&#39;Set-Cookie&#39;</span><span class=o>:</span> <span class=sb>`token=</span><span class=si>${</span><span class=nx>token</span><span class=p>.</span><span class=nx>value</span><span class=si>}</span><span class=sb>`</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 也可以通过 NextRequest 直接拿到 cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=kr>type</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>token</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;token&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>读取/设置请求头部信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>headers</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/headers&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>headersList</span> <span class=o>=</span> <span class=nx>headers</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>referer</span> <span class=o>=</span> <span class=nx>headersList</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;referer&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过 Response 设置头部信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=s1>&#39;Hello, Next.js!&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span> <span class=nx>referer</span>: <span class=kt>referer</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>status</span>: <span class=kt>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 也可以通过 NextRequest 直接拿到 header
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=kr>type</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>requestHeaders</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Headers</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>配置重定向：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>redirect</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/navigation&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>redirect</span><span class=p>(</span><span class=s1>&#39;https://nextjs.org/&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>获取路由动态/查询参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/items/[slug]/route.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>request</span>: <span class=kt>Request</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=nx>params</span> <span class=p>}</span><span class=o>:</span> <span class=p>{</span> <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>slug</span>: <span class=kt>string</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>slug</span> <span class=o>=</span> <span class=nx>params</span><span class=p>.</span><span class=nx>slug</span><span class=p>;</span> <span class=c1>// &#39;a&#39;, &#39;b&#39;, or &#39;c&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// /api/search?query=hello
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=kr>type</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>searchParams</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>searchParams</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>query</span> <span class=o>=</span> <span class=nx>searchParams</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;query&#39;</span><span class=p>);</span> <span class=c1>// hello
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>流式响应：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/api/chat/route.ts
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>openai</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@ai-sdk/openai&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>StreamingTextResponse</span><span class=p>,</span> <span class=nx>streamText</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;ai&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>messages</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>req</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>result</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>streamText</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>model</span>: <span class=kt>openai</span><span class=p>(</span><span class=s1>&#39;gpt-4-turbo&#39;</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=nx>messages</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>StreamingTextResponse</span><span class=p>(</span><span class=nx>result</span><span class=p>.</span><span class=nx>toAIStream</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 或者使用底层 API
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>function</span> <span class=nx>iteratorToStream</span><span class=p>(</span><span class=nx>iterator</span>: <span class=kt>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>ReadableStream</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=kr>async</span> <span class=nx>pull</span><span class=p>(</span><span class=nx>controller</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kr>const</span> <span class=p>{</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>done</span> <span class=p>}</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>iterator</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nx>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>controller</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>controller</span><span class=p>.</span><span class=nx>enqueue</span><span class=p>(</span><span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>sleep</span><span class=p>(</span><span class=nx>time</span>: <span class=kt>number</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Promise</span><span class=p>(</span><span class=nx>resolve</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>setTimeout</span><span class=p>(</span><span class=nx>resolve</span><span class=p>,</span> <span class=nx>time</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>encoder</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TextEncoder</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kr>async</span> <span class=kd>function</span><span class=o>*</span> <span class=nx>makeIterator() {</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=nx>encoder</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=s1>&#39;&lt;p&gt;One&lt;/p&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>sleep</span><span class=p>(</span><span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=nx>encoder</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=s1>&#39;&lt;p&gt;Two&lt;/p&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>await</span> <span class=nx>sleep</span><span class=p>(</span><span class=mi>200</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>yield</span> <span class=nx>encoder</span><span class=p>.</span><span class=nx>encode</span><span class=p>(</span><span class=s1>&#39;&lt;p&gt;Three&lt;/p&gt;&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET() {</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>iterator</span> <span class=o>=</span> <span class=nx>makeIterator</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>stream</span> <span class=o>=</span> <span class=nx>iteratorToStream</span><span class=p>(</span><span class=nx>iterator</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=nx>stream</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>读取请求体：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// 读取 json
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>request</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>res</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=c1>// 读取 formData
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>POST</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>formData</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>request</span><span class=p>.</span><span class=nx>formData</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>name</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;name&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>email</span> <span class=o>=</span> <span class=nx>formData</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;email&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>json</span><span class=p>({</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>email</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>响应跨域配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span><span class=s1>&#39;Hello, Next.js!&#39;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>status</span>: <span class=kt>200</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=o>:</span> <span class=s1>&#39;*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Access-Control-Allow-Methods&#39;</span><span class=o>:</span> <span class=s1>&#39;GET, POST, PUT, DELETE, OPTIONS&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s1>&#39;Access-Control-Allow-Headers&#39;</span><span class=o>:</span> <span class=s1>&#39;Content-Type, Authorization&#39;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>响应 UI 无关的内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>GET() {</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=k>new</span> <span class=nx>Response</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=sb>`
</span></span></span><span class=line><span class=cl><span class=sb>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;
</span></span></span><span class=line><span class=cl><span class=sb>&lt;rss version=&#34;2.0&#34;&gt;
</span></span></span><span class=line><span class=cl><span class=sb>  &lt;channel&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    &lt;title&gt;Next.js Documentation&lt;/title&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    &lt;link&gt;https://nextjs.org/docs&lt;/link&gt;
</span></span></span><span class=line><span class=cl><span class=sb>    &lt;description&gt;The React Framework for the Web&lt;/description&gt;
</span></span></span><span class=line><span class=cl><span class=sb>  &lt;/channel&gt;
</span></span></span><span class=line><span class=cl><span class=sb>&lt;/rss&gt;`</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;Content-Type&#39;</span><span class=o>:</span> <span class=s1>&#39;text/xml&#39;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=中间件>中间件</h2><p>中间件目前仅支持 <a class=link href=https://edge-runtime.vercel.app target=_blank rel=noopener>Edge
</a>运行时，暂不支持 Node；不过已经提上<a class=link href=https://github.com/vercel/next.js/discussions/71727 target=_blank rel=noopener>
日程
</a>了。</p><p>中间件会在请求完成之前运行一些逻辑；通过中间件，可以完成重定向、头部信息修改等；他的运行时机发生在缓存和路由匹配之前。</p><p>使用场景：</p><ul><li>用户验证与授权，确认用户身份，在访问资源之前，验证是否有对应权限；</li><li>服务器端重定向；</li><li>路径重写；</li><li>机器人检测，阻止机器人访问；</li><li>日志或数据分析；</li><li>功能标记。</li></ul><p>不适用场景：</p><ul><li>复杂数据的获取和修改；</li><li>复杂计算任务，会导致页面加载延迟；</li><li>会话管理；</li><li>数据库操作。</li></ul><p>每个 Next.js 项目只有一个 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/middleware target=_blank rel=noopener>middleware.ts
</a>作为中间件的入口（当然，你可分为多个文件，然后导入主文件中）。</p><p>调用时机：</p><ol><li>next.config.js 中的 headers 配置；</li><li>next.config.js 中的 redirects 配置；</li><li><strong>中间件</strong>；</li><li>next.config.js 中的 beforeFiles 配置；</li><li>文件系统路由；</li><li>next.config.js 中的 afterFiles 配置；</li><li>动态路由；</li><li>next.config.js 中的 fallback 配置。</li></ol><p>可以通过 Matcher 或者条件语句来决定中间件运行在哪个路由上：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>   * NextResponse 可以用来：
</span></span></span><span class=line><span class=cl><span class=cm>   * redirect
</span></span></span><span class=line><span class=cl><span class=cm>   * rewrite
</span></span></span><span class=line><span class=cl><span class=cm>   * 设置请求头
</span></span></span><span class=line><span class=cl><span class=cm>   * 设置响应头
</span></span></span><span class=line><span class=cl><span class=cm>   * 设置 cookie
</span></span></span><span class=line><span class=cl><span class=cm>   */</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;/home&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 如果没有，那么每个路由都会调用中间件
</span></span></span><span class=line><span class=cl><span class=cm> * 需要是常量，可以被静态分析
</span></span></span><span class=line><span class=cl><span class=cm> * 必须以 / 开头
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=s1>&#39;/about/:path*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;/about/:path&#39;</span><span class=p>,</span> <span class=c1>// 匹配 /about/a、/about/b
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;/about/:path*&#39;</span><span class=p>,</span> <span class=c1>// 匹配 /about/a、/about/b、/about/a/b/c
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s1>&#39;/dashboard/:path*&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span><span class=o>:</span> <span class=s1>&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>missing</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;next-router-prefetch&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;purpose&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=s1>&#39;prefetch&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span><span class=o>:</span> <span class=s1>&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>has</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;next-router-prefetch&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;purpose&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=s1>&#39;prefetch&#39;</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span><span class=o>:</span> <span class=s1>&#39;/((?!api|_next/static|_next/image|favicon.ico).*)&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>has</span><span class=o>:</span> <span class=p>[{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;x-present&#39;</span> <span class=p>}],</span>
</span></span><span class=line><span class=cl>      <span class=nx>missing</span><span class=o>:</span> <span class=p>[{</span> <span class=kr>type</span><span class=o>:</span> <span class=s1>&#39;header&#39;</span><span class=p>,</span> <span class=nx>key</span><span class=o>:</span> <span class=s1>&#39;x-missing&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=s1>&#39;prefetch&#39;</span> <span class=p>}]</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=c1>// 使用条件判断
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>pathname</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;/about&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>rewrite</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;/about-2&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>pathname</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s1>&#39;/dashboard&#39;</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>rewrite</span><span class=p>(</span><span class=k>new</span> <span class=nx>URL</span><span class=p>(</span><span class=s1>&#39;/dashboard/user&#39;</span><span class=p>,</span> <span class=nx>request</span><span class=p>.</span><span class=nx>url</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>读取/设置 cookie：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 cookie 中的值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kd>let</span> <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;nextjs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>cookie</span><span class=p>);</span> <span class=c1>// { name: &#39;nextjs&#39;, value: &#39;fast&#39;, Path: &#39;/&#39; }
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>allCookies</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=nx>getAll</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>allCookies</span><span class=p>);</span> <span class=c1>// [{ name: &#39;nextjs&#39;, value: &#39;fast&#39; }]
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=s1>&#39;nextjs&#39;</span><span class=p>);</span> <span class=c1>// true
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=k>delete</span><span class=p>(</span><span class=s1>&#39;nextjs&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>request</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=nx>has</span><span class=p>(</span><span class=s1>&#39;nextjs&#39;</span><span class=p>);</span> <span class=c1>// false
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 设置 cookie 中的值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=s1>&#39;vercel&#39;</span><span class=p>,</span> <span class=s1>&#39;fast&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=kr>set</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>name</span><span class=o>:</span> <span class=s1>&#39;vercel&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>value</span><span class=o>:</span> <span class=s1>&#39;fast&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>path</span><span class=o>:</span> <span class=s1>&#39;/&#39;</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>cookie</span> <span class=o>=</span> <span class=nx>response</span><span class=p>.</span><span class=nx>cookies</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;vercel&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>cookie</span><span class=p>);</span> <span class=c1>// { name: &#39;vercel&#39;, value: &#39;fast&#39;, Path: &#39;/&#39; }
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 响应头中就会有 Set-Cookie:vercel=fast;path=/
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>设置头部：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 修改之前，先 new 一份儿
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>requestHeaders</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Headers</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>requestHeaders</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=s1>&#39;x-hello-from-middleware1&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置新的响应头部信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>({</span>
</span></span><span class=line><span class=cl>    <span class=nx>request</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>headers</span>: <span class=kt>requestHeaders</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=s1>&#39;x-hello-from-middleware2&#39;</span><span class=p>,</span> <span class=s1>&#39;hello&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>配置 CROS：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextRequest</span><span class=p>,</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>allowedOrigins</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;https://acme.com&#39;</span><span class=p>,</span> <span class=s1>&#39;https://my-app.org&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>corsOptions</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;Access-Control-Allow-Methods&#39;</span><span class=o>:</span> <span class=s1>&#39;GET, POST, PUT, DELETE, OPTIONS&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s1>&#39;Access-Control-Allow-Headers&#39;</span><span class=o>:</span> <span class=s1>&#39;Content-Type, Authorization&#39;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取原始请求头中的 origin 字段
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>origin</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;origin&#39;</span><span class=p>)</span> <span class=o>??</span> <span class=s1>&#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>isAllowedOrigin</span> <span class=o>=</span> <span class=nx>allowedOrigins</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=nx>origin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 判断是不是预请求
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>isPreflight</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>method</span> <span class=o>===</span> <span class=s1>&#39;OPTIONS&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isPreflight</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>preflightHeaders</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>...(</span><span class=nx>isAllowedOrigin</span> <span class=o>&amp;&amp;</span> <span class=p>{</span> <span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=o>:</span> <span class=nx>origin</span> <span class=p>}),</span>
</span></span><span class=line><span class=cl>      <span class=p>...</span><span class=nx>corsOptions</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>json</span><span class=p>({},</span> <span class=p>{</span> <span class=nx>headers</span>: <span class=kt>preflightHeaders</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 如果不是预请求
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>response</span> <span class=o>=</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>isAllowedOrigin</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=s1>&#39;Access-Control-Allow-Origin&#39;</span><span class=p>,</span> <span class=nx>origin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nb>Object</span><span class=p>.</span><span class=nx>entries</span><span class=p>(</span><span class=nx>corsOptions</span><span class=p>).</span><span class=nx>forEach</span><span class=p>(([</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>response</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>response</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=s1>&#39;/api/:path*&#39;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>响应请求：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=kr>type</span> <span class=p>{</span> <span class=nx>NextRequest</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>isAuthenticated</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@lib/auth&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span>: <span class=kt>NextRequest</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>isAuthenticated</span><span class=p>(</span><span class=nx>request</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>Response</span><span class=p>.</span><span class=nx>json</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>success</span>: <span class=kt>false</span><span class=p>,</span> <span class=nx>message</span><span class=o>:</span> <span class=s1>&#39;authentication failed&#39;</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=nx>status</span>: <span class=kt>401</span> <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=s1>&#39;/api/:function*&#39;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=国际化>国际化</h2><p>可以通过头部信息 Accept-Language 获取浏览器语言设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>match</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@formatjs/intl-localematcher&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=nx>Negotiator</span> <span class=kr>from</span> <span class=s1>&#39;negotiator&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>headers</span> <span class=o>=</span> <span class=p>{</span> <span class=s1>&#39;accept-language&#39;</span><span class=o>:</span> <span class=s1>&#39;en-US,en;q=0.5&#39;</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>languages</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Negotiator</span><span class=p>({</span> <span class=nx>headers</span> <span class=p>}).</span><span class=nx>languages</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>locales</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;en-US&#39;</span><span class=p>,</span> <span class=s1>&#39;nl-NL&#39;</span><span class=p>,</span> <span class=s1>&#39;nl&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>defaultLocale</span> <span class=o>=</span> <span class=s1>&#39;en-US&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nx>match</span><span class=p>(</span><span class=nx>languages</span><span class=p>,</span> <span class=nx>locales</span><span class=p>,</span> <span class=nx>defaultLocale</span><span class=p>);</span> <span class=c1>// &#39;en-US&#39;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>import</span> <span class=p>{</span> <span class=nx>NextResponse</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;next/server&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kd>let</span> <span class=nx>locales</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;en-US&#39;</span><span class=p>,</span> <span class=s1>&#39;nl-NL&#39;</span><span class=p>,</span> <span class=s1>&#39;nl&#39;</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>getLocale</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>middleware</span><span class=p>(</span><span class=nx>request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 检查 pathname 中是否有支持的 local
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=p>{</span> <span class=nx>pathname</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>pathnameHasLocale</span> <span class=o>=</span> <span class=nx>locales</span><span class=p>.</span><span class=nx>some</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>locale</span> <span class=o>=&gt;</span> <span class=nx>pathname</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=sb>`/</span><span class=si>${</span><span class=nx>locale</span><span class=si>}</span><span class=sb>/`</span><span class=p>)</span> <span class=o>||</span> <span class=nx>pathname</span> <span class=o>===</span> <span class=sb>`/</span><span class=si>${</span><span class=nx>locale</span><span class=si>}</span><span class=sb>`</span>
</span></span><span class=line><span class=cl>  <span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>pathnameHasLocale</span><span class=p>)</span> <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 没有就重定向
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>const</span> <span class=nx>locale</span> <span class=o>=</span> <span class=nx>getLocale</span><span class=p>(</span><span class=nx>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>.</span><span class=nx>pathname</span> <span class=o>=</span> <span class=sb>`/</span><span class=si>${</span><span class=nx>locale</span><span class=si>}${</span><span class=nx>pathname</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// /products 2 /en-US/products
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>NextResponse</span><span class=p>.</span><span class=nx>redirect</span><span class=p>(</span><span class=nx>request</span><span class=p>.</span><span class=nx>nextUrl</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>config</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>matcher</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;/((?!_next).*)&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></td></tr></table></div></div><p>最后，在 <a class=link href=https://nextjs.org/docs/app/api-reference/file-conventions/page target=_blank rel=noopener>page.tsx
</a>中获取语言：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tsx data-lang=tsx><span class=line><span class=cl><span class=c1>// app/[lang]/dictionaries.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=s1>&#39;server-only&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>dictionaries</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 动态获取语言文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>en</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;./dictionaries/en.json&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>module</span> <span class=o>=&gt;</span> <span class=nx>module</span><span class=p>.</span><span class=k>default</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=nx>nl</span><span class=o>:</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=kr>import</span><span class=p>(</span><span class=s1>&#39;./dictionaries/nl.json&#39;</span><span class=p>).</span><span class=nx>then</span><span class=p>(</span><span class=nx>module</span> <span class=o>=&gt;</span> <span class=nx>module</span><span class=p>.</span><span class=k>default</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>const</span> <span class=nx>getDictionary</span> <span class=o>=</span> <span class=kr>async</span> <span class=nx>locale</span> <span class=o>=&gt;</span> <span class=nx>dictionaries</span><span class=p>[</span><span class=nx>locale</span><span class=p>]();</span>
</span></span><span class=line><span class=cl><span class=c1>// app/[lang]/page.js
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>getDictionary</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;./dictionaries&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=kr>async</span> <span class=kd>function</span> <span class=nx>Page</span><span class=p>({</span> <span class=nx>params</span><span class=o>:</span> <span class=p>{</span> <span class=nx>lang</span> <span class=p>}</span> <span class=p>})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>dict</span> <span class=o>=</span> <span class=k>await</span> <span class=nx>getDictionary</span><span class=p>(</span><span class=nx>lang</span><span class=p>);</span> <span class=c1>// en
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>&lt;</span><span class=nt>button</span><span class=p>&gt;{</span><span class=nx>dict</span><span class=p>.</span><span class=nx>products</span><span class=p>.</span><span class=nx>cart</span><span class=p>}&lt;/</span><span class=nt>button</span><span class=p>&gt;;</span> <span class=c1>// Add to Cart
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/next.js-%E4%B9%8B-auth.js/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 Auth.js</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-optimizations/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 Optimizations</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-datafetching/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 DataFetching</h2></div></a></article><article class=has-image><a href=/p/next.js-%E4%B9%8B-rendering-%E4%B8%8E-caching/><div class=article-image><img src=/img/cover/nextjs.png loading=lazy data-key data-hash=/img/cover/nextjs.png></div><div class=article-details><h2 class=article-title>Next.js 之 Rendering 与 Caching</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2025
<a href=https://github.com/ElementRef target=_blank>馬腊咯稽</a></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>, Deploy by Actions<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#路由相关特殊文件>路由相关（特殊）文件</a></li><li><a href=#路由的嵌套表现为组件的嵌套>路由的嵌套表现为组件的嵌套</a></li><li><a href=#路由导航有四种方式>路由导航有四种方式</a></li><li><a href=#部分渲染>部分渲染</a></li><li><a href=#错误处理>错误处理</a></li><li><a href=#流式渲染>流式渲染</a></li><li><a href=#重定向>重定向</a></li><li><a href=#路由组>路由组</a></li><li><a href=#私有目录>私有目录</a></li><li><a href=#动态路由>动态路由</a></li><li><a href=#并行路由>并行路由</a></li><li><a href=#路由拦截>路由拦截</a></li><li><a href=#路由处理程序>路由处理程序</a></li><li><a href=#中间件>中间件</a></li><li><a href=#国际化>国际化</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script src=https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>