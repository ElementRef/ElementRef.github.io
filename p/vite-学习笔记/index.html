<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="Vite 内部有两套实现：
开发环境下，借助 esbuild 和预打包缓存实现快速的 HMR： 首次启动时，esbuild 会将 node_modules 下的依赖进行预打包并缓存在 .vite 目录； 对 node_modules 下的依赖配置强缓存，对项目代码配置协商缓存； 只编译当前页面需要的依赖和项目代码； 不管兼容性问题，无需代码降级转换。 生产环境下，借助 Rollup 打包，输出优化后的文件： 需要 tree-shaking、懒加载、代码分割、缓存配置来实现更好的访问速度； 不是所有的环境都升级到了 HTTP/2|3，不优化可能会产生大量请求； 可以借助插件对更多资源（CSS|SVG|IMAGE）做针对性处理； 需要解决产物的兼容性问题，例如客户端较低版本的浏览器。 为什么是 Vite Vite 主要解决了项目启动慢、HMR 慢的问题；但是宣传上比较讨巧，实际上项目第一次启动时，会预打包并将结果缓存；HMR 也是借助了 ESM 的特性，只转换不打包。
"><title>Vite 学习笔记 · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/vite-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><link rel="stylesheet" href="/scss/style.min.71af184584791a9daf2008fabd318cb741ad5c3fc04b7c5ca044dbbc69190e9b.css"><meta property="og:title" content="Vite 学习笔记"><meta property="og:description" content="Vite 内部有两套实现：
开发环境下，借助 esbuild 和预打包缓存实现快速的 HMR： 首次启动时，esbuild 会将 node_modules 下的依赖进行预打包并缓存在 .vite 目录； 对 node_modules 下的依赖配置强缓存，对项目代码配置协商缓存； 只编译当前页面需要的依赖和项目代码； 不管兼容性问题，无需代码降级转换。 生产环境下，借助 Rollup 打包，输出优化后的文件： 需要 tree-shaking、懒加载、代码分割、缓存配置来实现更好的访问速度； 不是所有的环境都升级到了 HTTP/2|3，不优化可能会产生大量请求； 可以借助插件对更多资源（CSS|SVG|IMAGE）做针对性处理； 需要解决产物的兼容性问题，例如客户端较低版本的浏览器。 为什么是 Vite Vite 主要解决了项目启动慢、HMR 慢的问题；但是宣传上比较讨巧，实际上项目第一次启动时，会预打包并将结果缓存；HMR 也是借助了 ESM 的特性，只转换不打包。
"><meta property="og:url" content="https://ElementRef.github.io/p/vite-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2024-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-29T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/vite.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="Vite 学习笔记"><meta name="twitter:description" content="Vite 内部有两套实现：
开发环境下，借助 esbuild 和预打包缓存实现快速的 HMR： 首次启动时，esbuild 会将 node_modules 下的依赖进行预打包并缓存在 .vite 目录； 对 node_modules 下的依赖配置强缓存，对项目代码配置协商缓存； 只编译当前页面需要的依赖和项目代码； 不管兼容性问题，无需代码降级转换。 生产环境下，借助 Rollup 打包，输出优化后的文件： 需要 tree-shaking、懒加载、代码分割、缓存配置来实现更好的访问速度； 不是所有的环境都升级到了 HTTP/2|3，不优化可能会产生大量请求； 可以借助插件对更多资源（CSS|SVG|IMAGE）做针对性处理； 需要解决产物的兼容性问题，例如客户端较低版本的浏览器。 为什么是 Vite Vite 主要解决了项目启动慢、HMR 慢的问题；但是宣传上比较讨巧，实际上项目第一次启动时，会预打包并将结果缓存；HMR 也是借助了 ESM 的特性，只转换不打包。
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/vite.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta name="robots" content="noarchive, noindex, nofollow"><meta name="theme-color" content="#ffffff"><script defer="" src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2"></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container extended flex main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu7590466716559688570.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://space.bilibili.com/593541941" target="_blank" title="Bilibili"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M3 10a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7a4 4 0 01-4-4v-6z"></path><path d="M8 3l2 3"></path><path d="M16 3l-2 3"></path><path d="M9 13v-2"></path><path d="M15 11v2"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/vite-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><img src="/img/cover/vite.webp" alt="Vite 学习笔记" fetchpriority="high" decoding="async" width="2600" height="1407" jampack-sized="true" srcset="/img/cover/vite.webp 2600w, /img/cover/vite@1400w.webp 1400w, /img/cover/vite@1100w.webp 1100w, /img/cover/vite@800w.webp 800w" sizes="100vw"></a></div><div class="article-details"><header class="article-category"><a href="/categories/vite/">Vite</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/vite-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">Vite 学习笔记</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Oct 29, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：16 分钟</time></div></footer></div></header><section class="article-content"><p>Vite 内部有两套实现：</p><ul><li>开发环境下，借助 esbuild 和预打包缓存实现快速的 HMR：<ul><li>首次启动时，esbuild 会将 node_modules 下的依赖进行预打包并缓存在 .vite 目录；</li><li>对 node_modules 下的依赖配置强缓存，对项目代码配置协商缓存；</li><li>只编译当前页面需要的依赖和项目代码；</li><li>不管兼容性问题，无需代码降级转换。</li></ul></li><li>生产环境下，借助 Rollup 打包，输出优化后的文件：<ul><li>需要 tree-shaking、懒加载、代码分割、缓存配置来实现更好的访问速度；</li><li>不是所有的环境都升级到了 HTTP/2|3，不优化可能会产生大量请求；</li><li>可以借助插件对更多资源（CSS|SVG|IMAGE）做针对性处理；</li><li>需要解决产物的兼容性问题，例如客户端较低版本的浏览器。</li></ul></li></ul><h2 id="为什么是-vite">为什么是 Vite</h2><p>Vite 主要解决了项目启动慢、HMR 慢的问题；但是宣传上比较讨巧，实际上项目第一次启动时，会预打包并将结果缓存；HMR 也是借助了 ESM 的特性，只转换不打包。</p><p>在开发环境，相较于 Webpack，改变了运行策略；将<strong>先编译后运行服务</strong>变为了<strong>先运行服务后编译</strong>；模块之间的依赖解析工作交给了浏览器，Vite 只负责按需“编译”。所以，他提升了部分开发体验，而对生产环境的打包速度并没有质的提升。</p><p>为什么说是“部分”呢？因为如果页面依赖众多，还是会有可感知的“白屏”。这可能是因为 esbuild 还不够快？也可能是复杂项目的渲染触发了过多的 HTTP 请求，达到了浏览器的并发限制。可以看看<a class="link" href="https://moonvy.com/blog/post/2024/migrate-vite-to-rsbuild" target="_blank" rel="noopener">
这篇文章
</a>和<a class="link" href="https://github.com/vitejs/vite/discussions/13697" target="_blank" rel="noopener">
相关 issue
</a>。</p><h2 id="功能">功能</h2><h3 id="预构建">预构建</h3><p>在项目第一次启动时，Vite 通过 esbuild 对 node_modules 下的依赖进行预打包，将 CJS|UMD 规范的包转换为 ESM 规范；然后解析页面引用，将：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">someMethod</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'my-dep'</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>转换为浏览器能解析的代码，发送给浏览器。</p><h3 id="热替换">热替换</h3><p>Vite 提供了一套适用于 ESM 的 <a class="link" href="https://cn.vitejs.dev/guide/api-hmr.html" target="_blank" rel="noopener">HMR API
</a>，可以实现精准的 HMR。Vite 已经集成了 <a class="link" href="https://github.com/vitejs/vite-plugin-vue/tree/main/packages/plugin-vue" target="_blank" rel="noopener">Vue
</a>、<a class="link" href="https://github.com/vitejs/vite-plugin-react/tree/main/packages/plugin-react" target="_blank" rel="noopener">
React
</a>的 HMR 方案。</p><h3 id="typescript">TypeScript</h3><p>Vite 对 TS 文件进行转换而不进行类型检查，它希望类型检查由 IDE 完成。因为类型检查需要解析整个项目的依赖关系，和 Vite 的按需编译模式不匹配。</p><p>如果需要进行类型检查，可以借助 tsc --noEmit，或者借助 <a class="link" href="https://github.com/fi3ework/vite-plugin-checker" target="_blank" rel="noopener">vite-plugin-checker
</a>插件。</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">someType</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'someModule'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="p">{</span> <span class="nx">someType</span> <span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>这段代码在 Vite 下可能不会正常工作，因为 someType 仅仅是一个类型；所以最好采用下边这种写法：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">someType</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'someModule'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">someType</span> <span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>import|export type 是 TS 在 3.8 引入的语法，用来确保导入导出的仅仅是类型，可以在编译时去掉。</p><p>Vite 建议使用以下 compilerOptions：</p><ul><li>isolatedModules:true<ul><li>除了 tsc，其他编译工具在编译 TS 时，都不会有类型系统的介入；</li><li>如果第三方依赖不兼容这个选项，可是使用 skipLibCheck:true；</li><li>这个选项用来保证，每个文件都可以被单独编译。</li></ul></li><li>useDefineForClassFields<ul><li>target:ESNext|ES2022+ 时，应为 true；</li><li>target 为其他版本时，应为 false。</li></ul></li><li>target<ul><li>Vite 会忽略这项设置，而读取 esbuild.target；</li><li>可以在 vite.config 中配置 esbuild.target。</li></ul></li><li>types:[“vite/client”] 可以为编辑器提供以下类型提示：<ul><li>import.meta.env；</li><li>import.meta.hot；</li><li>资源导入。</li></ul></li></ul><h3 id="glob-导入">Glob 导入</h3><p>Vite 扩展（不属于 ES 标准）了 import.meta，用来从文件系统中导入多个模块：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">(</span><span class="s1">'./dir/*.js'</span><span class="p">);</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>默认会被转换为异步导入：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s1">'./dir/foo.js'</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kr">import</span><span class="p">(</span><span class="s1">'./dir/foo.js'</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">  <span class="s1">'./dir/bar.js'</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kr">import</span><span class="p">(</span><span class="s1">'./dir/bar.js'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>如果需要转换为同步导入，传入第二个参数即可：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">(</span><span class="s1">'./dir/*.js'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">eager</span>: <span class="kt">true</span> <span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>会被转换为同步导入：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">__glob__0_0</span> <span class="kr">from</span> <span class="s1">'./dir/foo.js'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="o">*</span> <span class="kr">as</span> <span class="nx">__glob__0_1</span> <span class="kr">from</span> <span class="s1">'./dir/bar.js'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s1">'./dir/foo.js'</span><span class="o">:</span> <span class="nx">__glob__0_0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">'./dir/bar.js'</span><span class="o">:</span> <span class="nx">__glob__0_1</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>可以通过遍历 modules 拿到对应的模块：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">modules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">modules</span><span class="p">[</span><span class="nx">path</span><span class="p">]().</span><span class="nx">then</span><span class="p">(</span><span class="nx">mod</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>import.meta.glob 也支持更多导入模式：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 导入多个目录下的模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">([</span><span class="s1">'./dir/*.js'</span><span class="p">,</span> <span class="s1">'./another/*.js'</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 不导入 ./dir/bar.js
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">([</span><span class="s1">'./dir/*.js'</span><span class="p">,</span> <span class="s1">'!**/bar.js'</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 导入模块内的部分内容，仅导入 setup 变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">(</span><span class="s1">'./dir/*.js'</span><span class="p">,</span> <span class="p">{</span> <span class="kr">import</span><span class="o">:</span> <span class="s1">'setup'</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 仅导入默认导出的变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">modules</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">(</span><span class="s1">'./dir/*.js'</span><span class="p">,</span> <span class="p">{</span> <span class="kr">import</span><span class="o">:</span> <span class="s1">'default'</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 将模块作为字符串导入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">const</span> <span class="nx">moduleStrings</span> <span class="o">=</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">glob</span><span class="p">(</span><span class="s1">'./dir/*.svg'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">query</span><span class="o">:</span> <span class="s1">'?raw'</span> <span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="缓存">缓存</h2><p>Vite 会基于以下条件来判断是否要重新进行预打包：</p><ol><li>包管理器依赖锁：package-lock.json，yarn.lock，pnpm-lock.yaml；</li><li>patch 文件夹的修改时间；</li><li>vite.config.js 文件配置；</li><li>NODE_ENV 的值；</li><li>--force 参数。</li></ol><h2 id="静态资源">静态资源</h2><p>Vite 对静态资源的处理就像是 file-loader：</p><ul><li>模块中引入的静态资源，根据 assetsInlineLimit 配置，在构建后被移动到资源目录，或是被 base64 处理；</li><li>如果有引入不常见的静态资源，可以在 assetsInclude 中配置；</li><li>静态资源在打包后，也会以 hash 值命名。</li></ul><p>文件被导入的时候，可以通过 ?url、?raw、?worker 来声明资源导入方式：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 作为一个 url 导入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">workletURL</span> <span class="kr">from</span> <span class="s1">'extra-scalloped-border/worklet.js?url'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 作为字符串导入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">shaderString</span> <span class="kr">from</span> <span class="s1">'./shader.glsl?raw'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 作为 WebWorker 导入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="nx">Worker</span> <span class="kr">from</span> <span class="s1">'./shader.js?worker'</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>特别的，public 目录下的资源应该符合以下特点：</p><ul><li>打包后名称不会改变；</li><li>没有被模块引入。</li></ul><p>import.meta.url 属于 ESM 规范，返回值为当前模块的绝对路径：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">imgUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="s1">'./img.png'</span><span class="p">,</span> <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">href</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'hero-img'</span><span class="p">).</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">imgUrl</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但是，如果 build.target 不支持 import.meta.url，构建将会失败；同时，也不应该在为 SSR 打包的情况下使用，因为服务器和浏览器的语意不同。</p><h2 id="打包">打包</h2><p>Vite 默认的打包产物仅支持兼容 ESM 规范的浏览器：</p><ul><li>Chrome &gt;= 87</li><li>Firefox &gt;= 78</li><li>Safari &gt;= 14</li><li>Edge &gt;= 88</li></ul><p>可以通过 build.target 指定构建目标，最低为 es2015。如果要兼容更低版本的浏览器，需要使用<a class="link" href="https://github.com/vitejs/vite/tree/main/packages/plugin-legacy" target="_blank" rel="noopener">
@vitejs/plugin-legacy
</a>。</p><p>如果需要自定义构建，可以配置 build.rollupOptions；如果需要自定义分包，可以配置 build.rollupOptions.output.manualChunks。</p><h3 id="处理加载出错">处理加载出错</h3><p>当应用重新部署时，服务器可能会将之前的构建产物删除，导致用户电脑上未关闭的页面报错；我们可以监听 vite:preloadError 事件，来刷新页面：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'vite:preloadError'</span><span class="p">,</span> <span class="nx">event</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();</span> <span class="c1">// 刷新页面
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="库打包">库打包</h3><p>如果要给组件库打包，需要配置 build.lib：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">resolve</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'path'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">build</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lib</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 单入口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">entry</span>: <span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'lib/main.js'</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 多入口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">entry</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'my-lib'</span><span class="o">:</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'lib/main.js'</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secondary</span>: <span class="kt">resolve</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'lib/secondary.js'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">name</span><span class="o">:</span> <span class="s1">'MyLib'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 将添加适当的扩展名后缀
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">fileName</span><span class="o">:</span> <span class="s1">'my-lib'</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rollupOptions</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 你不想打包进库的依赖，例如 peerDependencies
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">external</span><span class="o">:</span> <span class="p">[</span><span class="s1">'vue'</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 在 UMD 构建模式下为这些外部化的依赖，提供一个全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">globals</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">vue</span><span class="o">:</span> <span class="s1">'Vue'</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>还需要配置对应的 package.json：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"my-lib"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果不包含 "type":"module"
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Vite 会生成不同的文件后缀名以兼容 Node.js
</span></span></span><span class="line"><span class="cl"><span class="cm">   * .js 会变为 .mjs 而 .cjs 会变为 .js
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"module"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"files"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"dist"</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"main"</span><span class="o">:</span> <span class="s2">"./dist/my-lib.cjs"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"module"</span><span class="o">:</span> <span class="s2">"./dist/my-lib.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s2">"exports"</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"."</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"import"</span><span class="o">:</span> <span class="s2">"./dist/my-lib.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"require"</span><span class="o">:</span> <span class="s2">"./dist/my-lib.cjs"</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">"./secondary"</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"import"</span><span class="o">:</span> <span class="s2">"./dist/secondary.js"</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">"require"</span><span class="o">:</span> <span class="s2">"./dist/secondary.cjs"</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>注意：在库模式中，所有 import.meta.env._ 都会在构建时被<strong>静态替换</strong>；但是，process.env._ <strong>不会</strong>。</p><h2 id="环境变量">环境变量</h2><p>Vite 在 import.meta.env 上暴露了一些环境变量，会在编译时被静态替换掉：</p><ul><li>import.meta.env.MODE，运行的模式（development|production），可以通过 --mode 指定为别的值，比如 staging；</li><li>import.meta.env.BASE_URL，部署应用时的 base 路径；</li><li>import.meta.env.PROD，是否运行在生产环境；</li><li>import.meta.env.DEV，是否运行在开发环境；</li><li>import.meta.env.SSR，是否运行在 server 上。</li></ul><p>Vite 会使用 dotenv 从项目目录中加载 .env 文件：</p><ul><li>.env，所有情况下都会加载；</li><li>.env.local，所有情况下都会加载，但会被 git 忽略；</li><li>.env.[mode]，只在指定模式下加载；</li><li>.env.[mode].local，只在指定模式下加载，但会被 git 忽略。</li></ul><p>.env 中的内容会通过 import.meta.env 暴露：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">VITE_SOME_KEY=123</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">DB_PASSWORD=foobar</span><span class="w">
</span></span></span></code></pre></td></tr></tbody></table></div></div><p>默认情况下，Vite 仅会暴露以 VITE_开头的属性：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * VITE_SOME_KEY 在被定义时，是 number 类型
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 实际被解析为了字符串，boolean 类型也一样
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 要注意类型转换
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">VITE_SOME_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DB_PASSWORD</span><span class="p">);</span> <span class="c1">// undefined
</span></span></span></code></pre></td></tr></tbody></table></div></div><p>如果要在 .env 文件中使用 $，要进行转译：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">KEY=123</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NEW_KEY1=test$foo  </span><span class="w"> </span><span class="c"># test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NEW_KEY2=test$KEY  </span><span class="w"> </span><span class="c"># test123</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NEW_KEY3=test\$foo </span><span class="w"> </span><span class="c"># test$foo</span><span class="w">
</span></span></span></code></pre></td></tr></tbody></table></div></div><h3 id="类型提示">类型提示</h3><p>如果要使得 .env 中的变量有类型提示，需要在 src 目录下创建 vite-env.d.ts 文件并增加 ImportMetaEnv 定义：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">/// &lt;reference types="vite/client" /&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ImportMetaEnv</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">readonly</span> <span class="nx">VITE_APP_TITLE</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 更多环境变量...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">ImportMeta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">readonly</span> <span class="nx">env</span>: <span class="kt">ImportMetaEnv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="在-html-中使用">在 HTML 中使用</h3><p>import.meta.env 中的任何属性都可以通过特殊的 %ENV_NAME% 语法在 HTML 文件中使用：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">h1</span> <span class="na">alt</span><span class="o">=</span><span class="s">"如果 import.meta.env.MODE 不存在，将不会替换"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  Vite is running in %MODE%
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">p</span> <span class="na">alt</span><span class="o">=</span><span class="s">"在 JS 中，则不同，将会按 undefined 处理"</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  Using data from %VITE_API_URL%
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="node_env">NODE_ENV</h3><p>import.meta.env.mode 和 process.env.NODE_ENV 是两个不同的东西；import.meta.env.mode 是由运行 Vite 时，指定的 mode 决定的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vite build                     <span class="c1"># import.meta.env.mode 为 production</span>
</span></span><span class="line"><span class="cl">vite build --mode development  <span class="c1"># import.meta.env.mode 为 development</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>而 process.env.NODE_ENV 是由运行命令时，指定的 NODE_ENV 决定的：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vite build --mode development                      <span class="c1"># NODE_ENV 为 production</span>
</span></span><span class="line"><span class="cl"><span class="nv">NODE_ENV</span><span class="o">=</span>development vite build --mode development <span class="c1"># NODE_ENV 为 development</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>但是 NODE_ENV 和 import.meta.env.PROD ｜ import.meta.env.DEV 有关：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">vite build --mode development                      <span class="c1"># import.meta.env.PROD 为 true</span>
</span></span><span class="line"><span class="cl"><span class="nv">NODE_ENV</span><span class="o">=</span>development vite build --mode development <span class="c1"># import.meta.env.PROD 为 false</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="插件">插件</h2><p>如果要写插件，推荐使用 <a class="link" href="https://github.com/antfu/vite-plugin-inspect" target="_blank" rel="noopener">vite-plugin-inspect
</a>，可以帮助调试插件。</p><h3 id="约定">约定</h3><p>如果要开发<strong>兼容 Rollup</strong> 的插件，插件名称请以 rollup-plugin- 作为前缀；如果要开发<strong>Vite 独有</strong> 的插件，插件名称请以 vite-plugin- 作为前缀。</p><p>如果插件仅适用于某些框架，应该遵循以下前缀：</p><ul><li>vite-plugin-svelte- 前缀作为 Svelte 插件；</li><li>vite-plugin-react- 前缀作为 React 插件；</li><li>vite-plugin-vue- 前缀作为 Vue 插件。</li></ul><p>Vite 插件一般为一个返回实际插件对象的工厂函数；插件的逻辑调用主要被放在了钩子函数中，Vite 会在合适的时候调用这些钩子；文档上列举了一些通用钩子函数：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">Plugin</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">example</span><span class="p">()</span><span class="o">:</span> <span class="nx">Plugin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">'vite-plugin-example'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Vite 启动时调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">options() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">buildStart() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 模块请求时调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">resolveId() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">load() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">transform() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Vite 退出时调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">buildEnd() {</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">closeBundle() {</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>Vite 还提供了一些独有的钩子函数：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">Plugin</span><span class="p">,</span> <span class="nx">UserConfig</span><span class="p">,</span> <span class="nx">ResolvedConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">example</span><span class="p">()</span><span class="o">:</span> <span class="nx">Plugin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果不指明 apply
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 开发和构建过程中都会调用
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">apply</span><span class="o">:</span> <span class="s1">'build'</span><span class="p">,</span> <span class="c1">// 或 'serve'
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">apply</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="p">{</span> <span class="nx">command</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 非 SSR 打包时运行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nx">command</span> <span class="o">===</span> <span class="s1">'build'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">ssr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">'vite-plugin-example'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// alias
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">enforce</span><span class="o">:</span> <span class="s1">'pre'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 核心插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 无 enforce 配置的插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 构建用的插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">enforce</span><span class="o">:</span> <span class="s1">'post'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 后置构建插件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">config</span><span class="p">(</span><span class="nx">config</span>: <span class="kt">UserConfig</span><span class="p">,</span> <span class="nx">env</span><span class="o">:</span> <span class="p">{</span> <span class="nx">mode</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">command</span>: <span class="kt">string</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 解析 Vite 配置前调用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 接收一份原始配置和环境描述
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 返回合并后的配置。或者直接改变原始配置
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">config</span><span class="p">.</span><span class="nx">build</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">build</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">rollupOptions</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">rollupOptions</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">rollupOptions</span><span class="p">.</span><span class="nx">output</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">        <span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">rollupOptions</span><span class="p">.</span><span class="nx">output</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="p">{</span> <span class="nx">output</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">build</span><span class="p">.</span><span class="nx">rollupOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">outputConfig</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="o">?</span> <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">output</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">outputConfig</span><span class="p">.</span><span class="nx">manualChunks</span> <span class="o">=</span> <span class="nx">outputConfig</span><span class="p">.</span><span class="nx">manualChunks</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="nx">outputConfig</span><span class="p">.</span><span class="nx">assetFileNames</span> <span class="o">=</span> <span class="s1">'assets/[name].[hash:6][extname]'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">outputConfig</span><span class="p">.</span><span class="nx">chunkFileNames</span> <span class="o">=</span> <span class="nx">chunkInfo</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">chunkInfo</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">'vendor/'</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="o">?</span> <span class="s1">'[name]-[hash].js'</span>
</span></span><span class="line"><span class="cl">          <span class="o">:</span> <span class="s1">'assets/[name]-[hash].js'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">manualChunks</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">output</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">manualChunks</span>
</span></span><span class="line"><span class="cl">        : <span class="kt">output.manualChunks</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">manualChunks</span> <span class="o">!==</span> <span class="s1">'object'</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="nx">dependencies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">dep</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">dep</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="kr">const</span> <span class="nx">chunkName</span> <span class="o">=</span> <span class="sb">`vendor/</span><span class="si">${</span><span class="nx">index</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">manualChunks</span><span class="p">[</span><span class="nx">chunkName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">dep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">manualChunks</span><span class="p">[</span><span class="sb">`vendor/</span><span class="si">${</span><span class="nx">dep</span><span class="si">}</span><span class="sb">`</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">dep</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">configResolved</span><span class="p">(</span><span class="nx">config</span>: <span class="kt">ResolvedConfig</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 解析 Vite 配置后调用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 用来读取“Vite 最终配置”
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">configureServer</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 用于配置开发服务器 ViteDevServer
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 将在内部中间件被安装前调用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 在生产环境时不会运行
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">server</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 自定义中间件，早于内部中间件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="nx">server</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'message'</span><span class="p">,</span> <span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 输出 WebSocket 信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">server</span><span class="p">.</span><span class="nx">middlewares</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 晚于内部中间件调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">configurePreviewServer</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 预览服务器配置，其他同 configResolved
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">transformIndexHtml</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 用于转换 HTML 的钩子
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 接收当前 HTML 字符串
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 返回经过转换的 HTML
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 用于做代码注入
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s1">'&lt;!-- FOLLOW VITE BUILD INJECT --&gt;'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="sb">`&lt;script id="env_injection" type="module"&gt;
</span></span></span><span class="line"><span class="cl"><span class="sb">            </span><span class="si">${</span><span class="kd">function</span> <span class="nx">injectEnv</span><span class="p">(</span><span class="nx">env</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">env</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">globalThis</span><span class="p">[</span><span class="s1">'__followEnv'</span><span class="p">]</span> <span class="o">??=</span> <span class="p">{</span><span class="si">}</span><span class="sb">;
</span></span></span><span class="line"><span class="cl"><span class="sb">                globalThis['__followEnv'][key] = env[key];
</span></span></span><span class="line"><span class="cl"><span class="sb">              }
</span></span></span><span class="line"><span class="cl"><span class="sb">            }.toString()}
</span></span></span><span class="line"><span class="cl"><span class="sb">            // 将 .env 文件中的内容暴露到前端 __followEnv 变量中
</span></span></span><span class="line"><span class="cl"><span class="sb">            injectEnv(</span><span class="si">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">              <span class="nx">VITE_API_URL</span>: <span class="kt">env.VITE_API_URL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">VITE_WEB_URL</span>: <span class="kt">env.VITE_WEB_URL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nx">VITE_IMGPROXY_URL</span>: <span class="kt">env.VITE_IMGPROXY_URL</span>
</span></span><span class="line"><span class="cl">            <span class="si">}</span><span class="sb">)})
</span></span></span><span class="line"><span class="cl"><span class="sb">         &lt;/script&gt;`</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handleHotUpdate</span><span class="p">({</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">modules</span><span class="p">,</span> <span class="nx">read</span><span class="p">,</span> <span class="nx">server</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 自定义模块热更新逻辑
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 可以更精确的控制 HMR
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">invalidatedModules</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">mod</span> <span class="k">of</span> <span class="nx">modules</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 手动使模块失效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">server</span><span class="p">.</span><span class="nx">moduleGraph</span><span class="p">.</span><span class="nx">invalidateModule</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">mod</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">invalidatedModules</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">timestamp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">server</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span> <span class="kr">type</span><span class="o">:</span> <span class="s1">'full-reload'</span> <span class="p">});</span> <span class="c1">// 发送全局刷新事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="p">[];</span> <span class="c1">// 如果返回的是 []，表示全局刷新而不是用 HMR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="服务端到客户端">服务端到客户端</h3><p>服务端通过 server.ws.send 向客户端发送自定义事件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 例子来自 Follow，apps/server/client/i18n.ts
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">readFileSync</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'node:fs'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">Plugin</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">customI18nHmrPlugin</span><span class="p">()</span><span class="o">:</span> <span class="nx">Plugin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">'custom-i18n-hmr'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handleHotUpdate</span><span class="p">({</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">server</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">'.json'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">file</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'locales'</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 使用 WebSocket 发送一个 i18n-update 事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">server</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">          <span class="kr">type</span><span class="o">:</span> <span class="s1">'custom'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">           * 可以直接在项目代码中监听 i18n-update 事件
</span></span></span><span class="line"><span class="cl"><span class="cm">           * import.meta.hot.on('i18n-update', () =&gt; {})
</span></span></span><span class="line"><span class="cl"><span class="cm">           */</span>
</span></span><span class="line"><span class="cl">          <span class="nx">event</span><span class="o">:</span> <span class="s1">'i18n-update'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span>: <span class="kt">readFileSync</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="s1">'utf-8'</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">file</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 阻止 Vite 内置的 HMR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>前端通过 import.meta.hot.on 监听自定义事件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 会在生产打包时，被 TreeShaking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'i18n-update'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="kr">async</span> <span class="p">({</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">content</span> <span class="p">}</span><span class="o">:</span> <span class="p">{</span> <span class="nx">file</span>: <span class="kt">string</span><span class="p">;</span> <span class="nx">content</span>: <span class="kt">string</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">resources</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">i18next</span> <span class="o">=</span> <span class="nx">jotaiStore</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">i18nAtom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">nsName</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/locales\/(.+?)\//</span><span class="p">)</span><span class="o">?</span><span class="p">.[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nsName</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">lang</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">).</span><span class="nx">pop</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">'.json'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">lang</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 更新 i18nAtom
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">i18next</span><span class="p">.</span><span class="nx">addResourceBundle</span><span class="p">(</span><span class="nx">lang</span><span class="p">,</span> <span class="nx">nsName</span><span class="p">,</span> <span class="nx">resources</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">await</span> <span class="nx">i18next</span><span class="p">.</span><span class="nx">reloadResources</span><span class="p">(</span><span class="nx">lang</span><span class="p">,</span> <span class="nx">nsName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 派发更新事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">DEV</span> <span class="o">&amp;&amp;</span> <span class="nx">EventBus</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s1">'I18N_UPDATE'</span><span class="p">,</span> <span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="客户端到服务端">客户端到服务端</h3><p>客户端通过 import.meta.hot.send 向服务端发送事件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="c1">// 会在生产打包时，被 TreeShaking
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">import</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hot</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'my:from-client'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Hey!'</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>服务端通过 server.ws.on 监听客户端事件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">configureServer</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">server</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'my:from-client'</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Message from client:'</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'my:ack'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">msg</span><span class="o">:</span> <span class="s1">'Hi! I got your message!'</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>如果想要自定义事件有 TS 类型提示，可以在 .d.ts 文件中声明类型：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="s1">'vite/types/customEvent.d.ts'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">declare</span> <span class="nx">module</span> <span class="s1">'vite/types/customEvent.d.ts'</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">interface</span> <span class="nx">CustomEventMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">'custom:foo'</span><span class="o">:</span> <span class="p">{</span> <span class="nx">msg</span>: <span class="kt">string</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 'event-key': payload
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="配置">配置</h2><p>Vite 运行时，会查找项目根目录下的 vite.config.js|ts，也可以通过 --config 指定配置文件：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="nx">vite</span> <span class="o">--</span><span class="nx">config</span> <span class="nx">src</span><span class="o">/</span><span class="nx">config</span><span class="p">.</span><span class="nx">js</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="类型提示-1">类型提示</h3><p>如果配置文件是 .js，可以通过 JSDoc/defineConfig 获取类型提示：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="cm">/** @type {import('vite').UserConfig} */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 或者借助工具函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">});</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>或者是 .ts 的配置文件，并使用 satisfies 关键字：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="kr">type</span> <span class="p">{</span> <span class="nx">UserConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span> <span class="nx">satisfies</span> <span class="nx">UserConfig</span><span class="p">;</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="情景配置">情景配置</h3><p>如果要基于不同的命令/模式返回不同的配置，可以使用函数形式：</p><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">defineConfig</span> <span class="p">}</span> <span class="kr">from</span> <span class="s1">'vite'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 配置可以是异步的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="k">default</span> <span class="kr">async</span> <span class="p">({</span> <span class="nx">mode</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 根据 mode 加载 .env 文件中所有变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">env</span> <span class="o">=</span> <span class="nx">loadEnv</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="s1">''</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'env'</span><span class="p">,</span> <span class="nx">env</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">===</span> <span class="s1">'production'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">      <span class="nx">define</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">__APP_ENV__</span>: <span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_ENV</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">defineConfig</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">define</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">__APP_ENV__</span>: <span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">env</span><span class="p">.</span><span class="nx">APP_ENV</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h3 id="配置选项">配置选项</h3><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-ts" data-lang="ts"><span class="line"><span class="cl"><span class="kr">interface</span> <span class="nx">UserConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 项目根目录，index.html 所在的目录
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 配置文件需要和 HTML 文件在同一个目录下
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">root?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 基础路径：
</span></span></span><span class="line"><span class="cl"><span class="cm">   * /foo/，绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ./，相对路径，默认为 /
</span></span></span><span class="line"><span class="cl"><span class="cm">   * https://bar.com/foo/，URL，开发模式下等同于 /foo/
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">base?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 默认为 public
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 静态资源路径，不会被打包
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 打包之后会被复制到 outDir
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">publicDir?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 缓存目录
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 保存着 Vite 的预构建缓存
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 默认为 node_modules/.vite
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cacheDir?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 默认情况下，mode 为 development|production
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 可以在运行 Vite 时，使用 --mode 指定为其他值
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mode?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 定义全局变量
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 在开发模式下会被定义在全局
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 在生产打包时，会被静态替换
</span></span></span><span class="line"><span class="cl"><span class="cm">   * APP_VERSION: JSON.stringify(pkg.version)
</span></span></span><span class="line"><span class="cl"><span class="cm">   * APP_NAME: JSON.stringify(pkg.name)
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">define?</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 插件配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">plugins?</span>: <span class="kt">PluginOption</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 定义模块解析配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">resolve</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ['browser', 'module', 'jsnext:main', 'jsnext']
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 解析包的入口时，尝试的字段列表
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mainFields?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 因为现在的第三方包会在 package.json 中导出对应 CJS、ESM、UMD 等规范的不同文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 对模块进行解析的过程中，匹配那些“情景导出”
</span></span></span><span class="line"><span class="cl"><span class="cm">     * [import, module, browser, default]
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">conditions?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ['.mjs', '.js', '.mts', '.ts', '.jsx', '.tsx', '.json']
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 解析模块导入时，匹配哪些扩展名
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">extensions?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * https://github.com/vitejs/vite/issues/5384
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在 monorepo 中，如果项目有相同的依赖
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 应该将这个依赖配置于此
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 防止解析为多个副本
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dedupe?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 针对 npm link 模块解析时
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 使用真实文件地址（false）还是符号连接地址（true）
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">preserveSymlinks?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 定义文件系统路径别名，只能使用绝对路径
</span></span></span><span class="line"><span class="cl"><span class="cm">     * "@pkg": resolve(__dirname, "../../package.json"),
</span></span></span><span class="line"><span class="cl"><span class="cm">     * "@client": resolve(__dirname, "./client")
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alias?</span>: <span class="kt">AliasOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 前端是可以通过 meta 标签设置内容安全策略的，可以让只有和页面同域名的静态资源才加载
</span></span></span><span class="line"><span class="cl"><span class="cm">   * &lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'" /&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 阻止页面上所有内联 JavaScript 的执行，可以避免 XSS 攻击
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ----------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm">   * &lt;meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'" /&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * unsafe-inline 会允许内联 JavaScript 执行，但是不推荐
</span></span></span><span class="line"><span class="cl"><span class="cm">   * --------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm">   * &lt;meta http-equiv="Content-Security-Policy" content="script-src 'nonce-NDhkODkxMzYtNGUxZS00N2NjLTk1YTItNWMyOTM4YzdhZGJj'"&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * &lt;script nonce="NDhkODkxMzYtNGUxZS00N2NjLTk1YTItNWMyOTM4YzdhZGJj"&gt;&lt;/script&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * nonce 会允许上边的 JavaScript 代码执行
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="cm">   * html.cspNonce 会自动帮我们生成对应的 meta 和 script 标签
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">html</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cspNonce?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// CSS 配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">css</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CSS 转换器配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">transformer</span><span class="o">?:</span> <span class="s1">'postcss'</span> <span class="o">|</span> <span class="s1">'lightningcss'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 控制 CSS modules 行为
</span></span></span><span class="line"><span class="cl"><span class="cm">     * https://github.com/madyankin/postcss-modules
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果使用了 LightningCSS，参考如下链接
</span></span></span><span class="line"><span class="cl"><span class="cm">     * https://lightningcss.dev/css-modules.html
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">modules?</span>: <span class="kt">CSSModulesOptions</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CSS 预处理器配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preprocessorOptions?</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否在 Worker&nbsp;线程运行预处理器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preprocessorMaxWorkers?</span>: <span class="kt">number</span> <span class="o">|</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">postcss</span><span class="o">?:</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="p">(</span><span class="nx">PostCSS</span><span class="p">.</span><span class="nx">ProcessOptions</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">plugins?</span>: <span class="kt">PostCSS.AcceptedPlugin</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在开发环境下是否启用 sourcemap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">devSourcemap?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lightningcss?</span>: <span class="kt">LightningCSSOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * json.namedExports 是否支持从 JSON 中按名称导入
</span></span></span><span class="line"><span class="cl"><span class="cm">   * json.stringify 导入的 JSON 按照字面量处理还是模块处理
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">json?</span>: <span class="kt">JsonOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// esbuild 配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">esbuild?</span>: <span class="kt">ESBuildOptions</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">assetsInclude?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span> <span class="o">|</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">)[];</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 服务器配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">server</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 禁用或配置 HMR
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">hmr?</span>: <span class="kt">HmrOptions</span> <span class="o">|</span> <span class="kr">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ws?</span>: <span class="kt">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 文件预热配置，提前对配置的文件进行转换和缓存
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 用来提高页面加载速度，防止转换｜请求瀑布
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 仅把常用的文件添加至此，防止 Vite 过载
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">warmup</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 客户端渲染中，要使用的文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">clientFiles</span><span class="o">:</span> <span class="p">[</span><span class="s1">'./src/components/*.vue'</span><span class="p">,</span> <span class="s1">'./src/utils/big-utils.js'</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 服务端渲染中，要使用的文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">ssrFiles</span><span class="o">:</span> <span class="p">[</span><span class="s1">'./src/server/modules/*.js'</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 使用 chokidar 监听文件变动，https://github.com/paulmillr/chokidar#api
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Vite 会监听项目目录，并跳过 .git、node_modules、cacheDir、build.outDir
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果设置为 null，则不监听任何目录
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">watch?</span>: <span class="kt">WatchOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * https://vite.vuejs.ac.cn/guide/ssr/
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 将 Vite 作为中间件来运行
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 一般用作服务端渲染
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">middlewareMode</span><span class="o">?:</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="kr">boolean</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">server</span>: <span class="kt">HttpServer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// /\@fs/ 配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fs</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 不能通过 Vite 访问项目根目录路径以外的文件访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">strict?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 哪些文件可以通过 /@fs/ 路径提供服务
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">allow?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 默认值为 ['.env', '.env.*', '*.crt', '*.pem']
</span></span></span><span class="line"><span class="cl"><span class="cm">       * Vite 将不会为配置的文件提供文件服务
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 防止敏感信息意外泄露
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 优先级高于 allow
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">deny?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cachedChecks?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">origin?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">preTransformRequests?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sourcemapIgnoreList</span><span class="o">?:</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="p">((</span><span class="nx">sourcePath</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">sourcemapPath</span>: <span class="kt">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 开发服务器端口，如果被占用，会尝试下一个端口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">port?</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果端口被占用，退出进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">strictPort?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 监听 IP
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">host?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kr">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启用 TLS + HTTP/2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">https?</span>: <span class="kt">HttpsServerOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否自动打开浏览器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">open?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * export default defineConfig({
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  server: {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    proxy: {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      // http://localhost:5173/foo -&gt; http://localhost:4567/foo
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      '/foo': 'http://localhost:4567',
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      // http://localhost:5173/api/bar -&gt; http://jsonplaceholder.typicode.com/bar
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      '/api': {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        target: 'http://jsonplaceholder.typicode.com',
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        changeOrigin: true,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        rewrite: (path) =&gt; path.replace(/^\/api/, ''), // 将多余的 api 去除
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      },
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      // http://localhost:5173/fallback/ -&gt; http://jsonplaceholder.typicode.com/
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      '^/fallback/.*': {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        target: 'http://jsonplaceholder.typicode.com',
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        changeOrigin: true,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        rewrite: (path) =&gt; path.replace(/^\/fallback/, ''), // 将多余的 fallback 去除
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      },
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      // 使用 proxy 实例
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      '/api': {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        target: 'http://jsonplaceholder.typicode.com',
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        changeOrigin: true,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        configure: (proxy, options) =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *          // proxy 是 'http-proxy' 的实例
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        }
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      },
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      // ws://localhost:5173/socket.io -&gt; ws://localhost:5174/socket.io
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      '/socket.io': {
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        target: 'ws://localhost:5174',
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        rewriteWsOrigin: true,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *        ws: true,
</span></span></span><span class="line"><span class="cl"><span class="cm">     *      },
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    },
</span></span></span><span class="line"><span class="cl"><span class="cm">     *  },
</span></span></span><span class="line"><span class="cl"><span class="cm">     * })
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">proxy?</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="err">,</span> <span class="na">string</span> <span class="err">|</span> <span class="na">ProxyOptions</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 跨域配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cors?</span>: <span class="kt">CorsOptions</span> <span class="o">|</span> <span class="kr">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 指定响应头部信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">headers?</span>: <span class="kt">OutgoingHttpHeaders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">build</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 设置打包产物（JS）的浏览器兼容性
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 默认值 modules 仅支持完整实现 ESM 规范的浏览器，['es2020', 'edge88', 'firefox78', 'chrome87', 'safari14']
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">target</span><span class="o">?:</span> <span class="s1">'modules'</span> <span class="o">|</span> <span class="nx">esbuild_TransformOptions</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否将“模块动态加载 polyfill”注入 HTML
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">polyfillModulePreload?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * https://guybedford.com/es-module-preloading-integrity#modulepreload-polyfill
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 默认情况下，会自动注入一个模块动态加载的 polyfill
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如是是对库进行打包，则置为 false
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">modulePreload?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="nx">ModulePreloadOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打包输出目录，默认 dist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">outDir?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 静态资源目录，默认 assets
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">assetsDir?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 小于此阈值的资源将被编译为 base64，内联进模块内部
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">assetsInlineLimit</span><span class="o">?:</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="kt">number</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="p">((</span><span class="nx">filePath</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">content</span>: <span class="kt">Buffer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="kr">boolean</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 是否对 CSS 进行代码拆分操作
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果为 false，整个项目的 CSS 将被打包进一个文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cssCodeSplit?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 同 build.target
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 设置打包产物（CSS）的浏览器兼容性
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cssTarget?</span>: <span class="kt">esbuild_TransformOptions</span><span class="p">[</span><span class="s1">'target'</span><span class="p">]</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// CSS 压缩配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cssMinify?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="s1">'esbuild'</span> <span class="o">|</span> <span class="s1">'lightningcss'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 是否生成 sourcemap
</span></span></span><span class="line"><span class="cl"><span class="cm">     * true，创建独立的 sourcemap
</span></span></span><span class="line"><span class="cl"><span class="cm">     * hidden，同 true，代码注释不再保留
</span></span></span><span class="line"><span class="cl"><span class="cm">     * inline，生成 sourcemap 并附加到输出文件内
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sourcemap?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="s1">'inline'</span> <span class="o">|</span> <span class="s1">'hidden'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 文件压缩配置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">minify?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="s1">'terser'</span> <span class="o">|</span> <span class="s1">'esbuild'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// https://terser.org/docs/api-reference#minify-options
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">terserOptions?</span>: <span class="kt">TerserOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// https://rollupjs.org/configuration-options/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">rollupOptions?</span>: <span class="kt">RollupOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// @rollup/plugin-commonjs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">commonjsOptions?</span>: <span class="kt">RollupCommonJSOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// @rollup/plugin-dynamic-import-vars
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dynamicImportVarsOptions?</span>: <span class="kt">RollupDynamicImportVarsOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否将打包产物写入磁盘
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">write?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 打包之前，是否清空打包目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">emptyOutDir?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 是否将 publicDir 复制到 outDir
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">copyPublicDir?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 是否生成 manifest 文件，其中包含了没有被 hash 过的资源文件名和 hash 后版本的映射
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 可以为一些服务器框架渲染时提供正确的资源引入链接
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">manifest?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 库模式，默认为 false
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果使用库模式：
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    entry 是必需的，因为库不能使用 HTML 作为入口
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    name 则是暴露的全局变量，并且在 formats 包含 'umd' 或 'iife' 时是必需的
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    formats 是 ['es', 'umd']，如果使用了多个配置入口，则是 ['es', 'cjs']
</span></span></span><span class="line"><span class="cl"><span class="cm">     *    fileName 是输出的包文件名，默认 fileName 是 package.json 的 name 选项
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lib?</span>: <span class="kt">LibraryOptions</span> <span class="o">|</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 生成面向 SSR 的构建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ssr?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当设置为 true 时，构建也将生成 SSR 的 manifest 文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ssrManifest?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ssrEmitAssets?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启用/禁用 gzip 压缩大小报告
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">reportCompressedSize?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// chunk 大小警告
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">chunkSizeWarningLimit?</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 启用 Rollup 的监听器。对于只在构建阶段或者集成流程使用的插件很常用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">watch?</span>: <span class="kt">WatcherOptions</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">preview?</span>: <span class="kt">PreviewOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 依赖优化，仅在开发环境中使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">optimizeDeps</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 强制预构建 node_modules 之外的包
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">include</span><span class="o">?:</span> <span class="p">[</span><span class="s1">'my-lib/components/**/*.vue'</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 在预构建中强制排除的依赖项，CommonJS 依赖应当总是被预构建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">exclude?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">needsInterop?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// https://esbuild.github.io/api
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">esbuildOptions?</span>: <span class="kt">Omit</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">esbuild_BuildOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'bundle'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'entryPoints'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'external'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'write'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'watch'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'outdir'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'outfile'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'outbase'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'outExtension'</span>
</span></span><span class="line"><span class="cl">      <span class="o">|</span> <span class="s1">'metafile'</span>
</span></span><span class="line"><span class="cl">    <span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">extensions?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">disabled?</span>: <span class="kt">boolean</span> <span class="o">|</span> <span class="s1">'build'</span> <span class="o">|</span> <span class="s1">'dev'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 不要主动进行预构建，除非 include 了依赖
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">noDiscovery?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">holdUntilCrawlEnd?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 默认情况下，Vite 会分析 index.html 来检测需要预构建的依赖项
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果指定了 build.rollupOptions.input，就去检测这个配置的文件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 如果都不满足要求，使用这个配置来自定义
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">entries?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 忽略缓存，强制进行预构建
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">force?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ssr</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">noExternal?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span> <span class="o">|</span> <span class="p">(</span><span class="kt">string</span> <span class="o">|</span> <span class="nb">RegExp</span><span class="p">)[]</span> <span class="o">|</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">external?</span>: <span class="kt">string</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">target?</span>: <span class="kt">SSRTarget</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">optimizeDeps?</span>: <span class="kt">SsrDepOptimizationOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resolve</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">conditions?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">      <span class="nx">externalConditions?</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">experimental?</span>: <span class="kt">ExperimentalOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">legacy?</span>: <span class="kt">LegacyOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">logLevel</span><span class="o">?:</span> <span class="s1">'error'</span> <span class="o">|</span> <span class="s1">'warn'</span> <span class="o">|</span> <span class="s1">'info'</span> <span class="o">|</span> <span class="s1">'silent'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">customLogger?</span>: <span class="kt">Logger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 避免 Vite 清屏而错过在终端中打印某些关键信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">clearScreen?</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// .env 文件目录，默认为根目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">envDir?</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * .env 文件中，以 envPrefix 开头的变量，会暴露在 import.meta.env 中
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 如果设置为 ''，将暴露所有变量；并且 Vite 会报错
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 默认只暴露 VITE_ 开头的环境变量
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nx">envPrefix?</span>: <span class="kt">string</span> <span class="o">|</span> <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="nx">worker</span><span class="o">?:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">format</span><span class="o">?:</span> <span class="s1">'es'</span> <span class="o">|</span> <span class="s1">'iife'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">plugins</span><span class="o">?:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">PluginOption</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rollupOptions?</span>: <span class="kt">Omit</span><span class="o">&lt;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">RollupOptions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'plugins'</span> <span class="o">|</span> <span class="s1">'input'</span> <span class="o">|</span> <span class="s1">'onwarn'</span> <span class="o">|</span> <span class="s1">'preserveEntrySignatures'</span>
</span></span><span class="line"><span class="cl">    <span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 应用类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">appType</span><span class="o">?:</span> <span class="s1">'spa'</span> <span class="o">|</span> <span class="s1">'mpa'</span> <span class="o">|</span> <span class="s1">'custom'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="参考">参考</h2><ul><li><a class="link" href="https://www.zhangxinxu.com/wordpress/2023/08/html-attribute-nonce-translate" target="_blank" rel="noopener">查漏补缺，我仍未知道的 HTML nonce 和 popover 属性</a></li></ul></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2025
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#为什么是-vite">为什么是 Vite</a></li><li><a href="#功能">功能</a><ol><li><a href="#预构建">预构建</a></li><li><a href="#热替换">热替换</a></li><li><a href="#typescript">TypeScript</a></li><li><a href="#glob-导入">Glob 导入</a></li></ol></li><li><a href="#缓存">缓存</a></li><li><a href="#静态资源">静态资源</a></li><li><a href="#打包">打包</a><ol><li><a href="#处理加载出错">处理加载出错</a></li><li><a href="#库打包">库打包</a></li></ol></li><li><a href="#环境变量">环境变量</a><ol><li><a href="#类型提示">类型提示</a></li><li><a href="#在-html-中使用">在 HTML 中使用</a></li><li><a href="#node_env">NODE_ENV</a></li></ol></li><li><a href="#插件">插件</a><ol><li><a href="#约定">约定</a></li><li><a href="#服务端到客户端">服务端到客户端</a></li><li><a href="#客户端到服务端">客户端到服务端</a></li></ol></li><li><a href="#配置">配置</a><ol><li><a href="#类型提示-1">类型提示</a></li><li><a href="#情景配置">情景配置</a></li><li><a href="#配置选项">配置选项</a></li></ol></li><li><a href="#参考">参考</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>