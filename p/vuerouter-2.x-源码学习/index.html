<!DOCTYPE html><html lang="zh-cn" dir="ltr"><head><meta charset="utf-8"><style>:where(img[jampack-sized]){max-width:100%;height:auto}</style><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="description" content="Vue.use(Router) Vue.use 会调用 Router 的静态 install 方法：
保存 Vue 构造函数，方便其他组件调用 Vue 的工具函数； 在每个 Vue 实例中混入钩子： 定义 _routerRoot、_router、_route（getter/setter）； 调用 Router 实例的 init 方法； 注册路由实例。 在 Vue 原型上挂载 $router、$route； 注册 router-view 和 router-link 组件。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 export let _Vue; // 别的地方有用到 _Vue.extend export function install(Vue) { // 防止重复 install if (install.installed) return; install.installed = true; // 保存 Vue _Vue = Vue; const isDef = v => v !== undefined; const registerInstance = (vm, callVal) => { let i = vm.$options._parentVnode; if ( isDef(i) &amp;&amp; isDef((i = i.data)) &amp;&amp; isDef((i = i.registerRouteInstance)) ) { /** * 调用 vm.$options._parentVnode.data.registerRouteInstance * data.registerRouteInstance 存在于 router-view 中 */ i(vm, callVal); } }; // 混入钩子（确保每个 vm 都能访问到路由） Vue.mixin({ beforeCreate() { // new Vue({router, ...})，挂载根实例，如果是根 vm if (isDef(this.$options.router)) { // _routerRoot 指向根组件实例 this._routerRoot = this; // 传入的 new Router({mode, routes, ...}) this._router = this.$options.router; /** * 调用 _router 的 init 方法，将 this 保存到数组里 * 监听 history，有变化会更新所有 this 里的 route */ this._router.init(this); /** * defineReactive(obj, key, val, customSetter, shallow) * 将 this._route 转化为 getter/setter，render 被调用时 * router.view 会访问 this._route，触发 getter * 当 this._route 更新后，setter 调用 * router.view 渲染匹配的组件 */ Vue.util.defineReactive(this, '_route', this._router.history.current); } else { // 如果不是根组件，向上（从父级）查找 _routerRoot this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this; } registerInstance(this, this); }, destroyed() { registerInstance(this); } }); /** * 直接在原型链上添加 $router/$route，都指向 _routerRoot 上对应的属性 * vm.$router = this._routerRoot._router = new Router({mode, routes, ...}) * vm.$route = this._routerRoot._route */ Object.defineProperty(Vue.prototype, '$router', { get() { // 都指向 new VueRouter({...}) return this._routerRoot._router; } }); Object.defineProperty(Vue.prototype, '$route', { get() { // 都指向 this._router.history.current return this._routerRoot._route; } }); // 全局注册 router-view 和 router-link 组件 Vue.component('router-view', View); Vue.component('router-link', Link); const strats = Vue.config.optionMergeStrategies; strats.beforeRouteEnter = strats.beforeRouteLeave = strats.created; } VueRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 export default class VueRouter { static install: () => void; static version: string; app: any; apps: Array<any>; ready: boolean; readyCbs: Array<Function>; options: RouterOptions; mode: string; history: HashHistory | HTML5History | AbstractHistory; matcher: Matcher; fallback: boolean; beforeHooks: Array<?NavigationGuard>; resolveHooks: Array<?NavigationGuard>; afterHooks: Array<?AfterNavigationHook>; constructor(options: RouterOptions = {}) { this.app = null; this.apps = []; this.options = options; this.beforeHooks = []; this.resolveHooks = []; this.afterHooks = []; this.matcher = createMatcher(options.routes || [], this); // 默认 hash 模式 let mode = options.mode || 'hash'; this.fallback = // 不支持 history，退回 hash mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false; if (this.fallback) { mode = 'hash'; } // 非浏览器环境使用 abstract 模式 if (!inBrowser) { mode = 'abstract'; } this.mode = mode; // options.base 就是&quot;基路径&quot; switch (mode) { case 'history': /** * 处理滚动行为 * 监听 popstate 并调用 transitionTo */ this.history = new HTML5History(this, options.base); break; case 'hash': /** * 处理 URL 格式 * 监听 hashchange 并调用 transitionTo */ this.history = new HashHistory(this, options.base, this.fallback); break; case 'abstract': this.history = new AbstractHistory(this, options.base); break; default: } } match(raw: RawLocation, current?: Route, redirectedFrom?: Location): Route { return this.matcher.match(raw, current, redirectedFrom); } get currentRoute() { return this.history &amp;&amp; this.history.current; } // 每个组件的 beforeCreate 会调用 init 方法，将当前实例传进来 init(app: any) { // 向 this.apps 添加当前 Vue 实例 this.apps.push(app); // 不要重复 init if (this.app) { return; } // _router.app = vm this.app = app; const history = this.history; if (history instanceof HTML5History) { /** * getCurrentLocation 就是截取掉&quot;基路径&quot;后的路径 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => /api/?abc=123#hahaha */ history.transitionTo(history.getCurrentLocation()); } else if (history instanceof HashHistory) { // 绑定 hashchange 事件 const setupHashListener = () => { history.setupListeners(); }; // 跳转一次页面，触发一次 hashchange history.transitionTo( /** * getCurrentLocation 就是截取掉 # 后边的值 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => hahaha */ history.getCurrentLocation(), setupHashListener, setupHashListener ); } /** * 路由改变的时候，所有 Vue 实例里的 _route 都要改变 * history 的 updateRoute 会调用 listen 里的回调 * _route 已经是“响应式”，会触发组件更新 */ history.listen(route => { this.apps.forEach(app => { app._route = route; }); }); } beforeEach(fn: Function): Function { return registerHook(this.beforeHooks, fn); } beforeResolve(fn: Function): Function { return registerHook(this.resolveHooks, fn); } afterEach(fn: Function): Function { return registerHook(this.afterHooks, fn); } onReady(cb: Function, errorCb?: Function) { this.history.onReady(cb, errorCb); } onError(errorCb: Function) { this.history.onError(errorCb); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.push(location, onComplete, onAbort); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.replace(location, onComplete, onAbort); } go(n: number) { this.history.go(n); } back() { this.go(-1); } forward() { this.go(1); } getMatchedComponents(to?: RawLocation | Route): Array<any> { const route: any = to ? to.matched ? to : this.resolve(to).route : this.currentRoute; if (!route) { return []; } return [].concat.apply( [], route.matched.map(m => { return Object.keys(m.components).map(key => { return m.components[key]; }); }) ); } resolve( to: RawLocation, current?: Route, append?: boolean ): { location: Location; route: Route; href: string; normalizedTo: Location; resolved: Route; } { const location = normalizeLocation( to, current || this.history.current, append, this ); const route = this.match(location, current); const fullPath = route.redirectedFrom || route.fullPath; const base = this.history.base; const href = createHref(base, fullPath, this.mode); return { location, route, href, normalizedTo: location, resolved: route }; } addRoutes(routes: Array<RouteConfig>) { this.matcher.addRoutes(routes); if (this.history.current !== START) { this.history.transitionTo(this.history.getCurrentLocation()); } } } BaseHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 export class History { base: string; cb: (r: Route) => void; current: Route; errorCbs: Array<Function>; pending: ?Route; ready: boolean; readyCbs: Array<Function>; readyErrorCbs: Array<Function>; router: Router; /** * 需要子类去实现的方法： * ensureURL: (push?: boolean) => void; * getCurrentLocation: () => string; * go: (n: number) => void; * push: (loc: RawLocation) => void; * replace: (loc: RawLocation) => void; */ constructor(router: Router, base: ?string) { this.base = normalizeBase(base); this.current = START; this.errorCbs = []; this.pending = null; this.ready = false; this.readyCbs = []; this.readyErrorCbs = []; this.router = router; } listen(cb: Function) { // history.listen(route => { // this.apps.forEach(app => { // app._route = route; // }); // }); // 给 this.cb 赋值，会在 updateRoute 调用 this.cb // 更新应用中所有的 app._route this.cb = cb; } onReady(cb: Function, errorCb: ?Function) { if (this.ready) { cb(); } else { this.readyCbs.push(cb); if (errorCb) { this.readyErrorCbs.push(errorCb); } } } onError(errorCb: Function) { this.errorCbs.push(errorCb); } // 用于路由切换 transitionTo( location: RawLocation, onComplete?: Function, onAbort?: Function ) { // 匹配目标 location 的 route const route = this.router.match(location, this.current); // 确认切换（异步） this.confirmTransition( route, // onComplete () => { this.updateRoute(route); // 更新 route onComplete &amp;&amp; onComplete(route); this.ensureURL(); if (!this.ready) { this.ready = true; this.readyCbs.forEach(cb => { cb(route); }); } }, // onAbort err => { if (onAbort) { onAbort(err); } if (err &amp;&amp; !this.ready) { this.ready = true; this.readyErrorCbs.forEach(cb => { cb(err); }); } } ); } confirmTransition(route: Route, onComplete: Function, onAbort?: Function) { const current = this.current; // 导航取消的时候调用 const abort = err => { if (isError(err)) { if (this.errorCbs.length) { this.errorCbs.forEach(cb => { cb(err); }); } else { console.error(err); } } onAbort &amp;&amp; onAbort(err); }; if ( // 如果 route 和 current 是相同路径（path、hash、query、params 一样） isSameRoute(route, current) &amp;&amp; // 并且匹配的长度一致 route.matched.length === current.matched.length ) { // 就没必要跳转 this.ensureURL(); return abort(); } // 找出 currentRecord 和 nextRecord 中的相同与不同 const { updated, // 相同但需要更新的 deactivated, // currentRecord 独有的 activated // nextRecord 独有的 } = resolveQueue( this.current.matched, // currentRecord 数组 route.matched // nextRecord 数组 ); /** * 导航被触发 * 在失活的组件里调用 beforeRouteLeave 守卫 * 调用全局的 beforeEach 守卫 * 在重用的组件里调用 beforeRouteUpdate 守卫 * 在路由配置里调用 beforeEnter * 解析异步路由组件 * 在被激活的组件里调用 beforeRouteEnter * 调用全局的 beforeResolve 守卫 * 导航被确认 * 调用全局的 afterEach 钩子 * 触发 DOM 更新 * 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 */ const queue: Array<?NavigationGuard> = [].concat( // 组件内部的 beforeRouteLeave extractLeaveGuards(deactivated), // 全局 beforeEach this.router.beforeHooks, // 组件内部的 beforeRouteUpdate extractUpdateHooks(updated), // routes 路由表里写的 beforeEnter activated.map(m => m.beforeEnter), // 解析异步路由组件，会等待异步组件的加载，加载完成之后再导航 resolveAsyncComponents(activated) ); this.pending = route; const iterator = (hook: NavigationGuard, next) => { // next 被调用之后，会去拿数组里的下一个钩子函数 if (this.pending !== route) { return abort(); } try { // 有点 to、from、next 那味儿了 hook(route, current, (to: any) => { if (to === false || isError(to)) { // next(false) -> 停止导航 this.ensureURL(true); abort(to); } else if ( typeof to === 'string' || (typeof to === 'object' &amp;&amp; (typeof to.path === 'string' || typeof to.name === 'string')) ) { // next('/') 或 next({ path: '/' }) -> 重定向 abort(); if (typeof to === 'object' &amp;&amp; to.replace) { this.replace(to); } else { this.push(to); } } else { next(to); } }); } catch (e) { abort(e); } }; runQueue( queue, // 保存了要执行的钩子函数 iterator, // queue 里的钩子会被一个一个的拿到 iterator 里执行 () => { // queue 里的钩子被全部调用完成之后，会执行此函数 const postEnterCbs = []; const isValid = () => this.current === route; // 获取组件里 beforeRouteEnter 钩子 const enterGuards = extractEnterGuards( activated, postEnterCbs, isValid ); // 拼接上全局 beforeResolve 钩子 const queue = enterGuards.concat(this.router.resolveHooks); runQueue(queue, iterator, () => { // 新的 queue 里的钩子被全部调用完成之后，会执行此函数 if (this.pending !== route) { return abort(); } this.pending = null; onComplete(route); if (this.router.app) { // 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 this.router.app.$nextTick(() => { postEnterCbs.forEach(cb => { cb(); }); }); } }); } ); } updateRoute(route: Route) { const prev = this.current; this.current = route; // 调用 this.cb（init 的时候，由 history.listen 赋值） this.cb &amp;&amp; this.cb(route); this.router.afterHooks.forEach(hook => { hook &amp;&amp; hook(route, prev); }); } } export function runQueue( queue: Array<?NavigationGuard>, fn: Function, cb: Function ) { const step = index => { if (index >= queue.length) { cb(); } else { if (queue[index]) { fn(queue[index], () => { step(index + 1); }); } else { step(index + 1); } } }; step(0); } HTML5History 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 export class HTML5History extends History { constructor(router: Router, base: ?string) { super(router, base); const expectScroll = router.options.scrollBehavior; if (expectScroll) { // popstate 时，保存滚动位置 setupScroll(); } /** * 调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件 * popstate 事件只会在浏览器后退按钮或调用 history.back() 方法时触发 * 即，在同一文档的两个历史记录条目之间导航会触发该事件 * 重新调用 transitionTo 完成页面切换 */ window.addEventListener('popstate', e => { const current = this.current; this.transitionTo(getLocation(this.base), route => { if (expectScroll) { /** * handleScroll(router, to, from, isPop) * 调用 getScrollPosition 获取滚动位置（保存在 history 的 state 里） * 调用 router.options.scrollBehavior(to, from, position) 判断是否需要滚动 * 调用 window.scrollTo 进行滚动 */ handleScroll(router, route, current, true); } }); }); } go(n: number) { window.history.go(n); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { pushState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { replaceState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } ensureURL(push?: boolean) { if (getLocation(this.base) !== this.current.fullPath) { const current = cleanPath(this.base + this.current.fullPath); push ? pushState(current) : replaceState(current); } } getCurrentLocation(): string { return getLocation(this.base); } } HashHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 export class HashHistory extends History { constructor(router: Router, base: ?string, fallback: boolean) { super(router, base); /** * checkFallback 会把 HTML5History 格式的链接转换为 HashHistory 格式的链接 * 然后 location.replace 掉 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * checkFallback => https://router.vuejs.org/zh/#/api/?abc=123#hahaha */ if (fallback &amp;&amp; checkFallback(this.base)) { return; } // /zh#/api/?abc=123#hahaha replace 成为 /zh/#/api/?abc=123#hahaha ensureSlash(); // 保证 # 前边有 / } // 延迟到应用挂载，防止事件过早触发 setupListeners() { window.addEventListener('hashchange', () => { if (!ensureSlash()) { return; } // 获取 hash 并跳转 this.transitionTo(getHash(), route => { replaceHash(route.fullPath); }); }); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 赋值 window.location.hash pushHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 调用 window.location.replace replaceHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } go(n: number) { window.history.go(n); } ensureURL(push?: boolean) { const current = this.current.fullPath; if (getHash() !== current) { push ? pushHash(current) : replaceHash(current); } } getCurrentLocation() { return getHash(); } } matcher 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 export function createMatcher( routes: Array<RouteConfig>, // options.routes router: VueRouter // VueRouter 实例 ): Matcher { // 把传入的路由表转换为路由映射表 const { pathList, pathMap, nameMap } = createRouteMap(routes); // addRoutes 就是把新来的 routes 添加到 pathList, pathMap, nameMap 里 function addRoutes(routes) { createRouteMap(routes, pathList, pathMap, nameMap); } // 根据 RawLocation 和 currentRoute 返回一个 route function match( raw: RawLocation, // url 或者 Location 对象 currentRoute?: Route, redirectedFrom?: Location ): Route { const location = normalizeLocation(raw, currentRoute, false, router); const { name } = location; if (name) { const record = nameMap[name]; // 获取 name 对应的 record if (!record) return _createRoute(null, location); const paramNames = record.regex.keys .filter(key => !key.optional) .map(key => key.name); if (typeof location.params !== 'object') { location.params = {}; } if (currentRoute &amp;&amp; typeof currentRoute.params === 'object') { for (const key in currentRoute.params) { if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) > -1) { location.params[key] = currentRoute.params[key]; } } } if (record) { location.path = fillParams( record.path, location.params, `named route &quot;${name}&quot;` ); return _createRoute(record, location, redirectedFrom); } } else if (location.path) { location.params = {}; for (let i = 0; i < pathList.length; i++) { const path = pathList[i]; const record = pathMap[path]; if (matchRoute(record.regex, location.path, location.params)) { return _createRoute(record, location, redirectedFrom); } } } return _createRoute(null, location); } // ... return { match, addRoutes }; } route-map 传入 option.routes（开发者写的路由表）返回一个数组两个对象：
"><title>VueRouter 2.x 源码学习 · I AM BEA, I DRINK TEA</title>
<link rel="canonical" href="https://ElementRef.github.io/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><link rel="stylesheet" href="/scss/style.min.30cd3e7b84ff4cd8d6b6cf6b1a0f3b6922de6b38f2970fd914982d09106f2eef.css"><meta property="og:title" content="VueRouter 2.x 源码学习"><meta property="og:description" content="Vue.use(Router) Vue.use 会调用 Router 的静态 install 方法：
保存 Vue 构造函数，方便其他组件调用 Vue 的工具函数； 在每个 Vue 实例中混入钩子： 定义 _routerRoot、_router、_route（getter/setter）； 调用 Router 实例的 init 方法； 注册路由实例。 在 Vue 原型上挂载 $router、$route； 注册 router-view 和 router-link 组件。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 export let _Vue; // 别的地方有用到 _Vue.extend export function install(Vue) { // 防止重复 install if (install.installed) return; install.installed = true; // 保存 Vue _Vue = Vue; const isDef = v => v !== undefined; const registerInstance = (vm, callVal) => { let i = vm.$options._parentVnode; if ( isDef(i) &amp;&amp; isDef((i = i.data)) &amp;&amp; isDef((i = i.registerRouteInstance)) ) { /** * 调用 vm.$options._parentVnode.data.registerRouteInstance * data.registerRouteInstance 存在于 router-view 中 */ i(vm, callVal); } }; // 混入钩子（确保每个 vm 都能访问到路由） Vue.mixin({ beforeCreate() { // new Vue({router, ...})，挂载根实例，如果是根 vm if (isDef(this.$options.router)) { // _routerRoot 指向根组件实例 this._routerRoot = this; // 传入的 new Router({mode, routes, ...}) this._router = this.$options.router; /** * 调用 _router 的 init 方法，将 this 保存到数组里 * 监听 history，有变化会更新所有 this 里的 route */ this._router.init(this); /** * defineReactive(obj, key, val, customSetter, shallow) * 将 this._route 转化为 getter/setter，render 被调用时 * router.view 会访问 this._route，触发 getter * 当 this._route 更新后，setter 调用 * router.view 渲染匹配的组件 */ Vue.util.defineReactive(this, '_route', this._router.history.current); } else { // 如果不是根组件，向上（从父级）查找 _routerRoot this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this; } registerInstance(this, this); }, destroyed() { registerInstance(this); } }); /** * 直接在原型链上添加 $router/$route，都指向 _routerRoot 上对应的属性 * vm.$router = this._routerRoot._router = new Router({mode, routes, ...}) * vm.$route = this._routerRoot._route */ Object.defineProperty(Vue.prototype, '$router', { get() { // 都指向 new VueRouter({...}) return this._routerRoot._router; } }); Object.defineProperty(Vue.prototype, '$route', { get() { // 都指向 this._router.history.current return this._routerRoot._route; } }); // 全局注册 router-view 和 router-link 组件 Vue.component('router-view', View); Vue.component('router-link', Link); const strats = Vue.config.optionMergeStrategies; strats.beforeRouteEnter = strats.beforeRouteLeave = strats.created; } VueRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 export default class VueRouter { static install: () => void; static version: string; app: any; apps: Array<any>; ready: boolean; readyCbs: Array<Function>; options: RouterOptions; mode: string; history: HashHistory | HTML5History | AbstractHistory; matcher: Matcher; fallback: boolean; beforeHooks: Array<?NavigationGuard>; resolveHooks: Array<?NavigationGuard>; afterHooks: Array<?AfterNavigationHook>; constructor(options: RouterOptions = {}) { this.app = null; this.apps = []; this.options = options; this.beforeHooks = []; this.resolveHooks = []; this.afterHooks = []; this.matcher = createMatcher(options.routes || [], this); // 默认 hash 模式 let mode = options.mode || 'hash'; this.fallback = // 不支持 history，退回 hash mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false; if (this.fallback) { mode = 'hash'; } // 非浏览器环境使用 abstract 模式 if (!inBrowser) { mode = 'abstract'; } this.mode = mode; // options.base 就是&quot;基路径&quot; switch (mode) { case 'history': /** * 处理滚动行为 * 监听 popstate 并调用 transitionTo */ this.history = new HTML5History(this, options.base); break; case 'hash': /** * 处理 URL 格式 * 监听 hashchange 并调用 transitionTo */ this.history = new HashHistory(this, options.base, this.fallback); break; case 'abstract': this.history = new AbstractHistory(this, options.base); break; default: } } match(raw: RawLocation, current?: Route, redirectedFrom?: Location): Route { return this.matcher.match(raw, current, redirectedFrom); } get currentRoute() { return this.history &amp;&amp; this.history.current; } // 每个组件的 beforeCreate 会调用 init 方法，将当前实例传进来 init(app: any) { // 向 this.apps 添加当前 Vue 实例 this.apps.push(app); // 不要重复 init if (this.app) { return; } // _router.app = vm this.app = app; const history = this.history; if (history instanceof HTML5History) { /** * getCurrentLocation 就是截取掉&quot;基路径&quot;后的路径 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => /api/?abc=123#hahaha */ history.transitionTo(history.getCurrentLocation()); } else if (history instanceof HashHistory) { // 绑定 hashchange 事件 const setupHashListener = () => { history.setupListeners(); }; // 跳转一次页面，触发一次 hashchange history.transitionTo( /** * getCurrentLocation 就是截取掉 # 后边的值 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => hahaha */ history.getCurrentLocation(), setupHashListener, setupHashListener ); } /** * 路由改变的时候，所有 Vue 实例里的 _route 都要改变 * history 的 updateRoute 会调用 listen 里的回调 * _route 已经是“响应式”，会触发组件更新 */ history.listen(route => { this.apps.forEach(app => { app._route = route; }); }); } beforeEach(fn: Function): Function { return registerHook(this.beforeHooks, fn); } beforeResolve(fn: Function): Function { return registerHook(this.resolveHooks, fn); } afterEach(fn: Function): Function { return registerHook(this.afterHooks, fn); } onReady(cb: Function, errorCb?: Function) { this.history.onReady(cb, errorCb); } onError(errorCb: Function) { this.history.onError(errorCb); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.push(location, onComplete, onAbort); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.replace(location, onComplete, onAbort); } go(n: number) { this.history.go(n); } back() { this.go(-1); } forward() { this.go(1); } getMatchedComponents(to?: RawLocation | Route): Array<any> { const route: any = to ? to.matched ? to : this.resolve(to).route : this.currentRoute; if (!route) { return []; } return [].concat.apply( [], route.matched.map(m => { return Object.keys(m.components).map(key => { return m.components[key]; }); }) ); } resolve( to: RawLocation, current?: Route, append?: boolean ): { location: Location; route: Route; href: string; normalizedTo: Location; resolved: Route; } { const location = normalizeLocation( to, current || this.history.current, append, this ); const route = this.match(location, current); const fullPath = route.redirectedFrom || route.fullPath; const base = this.history.base; const href = createHref(base, fullPath, this.mode); return { location, route, href, normalizedTo: location, resolved: route }; } addRoutes(routes: Array<RouteConfig>) { this.matcher.addRoutes(routes); if (this.history.current !== START) { this.history.transitionTo(this.history.getCurrentLocation()); } } } BaseHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 export class History { base: string; cb: (r: Route) => void; current: Route; errorCbs: Array<Function>; pending: ?Route; ready: boolean; readyCbs: Array<Function>; readyErrorCbs: Array<Function>; router: Router; /** * 需要子类去实现的方法： * ensureURL: (push?: boolean) => void; * getCurrentLocation: () => string; * go: (n: number) => void; * push: (loc: RawLocation) => void; * replace: (loc: RawLocation) => void; */ constructor(router: Router, base: ?string) { this.base = normalizeBase(base); this.current = START; this.errorCbs = []; this.pending = null; this.ready = false; this.readyCbs = []; this.readyErrorCbs = []; this.router = router; } listen(cb: Function) { // history.listen(route => { // this.apps.forEach(app => { // app._route = route; // }); // }); // 给 this.cb 赋值，会在 updateRoute 调用 this.cb // 更新应用中所有的 app._route this.cb = cb; } onReady(cb: Function, errorCb: ?Function) { if (this.ready) { cb(); } else { this.readyCbs.push(cb); if (errorCb) { this.readyErrorCbs.push(errorCb); } } } onError(errorCb: Function) { this.errorCbs.push(errorCb); } // 用于路由切换 transitionTo( location: RawLocation, onComplete?: Function, onAbort?: Function ) { // 匹配目标 location 的 route const route = this.router.match(location, this.current); // 确认切换（异步） this.confirmTransition( route, // onComplete () => { this.updateRoute(route); // 更新 route onComplete &amp;&amp; onComplete(route); this.ensureURL(); if (!this.ready) { this.ready = true; this.readyCbs.forEach(cb => { cb(route); }); } }, // onAbort err => { if (onAbort) { onAbort(err); } if (err &amp;&amp; !this.ready) { this.ready = true; this.readyErrorCbs.forEach(cb => { cb(err); }); } } ); } confirmTransition(route: Route, onComplete: Function, onAbort?: Function) { const current = this.current; // 导航取消的时候调用 const abort = err => { if (isError(err)) { if (this.errorCbs.length) { this.errorCbs.forEach(cb => { cb(err); }); } else { console.error(err); } } onAbort &amp;&amp; onAbort(err); }; if ( // 如果 route 和 current 是相同路径（path、hash、query、params 一样） isSameRoute(route, current) &amp;&amp; // 并且匹配的长度一致 route.matched.length === current.matched.length ) { // 就没必要跳转 this.ensureURL(); return abort(); } // 找出 currentRecord 和 nextRecord 中的相同与不同 const { updated, // 相同但需要更新的 deactivated, // currentRecord 独有的 activated // nextRecord 独有的 } = resolveQueue( this.current.matched, // currentRecord 数组 route.matched // nextRecord 数组 ); /** * 导航被触发 * 在失活的组件里调用 beforeRouteLeave 守卫 * 调用全局的 beforeEach 守卫 * 在重用的组件里调用 beforeRouteUpdate 守卫 * 在路由配置里调用 beforeEnter * 解析异步路由组件 * 在被激活的组件里调用 beforeRouteEnter * 调用全局的 beforeResolve 守卫 * 导航被确认 * 调用全局的 afterEach 钩子 * 触发 DOM 更新 * 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 */ const queue: Array<?NavigationGuard> = [].concat( // 组件内部的 beforeRouteLeave extractLeaveGuards(deactivated), // 全局 beforeEach this.router.beforeHooks, // 组件内部的 beforeRouteUpdate extractUpdateHooks(updated), // routes 路由表里写的 beforeEnter activated.map(m => m.beforeEnter), // 解析异步路由组件，会等待异步组件的加载，加载完成之后再导航 resolveAsyncComponents(activated) ); this.pending = route; const iterator = (hook: NavigationGuard, next) => { // next 被调用之后，会去拿数组里的下一个钩子函数 if (this.pending !== route) { return abort(); } try { // 有点 to、from、next 那味儿了 hook(route, current, (to: any) => { if (to === false || isError(to)) { // next(false) -> 停止导航 this.ensureURL(true); abort(to); } else if ( typeof to === 'string' || (typeof to === 'object' &amp;&amp; (typeof to.path === 'string' || typeof to.name === 'string')) ) { // next('/') 或 next({ path: '/' }) -> 重定向 abort(); if (typeof to === 'object' &amp;&amp; to.replace) { this.replace(to); } else { this.push(to); } } else { next(to); } }); } catch (e) { abort(e); } }; runQueue( queue, // 保存了要执行的钩子函数 iterator, // queue 里的钩子会被一个一个的拿到 iterator 里执行 () => { // queue 里的钩子被全部调用完成之后，会执行此函数 const postEnterCbs = []; const isValid = () => this.current === route; // 获取组件里 beforeRouteEnter 钩子 const enterGuards = extractEnterGuards( activated, postEnterCbs, isValid ); // 拼接上全局 beforeResolve 钩子 const queue = enterGuards.concat(this.router.resolveHooks); runQueue(queue, iterator, () => { // 新的 queue 里的钩子被全部调用完成之后，会执行此函数 if (this.pending !== route) { return abort(); } this.pending = null; onComplete(route); if (this.router.app) { // 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 this.router.app.$nextTick(() => { postEnterCbs.forEach(cb => { cb(); }); }); } }); } ); } updateRoute(route: Route) { const prev = this.current; this.current = route; // 调用 this.cb（init 的时候，由 history.listen 赋值） this.cb &amp;&amp; this.cb(route); this.router.afterHooks.forEach(hook => { hook &amp;&amp; hook(route, prev); }); } } export function runQueue( queue: Array<?NavigationGuard>, fn: Function, cb: Function ) { const step = index => { if (index >= queue.length) { cb(); } else { if (queue[index]) { fn(queue[index], () => { step(index + 1); }); } else { step(index + 1); } } }; step(0); } HTML5History 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 export class HTML5History extends History { constructor(router: Router, base: ?string) { super(router, base); const expectScroll = router.options.scrollBehavior; if (expectScroll) { // popstate 时，保存滚动位置 setupScroll(); } /** * 调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件 * popstate 事件只会在浏览器后退按钮或调用 history.back() 方法时触发 * 即，在同一文档的两个历史记录条目之间导航会触发该事件 * 重新调用 transitionTo 完成页面切换 */ window.addEventListener('popstate', e => { const current = this.current; this.transitionTo(getLocation(this.base), route => { if (expectScroll) { /** * handleScroll(router, to, from, isPop) * 调用 getScrollPosition 获取滚动位置（保存在 history 的 state 里） * 调用 router.options.scrollBehavior(to, from, position) 判断是否需要滚动 * 调用 window.scrollTo 进行滚动 */ handleScroll(router, route, current, true); } }); }); } go(n: number) { window.history.go(n); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { pushState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { replaceState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } ensureURL(push?: boolean) { if (getLocation(this.base) !== this.current.fullPath) { const current = cleanPath(this.base + this.current.fullPath); push ? pushState(current) : replaceState(current); } } getCurrentLocation(): string { return getLocation(this.base); } } HashHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 export class HashHistory extends History { constructor(router: Router, base: ?string, fallback: boolean) { super(router, base); /** * checkFallback 会把 HTML5History 格式的链接转换为 HashHistory 格式的链接 * 然后 location.replace 掉 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * checkFallback => https://router.vuejs.org/zh/#/api/?abc=123#hahaha */ if (fallback &amp;&amp; checkFallback(this.base)) { return; } // /zh#/api/?abc=123#hahaha replace 成为 /zh/#/api/?abc=123#hahaha ensureSlash(); // 保证 # 前边有 / } // 延迟到应用挂载，防止事件过早触发 setupListeners() { window.addEventListener('hashchange', () => { if (!ensureSlash()) { return; } // 获取 hash 并跳转 this.transitionTo(getHash(), route => { replaceHash(route.fullPath); }); }); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 赋值 window.location.hash pushHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 调用 window.location.replace replaceHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } go(n: number) { window.history.go(n); } ensureURL(push?: boolean) { const current = this.current.fullPath; if (getHash() !== current) { push ? pushHash(current) : replaceHash(current); } } getCurrentLocation() { return getHash(); } } matcher 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 export function createMatcher( routes: Array<RouteConfig>, // options.routes router: VueRouter // VueRouter 实例 ): Matcher { // 把传入的路由表转换为路由映射表 const { pathList, pathMap, nameMap } = createRouteMap(routes); // addRoutes 就是把新来的 routes 添加到 pathList, pathMap, nameMap 里 function addRoutes(routes) { createRouteMap(routes, pathList, pathMap, nameMap); } // 根据 RawLocation 和 currentRoute 返回一个 route function match( raw: RawLocation, // url 或者 Location 对象 currentRoute?: Route, redirectedFrom?: Location ): Route { const location = normalizeLocation(raw, currentRoute, false, router); const { name } = location; if (name) { const record = nameMap[name]; // 获取 name 对应的 record if (!record) return _createRoute(null, location); const paramNames = record.regex.keys .filter(key => !key.optional) .map(key => key.name); if (typeof location.params !== 'object') { location.params = {}; } if (currentRoute &amp;&amp; typeof currentRoute.params === 'object') { for (const key in currentRoute.params) { if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) > -1) { location.params[key] = currentRoute.params[key]; } } } if (record) { location.path = fillParams( record.path, location.params, `named route &quot;${name}&quot;` ); return _createRoute(record, location, redirectedFrom); } } else if (location.path) { location.params = {}; for (let i = 0; i < pathList.length; i++) { const path = pathList[i]; const record = pathMap[path]; if (matchRoute(record.regex, location.path, location.params)) { return _createRoute(record, location, redirectedFrom); } } } return _createRoute(null, location); } // ... return { match, addRoutes }; } route-map 传入 option.routes（开发者写的路由表）返回一个数组两个对象：
"><meta property="og:url" content="https://ElementRef.github.io/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><meta property="og:site_name" content="馬腊咯稽"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2022-01-06T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-06T00:00:00+00:00"><meta property="og:image" content="https://ElementRef.github.io/img/cover/vue.png"><meta property="og:logo" content="/og-logo.png"><meta name="twitter:title" content="VueRouter 2.x 源码学习"><meta name="twitter:description" content="Vue.use(Router) Vue.use 会调用 Router 的静态 install 方法：
保存 Vue 构造函数，方便其他组件调用 Vue 的工具函数； 在每个 Vue 实例中混入钩子： 定义 _routerRoot、_router、_route（getter/setter）； 调用 Router 实例的 init 方法； 注册路由实例。 在 Vue 原型上挂载 $router、$route； 注册 router-view 和 router-link 组件。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 export let _Vue; // 别的地方有用到 _Vue.extend export function install(Vue) { // 防止重复 install if (install.installed) return; install.installed = true; // 保存 Vue _Vue = Vue; const isDef = v => v !== undefined; const registerInstance = (vm, callVal) => { let i = vm.$options._parentVnode; if ( isDef(i) &amp;&amp; isDef((i = i.data)) &amp;&amp; isDef((i = i.registerRouteInstance)) ) { /** * 调用 vm.$options._parentVnode.data.registerRouteInstance * data.registerRouteInstance 存在于 router-view 中 */ i(vm, callVal); } }; // 混入钩子（确保每个 vm 都能访问到路由） Vue.mixin({ beforeCreate() { // new Vue({router, ...})，挂载根实例，如果是根 vm if (isDef(this.$options.router)) { // _routerRoot 指向根组件实例 this._routerRoot = this; // 传入的 new Router({mode, routes, ...}) this._router = this.$options.router; /** * 调用 _router 的 init 方法，将 this 保存到数组里 * 监听 history，有变化会更新所有 this 里的 route */ this._router.init(this); /** * defineReactive(obj, key, val, customSetter, shallow) * 将 this._route 转化为 getter/setter，render 被调用时 * router.view 会访问 this._route，触发 getter * 当 this._route 更新后，setter 调用 * router.view 渲染匹配的组件 */ Vue.util.defineReactive(this, '_route', this._router.history.current); } else { // 如果不是根组件，向上（从父级）查找 _routerRoot this._routerRoot = (this.$parent &amp;&amp; this.$parent._routerRoot) || this; } registerInstance(this, this); }, destroyed() { registerInstance(this); } }); /** * 直接在原型链上添加 $router/$route，都指向 _routerRoot 上对应的属性 * vm.$router = this._routerRoot._router = new Router({mode, routes, ...}) * vm.$route = this._routerRoot._route */ Object.defineProperty(Vue.prototype, '$router', { get() { // 都指向 new VueRouter({...}) return this._routerRoot._router; } }); Object.defineProperty(Vue.prototype, '$route', { get() { // 都指向 this._router.history.current return this._routerRoot._route; } }); // 全局注册 router-view 和 router-link 组件 Vue.component('router-view', View); Vue.component('router-link', Link); const strats = Vue.config.optionMergeStrategies; strats.beforeRouteEnter = strats.beforeRouteLeave = strats.created; } VueRouter 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 export default class VueRouter { static install: () => void; static version: string; app: any; apps: Array<any>; ready: boolean; readyCbs: Array<Function>; options: RouterOptions; mode: string; history: HashHistory | HTML5History | AbstractHistory; matcher: Matcher; fallback: boolean; beforeHooks: Array<?NavigationGuard>; resolveHooks: Array<?NavigationGuard>; afterHooks: Array<?AfterNavigationHook>; constructor(options: RouterOptions = {}) { this.app = null; this.apps = []; this.options = options; this.beforeHooks = []; this.resolveHooks = []; this.afterHooks = []; this.matcher = createMatcher(options.routes || [], this); // 默认 hash 模式 let mode = options.mode || 'hash'; this.fallback = // 不支持 history，退回 hash mode === 'history' &amp;&amp; !supportsPushState &amp;&amp; options.fallback !== false; if (this.fallback) { mode = 'hash'; } // 非浏览器环境使用 abstract 模式 if (!inBrowser) { mode = 'abstract'; } this.mode = mode; // options.base 就是&quot;基路径&quot; switch (mode) { case 'history': /** * 处理滚动行为 * 监听 popstate 并调用 transitionTo */ this.history = new HTML5History(this, options.base); break; case 'hash': /** * 处理 URL 格式 * 监听 hashchange 并调用 transitionTo */ this.history = new HashHistory(this, options.base, this.fallback); break; case 'abstract': this.history = new AbstractHistory(this, options.base); break; default: } } match(raw: RawLocation, current?: Route, redirectedFrom?: Location): Route { return this.matcher.match(raw, current, redirectedFrom); } get currentRoute() { return this.history &amp;&amp; this.history.current; } // 每个组件的 beforeCreate 会调用 init 方法，将当前实例传进来 init(app: any) { // 向 this.apps 添加当前 Vue 实例 this.apps.push(app); // 不要重复 init if (this.app) { return; } // _router.app = vm this.app = app; const history = this.history; if (history instanceof HTML5History) { /** * getCurrentLocation 就是截取掉&quot;基路径&quot;后的路径 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => /api/?abc=123#hahaha */ history.transitionTo(history.getCurrentLocation()); } else if (history instanceof HashHistory) { // 绑定 hashchange 事件 const setupHashListener = () => { history.setupListeners(); }; // 跳转一次页面，触发一次 hashchange history.transitionTo( /** * getCurrentLocation 就是截取掉 # 后边的值 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * getCurrentLocation => hahaha */ history.getCurrentLocation(), setupHashListener, setupHashListener ); } /** * 路由改变的时候，所有 Vue 实例里的 _route 都要改变 * history 的 updateRoute 会调用 listen 里的回调 * _route 已经是“响应式”，会触发组件更新 */ history.listen(route => { this.apps.forEach(app => { app._route = route; }); }); } beforeEach(fn: Function): Function { return registerHook(this.beforeHooks, fn); } beforeResolve(fn: Function): Function { return registerHook(this.resolveHooks, fn); } afterEach(fn: Function): Function { return registerHook(this.afterHooks, fn); } onReady(cb: Function, errorCb?: Function) { this.history.onReady(cb, errorCb); } onError(errorCb: Function) { this.history.onError(errorCb); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.push(location, onComplete, onAbort); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.history.replace(location, onComplete, onAbort); } go(n: number) { this.history.go(n); } back() { this.go(-1); } forward() { this.go(1); } getMatchedComponents(to?: RawLocation | Route): Array<any> { const route: any = to ? to.matched ? to : this.resolve(to).route : this.currentRoute; if (!route) { return []; } return [].concat.apply( [], route.matched.map(m => { return Object.keys(m.components).map(key => { return m.components[key]; }); }) ); } resolve( to: RawLocation, current?: Route, append?: boolean ): { location: Location; route: Route; href: string; normalizedTo: Location; resolved: Route; } { const location = normalizeLocation( to, current || this.history.current, append, this ); const route = this.match(location, current); const fullPath = route.redirectedFrom || route.fullPath; const base = this.history.base; const href = createHref(base, fullPath, this.mode); return { location, route, href, normalizedTo: location, resolved: route }; } addRoutes(routes: Array<RouteConfig>) { this.matcher.addRoutes(routes); if (this.history.current !== START) { this.history.transitionTo(this.history.getCurrentLocation()); } } } BaseHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 export class History { base: string; cb: (r: Route) => void; current: Route; errorCbs: Array<Function>; pending: ?Route; ready: boolean; readyCbs: Array<Function>; readyErrorCbs: Array<Function>; router: Router; /** * 需要子类去实现的方法： * ensureURL: (push?: boolean) => void; * getCurrentLocation: () => string; * go: (n: number) => void; * push: (loc: RawLocation) => void; * replace: (loc: RawLocation) => void; */ constructor(router: Router, base: ?string) { this.base = normalizeBase(base); this.current = START; this.errorCbs = []; this.pending = null; this.ready = false; this.readyCbs = []; this.readyErrorCbs = []; this.router = router; } listen(cb: Function) { // history.listen(route => { // this.apps.forEach(app => { // app._route = route; // }); // }); // 给 this.cb 赋值，会在 updateRoute 调用 this.cb // 更新应用中所有的 app._route this.cb = cb; } onReady(cb: Function, errorCb: ?Function) { if (this.ready) { cb(); } else { this.readyCbs.push(cb); if (errorCb) { this.readyErrorCbs.push(errorCb); } } } onError(errorCb: Function) { this.errorCbs.push(errorCb); } // 用于路由切换 transitionTo( location: RawLocation, onComplete?: Function, onAbort?: Function ) { // 匹配目标 location 的 route const route = this.router.match(location, this.current); // 确认切换（异步） this.confirmTransition( route, // onComplete () => { this.updateRoute(route); // 更新 route onComplete &amp;&amp; onComplete(route); this.ensureURL(); if (!this.ready) { this.ready = true; this.readyCbs.forEach(cb => { cb(route); }); } }, // onAbort err => { if (onAbort) { onAbort(err); } if (err &amp;&amp; !this.ready) { this.ready = true; this.readyErrorCbs.forEach(cb => { cb(err); }); } } ); } confirmTransition(route: Route, onComplete: Function, onAbort?: Function) { const current = this.current; // 导航取消的时候调用 const abort = err => { if (isError(err)) { if (this.errorCbs.length) { this.errorCbs.forEach(cb => { cb(err); }); } else { console.error(err); } } onAbort &amp;&amp; onAbort(err); }; if ( // 如果 route 和 current 是相同路径（path、hash、query、params 一样） isSameRoute(route, current) &amp;&amp; // 并且匹配的长度一致 route.matched.length === current.matched.length ) { // 就没必要跳转 this.ensureURL(); return abort(); } // 找出 currentRecord 和 nextRecord 中的相同与不同 const { updated, // 相同但需要更新的 deactivated, // currentRecord 独有的 activated // nextRecord 独有的 } = resolveQueue( this.current.matched, // currentRecord 数组 route.matched // nextRecord 数组 ); /** * 导航被触发 * 在失活的组件里调用 beforeRouteLeave 守卫 * 调用全局的 beforeEach 守卫 * 在重用的组件里调用 beforeRouteUpdate 守卫 * 在路由配置里调用 beforeEnter * 解析异步路由组件 * 在被激活的组件里调用 beforeRouteEnter * 调用全局的 beforeResolve 守卫 * 导航被确认 * 调用全局的 afterEach 钩子 * 触发 DOM 更新 * 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 */ const queue: Array<?NavigationGuard> = [].concat( // 组件内部的 beforeRouteLeave extractLeaveGuards(deactivated), // 全局 beforeEach this.router.beforeHooks, // 组件内部的 beforeRouteUpdate extractUpdateHooks(updated), // routes 路由表里写的 beforeEnter activated.map(m => m.beforeEnter), // 解析异步路由组件，会等待异步组件的加载，加载完成之后再导航 resolveAsyncComponents(activated) ); this.pending = route; const iterator = (hook: NavigationGuard, next) => { // next 被调用之后，会去拿数组里的下一个钩子函数 if (this.pending !== route) { return abort(); } try { // 有点 to、from、next 那味儿了 hook(route, current, (to: any) => { if (to === false || isError(to)) { // next(false) -> 停止导航 this.ensureURL(true); abort(to); } else if ( typeof to === 'string' || (typeof to === 'object' &amp;&amp; (typeof to.path === 'string' || typeof to.name === 'string')) ) { // next('/') 或 next({ path: '/' }) -> 重定向 abort(); if (typeof to === 'object' &amp;&amp; to.replace) { this.replace(to); } else { this.push(to); } } else { next(to); } }); } catch (e) { abort(e); } }; runQueue( queue, // 保存了要执行的钩子函数 iterator, // queue 里的钩子会被一个一个的拿到 iterator 里执行 () => { // queue 里的钩子被全部调用完成之后，会执行此函数 const postEnterCbs = []; const isValid = () => this.current === route; // 获取组件里 beforeRouteEnter 钩子 const enterGuards = extractEnterGuards( activated, postEnterCbs, isValid ); // 拼接上全局 beforeResolve 钩子 const queue = enterGuards.concat(this.router.resolveHooks); runQueue(queue, iterator, () => { // 新的 queue 里的钩子被全部调用完成之后，会执行此函数 if (this.pending !== route) { return abort(); } this.pending = null; onComplete(route); if (this.router.app) { // 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入 this.router.app.$nextTick(() => { postEnterCbs.forEach(cb => { cb(); }); }); } }); } ); } updateRoute(route: Route) { const prev = this.current; this.current = route; // 调用 this.cb（init 的时候，由 history.listen 赋值） this.cb &amp;&amp; this.cb(route); this.router.afterHooks.forEach(hook => { hook &amp;&amp; hook(route, prev); }); } } export function runQueue( queue: Array<?NavigationGuard>, fn: Function, cb: Function ) { const step = index => { if (index >= queue.length) { cb(); } else { if (queue[index]) { fn(queue[index], () => { step(index + 1); }); } else { step(index + 1); } } }; step(0); } HTML5History 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 export class HTML5History extends History { constructor(router: Router, base: ?string) { super(router, base); const expectScroll = router.options.scrollBehavior; if (expectScroll) { // popstate 时，保存滚动位置 setupScroll(); } /** * 调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件 * popstate 事件只会在浏览器后退按钮或调用 history.back() 方法时触发 * 即，在同一文档的两个历史记录条目之间导航会触发该事件 * 重新调用 transitionTo 完成页面切换 */ window.addEventListener('popstate', e => { const current = this.current; this.transitionTo(getLocation(this.base), route => { if (expectScroll) { /** * handleScroll(router, to, from, isPop) * 调用 getScrollPosition 获取滚动位置（保存在 history 的 state 里） * 调用 router.options.scrollBehavior(to, from, position) 判断是否需要滚动 * 调用 window.scrollTo 进行滚动 */ handleScroll(router, route, current, true); } }); }); } go(n: number) { window.history.go(n); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { pushState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { const { current: fromRoute } = this; this.transitionTo( location, route => { replaceState(cleanPath(this.base + route.fullPath)); handleScroll(this.router, route, fromRoute, false); onComplete &amp;&amp; onComplete(route); }, onAbort ); } ensureURL(push?: boolean) { if (getLocation(this.base) !== this.current.fullPath) { const current = cleanPath(this.base + this.current.fullPath); push ? pushState(current) : replaceState(current); } } getCurrentLocation(): string { return getLocation(this.base); } } HashHistory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 export class HashHistory extends History { constructor(router: Router, base: ?string, fallback: boolean) { super(router, base); /** * checkFallback 会把 HTML5History 格式的链接转换为 HashHistory 格式的链接 * 然后 location.replace 掉 * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh * checkFallback => https://router.vuejs.org/zh/#/api/?abc=123#hahaha */ if (fallback &amp;&amp; checkFallback(this.base)) { return; } // /zh#/api/?abc=123#hahaha replace 成为 /zh/#/api/?abc=123#hahaha ensureSlash(); // 保证 # 前边有 / } // 延迟到应用挂载，防止事件过早触发 setupListeners() { window.addEventListener('hashchange', () => { if (!ensureSlash()) { return; } // 获取 hash 并跳转 this.transitionTo(getHash(), route => { replaceHash(route.fullPath); }); }); } push(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 赋值 window.location.hash pushHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } replace(location: RawLocation, onComplete?: Function, onAbort?: Function) { this.transitionTo( location, route => { // 调用 window.location.replace replaceHash(route.fullPath); onComplete &amp;&amp; onComplete(route); }, onAbort ); } go(n: number) { window.history.go(n); } ensureURL(push?: boolean) { const current = this.current.fullPath; if (getHash() !== current) { push ? pushHash(current) : replaceHash(current); } } getCurrentLocation() { return getHash(); } } matcher 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 export function createMatcher( routes: Array<RouteConfig>, // options.routes router: VueRouter // VueRouter 实例 ): Matcher { // 把传入的路由表转换为路由映射表 const { pathList, pathMap, nameMap } = createRouteMap(routes); // addRoutes 就是把新来的 routes 添加到 pathList, pathMap, nameMap 里 function addRoutes(routes) { createRouteMap(routes, pathList, pathMap, nameMap); } // 根据 RawLocation 和 currentRoute 返回一个 route function match( raw: RawLocation, // url 或者 Location 对象 currentRoute?: Route, redirectedFrom?: Location ): Route { const location = normalizeLocation(raw, currentRoute, false, router); const { name } = location; if (name) { const record = nameMap[name]; // 获取 name 对应的 record if (!record) return _createRoute(null, location); const paramNames = record.regex.keys .filter(key => !key.optional) .map(key => key.name); if (typeof location.params !== 'object') { location.params = {}; } if (currentRoute &amp;&amp; typeof currentRoute.params === 'object') { for (const key in currentRoute.params) { if (!(key in location.params) &amp;&amp; paramNames.indexOf(key) > -1) { location.params[key] = currentRoute.params[key]; } } } if (record) { location.path = fillParams( record.path, location.params, `named route &quot;${name}&quot;` ); return _createRoute(record, location, redirectedFrom); } } else if (location.path) { location.params = {}; for (let i = 0; i < pathList.length; i++) { const path = pathList[i]; const record = pathMap[path]; if (matchRoute(record.regex, location.path, location.params)) { return _createRoute(record, location, redirectedFrom); } } } return _createRoute(null, location); } // ... return { match, addRoutes }; } route-map 传入 option.routes（开发者写的路由表）返回一个数组两个对象：
"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://ElementRef.github.io/img/cover/vue.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><meta http-equiv="Content-Security-Policy" content=" default-src 'self'; img-src 'self' data: https:; frame-src 'self' *.bilibili.com *.qq.com *.youtube.com https://youtu.be https://giscus.app; connect-src 'self' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; font-src 'self' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; script-src 'self' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; style-src 'self' 'unsafe-inline' https://umami.pavilion0321907.workers.dev https://cdn.jsdelivr.net https://cusdis.com https://giscus.app https://utteranc.es https://unpkg.com https://gitlab.com; upgrade-insecure-requests"><script src="https://umami.pavilion0321907.workers.dev/elementref.js" data-website-id="87868be0-a9cf-4f8c-8fee-e3cbb99e6cf2" crossorigin="anonymous" defer=""></script></head><body class="article-page"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="flex container extended main-container on-phone--column"><aside class="sidebar sticky left-sidebar"><button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
<span class="hamburger-box"><span class="hamburger-inner"></span></span></button><header><figure class="site-avatar"><a href="/"><img src="/img/avatar_hu15751654176150258532.webp" width="300" height="404" class="site-logo" alt="Avatar" fetchpriority="high" decoding="async"></a></figure><div class="site-meta"><h1 class="site-name"><a href="/">馬腊咯稽</a></h1><h2 class="site-description">I AM BEA, I DRINK TEA</h2></div></header><ol class="social-menu"><li><a href="https://github.com/ElementRef" target="_blank" title="GitHub"><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"></path></svg></a></li><li><a href="https://m.weibo.cn/u/6447635754" target="_blank" title="Weibo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-weibo"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M19 14.127C19 17.2 15.498 20 11 20c-4.126.0-8-2.224-8-5.565.0-1.78.984-3.737 2.7-5.567 2.362-2.51 5.193-3.687 6.551-2.238.415.44.752 1.39.749 2.062 2-1.615 4.308.387 3.5 2.693 1.26.557 2.5.538 2.5 2.742z"></path><path d="M15 4h1a5 5 0 015 5v1"></path></svg></a></li><li><a href="https://douban.com/people/nicknoonan" target="_blank" title="DouBan"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-douban"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 20h16"></path><path d="M5 4h14"></path><path d="M8 8h8a2 2 0 012 2v2a2 2 0 01-2 2H8a2 2 0 01-2-2v-2a2 2 0 012-2z"></path><path d="M16 14l-2 6"></path><path d="M8 17l1 3"></path></svg></a></li><li><a href="https://x.com/SpiciComic" target="_blank" title="Twitter"><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"></path></svg></a></li><li><a href="https://last.fm/zh/user/SpiciComic/listening-report" target="_blank" title="Last.fm"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-lastfm"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M20 8c-.83-1-1.388-1-2-1-.612.0-2 .271-2 2s1.384 2.233 3 3 2.125 1.812 2 3-1 2-3 2-3-1-3.5-2-1.585-4.78-2.497-6a5 5 0 10-1 7"></path></svg></a></li></ol><ol class="menu" id="main-menu"><li><a href="/"><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><polyline points="5 12 3 12 12 3 21 12 19 12"></polyline><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"></path></svg>
<span>首页</span></a></li><li><a href="/archives/"><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><rect x="3" y="4" width="18" height="4" rx="2"></rect><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"></path><line x1="10" y1="12" x2="14" y2="12"></line></svg>
<span>归档</span></a></li><li><a href="/search/"><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
<span>搜索</span></a></li><li><a href="/%E5%90%AF%E5%8F%91/"><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"></path><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"></path></svg>
<span>启发</span></a></li><li><a href="/%E5%91%BD%E4%BB%A4/"><svg class="icon icon-tabler icon-tabler-terminal" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M5 7l5 5-5 5"></path><line x1="12" y1="19" x2="19" y2="19"></line></svg>
<span>命令</span></a></li><li><a href="/%E5%85%B3%E4%BA%8E/"><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="7" r="4"></circle><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"></path></svg>
<span>关于</span></a></li><div class="menu-bottom-section"><li id="dark-mode-toggle"><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="8" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="16" cy="12" r="2"></circle><rect x="2" y="6" width="20" height="12" rx="6"></rect></svg>
<span>深色</span></li></div></ol></aside><main class="full-width main"><article class="has-image main-article"><header class="article-header"><div class="article-image"><a href="/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><img src="/img/cover/vue.webp" alt="VueRouter 2.x 源码学习" fetchpriority="high" decoding="async" width="1200" height="720" jampack-sized="true"></a></div><div class="article-details"><header class="article-category"><a href="/categories/vue/">Vue</a></header><div class="article-title-wrapper"><h2 class="article-title"><a href="/p/vuerouter-2.x-%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">VueRouter 2.x 源码学习</a></h2></div><footer class="article-time"><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"></path><circle cx="18" cy="18" r="4"></circle><path d="M15 3v4"></path><path d="M7 3v4"></path><path d="M3 11h16"></path><path d="M18 16.496V18l1 1"></path></svg>
<time class="article-time--published">Jan 06, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
<time class="article-time--reading">阅读时长：12 分钟</time></div></footer></div></header><section class="article-content"><h2 id="vueuserouter">Vue.use(Router)</h2><p>Vue.use 会调用 Router 的静态 install 方法：</p><ol><li>保存 Vue 构造函数，方便其他组件调用 Vue 的工具函数；</li><li>在每个 Vue 实例中混入钩子：<ol><li>定义 _routerRoot、_router、_route（getter/setter）；</li><li>调用 Router 实例的 init 方法；</li><li>注册路由实例。</li></ol></li><li>在 Vue 原型上挂载 $router、$route；</li><li>注册 router-view 和 router-link 组件。</li></ol><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">let</span> <span class="nx">_Vue</span><span class="p">;</span> <span class="c1">// 别的地方有用到 _Vue.extend
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">install</span><span class="p">(</span><span class="nx">Vue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 防止重复 install
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">install</span><span class="p">.</span><span class="nx">installed</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">install</span><span class="p">.</span><span class="nx">installed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 保存 Vue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">_Vue</span> <span class="o">=</span> <span class="nx">Vue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">isDef</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">registerInstance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">callVal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">_parentVnode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">isDef</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">isDef</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">isDef</span><span class="p">((</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">registerRouteInstance</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 调用 vm.$options._parentVnode.data.registerRouteInstance
</span></span></span><span class="line"><span class="cl"><span class="cm">       * data.registerRouteInstance 存在于 router-view 中
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">i</span><span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">callVal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 混入钩子（确保每个 vm 都能访问到路由）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">Vue</span><span class="p">.</span><span class="nx">mixin</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">beforeCreate() {</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// new Vue({router, ...})，挂载根实例，如果是根 vm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">isDef</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">router</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// _routerRoot 指向根组件实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 传入的 new Router({mode, routes, ...})
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_router</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">router</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 调用 _router 的 init 方法，将 this 保存到数组里
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 监听 history，有变化会更新所有 this 里的 route
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">_router</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * defineReactive(obj, key, val, customSetter, shallow)
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 将 this._route 转化为 getter/setter，render 被调用时
</span></span></span><span class="line"><span class="cl"><span class="cm">         * router.view 会访问 this._route，触发 getter
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 当 this._route 更新后，setter 调用
</span></span></span><span class="line"><span class="cl"><span class="cm">         * router.view 渲染匹配的组件
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Vue</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">defineReactive</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">'_route'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">_router</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果不是根组件，向上（从父级）查找 _routerRoot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$parent</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">$parent</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">)</span> <span class="o">||</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">registerInstance</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">destroyed() {</span>
</span></span><span class="line"><span class="cl">      <span class="nx">registerInstance</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 直接在原型链上添加 $router/$route，都指向 _routerRoot 上对应的属性
</span></span></span><span class="line"><span class="cl"><span class="cm">   * vm.$router = this._routerRoot._router = new Router({mode, routes, ...})
</span></span></span><span class="line"><span class="cl"><span class="cm">   * vm.$route = this._routerRoot._route
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">'$router'</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">get</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 都指向 new VueRouter({...})
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">.</span><span class="nx">_router</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">'$route'</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">get</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 都指向 this._router.history.current
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_routerRoot</span><span class="p">.</span><span class="nx">_route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 全局注册 router-view 和 router-link 组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">Vue</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="s1">'router-view'</span><span class="p">,</span> <span class="nx">View</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Vue</span><span class="p">.</span><span class="nx">component</span><span class="p">(</span><span class="s1">'router-link'</span><span class="p">,</span> <span class="nx">Link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">strats</span> <span class="o">=</span> <span class="nx">Vue</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">optionMergeStrategies</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">strats</span><span class="p">.</span><span class="nx">beforeRouteEnter</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">.</span><span class="nx">beforeRouteLeave</span> <span class="o">=</span> <span class="nx">strats</span><span class="p">.</span><span class="nx">created</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="vuerouter">VueRouter</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">VueRouter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">install</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">static</span> <span class="nx">version</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">app</span>: <span class="kt">any</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">apps</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ready</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">readyCbs</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Function</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">options</span>: <span class="kt">RouterOptions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">mode</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">history</span>: <span class="kt">HashHistory</span> <span class="o">|</span> <span class="nx">HTML5History</span> <span class="o">|</span> <span class="nx">AbstractHistory</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">matcher</span>: <span class="kt">Matcher</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fallback</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">beforeHooks</span>: <span class="kt">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resolveHooks</span>: <span class="kt">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">afterHooks</span>: <span class="kt">Array</span><span class="o">&lt;?</span><span class="nx">AfterNavigationHook</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">options</span>: <span class="kt">RouterOptions</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">apps</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">beforeHooks</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">resolveHooks</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">afterHooks</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span> <span class="o">=</span> <span class="nx">createMatcher</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">routes</span> <span class="o">||</span> <span class="p">[],</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 默认 hash 模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">mode</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">mode</span> <span class="o">||</span> <span class="s1">'hash'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">fallback</span> <span class="o">=</span> <span class="c1">// 不支持 history，退回 hash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">mode</span> <span class="o">===</span> <span class="s1">'history'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">supportsPushState</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">fallback</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">fallback</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">mode</span> <span class="o">=</span> <span class="s1">'hash'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 非浏览器环境使用 abstract 模式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">inBrowser</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">mode</span> <span class="o">=</span> <span class="s1">'abstract'</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// options.base 就是"基路径"
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">switch</span> <span class="p">(</span><span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s1">'history'</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 处理滚动行为
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 监听 popstate 并调用 transitionTo
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HTML5History</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s1">'hash'</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 处理 URL 格式
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 监听 hashchange 并调用 transitionTo
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">HashHistory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fallback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="s1">'abstract'</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AbstractHistory</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">match</span><span class="p">(</span><span class="nx">raw</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">current?</span>: <span class="kt">Route</span><span class="p">,</span> <span class="nx">redirectedFrom?</span>: <span class="kt">Location</span><span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kr">get</span> <span class="nx">currentRoute() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 每个组件的 beforeCreate 会调用 init 方法，将当前实例传进来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">init</span><span class="p">(</span><span class="nx">app</span>: <span class="kt">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 向 this.apps 添加当前 Vue 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 不要重复 init
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _router.app = vm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">app</span> <span class="o">=</span> <span class="nx">app</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">history</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">history</span> <span class="k">instanceof</span> <span class="nx">HTML5History</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * getCurrentLocation 就是截取掉"基路径"后的路径
</span></span></span><span class="line"><span class="cl"><span class="cm">       * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class="line"><span class="cl"><span class="cm">       * getCurrentLocation =&gt; /api/?abc=123#hahaha
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="nx">history</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="nx">history</span><span class="p">.</span><span class="nx">getCurrentLocation</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">history</span> <span class="k">instanceof</span> <span class="nx">HashHistory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 绑定 hashchange 事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">setupHashListener</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">history</span><span class="p">.</span><span class="nx">setupListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 跳转一次页面，触发一次 hashchange
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">history</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * getCurrentLocation 就是截取掉 # 后边的值
</span></span></span><span class="line"><span class="cl"><span class="cm">         * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class="line"><span class="cl"><span class="cm">         * getCurrentLocation =&gt; hahaha
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="nx">history</span><span class="p">.</span><span class="nx">getCurrentLocation</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setupHashListener</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setupHashListener</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 路由改变的时候，所有 Vue 实例里的 _route 都要改变
</span></span></span><span class="line"><span class="cl"><span class="cm">     * history 的 updateRoute 会调用 listen 里的回调
</span></span></span><span class="line"><span class="cl"><span class="cm">     * _route 已经是“响应式”，会触发组件更新
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">history</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">apps</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">app</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">app</span><span class="p">.</span><span class="nx">_route</span> <span class="o">=</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">beforeEach</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">Function</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">registerHook</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">beforeHooks</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">beforeResolve</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">Function</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">registerHook</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">resolveHooks</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">afterEach</span><span class="p">(</span><span class="nx">fn</span>: <span class="kt">Function</span><span class="p">)</span><span class="o">:</span> <span class="nb">Function</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">registerHook</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">afterHooks</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onReady</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">errorCb?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">onReady</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">errorCb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onError</span><span class="p">(</span><span class="nx">errorCb</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">errorCb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">push</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">,</span> <span class="nx">onAbort</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">replace</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">onComplete</span><span class="p">,</span> <span class="nx">onAbort</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">go</span><span class="p">(</span><span class="nx">n</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">back() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">forward() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getMatchedComponents</span><span class="p">(</span><span class="nx">to?</span>: <span class="kt">RawLocation</span> <span class="o">|</span> <span class="nx">Route</span><span class="p">)</span><span class="o">:</span> <span class="nb">Array</span><span class="p">&lt;</span><span class="nt">any</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">route</span>: <span class="kt">any</span> <span class="o">=</span> <span class="nx">to</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="nx">to</span><span class="p">.</span><span class="nx">matched</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">to</span>
</span></span><span class="line"><span class="cl">        : <span class="kt">this.resolve</span><span class="p">(</span><span class="nx">to</span><span class="p">).</span><span class="nx">route</span>
</span></span><span class="line"><span class="cl">      : <span class="kt">this.currentRoute</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="p">[],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">components</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">resolve</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">to</span>: <span class="kt">RawLocation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">current?</span>: <span class="kt">Route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">append?</span>: <span class="kt">boolean</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">location</span>: <span class="kt">Location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span>: <span class="kt">Route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">href</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">normalizedTo</span>: <span class="kt">Location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">resolved</span>: <span class="kt">Route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">normalizeLocation</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">current</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">append</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">fullPath</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">redirectedFrom</span> <span class="o">||</span> <span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">base</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">base</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">href</span> <span class="o">=</span> <span class="nx">createHref</span><span class="p">(</span><span class="nx">base</span><span class="p">,</span> <span class="nx">fullPath</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">href</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">normalizedTo</span>: <span class="kt">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">resolved</span>: <span class="kt">route</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">addRoutes</span><span class="p">(</span><span class="nx">routes</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">RouteConfig</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">matcher</span><span class="p">.</span><span class="nx">addRoutes</span><span class="p">(</span><span class="nx">routes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">current</span> <span class="o">!==</span> <span class="nx">START</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">getCurrentLocation</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="basehistory">BaseHistory</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">History</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">base</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cb</span><span class="o">:</span> <span class="p">(</span><span class="nx">r</span>: <span class="kt">Route</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">current</span>: <span class="kt">Route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">errorCbs</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Function</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pending</span>: <span class="kt">?Route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ready</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">readyCbs</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Function</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">readyErrorCbs</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">Function</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">router</span>: <span class="kt">Router</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * 需要子类去实现的方法：
</span></span></span><span class="line"><span class="cl"><span class="cm">   * ensureURL: (push?: boolean) =&gt; void;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * getCurrentLocation: () =&gt; string;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * go: (n: number) =&gt; void;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * push: (loc: RawLocation) =&gt; void;
</span></span></span><span class="line"><span class="cl"><span class="cm">   * replace: (loc: RawLocation) =&gt; void;
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">router</span>: <span class="kt">Router</span><span class="p">,</span> <span class="nx">base</span>: <span class="kt">?string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="nx">normalizeBase</span><span class="p">(</span><span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">START</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">errorCbs</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">readyCbs</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">readyErrorCbs</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="nx">router</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">listen</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// history.listen(route =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   this.apps.forEach(app =&gt; {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//     app._route = route;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//   });
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// });
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 给 this.cb 赋值，会在 updateRoute 调用 this.cb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 更新应用中所有的 app._route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onReady</span><span class="p">(</span><span class="nx">cb</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">errorCb</span>: <span class="kt">?Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">readyCbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">cb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">errorCb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">readyErrorCbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorCb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">onError</span><span class="p">(</span><span class="nx">errorCb</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">errorCbs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorCb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 用于路由切换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">onAbort?</span>: <span class="kt">Function</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 匹配目标 location 的 route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">location</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 确认切换（异步）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">confirmTransition</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// onComplete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">updateRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span> <span class="c1">// 更新 route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">readyCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cb</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// onAbort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">onAbort</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onAbort</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">ready</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">readyErrorCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">confirmTransition</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">Route</span><span class="p">,</span> <span class="nx">onComplete</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 导航取消的时候调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">abort</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">isError</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">errorCbs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">errorCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onAbort</span> <span class="o">&amp;&amp;</span> <span class="nx">onAbort</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果 route 和 current 是相同路径（path、hash、query、params 一样）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">isSameRoute</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 并且匹配的长度一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="nx">current</span><span class="p">.</span><span class="nx">matched</span><span class="p">.</span><span class="nx">length</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 就没必要跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 找出 currentRecord 和 nextRecord 中的相同与不同
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">updated</span><span class="p">,</span> <span class="c1">// 相同但需要更新的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">deactivated</span><span class="p">,</span> <span class="c1">// currentRecord 独有的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">activated</span> <span class="c1">// nextRecord 独有的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span> <span class="o">=</span> <span class="nx">resolveQueue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">matched</span><span class="p">,</span> <span class="c1">// currentRecord 数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span> <span class="c1">// nextRecord 数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 导航被触发
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在失活的组件里调用 beforeRouteLeave 守卫
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 调用全局的 beforeEach 守卫
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在重用的组件里调用 beforeRouteUpdate 守卫
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在路由配置里调用 beforeEnter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 解析异步路由组件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 在被激活的组件里调用 beforeRouteEnter
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 调用全局的 beforeResolve 守卫
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 导航被确认
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 调用全局的 afterEach 钩子
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 触发 DOM 更新
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">queue</span>: <span class="kt">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 组件内部的 beforeRouteLeave
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">extractLeaveGuards</span><span class="p">(</span><span class="nx">deactivated</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 全局 beforeEach
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">beforeHooks</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 组件内部的 beforeRouteUpdate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">extractUpdateHooks</span><span class="p">(</span><span class="nx">updated</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// routes 路由表里写的 beforeEnter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">activated</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">m</span> <span class="o">=&gt;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">beforeEnter</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 解析异步路由组件，会等待异步组件的加载，加载完成之后再导航
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">resolveAsyncComponents</span><span class="p">(</span><span class="nx">activated</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">iterator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hook</span>: <span class="kt">NavigationGuard</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// next 被调用之后，会去拿数组里的下一个钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 有点 to、from、next 那味儿了
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="p">(</span><span class="nx">to</span>: <span class="kt">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">to</span> <span class="o">===</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">isError</span><span class="p">(</span><span class="nx">to</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// next(false) -&gt; 停止导航
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="p">.</span><span class="nx">ensureURL</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">abort</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">'string'</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">path</span> <span class="o">===</span> <span class="s1">'string'</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">to</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'string'</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// next('/') 或 next({ path: '/' }) -&gt; 重定向
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">to</span> <span class="o">===</span> <span class="s1">'object'</span> <span class="o">&amp;&amp;</span> <span class="nx">to</span><span class="p">.</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="k">this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">next</span><span class="p">(</span><span class="nx">to</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">abort</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runQueue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">queue</span><span class="p">,</span> <span class="c1">// 保存了要执行的钩子函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">iterator</span><span class="p">,</span> <span class="c1">// queue 里的钩子会被一个一个的拿到 iterator 里执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// queue 里的钩子被全部调用完成之后，会执行此函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">postEnterCbs</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">isValid</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">===</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 获取组件里 beforeRouteEnter 钩子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">enterGuards</span> <span class="o">=</span> <span class="nx">extractEnterGuards</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">activated</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">postEnterCbs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">isValid</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 拼接上全局 beforeResolve 钩子
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kr">const</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">enterGuards</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">resolveHooks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">runQueue</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">iterator</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// 新的 queue 里的钩子被全部调用完成之后，会执行此函数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">!==</span> <span class="nx">route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">abort</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="k">this</span><span class="p">.</span><span class="nx">pending</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 调用 beforeRouteEnter 守卫中传给 next 的回调函数，创建好的组件实例会作为回调函数的参数传入
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">$nextTick</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nx">postEnterCbs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">cb</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">              <span class="p">});</span>
</span></span><span class="line"><span class="cl">            <span class="p">});</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">updateRoute</span><span class="p">(</span><span class="nx">route</span>: <span class="kt">Route</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">prev</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 this.cb（init 的时候，由 history.listen 赋值）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="p">.</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">cb</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">afterHooks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">hook</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">hook</span> <span class="o">&amp;&amp;</span> <span class="nx">hook</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">prev</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">runQueue</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">queue</span>: <span class="kt">Array</span><span class="o">&lt;?</span><span class="nx">NavigationGuard</span><span class="o">&gt;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fn</span>: <span class="kt">Function</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">cb</span>: <span class="kt">Function</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">queue</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cb</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fn</span><span class="p">(</span><span class="nx">queue</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">step</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">step</span><span class="p">(</span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">step</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="html5history">HTML5History</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HTML5History</span> <span class="kr">extends</span> <span class="nx">History</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">router</span>: <span class="kt">Router</span><span class="p">,</span> <span class="nx">base</span>: <span class="kt">?string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">expectScroll</span> <span class="o">=</span> <span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">scrollBehavior</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">expectScroll</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// popstate 时，保存滚动位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">setupScroll</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 调用 history.pushState() 或者 history.replaceState() 不会触发 popstate 事件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * popstate 事件只会在浏览器后退按钮或调用 history.back() 方法时触发
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 即，在同一文档的两个历史记录条目之间导航会触发该事件
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 重新调用 transitionTo 完成页面切换
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'popstate'</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="nx">getLocation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span><span class="p">),</span> <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">expectScroll</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">           * handleScroll(router, to, from, isPop)
</span></span></span><span class="line"><span class="cl"><span class="cm">           * 调用 getScrollPosition 获取滚动位置（保存在 history 的 state 里）
</span></span></span><span class="line"><span class="cl"><span class="cm">           * 调用 router.options.scrollBehavior(to, from, position) 判断是否需要滚动
</span></span></span><span class="line"><span class="cl"><span class="cm">           * 调用 window.scrollTo 进行滚动
</span></span></span><span class="line"><span class="cl"><span class="cm">           */</span>
</span></span><span class="line"><span class="cl">          <span class="nx">handleScroll</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">current</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">go</span><span class="p">(</span><span class="nx">n</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">push</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">current</span>: <span class="kt">fromRoute</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pushState</span><span class="p">(</span><span class="nx">cleanPath</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fromRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onAbort</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">replace</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">current</span>: <span class="kt">fromRoute</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">replaceState</span><span class="p">(</span><span class="nx">cleanPath</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nx">handleScroll</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">fromRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onAbort</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ensureURL</span><span class="p">(</span><span class="nx">push?</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">getLocation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">cleanPath</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">push</span> <span class="o">?</span> <span class="nx">pushState</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span> <span class="o">:</span> <span class="nx">replaceState</span><span class="p">(</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getCurrentLocation</span><span class="p">()</span><span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">getLocation</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="hashhistory">HashHistory</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">HashHistory</span> <span class="kr">extends</span> <span class="nx">History</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">constructor</span><span class="p">(</span><span class="nx">router</span>: <span class="kt">Router</span><span class="p">,</span> <span class="nx">base</span>: <span class="kt">?string</span><span class="p">,</span> <span class="nx">fallback</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">super</span><span class="p">(</span><span class="nx">router</span><span class="p">,</span> <span class="nx">base</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * checkFallback 会把 HTML5History 格式的链接转换为 HashHistory 格式的链接
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 然后 location.replace 掉
</span></span></span><span class="line"><span class="cl"><span class="cm">     * url：https://router.vuejs.org/zh/api/?abc=123#hahaha，base: /zh
</span></span></span><span class="line"><span class="cl"><span class="cm">     * checkFallback =&gt; https://router.vuejs.org/zh/#/api/?abc=123#hahaha
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">fallback</span> <span class="o">&amp;&amp;</span> <span class="nx">checkFallback</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// /zh#/api/?abc=123#hahaha replace 成为 /zh/#/api/?abc=123#hahaha
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ensureSlash</span><span class="p">();</span> <span class="c1">// 保证 # 前边有 /
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 延迟到应用挂载，防止事件过早触发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">setupListeners() {</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'hashchange'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ensureSlash</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 获取 hash 并跳转
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="nx">getHash</span><span class="p">(),</span> <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">push</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 赋值 window.location.hash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">pushHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onAbort</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">replace</span><span class="p">(</span><span class="nx">location</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="nx">onComplete?</span>: <span class="kt">Function</span><span class="p">,</span> <span class="nx">onAbort?</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用 window.location.replace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">onComplete</span> <span class="o">&amp;&amp;</span> <span class="nx">onComplete</span><span class="p">(</span><span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nx">onAbort</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">go</span><span class="p">(</span><span class="nx">n</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">go</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">ensureURL</span><span class="p">(</span><span class="nx">push?</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">current</span><span class="p">.</span><span class="nx">fullPath</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">getHash</span><span class="p">()</span> <span class="o">!==</span> <span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">push</span> <span class="o">?</span> <span class="nx">pushHash</span><span class="p">(</span><span class="nx">current</span><span class="p">)</span> <span class="o">:</span> <span class="nx">replaceHash</span><span class="p">(</span><span class="nx">current</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">getCurrentLocation() {</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">getHash</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="matcher">matcher</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createMatcher</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">routes</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">RouteConfig</span><span class="p">&gt;,</span> <span class="c1">// options.routes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">router</span>: <span class="kt">VueRouter</span> <span class="c1">// VueRouter 实例
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span><span class="o">:</span> <span class="nx">Matcher</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 把传入的路由表转换为路由映射表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="p">{</span> <span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">createRouteMap</span><span class="p">(</span><span class="nx">routes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// addRoutes 就是把新来的 routes 添加到 pathList, pathMap, nameMap 里
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">function</span> <span class="nx">addRoutes</span><span class="p">(</span><span class="nx">routes</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createRouteMap</span><span class="p">(</span><span class="nx">routes</span><span class="p">,</span> <span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 根据 RawLocation 和 currentRoute 返回一个 route
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">function</span> <span class="nx">match</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">raw</span>: <span class="kt">RawLocation</span><span class="p">,</span> <span class="c1">// url 或者 Location 对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">currentRoute?</span>: <span class="kt">Route</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">redirectedFrom?</span>: <span class="kt">Location</span>
</span></span><span class="line"><span class="cl">  <span class="p">)</span><span class="o">:</span> <span class="nx">Route</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">location</span> <span class="o">=</span> <span class="nx">normalizeLocation</span><span class="p">(</span><span class="nx">raw</span><span class="p">,</span> <span class="nx">currentRoute</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">router</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">location</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span> <span class="c1">// 获取 name 对应的 record
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">record</span><span class="p">)</span> <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">paramNames</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">regex</span><span class="p">.</span><span class="nx">keys</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="nx">key</span><span class="p">.</span><span class="nx">optional</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="nx">key</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">!==</span> <span class="s1">'object'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">currentRoute</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span> <span class="o">===</span> <span class="s1">'object'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">paramNames</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">currentRoute</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">record</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">location</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="nx">fillParams</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="sb">`named route "</span><span class="si">${</span><span class="nx">name</span><span class="si">}</span><span class="sb">"`</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">location</span><span class="p">.</span><span class="nx">params</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">pathList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">pathList</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">record</span> <span class="o">=</span> <span class="nx">pathMap</span><span class="p">[</span><span class="nx">path</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">matchRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">regex</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> <span class="nx">location</span><span class="p">.</span><span class="nx">params</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="nx">record</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">redirectedFrom</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">_createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">match</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addRoutes</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="route-map">route-map</h2><p>传入 option.routes（开发者写的路由表）返回一个数组两个对象：</p><ol><li>所有路由的 path 组成的数组；</li><li>path 到 record 的映射关系；</li><li>name 到 record 的映射关系。</li></ol><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="c1">// 对路由表（routes）进行数据结构的转换
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">export</span> <span class="kd">function</span> <span class="nx">createRouteMap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">routes</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">RouteConfig</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">oldPathList?</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;,</span> <span class="c1">// addRoutes 才用得上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">oldPathMap?</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;,</span> <span class="c1">// addRoutes 才用得上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">oldNameMap?</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;</span> <span class="c1">// addRoutes 才用得上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 用来控制路径匹配优先级
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">pathList</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">oldPathList</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">pathMap</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">oldPathMap</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">nameMap</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;</span> <span class="o">=</span> <span class="nx">oldNameMap</span> <span class="o">||</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">routes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">route</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addRouteRecord</span><span class="p">(</span><span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span><span class="p">,</span> <span class="nx">route</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 确保 path 为通配符的路由一直在结尾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">pathList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">pathList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">'*'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">pathList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pathList</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">      <span class="nx">l</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pathList</span><span class="p">,</span> <span class="c1">// routePath[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pathMap</span><span class="p">,</span> <span class="c1">// {path: record, ...}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nameMap</span> <span class="c1">// {name: rocord, ...}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addRouteRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pathList</span>: <span class="kt">Array</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">pathMap</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">nameMap</span>: <span class="kt">Dictionary</span><span class="p">&lt;</span><span class="nt">RouteRecord</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">route</span>: <span class="kt">RouteConfig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">parent?</span>: <span class="kt">RouteRecord</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">matchAs?</span>: <span class="kt">string</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">name</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 去除 path 最后的 /，并拼接上 parent.path
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">normalizedPath</span> <span class="o">=</span> <span class="nx">normalizePath</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">parent</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">pathToRegexpOptions</span>: <span class="kt">PathToRegexpOptions</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span><span class="p">.</span><span class="nx">pathToRegexpOptions</span> <span class="o">||</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">route</span><span class="p">.</span><span class="nx">caseSensitive</span> <span class="o">===</span> <span class="s1">'boolean'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pathToRegexpOptions</span><span class="p">.</span><span class="nx">sensitive</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">caseSensitive</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 根据传入的 route 生成一个 record
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">const</span> <span class="nx">record</span>: <span class="kt">RouteRecord</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">path</span>: <span class="kt">normalizedPath</span><span class="p">,</span> <span class="c1">// 规范化之后的 path，带上父级路由的那种
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">regex</span>: <span class="kt">compileRouteRegex</span><span class="p">(</span><span class="nx">normalizedPath</span><span class="p">,</span> <span class="nx">pathToRegexpOptions</span><span class="p">),</span> <span class="c1">// 将 path 解析成正则表达式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 一条 path 可以对应多个 components，通过 router-view 的 name 属性来判断渲染出口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">components</span>: <span class="kt">route.components</span> <span class="o">||</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">component</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">instances</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">parent</span><span class="p">,</span> <span class="c1">// ParentRouteRecord
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">matchAs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">redirect</span>: <span class="kt">route.redirect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">beforeEnter</span>: <span class="kt">route.beforeEnter</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">meta</span>: <span class="kt">route.meta</span> <span class="o">||</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">props</span>:
</span></span><span class="line"><span class="cl">      <span class="kt">route.props</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">components</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">route</span><span class="p">.</span><span class="nx">props</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="nx">route</span><span class="p">.</span><span class="nx">props</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s1">'如果 route 有 name，没有重定向，有一个默认的子路由，如果通过 name 进行导航，默认的子路由不会渲染'</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">route</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">childMatchAs</span> <span class="o">=</span> <span class="nx">matchAs</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">cleanPath</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">matchAs</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">child</span><span class="p">.</span><span class="nx">path</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// record 作为 children 的 parent，重新调用 addRouteRecord
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">addRouteRecord</span><span class="p">(</span><span class="nx">pathList</span><span class="p">,</span> <span class="nx">pathMap</span><span class="p">,</span> <span class="nx">nameMap</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">childMatchAs</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 如果路由有别名，同样会生成一条 record
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">aliases</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span><span class="p">)</span> <span class="o">?</span> <span class="nx">route</span><span class="p">.</span><span class="nx">alias</span> <span class="o">:</span> <span class="p">[</span><span class="nx">route</span><span class="p">.</span><span class="nx">alias</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aliases</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">alias</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">aliasRoute</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span>: <span class="kt">alias</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">children</span>: <span class="kt">route.children</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="nx">addRouteRecord</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pathList</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">pathMap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">nameMap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aliasRoute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">parent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">record</span><span class="p">.</span><span class="nx">path</span> <span class="o">||</span> <span class="s1">'/'</span> <span class="c1">// matchAs
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pathMap</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pathList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pathMap</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">nameMap</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">record</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="router-link">router-link</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="s1">'router-link'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">to</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Object</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nx">required</span>: <span class="kt">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// router-link 默认就是 a 标签
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tag</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span> <span class="s1">'a'</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">exact</span>: <span class="kt">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">append</span>: <span class="kt">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">replace</span>: <span class="kt">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">activeClass</span>: <span class="kt">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">exactActiveClass</span>: <span class="kt">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">event</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Array</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span> <span class="s1">'click'</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">render</span><span class="p">(</span><span class="nx">h</span>: <span class="kt">Function</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$router</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">$route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="p">{</span> <span class="nx">location</span><span class="p">,</span> <span class="nx">route</span><span class="p">,</span> <span class="nx">href</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">router</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">to</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">current</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">append</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">classes</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">globalActiveClass</span> <span class="o">=</span> <span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">linkActiveClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">globalExactActiveClass</span> <span class="o">=</span> <span class="nx">router</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">linkExactActiveClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 不同状态的类名处理
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">activeClassFallback</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">globalActiveClass</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s1">'router-link-active'</span> <span class="o">:</span> <span class="nx">globalActiveClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">exactActiveClassFallback</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="nx">globalExactActiveClass</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="s1">'router-link-exact-active'</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="nx">globalExactActiveClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">activeClass</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">activeClass</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">activeClassFallback</span> : <span class="kt">this.activeClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">exactActiveClass</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">exactActiveClass</span> <span class="o">==</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="nx">exactActiveClassFallback</span>
</span></span><span class="line"><span class="cl">        : <span class="kt">this.exactActiveClass</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">compareTarget</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">path</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="nx">createRoute</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">location</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">router</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="nx">route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">classes</span><span class="p">[</span><span class="nx">exactActiveClass</span><span class="p">]</span> <span class="o">=</span> <span class="nx">isSameRoute</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">compareTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">classes</span><span class="p">[</span><span class="nx">activeClass</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">exact</span>
</span></span><span class="line"><span class="cl">      <span class="o">?</span> <span class="nx">classes</span><span class="p">[</span><span class="nx">exactActiveClass</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="nx">isIncludedRoute</span><span class="p">(</span><span class="nx">current</span><span class="p">,</span> <span class="nx">compareTarget</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 按下 meta、alt、ctrl、shift 时不起作用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 调用 preventDefault 时不起作用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * target=_blank 时不起作用
</span></span></span><span class="line"><span class="cl"><span class="cm">       * 右键点击时不起作用
</span></span></span><span class="line"><span class="cl"><span class="cm">       */</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">guardEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 调用 replace 和 push
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">replace</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">router</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">router</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">location</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">on</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">click</span>: <span class="kt">guardEvent</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">event</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 如果绑定了多个事件处理，也仅绑定在 click 上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">on</span><span class="p">[</span><span class="nx">e</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">on</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">event</span><span class="p">]</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">data</span>: <span class="kt">any</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">class</span><span class="o">:</span> <span class="nx">classes</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 创建 a 链接之后，会在 a 链接上绑定 href 属性和 click 事件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span> <span class="o">===</span> <span class="s1">'a'</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">data</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nx">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">data</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">href</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 找到子元素中的 a 标签，在上面加 listener 和 href
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">findAnchor</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$slots</span><span class="p">.</span><span class="k">default</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 将 a 标签上已有的属性和 on/href 进行合并
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">a</span><span class="p">.</span><span class="nx">isStatic</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">extend</span> <span class="o">=</span> <span class="nx">_Vue</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">aData</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">a</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aData</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nx">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">aAttrs</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">=</span> <span class="nx">extend</span><span class="p">({},</span> <span class="nx">a</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">attrs</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aAttrs</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">href</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 没 a 标签，那就把 listener 加到自己身上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">data</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="nx">on</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">$slots</span><span class="p">.</span><span class="k">default</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><h2 id="router-view">router-view</h2><div class="highlight"><div class="chroma"><table class="lntable"><tbody><tr><td class="lntd"><pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td><td class="lntd"><pre tabindex="0" class="chroma"><code class="language-typescript" data-lang="typescript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="k">default</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">name</span><span class="o">:</span> <span class="s1">'router-view'</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">functional</span>: <span class="kt">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">props</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">type</span><span class="o">:</span> <span class="nb">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="k">default</span><span class="o">:</span> <span class="s1">'default'</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">render</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="p">{</span> <span class="nx">props</span><span class="p">,</span> <span class="nx">children</span><span class="p">,</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">data</span> <span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">.</span><span class="nx">routerView</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 借用父级的 h 函数，酱紫 router-view 渲染的组件可以解析具名插槽
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$createElement</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当同一层级同时有多个 router-view 存在时，会通过 name 属性来确定渲染哪个组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">props</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$route</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">cache</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_routerViewCache</span> <span class="o">||</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">_routerViewCache</span> <span class="o">=</span> <span class="p">{});</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当前 router-view 所处的层级（嵌套深度，上层还有几个 router-view），顺便检查当前是否 active
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">inactive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * this._routerRoot = this.$parent._routerRoot
</span></span></span><span class="line"><span class="cl"><span class="cm">     * 非根组件的 _routerRoot 指向父级 _routerRoot
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">_routerRoot</span> <span class="o">!==</span> <span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果父级组件中有一层 routerView，depth++
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">$vnode</span> <span class="o">&amp;&amp;</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$vnode</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">routerView</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">depth</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 如果父级没有被激活，当前组件也不应激活，和 keep-active 组件有关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">_inactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">inactive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">$parent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="p">.</span><span class="nx">routerViewDepth</span> <span class="o">=</span> <span class="nx">depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 如果是 inactive 状态，渲染前一个视图
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">inactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 当前 route 下，对应层级有没有要渲染的组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">matched</span> <span class="o">=</span> <span class="nx">route</span><span class="p">.</span><span class="nx">matched</span><span class="p">[</span><span class="nx">depth</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 没有匹配上，就渲染空节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">matched</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">h</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 获取匹配到的组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">const</span> <span class="nx">component</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// data 上保存了一个函数，被实例注入的生命周期钩子调用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">data</span><span class="p">.</span><span class="nx">registerRouteInstance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vm</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">((</span><span class="nx">val</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span> <span class="o">!==</span> <span class="nx">vm</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">val</span> <span class="o">&amp;&amp;</span> <span class="nx">current</span> <span class="o">===</span> <span class="nx">vm</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">matched</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hook</span> <span class="o">||</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hook</span> <span class="o">=</span> <span class="p">{})).</span><span class="nx">prepatch</span> <span class="o">=</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">vnode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">matched</span><span class="p">.</span><span class="nx">instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vnode</span><span class="p">.</span><span class="nx">componentInstance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 解析 props
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">data</span><span class="p">.</span><span class="nx">props</span> <span class="o">=</span> <span class="nx">resolveProps</span><span class="p">(</span><span class="nx">route</span><span class="p">,</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">props</span> <span class="o">&amp;&amp;</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 调用 h 函数，渲染匹配到的组件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">h</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">children</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></tbody></table></div></div><p>总之，VueRouter 在初始化的时候，会向组件 mixin 一些钩子函数；在 beforeCreate 中，会借助 Vue.util.defineReactive API 将 vm._route 转换为 getter/setter；又因为 router-view 在调用 h 函数渲染组件的时候，会访问 vm._route.matched，router-view 所在实例的 renderWatcher 形成对 vm._route 的依赖。所以，每当 vm._route 变化，router-view 会自动匹配自己要渲染的组件。</p><p>router-link 默认会渲染出一个绑定了事件的 a 标签，用户点击时，会调用 transitionTo 进行导航；transitionTo 会计算出最新的 route，调用 History API 更新 URL，调用路由钩子，更新 vm._route，触发 router-view 更新。</p><p>至于 popstate 事件，主要用来处理浏览器的行为（history.pushState/replaceState 并不会触发 popstate）并调用 transitionTo 更新页面。</p></section><footer class="article-footer"><section class="article-not-by-ai-badge"><a href="https://notbyai.fyi/cn/" target="_blank" title="Not By AI"><svg width="131" height="42" viewBox="0 0 131 42" fill="none"><path d="M.5.5H116c8.008.0 14.5 6.49187 14.5 14.5V41.5H15C6.99187 41.5.5 35.0081.5 27V.5z" fill="#fff" stroke="#000"></path><path d="M17.9605 24.1575c3.4661 2.8068 8.4231 2.8068 11.8892.0l-1.3402-1.6549c-2.6847 2.174-6.5241 2.174-9.2088.0l-1.3402 1.6549z" fill="#000"></path><path d="M19.404 20.5134V17.6365h2.1296v2.8769H19.404z" fill="#000"></path><path d="M26.012 17.6365v2.8769h2.1295V17.6365H26.012z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M35 21.5C35 27.8513 29.8513 33 23.5 33S12 27.8513 12 21.5C12 15.1487 17.1487 10 23.5 10S35 15.1487 35 21.5zm-2.1295.0c0 5.1752-4.1953 9.3705-9.3705 9.3705S14.1295 26.6752 14.1295 21.5s4.1953-9.3705 9.3705-9.3705 9.3705 4.1953 9.3705 9.3705z" fill="#000"></path><path d="M61.844 12.1721l.1995.711L62.2294 12.8197C62.5169 12.7216 62.8276 12.6155 63.1503 12.5052v2.55C63.1503 15.1818 63.1005 15.2208 62.9709 15.2208 62.8612 15.2208 62.4922 15.2208 62.0634 15.211 62.1631 15.4156 62.2628 15.7273 62.2928 15.9123 62.901 15.9123 63.28 15.8929 63.5293 15.776 63.7686 15.6591 63.8583 15.4545 63.8583 15.0455V12.2629C64.2106 12.1421 64.5673 12.0195 64.9154 11.8994L64.8057 11.2273C64.4898 11.3348 64.1706 11.4415 63.8583 11.5441V9.63961H64.8057V8.95779H63.8583V7H63.1503V8.95779H61.9936v.68182h1.1567V11.7732C62.6577 11.9301 62.2064 12.0683 61.844 12.1721z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M66.0322 10.7695C65.3142 10.7695 65.1347 10.5162 65.1347 9.8052V7.39935h2.6127V9.32792H65.763V9.81494C65.763 10.1169 65.8128 10.2045 66.0322 10.2045H67.2986C67.4781 10.2045 67.7474 10.1948 67.9069 10.1656 67.9134 10.2165 67.92 10.2777 67.9268 10.3422 67.941 10.4754 67.9566 10.6224 67.9767 10.7208 67.8371 10.7597 67.5779 10.7695 67.3086 10.7695H66.0322zM65.763 7.90584H67.1391V8.82143H65.763V7.90584z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M69.0736 10.7208C68.3656 10.7208 68.1861 10.4773 68.1861 9.76623V7.39935H70.8087V9.2987H68.8144V9.77597C68.8144 10.0682 68.8642 10.1656 69.0936 10.1656h1.3262C70.5993 10.1656 70.8985 10.1461 71.058 10.1071 71.068 10.2825 71.0979 10.5357 71.1179 10.6721 70.9783 10.7208 70.709 10.7208 70.4298 10.7208H69.0736zM68.8144 7.90584h1.396v.88637h-1.396V7.90584z" fill="#000"></path><path d="M66.83 14.1299C66.2715 14.6753 65.3142 15.1818 64.4567 15.5032 64.6262 15.6201 64.9054 15.8539 65.035 15.9805 65.8727 15.6104 66.8898 14.9968 67.5081 14.3831L66.83 14.1299z" fill="#000"></path><path d="M68.4554 14.4513C69.2132 14.9091 70.1905 15.5812 70.6791 16L71.2974 15.6104C70.7788 15.1818 69.7916 14.539 69.0437 14.1007L68.4554 14.4513z" fill="#000"></path><path d="M50.4761 15.9318C49.798 15.5617 48.6612 15.0942 47.5344 14.7338L48.0031 14.2468C49.1299 14.5974 50.3564 15.0552 51.0844 15.4253L50.4761 15.9318z" fill="#000"></path><path d="M42 15.4156C43.067 15.1623 44.4032 14.6656 45.0713 14.2468L45.7594 14.6753C44.9218 15.1721 43.5855 15.6786 42.5185 15.9513 42.4088 15.8052 42.1596 15.5519 42 15.4156z" fill="#000"></path><path d="M56.1556 7.21693C56.1571 7.15007 56.1585 7.0868 56.1601 7.02922H56.9877L56.9868 7.0714C56.9788 7.4194 56.968 7.88942 56.9233 8.43665 57.0639 9.58208 57.6711 13.7136 61.2258 15.2597 61.0064 15.4253 60.787 15.6786 60.6773 15.8831c-2.5071-1.144-3.5872-3.5484-4.0775-5.3684C56.13 12.4644 55.0681 14.6445 52.63 15.9221 52.5004 15.7273 52.2511 15.5032 52.0217 15.3474c3.9976-1.9757 4.0968-6.45452 4.1339-8.13047z" fill="#000"></path><path d="M75.0586 9.43506C75.1376 9.06022 75.2116 8.69288 75.2761 8.3539L74.5283 8.27597C74.3089 9.50325 73.9299 11.1688 73.6408 12.1623L74.3986 12.2305C74.4264 12.1301 74.4552 12.0226 74.4848 11.9091H78.3699C78.3296 12.3408 78.2883 12.7224 78.2455 13.0584H72.0851V13.7403h6.0611C78.0034 14.5883 77.8408 15.0239 77.6395 15.1916 77.5198 15.289 77.4002 15.2987 77.1708 15.2987 76.9215 15.2987 76.2334 15.2987 75.5454 15.2305 75.675 15.4253 75.7747 15.7175 75.7947 15.9221 76.4429 15.961 77.091 15.9708 77.4201 15.9513 77.799 15.9318 78.0284 15.8636 78.2677 15.6396 78.532 15.3814 78.7263 14.8409 78.8969 13.7403H81V13.0584H78.991C79.0434 12.6344 79.0943 12.1472 79.1452 11.5877 79.1552 11.4805 79.1751 11.2565 79.1751 11.2565H74.6483C74.7379 10.8862 74.8303 10.4846 74.92 10.0779H79.2948V9.43506H75.0586z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M65.1746 11.6266V12.25H66.5109v1.1299H64.7558v.6233H71.1079v-.6233H69.5523V12.25h1.3262v-.6234H69.5523v-.6623H68.8642v.6623H67.189V10.9838H66.5109V11.6266H65.1746zm2.0144 1.7533V12.25h1.6752v1.1299H67.189z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M42.1895 14.0909v-.6234h1.4359V9.06494h2.5129V8.4513H42.4687V7.81818h3.6696V7.00974H46.8762v.80844H50.7852V8.4513H46.8762v.61364h2.7623V13.4675h1.406v.6234h-8.855zm2.1539-.6234h4.5472V12.7857H44.3434V13.4675zm0-1.1493h4.5472V11.7338H44.3434V12.3182zm0-1.0617h4.5472v-.5747H44.3434v.5747zm0-1.0325h4.5472V9.58117H44.3434V10.224z" fill="#000"></path><path d="M72.3245 9.65909V7.52597h8.4362V9.65909H79.9829V8.20779H73.0624v1.4513H72.3245z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M105.32 26.2505C105.32 25.9898 105.336 25.4196 105.336 25.4196H101.424V23.8717H105.573C105.764 26.2238 106.11 28.471 106.651 30.2984c-.875.9892-1.892 1.8173-3.039 2.4531C104.107 33.2077 104.953 34.2016 105.288 34.7067 106.138 34.1597 106.93 33.5082 107.658 32.7639 108.338 33.9391 109.193 34.6415 110.254 34.6415 111.898 34.6415 112.649 33.9572 113 30.78 112.377 30.5356 111.563 29.9817 111.036 29.4277 110.956 31.4155 110.765 32.2301 110.445 32.2301 110.06 32.2301 109.67 31.686 109.312 30.7655 110.465 29.1244 111.389 27.1985 112.058 25.0611L109.711 24.4908C109.396 25.6095 108.983 26.659 108.478 27.6243 108.264 26.4884 108.09 25.2105 107.974 23.8717h4.866V21.5418H111.142L111.946 20.6945C111.387 20.1568 110.27 19.4399 109.455 19l-1.405 1.4175C108.553 20.7329 109.148 21.1437 109.647 21.5418H107.835C107.811 20.7923 107.808 20.0385 107.827 19.2933h-2.443C105.387 20.0364 105.403 20.7892 105.433 21.5418H98.9812v4.8879C98.9812 28.5642 98.9014 31.4481 97.7199 33.3707 98.2468 33.6477 99.3006 34.5275 99.6997 35 100.514 33.7498 100.957 32.0088 101.189 30.2753 101.506 30.8638 101.745 31.7506 101.775 32.4257 102.51 32.4257 103.18 32.4094 103.612 32.3279 104.091 32.2301 104.458 32.0672 104.809 31.5947 105.192 31.0733 105.272 29.5743 105.32 26.2505zM101.197 30.2141C101.316 29.3052 101.378 28.4 101.406 27.5703h1.652C103.023 29.1922 102.963 29.8644 102.829 30.0631 102.701 30.2261 102.558 30.2749 102.35 30.2749 102.102 30.2749 101.674 30.2596 101.197 30.2141z" fill="#000"></path><path d="M86.8673 22.112C87.1314 21.4187 87.3672 20.705 87.565 19.9939L85.1541 19.4399C84.6112 21.6395 83.5893 23.8717 82.3599 25.2077 82.9507 25.5336 83.9885 26.2342 84.4515 26.6415 84.9297 26.0332 85.4007 25.2744 85.839 24.4257h3.0672v2.4928H84.7709v2.2811h4.1353V32.002H82.8708v2.3137H97.4005V32.002H91.3332V29.1996H95.9156V26.9185H91.3332V24.4257H96.5543V22.112H91.3332V19.277H88.9062v2.835H86.8673z" fill="#000"></path><path d="M47.3436 28.4645C47.4377 28.0285 47.4856 27.6141 47.4988 27.2444H43.8462V25.11h3.6564V23.4807h-3.816V21.2811h3.816V19.3585h2.2992V27c0 2.8513-.862200000000001 6.0611-4.774 7.9837C44.6446 34.4134 43.9261 33.6802 43.3672 33.224 44.7784 32.6761 45.7414 31.786 46.3804 30.8057 45.6568 30.9237 44.9507 31.0375 44.2921 31.1436L43.4151 31.2851 43 28.9226C44.1273 28.8236 45.7056 28.6496 47.3436 28.4645z" fill="#000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M72.6755 34.3305 67.632 19.7976H64.2697L59.1875 34.3305h3.1111L63.2841 31.3431H68.5306l.9178 2.9874H72.6755zM65.9218 23.1202l1.7778 5.7186H64.0861l1.8357-5.7186z" fill="#000"></path><path d="M53.7456 19.3585v1.9226h4.1833v2.1996H53.7456V25.11H57.5457v2.1344H53.7456v1.6619H58.2163v2.1996H53.7456v3.6497H51.4144V19.3585h2.3312z" fill="#000"></path><path d="M75.2125 22.2696v9.5922H73.4582v2.4721H79.719V31.8618h-1.55V22.2696h1.55v-2.472H73.4582v2.472h1.7543z" fill="#000"></path></svg></a></section></footer></article><aside class="related-content--wrapper"><h2 class="section-title">相关文章</h2><div class="related-content"><div class="flex article-list--tile"><article class="has-image"><a href="/p/vue-2.x/3.x-%E6%AF%94%E8%BE%83/"><div class="article-image"><img src="/img/cover/vue.webp" loading="lazy" data-key="" data-hash="/img/cover/vue.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Vue 2.x/3.x 比较</h2></div></a></article><article class="has-image"><a href="/p/%E5%9F%BA%E4%BA%8E%E4%BD%9C%E7%94%A8%E5%9F%9F%E6%8F%92%E6%A7%BD%E7%9A%84-renderless-%E7%BB%84%E4%BB%B6/"><div class="article-image"><img src="/img/cover/vue.webp" loading="lazy" data-key="" data-hash="/img/cover/vue.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">基于作用域插槽的 Renderless 组件</h2></div></a></article><article class="has-image"><a href="/p/vue-composition-api/"><div class="article-image"><img src="/img/cover/vue.webp" loading="lazy" data-key="" data-hash="/img/cover/vue.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Vue Composition API</h2></div></a></article><article class="has-image"><a href="/p/vue-3.0-%E6%9D%A5%E4%BA%86/"><div class="article-image"><img src="/img/cover/vue.webp" loading="lazy" data-key="" data-hash="/img/cover/vue.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Vue 3.0 来了</h2></div></a></article><article class="has-image"><a href="/p/vue-2.x-%E5%A4%8D%E4%B9%A0%E6%80%BB%E7%BB%93/"><div class="article-image"><img src="/img/cover/vue.webp" loading="lazy" data-key="" data-hash="/img/cover/vue.png" alt="" decoding="async" width="1200" height="720" jampack-sized="true"></div><div class="article-details"><h2 class="article-title">Vue 2.x 复习总结</h2></div></a></article></div></div></aside><footer class="site-footer"><section class="copyright" style="display:flex;justify-content:flex-start;align-items:center">©
2017 -
2026
<a href="https://github.com/ElementRef" target="_blank">馬腊咯稽
</a><a href="https://ipw.cn/ipv6webcheck/?site=elementref.github.io" target="_blank" title="本站支持 IPv6 访问"><img style="display:inline-block;vertical-align:middle" src="https://static.ipw.cn/icon/ipv6-certified-lite-s1.svg" alt="本站支持 IPv6 访问" loading="lazy" decoding="async"></a></section><section class="powerby">Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, Deploy by Actions<br>主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计</section></footer><div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"><div class="pswp__bg"></div><div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div><div class="pswp__item"></div><div class="pswp__item"></div></div><div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="关闭"></button>
<button class="pswp__button pswp__button--fs" title="全屏"></button>
<button class="pswp__button pswp__button--zoom" title="缩放"></button><div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div><button class="pswp__button pswp__button--arrow--left" title="上一张"></button>
<button class="pswp__button pswp__button--arrow--right" title="下一张"></button><div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin="anonymous" defer=""></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css" crossorigin="anonymous"></main><aside class="sidebar sticky right-sidebar"><section class="archives widget"><div class="widget-icon"><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"></path><line x1="5" y1="9" x2="19" y2="9"></line><line x1="5" y1="15" x2="19" y2="15"></line><line x1="11" y1="4" x2="7" y2="20"></line><line x1="17" y1="4" x2="13" y2="20"></line></svg></div><h2 class="section-title widget-title">目录</h2><div class="widget--toc"><nav id="TableOfContents"><ol><li><a href="#vueuserouter">Vue.use(Router)</a></li><li><a href="#vuerouter">VueRouter</a></li><li><a href="#basehistory">BaseHistory</a></li><li><a href="#html5history">HTML5History</a></li><li><a href="#hashhistory">HashHistory</a></li><li><a href="#matcher">matcher</a></li><li><a href="#route-map">route-map</a></li><li><a href="#router-link">router-link</a></li><li><a href="#router-view">router-view</a></li></ol></nav></div></section></aside></div><script src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js" integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin="anonymous"></script><script type="text/javascript" src="/ts/main.js" crossorigin="anonymous" defer=""></script><script src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" crossorigin="anonymous"></script><script>NProgress.configure({showSpinner:!1}),NProgress.start(),document.addEventListener("readystatechange",()=>{document.readyState==="interactive"&&NProgress.inc(.8),document.readyState==="complete"&&NProgress.done()})</script></body></html>